<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Clinic - Aplikasi Tagihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7fc;
            --card-bg: #ffffff;
            --primary-text: #1e293b;
            --secondary-text: #64748b;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e2e8f0;
            --navy-blue: #0f172a; /* Used for main headers */
            --light-blue-bg: #eff6ff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            padding-bottom: 50px; /* Add padding for the fixed footer */
        }
        .elegant-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.07);
        }
        .service-item:hover {
            background-color: var(--light-blue-bg);
            transform: translateX(4px);
            transition: all 0.2s ease-in-out;
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
        }
        .btn:hover {
             box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
             transform: translateY(-1px);
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        /* Ensure all buttons have a consistent disabled state */
        .btn:disabled {
            background-color: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.8;
        }
        .btn-secondary {
            background-color: var(--secondary-text);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-logout {
            background-color: #dc3545;
            color: white;
        }
        .btn-logout:hover {
            background-color: #c82333;
        }
        input:focus, .quantity-input:focus, .price-input:focus, .admin-input:focus, .admin-select:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25) !important;
            outline: none !important;
        }
        input:disabled {
            background-color: #f1f5f9;
            cursor: not-allowed;
        }
        .hidden { display: none; }

        /* New sidebar style for Admin Obat Page (Point 4) */
        .summary-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
            /* Adjusted max-height for better fit */
            max-height: calc(100vh - 150px); 
            overflow-y: auto;
            z-index: 10;
        }

        .quantity-input, .price-input {
            width: 80px;
            text-align: center;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            -moz-appearance: textfield;
        }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button,
        .price-input::-webkit-outer-spin-button,
        .price-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .read-only-mode {
            pointer-events: none;
        }
        /* Chat Box Styles */
        #chat-window {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform-origin: bottom right;
        }
        #chat-window.hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            pointer-events: none;
        }
        #chat-messages {
            scroll-behavior: smooth;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }
        .chat-message.sent {
            align-self: flex-end;
            align-items: flex-end;
        }
        .chat-message.received {
            align-self: flex-start;
            align-items: flex-start;
        }
        .chat-bubble {
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .chat-message.sent .chat-bubble {
            background-color: var(--accent-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-message.received .chat-bubble {
            background-color: #e5e7eb; /* gray-200 */
            color: var(--primary-text);
            border-bottom-left-radius: 0.25rem;
        }
        .chat-meta {
            font-size: 0.75rem; /* 12px */
            color: var(--secondary-text);
            margin-top: 0.25rem;
            padding: 0 0.5rem;
        }
        /* Loader Styles */
        #loader {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        .spinner {
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }

        /* Custom Modal Styles */
        #modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
<audio id="chat-send-sound" src="/sounds/send.mp3" preload="auto"></audio>
<audio id="chat-incoming-sound" src="/sounds/incoming.mp3" preload="auto"></audio>

    <div id="loader" class="hidden fixed inset-0 z-[999] flex justify-center items-center">
        <div class="spinner h-16 w-16 border-4 border-gray-300 rounded-full"></div>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="modal-overlay" class="hidden fixed inset-0 z-[99] flex items-center justify-center p-4">
        <div id="modal-box" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-actions" class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="btn btn-secondary py-2 px-4 rounded-lg">Batal</button>
                <button id="modal-confirm-btn" class="btn btn-danger py-2 px-4 rounded-lg">Konfirmasi</button>
            </div>
        </div>
    </div>

    <div id="auth-container" class="max-w-md mx-auto">
        <div class="bg-[var(--card-bg)] p-8 rounded-lg elegant-shadow text-center">
            <img id="logo-auth" src="https://dibyaklinik.com/images/bluelogo.png" alt="Logo Klinik" class="h-32 sm:h-40 w-auto mx-auto mb-4 object-contain" crossorigin="anonymous"/>
            
            <div id="login-form">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Login</h2>
                <form id="login" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md" required>
                    
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 pr-10 border border-[var(--border-color)] rounded-md" required>
                        <button type="button" id="password-toggle-btn" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700">
                            <svg id="eye-icon" class="h-5 w-5" xmlns="https://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.432 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <svg id="eye-slash-icon" class="h-5 w-5 hidden" xmlns="https://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center">
                            <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="remember-me" class="ml-2 block text-gray-700">Ingat Saya</label>
                        </div>
                        <a href="#" id="forgot-password-link" class="font-semibold text-[var(--navy-blue)] hover:underline">Lupa Password?</a>
                    </div>
                    <button type="submit" class="w-full btn btn-primary font-bold py-2 px-6 rounded-lg">Login</button>
                </form>
                <p class="mt-4 text-sm">Belum punya akun? <a href="#" id="show-register" class="text-[var(--navy-blue)] font-semibold">Daftar di sini</a></p>
            </div>
            
            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Register</h2>
                <form id="register" class="space-y-4">
                    <input type="text" id="register-username" placeholder="Username" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md" required>
                    <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md" required>
                    <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md" required>
                    <button type="submit" class="w-full btn btn-primary font-bold py-2 px-6 rounded-lg">Register</button>
                </form>
                <p class="mt-4 text-sm">Sudah punya akun? <a href="#" id="show-login" class="text-[var(--navy-blue)] font-semibold">Login di sini</a></p>
            </div>

            <div id="forgot-password-form" class="hidden">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Reset Password</h2>
                <form id="reset-password" class="space-y-4">
                     <p class="text-sm text-gray-600">Masukkan email Anda. Kami akan mengirimkan tautan untuk mereset password Anda.</p>
                    <input type="email" id="reset-email" placeholder="Email" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md" required>
                    <button type="submit" class="w-full btn btn-primary font-bold py-2 px-6 rounded-lg">Kirim Tautan Reset</button>
                </form>
                <p class="mt-4 text-sm"><a href="#" id="back-to-login-from-reset" class="text-[var(--navy-blue)] font-semibold">&larr; Kembali ke Login</a></p>
            </div>
            
            <div id="verify-email-message" class="hidden">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Verifikasi Email Anda</h2>
                <p class="mb-4 text-sm">Terima kasih telah mendaftar! Tautan verifikasi telah dikirim ke alamat email Anda. Silakan periksa kotak masuk Anda dan klik tautan tersebut untuk mengaktifkan akun Anda.</p>
                <a href="#" id="back-to-login" class="text-[var(--navy-blue)] font-semibold">Kembali ke Login</a>
            </div>
            
            <div id="unverified-user-message" class="hidden">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Akun Belum Terverifikasi</h2>
                <p class="mb-4 text-sm">Email Anda belum diverifikasi. Silakan periksa kotak masuk Anda untuk tautan verifikasi. Aplikasi tidak dapat digunakan sebelum verifikasi.</p>
                <button id="resend-verification-btn" class="w-full btn btn-secondary font-bold py-2 px-6 rounded-lg mb-4">Kirim Ulang Email Verifikasi</button>
                <button id="unverified-logout-btn" class="w-full btn btn-logout font-bold py-2 px-6 rounded-lg">Logout</button>
            </div>
            
            <div id="auth-messages" class="mt-4 text-sm">
                <p id="auth-error" class="text-red-500"></p>
                <p id="auth-success" class="text-green-500"></p>
            </div>
        </div>
    </div>

        <div id="main-app" class="hidden">
        <div class="relative max-w-7xl mx-auto bg-[var(--card-bg)] p-4 sm:p-8 rounded-lg elegant-shadow">
            <img src="https://dibyaklinik.com/images/bluelogo.png" class="absolute inset-0 w-full h-full object-contain opacity-5 pointer-events-none" alt="Watermark" crossorigin="anonymous"/>
            
            <header class="relative flex flex-col sm:flex-row items-center justify-between gap-4 mb-8 pb-6 border-b border-[var(--border-color)]">
                <div class="flex items-center self-start sm:self-center">
                    <img id="logo" src="https://dibyaklinik.com/images/bluelogo.png" alt="Logo Klinik" class="h-40 sm:h-42 w-auto mr-4 object-contain flex-shrink-0" crossorigin="anonymous"/>
                  <div id="datetime-container" class="hidden sm:block">
     <p id="date-display" class="font-semibold text-sm sm:text-base text-[var(--navy-blue)] whitespace-nowrap"></p>
     <p id="time-display" class="text-xs sm:text-sm text-[var(--secondary-text)]"></p>
 </div>
                </div>
                <div id="user-info" class="flex flex-wrap items-center justify-start sm:justify-end w-full sm:w-auto text-xs sm:text-sm"></div>
            </header>

            <div id="status-banner" class="hidden text-center font-semibold p-3 rounded-lg mb-6 text-white"></div>

            <div id="admin-page" class="hidden relative">
                <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Admin Panel</h2>
                <div class="bg-slate-50 rounded-lg p-4 sm:p-6 elegant-shadow border border-[var(--border-color)]">
                    <p class="text-lg">Welcome, <span id="admin-welcome-name"></span>.</p>
                    <p class="text-[var(--secondary-text)] mt-2">Gunakan panel ini untuk mengelola harga, stok, dan layanan.</p>
                                                
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-[var(--navy-blue)] mb-4">Stok Opname Obat & Alkes</h3>
                          <div class="mb-4 flex justify-end">
                            <button id="addObatBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Baru</button>
                        </div>
                        <div id="admin-obat-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 border bg-white p-4 rounded-md">
                            <p>Memuat data...</p>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="saveObatChangesBtn" class="btn btn-primary font-bold py-2 px-6 rounded-lg">Simpan Perubahan</button>
                        </div>
                    </div>

                    <div id="admin-tindakan-section" class="mt-8 pt-6 border-t">
                        <h3 class="text-xl font-semibold text-[var(--navy-blue)] mb-4">Edit Layanan & Tindakan</h3>
                        <div class="mb-4 flex justify-end">
                            <button id="addTindakanBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Baru</button>
                        </div>
                        <div id="admin-tindakan-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 border bg-white p-4 rounded-md">
                            <p>Memuat data...</p>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="saveTindakanChangesBtn" class="btn btn-primary font-bold py-2 px-6 rounded-lg">Simpan Perubahan</button>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t">
                        <button id="backToBillingBtn" class="btn btn-secondary font-bold py-2 px-6 rounded-lg">&larr; Kembali ke Billing</button>
                    </div>
                </div>
            </div>
            
                        <div id="log-page" class="hidden relative">
                 <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Log Aktivitas</h2>
                 <div class="bg-slate-50 rounded-lg p-4 sm:p-6 elegant-shadow border border-[var(--border-color)]">
                       <div id="log-list-container" class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                            <p>Memuat log...</p>
                       </div>
                       <div class="mt-8 pt-6 border-t">
                            <button id="backFromLogBtn" class="btn btn-secondary font-bold py-2 px-6 rounded-lg">&larr; Kembali ke Billing</button>
                       </div>
                 </div>
            </div>

                        <div id="tindakan-page" class="hidden relative">
                <main id="tindakan-interactive-area" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <h2 class="text-xl font-semibold mb-4 text-[var(--navy-blue)]">Pilih Layanan/Tindakan</h2>
                        <input type="text" id="tindakanSearchInput" placeholder="Cari layanan..." class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md mb-4">
                        <div id="serviceList" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-slate-50 rounded-lg p-4 sm:p-6 h-full flex flex-col elegant-shadow border border-[var(--border-color)]">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 text-center sm:text-left">
                                <h2 class="text-xl font-semibold text-[var(--navy-blue)] mb-4 sm:mb-0">Detail Tagihan Tindakan</h2>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <button id="new-bill-btn" class="btn btn-danger font-bold py-2 px-4 rounded-lg text-sm">Tagihan Baru</button>
                                    <button id="print-tindakan-list-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg text-sm">Cetak Daftar</button>
                                    <button id="print-price-list-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg text-sm">Cetak Semua</button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="patientName" class="block text-sm font-medium text-[var(--secondary-text)] mb-1">Nama Pasien</label>
                                <input type="text" id="patientName" placeholder="Masukkan nama pasien" class="w-full px-4 py-2 border border-[var(--border-color)] rounded-md">
                            </div>
                            <div class="flex-grow min-h-[200px] bg-white border border-[var(--border-color)] rounded-md p-4">
                                <ul id="selectedServicesList" class="space-y-3">
                                    <li id="empty-state-tindakan" class="text-center text-[var(--secondary-text)] py-10">Pilih layanan di sebelah kiri.</li>
                                </ul>
                            </div>
                            <div class="mt-6 pt-4 border-t border-[var(--border-color)]">
                                <div class="flex justify-between items-center text-lg sm:text-xl font-bold">
                                    <span class="text-[var(--primary-text)]">TOTAL TINDAKAN</span>
                                    <span id="totalAmountTindakan" class="text-[var(--navy-blue)]">Rp 0</span>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button id="goToObatBtn" class="w-full sm:w-auto btn btn-primary font-bold py-2 px-6 rounded-lg">Lanjut ke Obat & Alkes &rarr;</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

                        <div id="obat-page" class="hidden relative">
                                <main id="obat-interactive-area" class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-1">
                        <div class="mb-4 sticky top-0 bg-white/80 backdrop-blur-sm py-4 z-10 -mx-4 sm:-mx-8 px-4 sm:px-8">
                            <input type="text" id="obatSearchInput" class="w-full text-lg px-4 py-3 border-2 border-gray-200 rounded-lg" placeholder="Cari obat atau alkes...">
                        </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <section class="card shadow-sm"><h2 class="text-lg font-bold p-3 border-b">Obat-obatan</h2><div id="drugs-container" class="divide-y text-sm"></div></section>
                            </div>
                            <div>
                                <section class="card shadow-sm mb-6"><h2 class="text-lg font-bold p-3 border-b">Ampul & Vial</h2><div id="ampuls-container" class="divide-y text-sm"></div></section>
                                <section class="card shadow-sm"><h2 class="text-lg font-bold p-3 border-b">Alkes Habis Pakai</h2><div id="consumables-container" class="divide-y text-sm"></div></section>
                            </div>
                        </div>
                        <div id="no-results-obat" class="text-center text-gray-500 py-12 hidden"><h3>Tidak ada hasil</h3></div>
                    </div>
                    
                    <div id="obat-summary-sidebar" class="lg:w-80 xl:w-96">
                        </div>

                </main>
            </div>

            <div id="cashier-page" class="hidden relative">
                <div class="max-w-4xl mx-auto bg-slate-50 rounded-lg p-4 sm:p-6 elegant-shadow border border-[var(--border-color)]">
                    <h2 class="text-2xl font-bold text-[var(--navy-blue)] mb-4">Rincian Tagihan (Kasir)</h2>
                    
                    <div id="cashier-summary-container">
                        </div>
                </div>
            </div>

        </div>
    </div>
    
        <div id="total-summary-container" class="p-4 bg-white">
        <div class="container mx-auto px-0 lg:px-4">
              <div class="flex justify-between items-center mb-3">
                <div>
                    <h3 class="text-lg font-bold text-gray-800">Rincian Total</h3>
                    <p class="text-sm text-gray-600">Pasien: <span id="patientNameDisplay" class="font-semibold"></span></p>
                </div>
                <button id="resetObatButton" class="text-sm font-medium text-red-600 hover:text-red-800">Reset Obat</button>
            </div>

            <div id="summary-tindakan-section" class="mb-4">
                <h4 class="text-md font-semibold mb-2">Layanan & Tindakan</h4>
                <div id="summary-tindakan-list" class="bg-gray-50 p-2 rounded-md border max-h-32 overflow-y-auto text-sm">
                    <p class="text-gray-500 italic px-2">Belum ada tindakan yang dipilih.</p>
                </div>
            </div>

            <h4 class="text-md font-semibold mb-2">Obat & Alkes</h4>
            <div class="bg-gray-50 p-2 rounded-md border max-h-40 overflow-y-auto">
                                <div class="hidden sm:grid grid-cols-5 gap-4 font-bold mb-1 px-2 text-sm">
                    <div class="col-span-2">Nama Item</div>
                    <div>Jumlah</div>
                    <div class="text-right">Harga</div>
                    <div class="text-right">Subtotal</div>
                </div>
                <div class="hidden sm:block border-t my-2"></div>
                <div id="selected-obat-list" class="text-sm">
                      <p class="text-gray-500 italic px-2">Belum ada obat/alkes yang dipilih.</p>
                </div>
            </div>
            
                          <div class="mt-4 pt-4 border-t">
                                  <div class="flex flex-col gap-2 text-sm">
                       <div class="flex justify-between">
                            <span>Total Biaya Tindakan:</span>
                            <span id="subtotalTindakanDisplay" class="font-semibold">Rp 0</span>
                       </div>
                       <div class="flex justify-between">
                            <span>Total Biaya Obat & Alkes:</span>
                            <span id="subtotalObatDisplay" class="font-semibold">Rp 0</span>
                       </div>
                                          <div class="flex justify-between text-xl font-bold border-t pt-2 mt-2">
                            <span class="text-gray-900">GRAND TOTAL:</span>
                            <span id="grandTotalDisplay" class="text-[var(--accent-color)]">Rp 0</span>
                      </div>
                  </div>
                                  <div id="summary-buttons" class="mt-4 flex flex-col md:flex-row gap-2 justify-end">
                       <button id="backToTindakanBtn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg w-full md:w-auto">&larr; Kembali ke Tindakan</button>
                       <button id="finalize-bill-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full md:w-auto btn">Selesaikan & Siap Cetak</button>
                       <button id="print-etiket-btn" class="btn btn-secondary font-bold py-2 px-4 rounded-lg w-full md:w-auto">Cetak Etiket Obat</button>
                       <button id="print-invoice" class="btn btn-primary font-bold py-2 px-4 rounded-lg w-full md:w-auto">Cetak Invoice</button>
                  </div>
              </div>
        </div>
    </div>

        <div id="chat-toggle" class="hidden fixed bottom-16 right-4 sm:bottom-11 sm:right-4 bg-[var(--accent-color)] hover:bg-[var(--accent-hover)] text-white w-14 h-14 rounded-full flex items-center justify-center cursor-pointer shadow-lg z-50 transition-transform transform hover:scale-110">
        <svg xmlns="https://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <span id="chat-notification" class="absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
    </div>

    <div id="chat-window" class="hidden fixed bottom-24 right-4 sm:bottom-20 sm:right-4 w-[90vw] max-w-sm h-[60vh] max-h-[500px] bg-white rounded-lg shadow-2xl flex flex-col z-50 border border-gray-200">
    
    <div class="flex justify-between items-center p-3 bg-slate-800 text-white rounded-t-lg">
        <h3 class="font-bold text-lg">Komunikasi</h3>
        <div class="flex items-center gap-3">
            <button id="reset-chat-btn" class="hidden text-xs bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded-md">Hapus Chat</button>
            <button id="close-chat" class="text-white hover:text-gray-300">
                <svg xmlns="https://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 flex flex-col">
    </div>

    <div class="p-3 border-t bg-white">
        <form id="chat-form" class="flex gap-2">
            <input type="text" id="chat-input" placeholder="Ketik pesan..." class="flex-1 w-full px-3 py-2 border border-[var(--border-color)] rounded-md" autocomplete="off" required>
            <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-md">Kirim</button>
        </form>
    </div>

</div>
        <div id="online-users-footer" class="hidden fixed bottom-0 left-0 w-full bg-slate-800 text-white p-2 shadow-[0_-2px_10px_rgba(0,0,0,0.2)] z-50">
        <div class="container mx-auto px-4 flex items-center justify-center sm:justify-start gap-4 text-xs sm:text-sm">
            <span class="font-bold">Online:</span>
            <div id="online-users-list" class="flex flex-wrap gap-x-4 gap-y-1">
                 <p>Memuat...</p>
            </div>
        </div>
    </div>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut,
        updateProfile,
        sendEmailVerification,
        sendPasswordResetEmail,
        setPersistence,
        browserSessionPersistence,
        browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        collection,
        doc,
        getDoc,
        getDocs,
        writeBatch,
        setDoc,
        updateDoc,
        addDoc,
        deleteDoc,
        query,
        orderBy,
        onSnapshot,
        serverTimestamp,
        limit
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, set, onDisconnect, remove, update, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";


    const { jsPDF } = window.jspdf;

    // --- DATA (Initial Seed) ---
    const initialServices = [
        { id: "S01", name: "ADMIN", price: 10000, category: "ADMINISTRATIF" },
        { id: "S02", name: "SURAT KETERANGAN SPOG", price: 20000, category: "ADMINISTRATIF" },
        { id: "S03", name: "BUKU PRENATAL CARE", price: 25000, category: "ADMINISTRATIF" },
        { id: "S04", name: "BUKU PANDUAN HAMIL & PRENATAL CARE", price: 100000, category: "ADMINISTRATIF" },
        { id: "S05", name: "REKAM JANTUNG BAYI (CTG)", price: 50000, category: "LAYANAN" },
        { id: "S06", name: "USG 2D", price: 130000, category: "LAYANAN" },
        { id: "S07", name: "USG 2D SKRINING TRIMESTER 2 (18-23 MGG)", price: 310000, category: "LAYANAN" },
        { id: "S08", name: "USG TRANSVAGINAL", price: 195000, category: "LAYANAN" },
        { id: "S09", name: "USG 4D", price: 225000, category: "LAYANAN" },
        { id: "S10", name: "USG 2D GEMELLI", price: 200000, category: "LAYANAN" },
        { id: "S11", name: "USG 4D GEMELLI", price: 400000, category: "LAYANAN" },
        { id: "S12", name: "PAPSMEAR", price: 300000, category: "LABORATORIUM" },
        { id: "S13", name: "VAGINAL TOUCHE/PERIKSA DALAM", price: 70000, category: "TINDAKAN MEDIS" },
        { id: "S14", name: "STRIPPING OF MEMBRANE", price: 70000, category: "TINDAKAN MEDIS" },
        { id: "S15", name: "HIDROTUBASI", price: 520000, category: "TINDAKAN MEDIS" },
        { id: "S16", name: "VAGINAL TOILET", price: 200000, category: "TINDAKAN MEDIS" },
        { id: "S17", name: "INSPEKULO", price: 50000, category: "TINDAKAN MEDIS" },
        { id: "S18", name: "BIOPSI", price: 700000, category: "TINDAKAN MEDIS" },
        { id: "S19", name: "RAWAT LUKA", price: 125000, category: "TINDAKAN MEDIS" },
        { id: "S20", name: "PASANG KATETER", price: 60000, category: "TINDAKAN MEDIS" },
        { id: "S21", name: "PEMBIUSAN ANESTESI", price: 125000, category: "TINDAKAN MEDIS" },
        { id: "S22", name: "INJEKSI DMPA", price: 90000, category: "KONTRASEPSI" },
        { id: "S23", name: "LEPAS IUD", price: 500000, category: "KONTRASEPSI" },
        { id: "S24", name: "PASANG IUD", price: 520000, category: "KONTRASEPSI" },
        { id: "S25", name: "LEPAS PASANG IUD", price: 1000000, category: "KONTRASEPSI" },
        { id: "S26", name: "LEPAS IMPLAN", price: 700000, category: "KONTRASEPSI" },
        { id: "S27", name: "PASANG IMPLAN", price: 700000, category: "KONTRASEPSI" },
        { id: "S28", name: "LEPAS PASANG IMPLAN", price: 1400000, category: "KONTRASEPSI" },
        { id: "S29", name: "INJEKSI VAKSIN HPV", price: 200000, category: "VAKSINASI" },
        { id: "S30", name: "PAKET LAB TRIMESTER 1", price: 225000, category: "LABORATORIUM" },
        { id: "S31", name: "PAKET LAB TRIMESTER 3", price: 70000, category: "LABORATORIUM" },
        { id: "S32", name: "CEK HEMOGLOBIN", price: 70000, category: "LABORATORIUM" },
        { id: "S33", name: "CEK GULA DARAH", price: 70000, category: "LABORATORIUM" }
    ];
    const csvObatData = `NAMA OBAT,JUMLAH,HARGA,TOTAL
Domavit,,,0;Rindocal,,,0;Rinofer chew,,,0;Folamil Genio,,,0;Folamil Gold,,,0;Gardasil,,750000,0;Aspilet,,,0;Liproqy,,10000,0;Plasminex,,4500,0;Norelut,,,0;Provagin uvula,,,0;Folimid,,4500,0;Femaplex,,,0;Amoxsan,,4500,0;Mefinal,,2000,0;Baquinor,,,0;Erysanbe,,5000,0;Farsifen,,,0;Tradosik,,,0;Nipvell Cream,,,0;Lansoprazole,,,0;Gastridin,,,0;Dopamet,,,0;Nifedipin,,,0;Uresix (furosemid),,3000,0;Noprostol ,,12000,0;Primperan,,,0;Ondansetron,,,0;Metronidazole,,,0;Nystatin,,,0;Calfemil,,,0;Dumin,,,0;Silex Sirup,,,0;Triamcinolon inj.,,,0;Dexamethason inj.,,,0;Lidocain inj.,,,0;Ceftriaxone inj.,,,0;Infus NS 100ml,,10000,0;Infus RL 500ml,,10000,0;Folley Catheter 12,,15000,0;Urine Bag,,7500,0;Kassa Roll,,2000,0;Handscoon 6,,2000,0;Handscoon 7,,2000,0;IUD (Andalan Silver Line),,100000,0;Eazy touch,,,5000;Hb Stick,,,35000;Glucose Stick,,,35000;Spuit 3 cc,,,0;Spuit 20 cc,,,0`;

    // --- STATE MANAGEMENT ---
    let allServices = [];
    let selectedServices = [];
    let selectedObat = [];
    let tindakanTotal = 0;
    let obatTotal = 0;
    let allObatItems = [];
    let allLogs = []; // Cache for logs
    let drugs = [];
    let ampuls = [];
    let consumables = [];
    let idleTimer;
    let currentUserRole = 'user'; // 'user', 'stockManager', or 'admin'
    let currentBillStatus = 'editing'; // 'editing', 'completed'
    const STOCK_MANAGERS = ['nor dwi', 'urfianita','admin','Liza'];
    let unsubscribeObat = null; 
    let unsubscribeTindakan = null;
    let unsubscribeLogs = null;
    let unsubscribeOnlineUsers = null;
    let billIsEmpty = true;
    
    
    // --- DOM ELEMENTS ---
    const loader = document.getElementById('loader');
    const authContainer = document.getElementById('auth-container');
    const mainApp = document.getElementById('main-app');
    const tindakanPage = document.getElementById('tindakan-page');
    const obatPage = document.getElementById('obat-page');
    const cashierPage = document.getElementById('cashier-page');
    const adminPage = document.getElementById('admin-page');
    const logPage = document.getElementById('log-page');
    const patientNameInput = document.getElementById('patientName');
    const statusBanner = document.getElementById('status-banner');
    const newBillBtn = document.getElementById('new-bill-btn');
    
    // Auth Elements
    const loginForm = document.getElementById('login-form');
    const passwordInput = document.getElementById('login-password');
    const passwordToggleBtn = document.getElementById('password-toggle-btn');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeSlashIcon = document.getElementById('eye-slash-icon');
    const registerForm = document.getElementById('register-form');
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const verifyEmailMessage = document.getElementById('verify-email-message');
    const unverifiedUserMessage = document.getElementById('unverified-user-message');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const backToLoginLink = document.getElementById('back-to-login');
    const authErrorEl = document.getElementById('auth-error');
    const authSuccessEl = document.getElementById('auth-success');
    const userInfoEl = document.getElementById('user-info');
    
    // Tindakan Page Elements
    const serviceListContainer = document.getElementById('serviceList');
    const tindakanSearchInput = document.getElementById('tindakanSearchInput');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const totalAmountTindakanEl = document.getElementById('totalAmountTindakan');
    const emptyStateTindakan = document.getElementById('empty-state-tindakan');
    const goToObatBtn = document.getElementById('goToObatBtn');

    // Obat Page Elements
    const drugsContainer = document.getElementById('drugs-container');
    const ampulsContainer = document.getElementById('ampuls-container');
    const consumablesContainer = document.getElementById('consumables-container');
    const obatSearchInput = document.getElementById('obatSearchInput');
    const noResultsObatDiv = document.getElementById('no-results-obat');
    
    // Summary Elements (Movable Container and its placeholders)
    const totalSummaryContainer = document.getElementById('total-summary-container');
    const obatSummarySidebar = document.getElementById('obat-summary-sidebar');
    const cashierSummaryContainer = document.getElementById('cashier-summary-container');

    const selectedObatListDiv = document.getElementById('selected-obat-list');
    const summaryTindakanListDiv = document.getElementById('summary-tindakan-list');

    const backToTindakanBtn = document.getElementById('backToTindakanBtn');
    const printInvoiceBtn = document.getElementById('print-invoice');
    const printEtiketBtn = document.getElementById('print-etiket-btn');
    const finalizeBillBtn = document.getElementById('finalize-bill-btn');
    const resetObatButton = document.getElementById('resetObatButton');

    // Admin Page Elements
    const adminWelcomeName = document.getElementById('admin-welcome-name');
    const adminTindakanSection = document.getElementById('admin-tindakan-section');
    const adminObatListContainer = document.getElementById('admin-obat-list');
    const saveObatChangesBtn = document.getElementById('saveObatChangesBtn');
    const addObatBtn = document.getElementById('addObatBtn');
    const adminTindakanListContainer = document.getElementById('admin-tindakan-list');
    const saveTindakanChangesBtn = document.getElementById('saveTindakanChangesBtn');
    const addTindakanBtn = document.getElementById('addTindakanBtn');

    // Log Page Elements
    const logListContainer = document.getElementById('log-list-container');
    const backFromLogBtn = document.getElementById('backFromLogBtn');
    
    // Summary Display Elements
    const patientNameDisplay = document.getElementById('patientNameDisplay');
    const subtotalTindakanDisplay = document.getElementById('subtotalTindakanDisplay');
    const subtotalObatDisplay = document.getElementById('subtotalObatDisplay');
    const grandTotalDisplay = document.getElementById('grandTotalDisplay');

    const onlineUsersFooter = document.getElementById('online-users-footer');

    // Audio Elements
    const chatSendSound = document.getElementById('chat-send-sound');
    const chatIncomingSound = document.getElementById('chat-incoming-sound');

    // --- FIREBASE SETUP ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config)
        : {
            apiKey: "AIzaSyA7lWAOBUI0X2l0PCtB6_EUlmX6sNQhgvg",
            authDomain: "klinikprivatedrdibya.firebaseapp.com",
            databaseURL: "https://klinikprivatedrdibya-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "klinikprivatedrdibya",
            storageBucket: "klinikprivatedrdibya.appspot.com",
            messagingSenderId: "943850005223",
            appId: "1:943850005223:web:8ae5d5e2f63c298eb7b842"
        };
        
    const app = initializeApp(firebaseConfig);
    // CRITICAL FIX: Re-instated initialization lines
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const currentBillRef = ref(rtdb,'/currentBill');
    
    // --- UI HELPER FUNCTIONS (Loader, Toast, Modal) ---
    const showLoader = () => loader.classList.remove('hidden');
    const hideLoader = () => loader.classList.add('hidden');

    function showToast(message, type = 'success', duration = 3000) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10); // Trigger transition
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    }

    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitleEl = document.getElementById('modal-title');
    const modalMessageEl = document.getElementById('modal-message');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    function showModal({ title, message, confirmText = 'Konfirmasi', cancelText = 'Batal', onConfirm, onCancel, confirmClass = 'btn-danger' }) {
        modalTitleEl.textContent = title;
        modalMessageEl.textContent = message;
        modalConfirmBtn.textContent = confirmText;
        modalCancelBtn.textContent = cancelText;

        modalConfirmBtn.className = `btn ${confirmClass} py-2 px-4 rounded-lg`;

        modalConfirmBtn.onclick = () => {
            if (onConfirm) onConfirm();
            hideModal();
        };
        modalCancelBtn.onclick = () => {
            if (onCancel) onCancel();
            hideModal();
        };

        modalOverlay.classList.remove('hidden');
    }

    function hideModal() {
        modalOverlay.classList.add('hidden');
    }


    // --- HELPER & LOGGING FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    const formatCurrencyNoName = (number) => (isNaN(number) || number === 0) ? '0' : new Intl.NumberFormat('id-ID').format(number);
    const toTitleCase = (str) => !str ? '' : str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    const clearAuthMessages = () => { authErrorEl.textContent = ''; authSuccessEl.textContent = ''; };

    // --- DATETIME CLOCK ---
    function updateDateTime() {
        const dateDisplay = document.getElementById('date-display');
        const timeDisplay = document.getElementById('time-display');
        
        if (!dateDisplay || !timeDisplay) return;

        const now = new Date();
        
        const dateOptions = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            timeZone: 'Asia/Jakarta'
        };
        
        const timeOptions = {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZone: 'Asia/Jakarta',
            hour12: false
        };

        dateDisplay.textContent = now.toLocaleDateString('id-ID', dateOptions);
        timeDisplay.textContent = `${now.toLocaleTimeString('id-ID', timeOptions)} WIB`;
    }

    let clockInterval = null;
    function startClock() {
        if (clockInterval) clearInterval(clockInterval); 
        updateDateTime(); 
        clockInterval = setInterval(updateDateTime, 1000);
    }
    
    function stopClock() {
        if (clockInterval) clearInterval(clockInterval);
        clockInterval = null;
    }

    async function addLog(action, details = {}) {
        const user = auth.currentUser;
        if (!user) return; 

        try {
            const logCollection = collection(db, 'clinic/data/logs');
            await addDoc(logCollection, {
                timestamp: serverTimestamp(),
                user: user.displayName || user.email,
                action,
                details
            });
        } catch (error) {
            console.error("Error writing to log:", error);
        }
    }

    // Modified to allow Cashier reset if finalized
    async function confirmAndResetBill() {
        // Check permissions
        if (currentUserRole !== 'admin' && currentBillStatus !== 'completed') {
            showToast("Hanya Admin yang dapat mereset tagihan yang sedang diedit.", "error");
            return;
        }

        // If admin is resetting an active bill, prompt for confirmation.
        if (currentUserRole === 'admin' && currentBillStatus === 'editing' && !billIsEmpty) {
            showModal({
                title: 'Reset Tagihan?',
                message: 'Tagihan saat ini belum selesai. Anda yakin ingin membuang perubahan dan memulai tagihan baru?',
                confirmText: 'Ya, Reset',
                onConfirm: executeResetBill
            });
        } else {
            // If bill is empty or already completed (for cashier), reset immediately.
            executeResetBill();
        }
    }

    async function executeResetBill() {
        await set(currentBillRef, {
            patientName: '',
            selectedServices: {},
            selectedObat: {},
            status: 'editing',
            lastUpdatedBy: auth.currentUser ? auth.currentUser.displayName : 'Unknown'
        });
        // Navigation happens automatically via the RTDB listener when the reset is detected.
        showToast("Tagihan baru telah dibuat.", "info");
    }

    // --- IDLE TIMEOUT & SESSION LOGIC ---
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
            showModal({
                title: 'Sesi Berakhir',
                message: 'Sesi Anda telah berakhir karena tidak aktif. Anda akan di-logout.',
                confirmText: 'OK',
                onConfirm: () => signOut(auth)
            });
        }, 30 * 60 * 1000); // 30 minutes
    }

    function setupIdleTimer() {
        resetIdleTimer();
        window.addEventListener('mousemove', resetIdleTimer);
        window.addEventListener('mousedown', resetIdleTimer);
        window.addEventListener('keypress', resetIdleTimer);
        window.addEventListener('scroll', resetIdleTimer);
        window.addEventListener('touchstart', resetIdleTimer);
    }

    // --- UI MODE & PERMISSIONS ---
    function applyUIPermissions(role, status) {
        const isAdmin = role === 'admin';
        const isEditing = status === 'editing';

        // --- Admin Specific Controls (Tindakan/Obat Pages) ---
        
        // Show finalize button only for admin when editing
        finalizeBillBtn.classList.toggle('hidden', !isAdmin || !isEditing);
        
        // Disable editing inputs if: Not admin OR (Admin AND finalized)
        const isReadOnly = !isAdmin || (isAdmin && !isEditing);

        patientNameInput.disabled = isReadOnly;
        tindakanSearchInput.disabled = isReadOnly;
        serviceListContainer.classList.toggle('read-only-mode', isReadOnly);
        newBillBtn.disabled = !isAdmin; // Only admin can use the New Bill button on Tindakan Page
        obatSearchInput.disabled = isReadOnly;
        drugsContainer.classList.toggle('read-only-mode', isReadOnly);
        ampulsContainer.classList.toggle('read-only-mode', isReadOnly);
        consumablesContainer.classList.toggle('read-only-mode', isReadOnly);
        
        // Admin navigation buttons
        goToObatBtn.disabled = (isAdmin && !isEditing); // Admin can't proceed if finalized


        // --- Shared Summary Controls (Used in Admin Sidebar & Cashier View) ---

        // Disable inputs in the summary (Quantity, Cara Pakai) if read-only
        const summaryInputs = totalSummaryContainer.querySelectorAll('input');
        summaryInputs.forEach(input => input.disabled = isReadOnly);

        // Control print buttons visibility and state. Can print if finalized (regardless of role)
        const canPrint = !isEditing;
        printInvoiceBtn.disabled = !canPrint;
        printEtiketBtn.disabled = !canPrint;
        
        // Show status banner (Visible on all pages, but content depends on role/status)
        if (!isAdmin) {
            // Non-Admin view adjustments
            statusBanner.classList.remove('hidden');
            if (isEditing) {
                statusBanner.textContent = 'dr. Dibya sedang menyiapkan tagihan. Mohon tunggu...';
                statusBanner.className = 'text-center font-semibold p-3 rounded-lg mb-6 text-white bg-orange-500';
            } else {
                statusBanner.textContent = 'Tagihan siap untuk dicetak.';
                statusBanner.className = 'text-center font-semibold p-3 rounded-lg mb-6 text-white bg-green-500';
            }
            // Hide Admin-only buttons in the shared summary view
            backToTindakanBtn.classList.add('hidden');
            resetObatButton.classList.add('hidden');

        } else {
            // Admin view adjustments
            statusBanner.classList.add('hidden');
            // Show Admin-only buttons in the shared summary view
            backToTindakanBtn.classList.remove('hidden');
            resetObatButton.classList.remove('hidden');
            backToTindakanBtn.disabled = isReadOnly;
            resetObatButton.disabled = isReadOnly;
        }
    }


    // --- PAGE SWITCHING LOGIC ---
    function setupCurrentBillListener() {
        onValue(currentBillRef, (snapshot) => {
            const billData = snapshot.val() || { patientName: '', selectedServices: {}, selectedObat: {}, status: 'editing' };
            
            const serviceIds = billData.selectedServices ? Object.keys(billData.selectedServices) : [];
            const obatIds = billData.selectedObat ? Object.keys(billData.selectedObat) : [];
            const newBillIsEmpty = !billData.patientName && serviceIds.length === 0 && obatIds.length === 0;

            // Handle bill reset detection
            if (!billIsEmpty && newBillIsEmpty) {
                console.log("Bill reset detected. Navigating users to the appropriate start page.");
                if (currentUserRole === 'admin') {
                   showTindakanPage();
                } else {
                    showCashierPage();
                }
            }
            
            billIsEmpty = newBillIsEmpty;
            currentBillStatus = billData.status || 'editing';

            // Update Patient Name Input (Admin)
            if (document.activeElement !== patientNameInput) {
                patientNameInput.value = billData.patientName || '';
            }
            // Update Patient Name Display (Shared Summary)
            patientNameDisplay.textContent = billData.patientName || 'Tidak Ada Nama';

            // Update State
            selectedServices = allServices.filter(service => serviceIds.includes(service.id));

            const obatData = billData.selectedObat || {};
            const obatIdsFromData = Object.keys(obatData);
            selectedObat = allObatItems
                .filter(obat => obatIdsFromData.includes(obat.id))
                .map(obat => ({
                    ...obat,
                    quantity: obatData[obat.id]?.quantity || 0, // Default to 0 if missing
                    caraPakai: obatData[obat.id]?.caraPakai || ''
                }));

            // Re-render active Admin pages
            if (!tindakanPage.classList.contains('hidden')) {
                renderServiceList(tindakanSearchInput.value);
                updateTindakanBill();
            }
            if (!obatPage.classList.contains('hidden')) {
                renderAllObatItems();
            }

            // Update the shared summary view (crucial for Cashier Page and Admin Obat Page)
            updateSharedSummaryView();
            
            // Apply permissions based on new state
            applyUIPermissions(currentUserRole, currentBillStatus);
        });
    }

    // Reset styles related to the summary container layout
    function resetPageStyles() {
        // Ensure the container is detached and reset styles
        totalSummaryContainer.classList.remove('summary-sidebar', 'elegant-shadow', 'rounded-lg');
        document.body.style.paddingBottom = '50px'; 
    }
    
    function showAdminPage() {
        tindakanPage.classList.add('hidden');
        obatPage.classList.add('hidden');
        cashierPage.classList.add('hidden');
        adminPage.classList.remove('hidden');
        logPage.classList.add('hidden');
        resetPageStyles();
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Permissions check for Stock Manager
        if (currentUserRole === 'stockManager') {
            adminTindakanSection.classList.add('hidden');
            addObatBtn.classList.add('hidden'); // Cannot add new items
            saveTindakanChangesBtn.classList.add('hidden');
            addTindakanBtn.classList.add('hidden');
        } else if (currentUserRole === 'admin') { 
            adminTindakanSection.classList.remove('hidden');
            addObatBtn.classList.remove('hidden');
            saveTindakanChangesBtn.classList.remove('hidden');
            addTindakanBtn.classList.remove('hidden');
            renderAdminTindakanList();
        } else {
            // Users should not access this page.
            showCashierPage();
            return;
        }
        renderAdminObatList();
    }
    
    function showLogPage() {
        if (currentUserRole !== 'admin') {
            showToast('Anda tidak memiliki akses ke halaman ini.', 'error');
            showCashierPage(); // Redirect non-admins
            return;
        }
        tindakanPage.classList.add('hidden');
        obatPage.classList.add('hidden');
        cashierPage.classList.add('hidden');
        adminPage.classList.add('hidden');
        logPage.classList.remove('hidden');
        resetPageStyles();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        renderLogs(allLogs); // Render immediately using cache
    }
    
    // Only for Admin
    function showTindakanPage() {
        if (currentUserRole !== 'admin') {
            showCashierPage();
            return;
        }
        tindakanPage.classList.remove('hidden');
        obatPage.classList.add('hidden');
        cashierPage.classList.add('hidden');
        adminPage.classList.add('hidden');
        logPage.classList.add('hidden');
        resetPageStyles();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        renderServiceList(tindakanSearchInput.value); 
        updateTindakanBill();
    }

    // Only for Admin, handles layout change
    function showObatPage() {
        if (currentUserRole !== 'admin') {
            showCashierPage();
            return;
        }

        if (!patientNameInput.value.trim()) {
            showToast('Harap isi nama pasien terlebih dahulu.', 'error');
            patientNameInput.focus();
            showTindakanPage();
            return;
        }
        window.scrollTo(0, 0);
        tindakanPage.classList.add('hidden');
        obatPage.classList.remove('hidden');
        cashierPage.classList.add('hidden');
        adminPage.classList.add('hidden');
        logPage.classList.add('hidden');
        
        // --- Layout Management ---
        resetPageStyles();

        // Move the summary container into the sidebar
        obatSummarySidebar.appendChild(totalSummaryContainer);
        // Apply sidebar styling
        totalSummaryContainer.classList.add('summary-sidebar', 'elegant-shadow', 'rounded-lg');


        patientNameDisplay.textContent = patientNameInput.value;
        subtotalTindakanDisplay.textContent = formatCurrency(tindakanTotal);
        updateAllTotals();
        renderAllObatItems();
        updateSharedSummaryView(); // Ensure everything in the summary is current
    }

    // New function for Cashier/Stock Manager view
    function showCashierPage() {
        tindakanPage.classList.add('hidden');
        obatPage.classList.add('hidden');
        cashierPage.classList.remove('hidden');
        adminPage.classList.add('hidden');
        logPage.classList.add('hidden');
        resetPageStyles();
        window.scrollTo(0, 0);

        // Move the summary container into the cashier page container
        cashierSummaryContainer.appendChild(totalSummaryContainer);

        // Ensure the summary is up-to-date
        updateSharedSummaryView();
        applyUIPermissions(currentUserRole, currentBillStatus);
    }
    
    // --- FIRESTORE & DATA LOGIC ---
    async function initializeFirestoreData() {
        const batch = writeBatch(db);

        // Initialize Obat Data
        const obatCollectionRef = collection(db, 'clinic/data/obat');
        // Check if collection exists and has documents by trying to fetch 1 document.
        const obatQuerySnapshot = await getDocs(query(obatCollectionRef, limit(1)));

        if (obatQuerySnapshot.empty) {
            console.log("Seeding initial OBAT data to shared collection...");
            // Handle the CSV parsing correctly
            const seedObatData = csvObatData.trim().split('\n').slice(1).join(';').split(';').map((row, index) => {
                const columns = row.split(',');
                return { 
                    name: toTitleCase(columns[0].trim()), 
                    price: columns[2] ? parseInt(columns[2], 10) : 0,
                    stock: 0,
                    category: index < 38 ? 'drugs' : (index < 44 ? 'ampuls' : 'consumables'),
                    caraPakai: ''
                };
            });
            seedObatData.forEach(item => {
                const itemRef = doc(obatCollectionRef);
                batch.set(itemRef, item);
            });
        }

        // Initialize Tindakan Data
        const tindakanCollectionRef = collection(db, 'clinic/data/tindakan');
        const tindakanQuerySnapshot = await getDocs(query(tindakanCollectionRef, limit(1)));

        if (tindakanQuerySnapshot.empty){
            console.log("Seeding initial TINDAKAN data to shared collection...");
            initialServices.forEach(item => {
                const itemRef = doc(tindakanCollectionRef);
                batch.set(itemRef, item);
            });
        }
        
        await batch.commit();
    }

    function setupRealtimeListeners() {
        if (unsubscribeObat) unsubscribeObat();
        if (unsubscribeTindakan) unsubscribeTindakan();
        if (unsubscribeLogs) unsubscribeLogs();
        if (unsubscribeOnlineUsers) unsubscribeOnlineUsers();

        showLoader();
        const obatQuery = query(collection(db, 'clinic/data/obat'), orderBy("name"));
        unsubscribeObat = onSnapshot(obatQuery, (snapshot) => {
            allObatItems = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
            drugs = allObatItems.filter(i => i.category === 'drugs');
            ampuls = allObatItems.filter(i => i.category === 'ampuls');
            consumables = allObatItems.filter(i => i.category === 'consumables');
            if (!adminPage.classList.contains('hidden')) renderAdminObatList();
            hideLoader();
        }, (error) => {
            console.error("Error fetching obat data:", error);
            showToast("Gagal memuat data obat.", "error");
            hideLoader();
        });

        const tindakanQuery = query(collection(db, 'clinic/data/tindakan'), orderBy("name"));
        unsubscribeTindakan = onSnapshot(tindakanQuery, (snapshot) => {
            allServices = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if (!adminPage.classList.contains('hidden')) renderAdminTindakanList();
        }, (error) => {
            console.error("Error fetching tindakan data:", error);
            showToast("Gagal memuat data tindakan.", "error");
        });

        // Modified Logs Listener
        const logsQuery = query(collection(db, 'clinic/data/logs'), orderBy("timestamp", "desc"), limit(100));
        unsubscribeLogs = onSnapshot(logsQuery, (snapshot) => {
            // Update the cache
            allLogs = snapshot.docs;
            // Render if the page is visible
             if (!logPage.classList.contains('hidden')) renderLogs(allLogs);
        }, (error) => {
            console.error("Error fetching logs:", error);
            if (!logPage.classList.contains('hidden')) {
                logListContainer.innerHTML = '<p class="text-red-500">Gagal memuat log.</p>';
            }
        });

        const statusRef = ref(rtdb, '/status');
        unsubscribeOnlineUsers = onValue(statusRef, (snapshot) => {
            const statuses = snapshot.val() || {};
            const onlineUsers = Object.values(statuses).filter(status => status.isOnline);
            renderOnlineUsers(onlineUsers);
        });
    }

    // --- LOG PAGE & ONLINE USERS LOGIC ---
    function renderLogs(logDocs) {
        logListContainer.innerHTML = '';
        if (!logDocs || logDocs.length === 0) {
            logListContainer.innerHTML = '<p>Tidak ada aktivitas yang tercatat.</p>';
            return;
        }
        logDocs.forEach(doc => {
            const log = doc.data();
            const logDiv = document.createElement('div');
            logDiv.className = 'p-3 bg-white rounded-md border border-gray-200';
            const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : 'No date';
            let detailsHTML = '';
            if (log.action === 'Stock Update') {
                detailsHTML = `<span class="font-medium">${log.details.itemName}</span> diubah dari <span class="font-semibold">${log.details.from}</span> menjadi <span class="font-semibold text-blue-600">${log.details.to}</span>.`;
            } else if (log.action === 'Invoice Created') {
                 detailsHTML = `Invoice dibuat untuk pasien: <span class="font-medium">${log.details.patientName}</span>.`;
            } else if (log.action === 'User Login') {
                 detailsHTML = `User berhasil login.`;
            } else {
                 detailsHTML = JSON.stringify(log.details);
            }
            logDiv.innerHTML = `<div class="flex justify-between items-start text-sm"><div><p class="font-bold text-gray-800">${log.user}</p><p class="text-gray-600">${detailsHTML}</p></div><p class="text-xs text-gray-500 whitespace-nowrap pl-4">${timestamp}</p></div>`;
            logListContainer.appendChild(logDiv);
        });
    }

    function renderOnlineUsers(users) {
        const onlineUsersList = document.getElementById('online-users-list');
        onlineUsersList.innerHTML = '';
        if (users.length === 0) {
            onlineUsersList.innerHTML = '<p class="text-gray-300">Tidak ada pengguna online.</p>';
            return;
        }
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `<span class="h-2 w-2 bg-green-400 rounded-full mr-2"></span><span>${user.displayName}</span>`;
            onlineUsersList.appendChild(div);
        });
    }

    // --- ADMIN PAGE LOGIC ---
    function renderAdminObatList() {
        adminObatListContainer.innerHTML = '';
        if (allObatItems.length === 0) {
            adminObatListContainer.innerHTML = '<p>Memuat data...</p>';
            return;
        }
        const isStockManager = currentUserRole === 'stockManager';
        const readOnlyAttr = isStockManager ? 'disabled' : '';

        allObatItems.forEach(item => {
            const itemRow = document.createElement('div');
            itemRow.className = 'flex flex-col md:grid md:grid-cols-12 gap-2 items-center p-3 md:p-2 border rounded-lg md:border-b md:rounded-none';
            itemRow.dataset.id = item.id;
            
            const deleteButtonHTML = isStockManager 
                ? `` 
                : `<button class="w-full md:w-auto md:col-span-1 btn-danger rounded h-8 mt-2 md:mt-0 md:h-6 md:w-6 flex items-center justify-center text-xs font-bold delete-obat-btn" data-id="${item.id}">&times;</button>`;
            
            itemRow.innerHTML = `
                <div class="w-full md:col-span-5">
                    <label class="text-xs text-gray-500 md:hidden">Nama Item</label>
                    <input type="text" placeholder="Nama Obat/Alkes" class="w-full admin-input admin-input-name border rounded px-2 py-1 text-sm" value="${item.name}" ${readOnlyAttr}>
                </div>
                <div class="w-full md:col-span-2">
                    <label class="text-xs text-gray-500 md:hidden">Harga</label>
                    <input type="number" placeholder="Harga" class="w-full admin-input admin-input-price border rounded px-2 py-1 text-sm" value="${item.price}" ${readOnlyAttr}>
                </div>
                <div class="w-full md:col-span-2">
                    <label class="text-xs text-gray-500 md:hidden">Stok</label>
                    <input type="number" placeholder="Stok" class="w-full admin-input admin-input-stock border rounded px-2 py-1 text-sm" value="${item.stock || 0}">
                </div>
                <div class="w-full md:col-span-2">
                    <label class="text-xs text-gray-500 md:hidden">Kategori</label>
                    <select class="w-full admin-select admin-select-category border rounded px-2 py-1 text-sm" ${readOnlyAttr}>
                        <option value="drugs" ${item.category === 'drugs' ? 'selected' : ''}>Obat</option>
                        <option value="ampuls" ${item.category === 'ampuls' ? 'selected' : ''}>Ampul/Vial</option>
                        <option value="consumables" ${item.category === 'consumables' ? 'selected' : ''}>Alkes</option>
                    </select>
                </div>
                ${deleteButtonHTML}
            `;
            adminObatListContainer.appendChild(itemRow);
        });
    }
    
    function addObatRow() {
        if (currentUserRole !== 'admin') return;
        const itemRow = document.createElement('div');
        itemRow.className = 'flex flex-col md:grid md:grid-cols-12 gap-2 items-center p-3 md:p-2 border rounded-lg md:border-b md:rounded-none bg-blue-50';
        itemRow.innerHTML = `
            <div class="w-full md:col-span-5">
                <input type="text" placeholder="Nama Obat/Alkes Baru" class="w-full admin-input admin-input-name border rounded px-2 py-1 text-sm" value="">
            </div>
            <div class="w-full md:col-span-2">
                <input type="number" placeholder="0" class="w-full admin-input admin-input-price border rounded px-2 py-1 text-sm" value="">
            </div>
            <div class="w-full md:col-span-2">
                <input type="number" placeholder="0" class="w-full admin-input admin-input-stock border rounded px-2 py-1 text-sm" value="0">
            </div>
            <div class="w-full md:col-span-2">
                <select class="w-full admin-select admin-select-category border rounded px-2 py-1 text-sm">
                    <option value="drugs" selected>Obat</option>
                    <option value="ampuls">Ampul/Vial</option>
                    <option value="consumables">Alkes</option>
                </select>
            </div>
            <button class="w-full md:w-auto md:col-span-1 btn-danger rounded h-8 mt-2 md:mt-0 md:h-6 md:w-6 flex items-center justify-center text-xs font-bold delete-obat-btn">&times;</button>
        `;
        adminObatListContainer.appendChild(itemRow);
        itemRow.querySelector('input[type="text"]').focus();
    }

    async function saveObatChanges() {
        showLoader();
        const batch = writeBatch(db);
        // Select existing rows (have data-id) or new rows (have bg-blue-50 class)
        const rows = adminObatListContainer.querySelectorAll('div[data-id], .bg-blue-50');
        let hasError = false;
        const originalItemsMap = new Map(allObatItems.map(item => [item.id, item]));
        
        rows.forEach(row => {
            const id = row.dataset.id;
            const nameInput = row.querySelector('.admin-input-name');
            const priceInput = row.querySelector('.admin-input-price');
            const stockInput = row.querySelector('.admin-input-stock');
            const categorySelect = row.querySelector('.admin-select-category');

            let dataToUpdate;
            const stock = parseInt(stockInput.value, 10);
            
            if (currentUserRole === 'admin') {
                const name = nameInput.value.trim();
                const price = parseInt(priceInput.value, 10);
                const category = categorySelect.value;
                if (!name || isNaN(price) || isNaN(stock)) { hasError = true; return; }
                dataToUpdate = { name, price, stock, category };
                // Preserve caraPakai for existing drugs
                if (id) {
                    const originalItem = originalItemsMap.get(id);
                    if (category === 'drugs' && originalItem) dataToUpdate.caraPakai = originalItem.caraPakai || '';
                } else {
                    if (category === 'drugs') dataToUpdate.caraPakai = '';
                }
            } 
            else { // Stock Manager can only update stock
                if (isNaN(stock)) { hasError = true; return; }
                dataToUpdate = { stock };
            }
            
            // Logging stock changes
            if (id) {
                const originalItem = originalItemsMap.get(id);
                const originalStock = originalItem ? (originalItem.stock || 0) : 0;
                if (originalStock !== stock) {
                    addLog('Stock Update', { itemName: originalItem.name, from: originalStock, to: stock });
                }
            }

            // Prepare batch update
            if (id) {
                const docRef = doc(db, 'clinic/data/obat', id);
                if (currentUserRole === 'admin') batch.set(docRef, dataToUpdate, { merge: true });
                else batch.update(docRef, dataToUpdate);
            } else if (currentUserRole === 'admin') {
                const newDocRef = doc(collection(db, 'clinic/data/obat'));
                batch.set(newDocRef, dataToUpdate);
            }
        });

        if (hasError) {
            showToast("Data tidak valid. Periksa kembali input Anda.", "error");
            hideLoader();
            return;
        }

        try {
            await batch.commit();
            showToast('Perubahan stok & obat berhasil disimpan!', 'success');
        } catch (error) {
            console.error("Error saving obat changes: ", error);
            showToast('Gagal menyimpan perubahan.', 'error');
        } finally {
            hideLoader();
        }
    }
    
    function handleDeleteObat(e) {
        if (currentUserRole !== 'admin') return;
        if (!e.target.classList.contains('delete-obat-btn')) return;
        const row = e.target.closest('.flex.flex-col, .grid');
        const id = e.target.dataset.id;
        const name = row.querySelector('.admin-input-name')?.value || 'Item baru';
        
        showModal({
            title: 'Hapus Item?',
            message: `Anda yakin ingin menghapus "${name}"? Aksi ini tidak dapat dibatalkan.`,
            onConfirm: async () => {
                if (id) {
                    try { 
                        await deleteDoc(doc(db, 'clinic/data/obat', id)); 
                        showToast(`"${name}" berhasil dihapus.`, 'success');
                    }
                    catch (error) { 
                        console.error("Error deleting document: ", error); 
                        showToast(`Gagal menghapus "${name}".`, 'error');
                    }
                } else { 
                    row.remove(); 
                    showToast('Item baru dibatalkan.', 'info');
                }
            }
        });
    }

    function renderAdminTindakanList() {
        if (currentUserRole !== 'admin') return;
        adminTindakanListContainer.innerHTML = '';
        if (allServices.length === 0) {
            adminTindakanListContainer.innerHTML = '<p>Belum ada data tindakan...</p>';
            return;
        }
        const categories = [...new Set(allServices.map(s => s.category).concat(initialServices.map(s => s.category)))];
        allServices.forEach(item => {
            const itemRow = document.createElement('div');
            itemRow.className = 'flex flex-col md:grid md:grid-cols-12 gap-2 items-center p-3 md:p-2 border rounded-lg md:border-b md:rounded-none';
            itemRow.dataset.id = item.id;
            const categoryOptions = categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
            itemRow.innerHTML = `
                <div class="w-full md:col-span-5">
                    <label class="text-xs text-gray-500 md:hidden">Nama Layanan</label>
                    <input type="text" placeholder="Nama Layanan" class="w-full admin-input border rounded px-2 py-1 text-sm" value="${item.name}">
                </div>
                <div class="w-full md:col-span-3">
                    <label class="text-xs text-gray-500 md:hidden">Harga</label>
                    <input type="number" placeholder="Harga" class="w-full admin-input border rounded px-2 py-1 text-sm" value="${item.price}">
                </div>
                <div class="w-full md:col-span-3">
                    <label class="text-xs text-gray-500 md:hidden">Kategori</label>
                    <select class="w-full admin-select border rounded px-2 py-1 text-sm">${categoryOptions}</select>
                </div>
                <button class="w-full md:w-auto md:col-span-1 btn-danger rounded h-8 mt-2 md:mt-0 md:h-6 md:w-6 flex items-center justify-center text-xs font-bold delete-tindakan-btn" data-id="${item.id}">&times;</button>
            `;
            adminTindakanListContainer.appendChild(itemRow);
        });
    }

    function addTindakanRow() {
        if (currentUserRole !== 'admin') return;
        const itemRow = document.createElement('div');
        itemRow.className = 'flex flex-col md:grid md:grid-cols-12 gap-2 items-center p-3 md:p-2 border rounded-lg md:border-b md:rounded-none bg-blue-50';
        const categories = [...new Set(allServices.map(s => s.category).concat(initialServices.map(s => s.category)))];
        const categoryOptions = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        itemRow.innerHTML = `
            <div class="w-full md:col-span-5">
                <input type="text" placeholder="Nama Layanan Baru" class="w-full admin-input border rounded px-2 py-1 text-sm" value="">
            </div>
            <div class="w-full md:col-span-3">
                <input type="number" placeholder="0" class="w-full admin-input border rounded px-2 py-1 text-sm" value="">
            </div>
            <div class="w-full md:col-span-3">
                <select class="w-full admin-select border rounded px-2 py-1 text-sm">${categoryOptions}</select>
            </div>
            <button class="w-full md:w-auto md:col-span-1 btn-danger rounded h-8 mt-2 md:mt-0 md:h-6 md:w-6 flex items-center justify-center text-xs font-bold delete-tindakan-btn">&times;</button>
        `;
        adminTindakanListContainer.appendChild(itemRow);
        itemRow.querySelector('input[type="text"]').focus();
    }
    
    async function saveTindakanChanges() {
        if (currentUserRole !== 'admin') return;
        showLoader();
        const batch = writeBatch(db);
        // Select existing rows (have data-id) or new rows (have bg-blue-50 class)
        const rows = adminTindakanListContainer.querySelectorAll('div[data-id], .bg-blue-50');
        let hasError = false;
        rows.forEach(row => {
            const id = row.dataset.id;
            const name = row.querySelector('input[type="text"]').value.trim();
            const price = parseInt(row.querySelector('input[type="number"]').value, 10);
            const category = row.querySelector('select').value;
            if (!name || isNaN(price)) { hasError = true; return; }
            const data = { name, price, category };
            if (id) {
                const docRef = doc(db, 'clinic/data/tindakan', id);
                batch.update(docRef, data);
            } else {
                const newDocRef = doc(collection(db, 'clinic/data/tindakan'));
                batch.set(newDocRef, data);
            }
        });
        if (hasError) {
            showToast("Data tidak valid.", "error");
            hideLoader();
            return;
        }
        try {
            await batch.commit();
            showToast("Perubahan layanan berhasil disimpan!", "success");
        } catch (error) {
            console.error("Error saving tindakan: ", error);
            showToast("Gagal menyimpan perubahan.", "error");
        } finally {
            hideLoader();
        }
    }

    function handleDeleteTindakan(e) {
        if (currentUserRole !== 'admin') return;
        if (!e.target.classList.contains('delete-tindakan-btn')) return;
        const row = e.target.closest('.flex.flex-col, .grid');
        const id = e.target.dataset.id;
        const name = row.querySelector('input[type="text"]')?.value || 'Layanan Baru';

        showModal({
            title: 'Hapus Layanan?',
            message: `Anda yakin ingin menghapus "${name}"?`,
            onConfirm: async () => {
                 if (id) {
                    try { 
                        await deleteDoc(doc(db, 'clinic/data/tindakan', id)); 
                        showToast(`"${name}" berhasil dihapus.`, 'success');
                    }
                    catch (error) { 
                        console.error("Error deleting document: ", error); 
                        showToast(`Gagal menghapus "${name}".`, 'error');
                    }
                } else { 
                    row.remove(); 
                    showToast('Layanan baru dibatalkan.', 'info');
                }
            }
        });
    }


    // --- TINDAKAN PAGE LOGIC (Admin Only) ---
    function renderServiceList(filter = '') {
        serviceListContainer.innerHTML = '';
        if (allServices.length === 0) {
            serviceListContainer.innerHTML = `<p class="text-gray-500">Memuat layanan...</p>`;
            return;
        }
        const filteredServices = allServices.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
        const categories = [...new Set(allServices.map(s => s.category))];
        categories.sort().forEach(category => {
            const servicesInCategory = filteredServices.filter(s => s.category === category);
            if (servicesInCategory.length > 0) {
                const header = document.createElement('h3');
                header.className = 'text-md font-semibold text-[var(--secondary-text)] mt-4 mb-2 sticky top-0 bg-white/80 backdrop-blur-sm py-1';
                header.textContent = category;
                serviceListContainer.appendChild(header);
                servicesInCategory.forEach(service => {
                    const isSelected = selectedServices.some(s => s.id === service.id);
                    const div = document.createElement('div');
                    div.className = `service-item flex justify-between items-center p-3 rounded-lg cursor-pointer ${isSelected ? 'bg-[var(--light-blue-bg)] font-semibold' : ''}`;
                    div.innerHTML = `<span>${service.name}</span> <span class="text-sm">${formatCurrency(service.price)}</span>`;
                    div.onclick = () => toggleService(service);
                    serviceListContainer.appendChild(div);
                });
            }
        });
    }

    function updateTindakanBill() {
        selectedServicesList.innerHTML = '';
        tindakanTotal = 0;
        if (selectedServices.length === 0) {
            selectedServicesList.innerHTML = `<li id="empty-state-tindakan" class="text-center text-[var(--secondary-text)] py-10">Pilih layanan di sebelah kiri.</li>`;
        } else {
            selectedServices.forEach(service => {
                tindakanTotal += service.price;
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm';
                li.innerHTML = `<span>${service.name}</span><div class="flex items-center"><span>${formatCurrency(service.price)}</span><button class="btn-danger text-xs w-6 h-6 rounded-full flex items-center justify-center ml-4">&times;</button></div>`;
                li.querySelector('button').onclick = () => toggleService(service);
                selectedServicesList.appendChild(li);
            });
        }
        totalAmountTindakanEl.textContent = formatCurrency(tindakanTotal);
    }

    async function toggleService(service) {
        if (currentUserRole !== 'admin') return;
        const index = selectedServices.findIndex(s => s.id === service.id);
        if (index > -1) {
            selectedServices.splice(index, 1);
        } else {
            selectedServices.push(service);
        }
        
        const servicesToSync = selectedServices.reduce((acc, srv) => {
            acc[srv.id] = true;
            return acc;
        }, {});
        
        const currentUser = auth.currentUser;
        
        await update(currentBillRef, {
            selectedServices: servicesToSync,
            status: 'editing',
            lastUpdatedBy: currentUser ? currentUser.displayName : 'Unknown'
        });
    }
    
    // --- OBAT PAGE & SUMMARY LOGIC ---

    // Centralized function to update all totals
    function updateAllTotals() {
        // Recalculate Tindakan Total
        tindakanTotal = selectedServices.reduce((sum, item) => sum + (item.price || 0), 0);
        subtotalTindakanDisplay.textContent = formatCurrency(tindakanTotal);

        // Recalculate Obat Total
        obatTotal = selectedObat.reduce((sum, item) => sum + (item.price * (item.quantity || 0)), 0);
        subtotalObatDisplay.textContent = formatCurrency(obatTotal);

        // Update Grand Total
        const grandTotal = tindakanTotal + obatTotal;
        grandTotalDisplay.textContent = formatCurrency(grandTotal);
    }

    // Handles input changes in the summary view (Admin only)
    function handleObatListInteraction(event) {
        if (currentUserRole !== 'admin') return;

        const input = event.target;
        const itemId = input.dataset.id;
        if (!itemId) return;

        const item = selectedObat.find(i => i.id === itemId);
        if (!item) return;

        let needsSync = false;

        if (input.classList.contains('quantity-input')) {
            let newQuantity = parseInt(input.value, 10);
            item.quantity = isNaN(newQuantity) || newQuantity < 0 ? 0 : newQuantity;
            
            const row = input.closest('.obat-summary-item');
            const subtotalEl = row.querySelector('.subtotal-value');
            if (subtotalEl) {
                subtotalEl.textContent = formatCurrencyNoName(item.price * item.quantity);
            }
            updateAllTotals();
            
            if(event.type === 'change'){
                 needsSync = true;
            }
        }

        if (input.classList.contains('cara-pakai-bill-input')) {
            item.caraPakai = input.value;
            if (event.type === 'change') {
                needsSync = true;
            }
        }

        if (needsSync) {
            syncObatStateToRTDB();
        }
    }

    // Syncs state to Firebase RTDB (Admin only)
    async function syncObatStateToRTDB() {
        if (currentUserRole !== 'admin') return;

        const obatToSync = selectedObat.reduce((acc, item) => {
            acc[item.id] = {
                quantity: item.quantity,
                caraPakai: item.caraPakai || ''
            };
            return acc;
        }, {});
        
        const currentUser = auth.currentUser;
        await update(currentBillRef, {
            selectedObat: obatToSync,
            status: 'editing',
            lastUpdatedBy: currentUser ? currentUser.displayName : 'Unknown'
        });
    }   

    function renderObatItems(container, items, filter = '') {
        container.innerHTML = '';
        const filteredItems = items.filter(i => i.name.toLowerCase().includes(filter));
        if (filteredItems.length === 0) return false;

        filteredItems.forEach(item => {
            const isSelected = selectedObat.some(selected => selected.id === item.id);
            const itemDiv = document.createElement('div');
            // Adjusted padding (p-2) and font sizes for a sleeker look in the new layout
            itemDiv.className = `flex justify-between items-center p-2 cursor-pointer hover:bg-blue-50 item-row`;
            const isDisabled = (item.price === 0 || isNaN(item.price) || item.stock <= 0);
             if (isDisabled) itemDiv.classList.add('opacity-50', 'cursor-not-allowed');
            itemDiv.innerHTML = `<div class="flex items-center"><input type="checkbox" class="item-checkbox h-4 w-4 mr-3" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}><label class="text-sm">${item.name}</label></div><div class="text-right"><p class="text-sm font-medium">${isDisabled && item.stock <=0 ? 'Stok Habis' : formatCurrency(item.price)}</p><p class="text-xs text-gray-500">Stok: ${item.stock || 0}</p></div>`;
            container.appendChild(itemDiv);
        });
        return true;
    }
    
    function renderAllObatItems() {
        if (allObatItems.length === 0) {
            drugsContainer.innerHTML = '<p class="p-4 text-sm text-gray-500">Memuat data...</p>';
            ampulsContainer.innerHTML = '';
            consumablesContainer.innerHTML = '';
            return;
        }
        const query = obatSearchInput.value.toLowerCase();
        const hasDrugs = renderObatItems(drugsContainer, drugs, query);
        const hasAmpuls = renderObatItems(ampulsContainer, ampuls, query);
        const hasConsumables = renderObatItems(consumablesContainer, consumables, query);
        noResultsObatDiv.style.display = (!hasDrugs && !hasAmpuls && !hasConsumables) ? 'block' : 'none';
    }
    
    // Updates the shared summary view (Renamed from updateObatBill)
   function updateSharedSummaryView() {
        updateAllTotals();

        // --- Render Tindakan List ---
        if (selectedServices.length === 0) {
            summaryTindakanListDiv.innerHTML = '<p class="text-gray-500 italic px-2">Belum ada tindakan yang dipilih.</p>';
        } else {
            summaryTindakanListDiv.innerHTML = selectedServices.map(item => {
                return `
                <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                    <span>${item.name}</span>
                    <span class="font-medium">${formatCurrencyNoName(item.price)}</span>
                </div>
                `;
            }).join('');
        }


        // --- Render Obat List ---

        // Preserve focus if user is actively typing (Admin only)
        const focusedElement = document.activeElement;
        const focusedId = focusedElement ? focusedElement.dataset.id : null;
        const focusedValue = focusedElement ? focusedElement.value : null;
        const focusedSelectionStart = focusedElement ? focusedElement.selectionStart : null;

        if (focusedElement && (focusedElement.classList.contains('cara-pakai-bill-input') || focusedElement.classList.contains('quantity-input'))) {
            // Do not re-render the list if the user is actively typing.
        } else {
            if (selectedObat.length === 0) {
                selectedObatListDiv.innerHTML = '<p class="text-gray-500 italic px-2">Belum ada obat/alkes yang dipilih.</p>';
            } else {
                selectedObatListDiv.innerHTML = selectedObat.map(item => {
                    const isDrug = item.category === 'drugs';
                    const subtotal = item.price * item.quantity;
                    const caraPakaiHTML = isDrug ? `<div class="col-span-full pt-1"><input type="text" value="${item.caraPakai || ''}" class="w-full text-xs px-2 py-1 border rounded cara-pakai-bill-input" placeholder="Tulis cara pakai..." data-id="${item.id}"></div>` : '';
                    
                    return `
                    <div class="obat-summary-item p-2 text-sm">
                        <div class="sm:hidden">
                            <div class="font-bold">${item.name}</div>
                            <div class="flex justify-between items-center mt-1">
                                <input type="number" value="${item.quantity}" min="0" class="quantity-input py-1 w-20" data-id="${item.id}">
                                <div class="text-right">
                                    <span>@ ${formatCurrencyNoName(item.price)}</span>
                                    <span class="font-bold ml-2 subtotal-value">${formatCurrencyNoName(subtotal)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="hidden sm:grid grid-cols-5 gap-4 items-center">
                            <span class="col-span-2">${item.name}</span>
                            <input type="number" value="${item.quantity}" min="0" class="quantity-input py-1" data-id="${item.id}">
                            <span class="font-medium text-right">${formatCurrencyNoName(item.price)}</span>
                            <span class="font-bold text-right subtotal-value">${formatCurrencyNoName(subtotal)}</span>
                        </div>
                        ${caraPakaiHTML}
                    </div>`;
                }).join('');
            }
        }
        
        // Restore focus if needed
        if (focusedId) {
            const newFocusedElement = selectedObatListDiv.querySelector(`[data-id="${focusedId}"].${focusedElement.className.split(' ').join('.')}`);
            if (newFocusedElement) {
                newFocusedElement.focus();
                newFocusedElement.value = focusedValue;
                try { newFocusedElement.setSelectionRange(focusedSelectionStart, focusedSelectionStart); } catch(e) {}
            }
        }
    }
    
    // Handles checkbox selection (Admin only)
    function handleObatSelection(event) {
        if (currentUserRole !== 'admin') return;

        const target = event.target;
        const row = target.closest('.item-row');
        if (!row) return;
        const checkbox = row.querySelector('.item-checkbox');
        if (target !== checkbox) {
             if(checkbox.disabled) return;
             checkbox.checked = !checkbox.checked;
        }
        const itemId = checkbox.dataset.id;
        const fullItem = allObatItems.find(i => i.id === itemId);
        if (!fullItem) return;
        if (checkbox.checked) {
            if (!selectedObat.some(i => i.id === itemId)) {
                const newItem = { id: itemId, name: fullItem.name, price: fullItem.price, quantity: 1, category: fullItem.category, caraPakai: fullItem.caraPakai || '' };
                selectedObat.push(newItem);
            }
        } else {
            selectedObat = selectedObat.filter(item => item.id !== itemId);
        }
        syncObatStateToRTDB();
    }

    function resetObatSelection() {
        if (currentUserRole !== 'admin') return;
        selectedObat = [];
        syncObatStateToRTDB();
        showToast("Daftar obat telah direset.", "info");
    }
    
    // --- PDF & STOCK DEDUCTION ---
    const getBase64Image = (img) => {
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        return canvas.toDataURL("image/png");
    }

    async function deductStockFromFirestore() {
        if (selectedObat.length === 0) return;
        console.log("Deducting stock...");
        const batch = writeBatch(db);
        const itemsToDeduct = selectedObat.filter(item => item.quantity > 0);
        const docRefs = itemsToDeduct.map(item => doc(db, 'clinic/data/obat', item.id));
        try {
            // Firestore doesn't support getDocs in a batch/transaction easily for this pattern. 
            // We fetch first, then batch update. Risk of race condition is low in this environment.
            const docSnapshots = await Promise.all(docRefs.map(ref => getDoc(ref)));
            docSnapshots.forEach((docSnap, index) => {
                if (docSnap.exists()) {
                    const currentStock = docSnap.data().stock || 0;
                    const itemUsed = itemsToDeduct[index];
                    const newStock = Math.max(0, currentStock - itemUsed.quantity);
                    batch.update(docSnap.ref, { stock: newStock });
                }
            });
            await batch.commit();
            console.log("Stock successfully updated.");
        } catch (error) {
            console.error("Error deducting stock: ", error);
            showToast("Gagal mengurangi stok. Periksa di admin panel.", "error");
        }
    }

    async function generateCombinedInvoice() {
        const cashierName = auth.currentUser ? auth.currentUser.displayName : 'Staff';
            const patientName = patientNameDisplay.textContent.trim(); // Get name from display
            
            if (!patientName || patientName === 'Tidak Ada Nama') {
                showToast("Nama pasien tidak ditemukan.", "error");
                return;
            }

            // Ensure finalized before printing
            if (currentBillStatus !== 'completed') {
                showToast("Tagihan belum difinalisasi oleh Admin.", "error");
                return;
            }

        const logoImg = document.getElementById('logo');
        if (!logoImg.complete || logoImg.naturalHeight === 0) { showToast("Logo belum termuat. Coba lagi.", "error"); return; }
        const logoBase64 = getBase64Image(logoImg);
        addLog('Invoice Created', { patientName });
        const lowerCasePatientName = patientName.toLowerCase();
        if (lowerCasePatientName !== 'tes' && lowerCasePatientName !== 'test') { await deductStockFromFirestore(); }
        else { console.log("Stock deduction skipped for test patient."); }
        
        // PDF Generation (A6 Format)
        const doc = new jsPDF({ format: 'a6' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const leftMargin = 8;
        const rightMargin = 8;
        const rightEdge = pageWidth - rightMargin;
        const center = pageWidth / 2;
        let y = 10;
        doc.addImage(logoBase64, 'PNG', center - 20, y, 37, 16);
        y += 20;
        doc.setFontSize(8); doc.setFont("helvetica", "normal");
        doc.text('RSIA Melinda - Jl. Balowerti 2 No. 59, Kediri', center, y, { align: 'center' });
        y += 4; doc.text('SIP: 503/0126/SIP-SIK/419.104/2024', center, y, { align: 'center' });
        y += 8; doc.setFontSize(11); doc.setFont("helvetica", "bold");
        doc.text("Invoice Pembayaran", center, y, { align: 'center' });
        y += 2; doc.setLineWidth(0.5); doc.line(leftMargin, y, rightEdge, y);
        y += 8;
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text(`Nama Pasien: ${patientName}`, leftMargin, y);
        doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, rightEdge, y, { align: 'right' });
        y += 6;

        // Tindakan Section
        if (selectedServices.length > 0) {
            y += 2; doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("Rincian Layanan & Tindakan", leftMargin, y);
            y += 5; doc.setFontSize(8); doc.text("Deskripsi", leftMargin, y); doc.text("Harga", rightEdge, y, { align: 'right' });
            y += 2; doc.setLineWidth(0.2); doc.line(leftMargin, y, rightEdge, y); y += 4;
            doc.setFont("helvetica", "normal");
            selectedServices.forEach(item => {
                const itemLines = doc.splitTextToSize(item.name, 60);
                doc.text(itemLines, leftMargin, y);
                doc.text(formatCurrencyNoName(item.price), rightEdge, y, { align: 'right' });
                y += (itemLines.length * 3.5) + 2;
            });
            y += 2; doc.setFont("helvetica", "bold");
            doc.text("Subtotal Tindakan", rightEdge - 25, y, { align: 'right' });
            doc.text(formatCurrency(tindakanTotal), rightEdge, y, { align: 'right' });
            y += 5;
        }

        // Obat Section
        const printedObat = selectedObat.filter(item => item.quantity > 0);
        if (printedObat.length > 0) {
            y += 5; doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("Rincian Obat & Alkes", leftMargin, y);
            y += 5; doc.setFontSize(8); const jmlCol = rightEdge - 38; const hargaCol = rightEdge - 20;
            doc.text("Deskripsi", leftMargin, y); doc.text("Jml", jmlCol, y, { align: 'center' });
            doc.text("Harga", hargaCol, y, { align: 'right' }); doc.text("Subtotal", rightEdge, y, { align: 'right' });
            y += 2; doc.setLineWidth(0.2); doc.line(leftMargin, y, rightEdge, y); y += 4;
            doc.setFont("helvetica", "normal");
            printedObat.forEach(item => {
                const itemLines = doc.splitTextToSize(item.name, 45);
                doc.text(itemLines, leftMargin, y);
                doc.text(String(item.quantity), jmlCol, y, { align: 'center' });
                doc.text(formatCurrencyNoName(item.price), hargaCol, y, { align: 'right' });
                doc.text(formatCurrencyNoName(item.price * item.quantity), rightEdge, y, { align: 'right' });
                y += (itemLines.length * 3.5) + 2;
            });
            y += 2; doc.setFont("helvetica", "bold");
            doc.text("Subtotal Obat & Alkes", rightEdge - 25, y, { align: 'right' });
            doc.text(formatCurrency(obatTotal), rightEdge, y, { align: 'right' });
            y += 5;
        }

        // Grand Total
        y += 5; doc.setLineWidth(0.5); doc.line(leftMargin, y, rightEdge, y); y += 5;
        doc.setFontSize(11); doc.setFont("helvetica", "bold");
        doc.text("GRAND TOTAL", rightEdge - 35, y, { align: 'right' });
        doc.text(formatCurrency(tindakanTotal + obatTotal), rightEdge, y, { align: 'right' });
        y += 10;
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text(`Kasir: ${cashierName}`, leftMargin, y);
        doc.save(`invoice-A6-${patientName.replace(/\s/g, '_')}.pdf`);

        // Prompt to start a new bill
        showModal({
            title: 'Invoice Dibuat',
            message: 'Invoice telah berhasil dibuat. Apakah Anda ingin membersihkan data untuk memulai tagihan baru?',
            confirmText: 'Ya, Mulai Baru',
            confirmClass: 'btn-primary',
            onConfirm: () => executeResetBill() // Use executeResetBill directly as confirmation is done
        });
    }
    
    async function generatePriceListPDF() {
        const logoImg = document.getElementById('logo');
        if (!logoImg.complete || logoImg.naturalHeight === 0) { showToast("Logo belum termuat. Coba lagi.", "error"); return; }
        const logoBase64 = getBase64Image(logoImg);
        const doc = new jsPDF(); let y = 15; const pageHeight = doc.internal.pageSize.height; const bottomMargin = 15;
        const checkPageBreak = (currentY) => { if (currentY > pageHeight - bottomMargin) { doc.addPage(); return 20; } return currentY; };
        doc.addImage(logoBase64, 'PNG', 15, y, 40, 16); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("Daftar Harga", 105, y + 5, { align: 'center' }); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 195, y + 16, { align: 'right' });
        y = 45; doc.setLineWidth(0.5); doc.line(15, y - 5, 195, y - 5);
        doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Layanan & Tindakan", 15, y); y += 8;
        const groupedServices = allServices.reduce((acc, service) => { (acc[service.category] = acc[service.category] || []).push(service); return acc; }, {});
        for (const category of Object.keys(groupedServices).sort()) {
            y = checkPageBreak(y); doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text(category, 17, y); y += 6;
            doc.setFontSize(9); doc.setFont("helvetica", "normal");
            groupedServices[category].forEach(service => {
                y = checkPageBreak(y); doc.text(service.name, 20, y); doc.text(formatCurrency(service.price), 195, y, { align: 'right' }); y += 5;
            }); y += 3;
        }
        y += 5; y = checkPageBreak(y); doc.setLineWidth(0.2); doc.line(15, y, 195, y); y += 8;
        doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Obat & Alkes (Stok Tersedia)", 15, y); y += 8;
        const availableObat = allObatItems.filter(item => item.stock > 0 && item.price > 0);
        const groupedObat = availableObat.reduce((acc, item) => {
            const categoryMap = { 'drugs': 'Obat-obatan', 'ampuls': 'Ampul & Vial', 'consumables': 'Alkes Habis Pakai' };
            const categoryName = categoryMap[item.category] || 'Lainnya';
            (acc[categoryName] = acc[categoryName] || []).push(item); return acc;
        }, {});
        for (const category of Object.keys(groupedObat).sort()) {
            y = checkPageBreak(y); doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text(category, 17, y); y += 6;
            doc.setFontSize(9); doc.setFont("helvetica", "normal");
            groupedObat[category].forEach(item => {
                y = checkPageBreak(y); doc.text(item.name, 20, y); doc.text(formatCurrency(item.price), 195, y, { align: 'right' }); y += 5;
            }); y += 3;
        }
        doc.save('Daftar-Harga-Lengkap-Klinik.pdf');
    }

    async function generateTindakanPriceListPDF() {
        const logoImg = document.getElementById('logo');
        if (!logoImg.complete || logoImg.naturalHeight === 0) { showToast("Logo belum termuat. Coba lagi.", "error"); return; }
        const logoBase64 = getBase64Image(logoImg);
        const doc = new jsPDF(); let y = 15; const pageHeight = doc.internal.pageSize.height; const bottomMargin = 15;
        const checkPageBreak = (currentY) => { if (currentY > pageHeight - bottomMargin) { doc.addPage(); return 20; } return currentY; };
        doc.addImage(logoBase64, 'PNG', 15, y, 40, 16); doc.setFontSize(16); doc.setFont("helvetica", "bold");
        doc.text("Daftar Harga Layanan & Tindakan", 105, y + 5, { align: 'center' }); doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 195, y + 16, { align: 'right' });
        y = 45; doc.setLineWidth(0.5); doc.line(15, y - 5, 195, y - 5);
        doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text("Layanan & Tindakan", 15, y); y += 8;
        const groupedServices = allServices.reduce((acc, service) => { (acc[service.category] = acc[service.category] || []).push(service); return acc; }, {});
        for (const category of Object.keys(groupedServices).sort()) {
            y = checkPageBreak(y); doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.text(category, 17, y); y += 6;
            doc.setFontSize(9); doc.setFont("helvetica", "normal");
            groupedServices[category].forEach(service => {
                y = checkPageBreak(y); doc.text(service.name, 20, y); doc.text(formatCurrency(service.price), 195, y, { align: 'right' }); y += 5;
            }); y += 3;
        }
        doc.save('Daftar-Tindakan-Klinik.pdf');
    }

    async function generateEtiketPDF() {
        const patientName = patientNameDisplay.textContent.trim();
        if (!patientName || patientName === 'Tidak Ada Nama') {
            showToast("Nama pasien tidak boleh kosong.", "error");
            return;
        }

        // Ensure finalized before printing
        if (currentBillStatus !== 'completed') {
            showToast("Tagihan belum difinalisasi oleh Admin.", "error");
            return;
        }
        
        const drugsToPrint = selectedObat.filter(item => item.category === 'drugs' && item.caraPakai && item.quantity > 0);
        if (drugsToPrint.length === 0) { showToast("Tidak ada obat dengan instruksi untuk dicetak.", "info"); return; }
        
        // PDF Generation (Etiket)
        const doc = new jsPDF();
        const labelWidth = 60; const labelHeight = 40; const marginX = 15; const marginY = 15;
        const gapX = 5; const gapY = 5; const cols = 3; let currentX = marginX; let currentY = marginY; let col = 0;
        drugsToPrint.forEach(item => {
            if (currentY + labelHeight > doc.internal.pageSize.height - marginY) { doc.addPage(); currentX = marginX; currentY = marginY; col = 0; }
            doc.rect(currentX, currentY, labelWidth, labelHeight);
            let textY = currentY + 3; doc.setFontSize(8); doc.setFont("helvetica", "bold"); doc.text("Dr. Dibya Private Clinic", currentX + labelWidth / 2, textY, { align: 'center' });
            textY += 3; doc.setFontSize(7); doc.setFont("helvetica", "normal"); doc.text("RSIA Melinda", currentX + labelWidth / 2, textY, { align: 'center' });
            textY += 3; doc.setFontSize(7); doc.text("Jl. Balowerti 2 No. 59, Kediri", currentX + labelWidth / 2, textY, { align: 'center' });
            textY += 3; const licenseNumber = "SIPA: 503/0522/SIP-SIK/419.104/2024"; doc.setFontSize(7); doc.text(licenseNumber, currentX + labelWidth / 2, textY, { align: 'center' });
            textY += 2; doc.setLineWidth(0.2); doc.line(currentX + 2, textY, currentX + labelWidth - 2, textY); textY += 4;
            doc.setFontSize(8); doc.text(`Pasien: ${patientName}`, currentX + 3, textY); doc.text(new Date().toLocaleDateString('id-ID'), currentX + labelWidth - 3, textY, { align: 'right' });
            textY += 4; doc.setFontSize(10); doc.setFont("helvetica", "bold");
            const drugNameLines = doc.splitTextToSize(item.name, labelWidth - 6);
            doc.text(drugNameLines, currentX + 3, textY);
            textY += (drugNameLines.length * 4) + 1;
            doc.setFontSize(9); doc.setFont("helvetica", "normal");
            const instructionLines = doc.splitTextToSize(item.caraPakai, labelWidth - 6);
            doc.text(instructionLines, currentX + 3, textY);
            const beforeAfterMeal = "Diminum sebelum/sesudah makan";
            doc.setFontSize(7); doc.setFont("helvetica", "bold"); doc.text(beforeAfterMeal, currentX + 3, currentY + labelHeight - 3);
            col++;
            if (col >= cols) { col = 0; currentX = marginX; currentY += labelHeight + gapY; }
            else { currentX += labelWidth + gapX; }
        });
        doc.save(`etiket-${patientName.replace(/\s/g, '_')}.pdf`);
    }

    // --- CHAT BOX LOGIC ---
    async function resetChat() {
        showLoader();
        console.log("Menghapus semua riwayat chat...");
        try {
            const chatMessagesRef = collection(db, 'chatMessages');
            const querySnapshot = await getDocs(chatMessagesRef);
            const batch = writeBatch(db);
            querySnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            showToast('Riwayat chat telah berhasil dihapus.', 'success');
        } catch (error) {
            console.error("Error saat mereset chat:", error);
            showToast('Gagal menghapus riwayat chat.', 'error');
        } finally {
            hideLoader();
        }
    }

    function confirmAndResetChat() {
        showModal({
            title: 'Hapus Riwayat Chat?',
            message: 'Anda yakin ingin menghapus SELURUH riwayat chat untuk semua pengguna? Aksi ini tidak dapat dibatalkan.',
            confirmText: 'Ya, Hapus Semua',
            confirmClass: 'btn-danger',
            onConfirm: () => {
                resetChat();
            }
        });
    }
    // Chat Elements
    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    const closeChatBtn = document.getElementById('close-chat');
    const chatMessagesContainer = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatNotification = document.getElementById('chat-notification');

    let isChatWindowOpen = false;
    let unsubscribeChat = null;

    function toggleChatWindow() {
        isChatWindowOpen = !isChatWindowOpen;
        if (isChatWindowOpen) {
            chatWindow.classList.remove('hidden');
            chatNotification.classList.add('hidden');
            setTimeout(() => chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight, 50);
            chatInput.focus();
        } else {
            chatWindow.classList.add('hidden');
        }
    }

    // Modified to handle sounds correctly on new messages
    function renderChatMessage(messageData, isNewMessage = false) {
        if (!messageData || !messageData.text) return;
        const currentUser = auth.currentUser;
        const isSent = currentUser && messageData.uid === currentUser.uid;

        const messageWrapper = document.createElement('div');
        messageWrapper.className = `chat-message ${isSent ? 'sent' : 'received'}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        bubble.textContent = messageData.text;

        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        
        const senderName = isSent ? 'Anda' : messageData.sender;
        const timestamp = messageData.timestamp ? new Date(messageData.timestamp.toMillis()).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';
        meta.textContent = `${senderName} - ${timestamp}`;

        messageWrapper.appendChild(bubble);
        messageWrapper.appendChild(meta);
        chatMessagesContainer.appendChild(messageWrapper);

        // Handle Scrolling
        const shouldScroll = chatMessagesContainer.scrollTop + chatMessagesContainer.clientHeight + 100 >= chatMessagesContainer.scrollHeight;
        if (shouldScroll || isSent) {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // Handle Notifications and Sounds
        if (isNewMessage && !isSent) {
            // Play incoming sound (even if window is open)
            chatIncomingSound.play().catch(e => console.log("User interaction needed to play sound.", e));

            // Show notification bubble if window is closed
            if (!isChatWindowOpen) {
               chatNotification.classList.remove('hidden');
            }
        }
    }

    // Modified to play send sound
    async function sendMessage(e) {
        e.preventDefault();
        const text = chatInput.value.trim();
        const currentUser = auth.currentUser;
        if (text && currentUser) {
            try {
                const chatMessagesRef = collection(db, 'chatMessages');
                await addDoc(chatMessagesRef, {
                    text: text,
                    sender: currentUser.displayName || currentUser.email,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                chatInput.value = '';
                // Play send sound
                chatSendSound.play().catch(e => console.log("User interaction needed to play sound.", e));
            } catch (error) {
                console.error("Error sending message:", error);
                showToast("Gagal mengirim pesan.", "error");
            }
        }
    }

    // Modified listener to handle initial load correctly
    function setupChatListener() {
        if (unsubscribeChat) unsubscribeChat();

        // Use ASC order for rendering chronologically
        const chatMessagesQuery = query(collection(db, 'chatMessages'), orderBy("timestamp", "asc"), limit(50));
        
        let initialLoad = true;

        unsubscribeChat = onSnapshot(chatMessagesQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    // Pass the initialLoad status to determine if sound should play
                    renderChatMessage(change.doc.data(), !initialLoad);
                }
            });

            if (initialLoad) {
                // Scroll to bottom after the initial batch is rendered
                if(isChatWindowOpen) {
                 chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                initialLoad = false;
            }
        });
    }

    chatToggle.addEventListener('click', toggleChatWindow);
    closeChatBtn.addEventListener('click', toggleChatWindow);
    chatForm.addEventListener('submit', sendMessage);


    // --- MAIN APP INITIALIZATION ---
    async function finalizeBill() {
        if (currentUserRole !== 'admin') return;
        showModal({
            title: 'Finalisasi Tagihan?',
            message: 'Apakah Anda yakin tagihan sudah final dan siap dicetak oleh kasir?',
            confirmText: 'Ya, Finalisasi',
            confirmClass: 'btn-primary',
            onConfirm: async () => {
                await update(currentBillRef, { status: 'completed' });
                showToast("Tagihan telah difinalisasi.", "success");
            }
        });
    }

    function initializeMainApp() {
        renderServiceList();
        updateTindakanBill();
        
        let debounceTimer;
        patientNameInput.addEventListener('input', (e) => {
            if (currentUserRole !== 'admin') return;
            clearTimeout(debounceTimer);
            const newName = e.target.value;
            const currentUser = auth.currentUser;
            debounceTimer = setTimeout(() => {
                update(currentBillRef, {
                    patientName: newName,
                    status: 'editing',
                    lastUpdatedBy: currentUser ? currentUser.displayName : 'Unknown'
                });
            }, 500);
        });

        tindakanSearchInput.addEventListener('input', (e) => renderServiceList(e.target.value));
        goToObatBtn.addEventListener('click', showObatPage);
        document.getElementById('print-price-list-btn').addEventListener('click', generatePriceListPDF);
        document.getElementById('print-tindakan-list-btn').addEventListener('click', generateTindakanPriceListPDF);
        backToTindakanBtn.addEventListener('click', showTindakanPage);
        obatSearchInput.addEventListener('input', renderAllObatItems);
        [drugsContainer, ampulsContainer, consumablesContainer].forEach(c => c.addEventListener('click', handleObatSelection));
        
        // Use the movable container for input listeners
        totalSummaryContainer.addEventListener('input', handleObatListInteraction);
        totalSummaryContainer.addEventListener('change', handleObatListInteraction);

        resetObatButton.addEventListener('click', resetObatSelection);
        printInvoiceBtn.addEventListener('click', generateCombinedInvoice);
        printEtiketBtn.addEventListener('click', generateEtiketPDF);
        finalizeBillBtn.addEventListener('click', finalizeBill);
        
        const backToBillingBtn = document.getElementById('backToBillingBtn');
        if (backToBillingBtn) backToBillingBtn.addEventListener('click', () => {
            if (currentUserRole === 'admin') {
                showTindakanPage();
            } else {
                showCashierPage();
            }
        });
        backFromLogBtn.addEventListener('click', showTindakanPage);
        saveObatChangesBtn.addEventListener('click', saveObatChanges);
        addObatBtn.addEventListener('click', addObatRow);
        adminObatListContainer.addEventListener('click', handleDeleteObat);
        addTindakanBtn.addEventListener('click', addTindakanRow);
        saveTindakanChangesBtn.addEventListener('click', saveTindakanChanges);
        adminTindakanListContainer.addEventListener('click', handleDeleteTindakan);
        newBillBtn.addEventListener('click', confirmAndResetBill);
    }
    
    // --- AUTHENTICATION LOGIC ---
    onAuthStateChanged(auth, user => {
        clearAuthMessages();
        allLogs = []; // Clear log cache on auth change

        if (user) {
            if (user && user.emailVerified) {
                authContainer.classList.add('hidden');
                mainApp.classList.remove('hidden');
                onlineUsersFooter.classList.remove('hidden');
                chatToggle.classList.remove('hidden');

                if (!sessionStorage.getItem('loginLogged')) {
                    addLog('User Login');
                    sessionStorage.setItem('loginLogged', 'true');
                }

                // Setup Realtime Database Presence
                const userStatusDatabaseRef = ref(rtdb, '/status/' + user.uid);
                const isOfflineForDatabase = { isOnline: false, last_changed: rtdbServerTimestamp(), displayName: user.displayName || user.email };
                const isOnlineForDatabase = { isOnline: true, last_changed: rtdbServerTimestamp(), displayName: user.displayName || user.email };
                onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => set(userStatusDatabaseRef, isOnlineForDatabase));

                // Determine Role
                const displayNameLower = user.displayName?.toLowerCase() || '';
                const isAdmin = displayNameLower === 'dr.dibya';
                const isStockManager = STOCK_MANAGERS.includes(displayNameLower);

                if (isAdmin) currentUserRole = 'admin';
                else if (isStockManager) currentUserRole = 'stockManager';
                else currentUserRole = 'user';
                
                // Setup UI Elements
                adminWelcomeName.textContent = user.displayName || user.email;
                userInfoEl.innerHTML = `<span class="w-full text-left mb-2 md:w-auto md:mb-0 font-medium mr-4">Selamat datang, ${user.displayName || user.email}</span><div class="flex gap-2 w-full md:w-auto"></div>`;
                const buttonContainer = userInfoEl.querySelector('.flex.gap-2');

                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logout-btn';
                logoutBtn.className = 'flex-grow md:flex-grow-0 btn btn-logout font-bold py-1 px-3 rounded-md';
                logoutBtn.textContent = 'Logout';
                logoutBtn.addEventListener('click', () => {
                    clearTimeout(idleTimer);
                    sessionStorage.removeItem('loginLogged');
                    set(userStatusDatabaseRef, isOfflineForDatabase); 
                    if (unsubscribeObat) unsubscribeObat(); 
                    if (unsubscribeTindakan) unsubscribeTindakan();
                    if (unsubscribeLogs) unsubscribeLogs();
                    if (unsubscribeOnlineUsers) unsubscribeOnlineUsers();
                    stopClock();
                    signOut(auth);
                });

                if (isAdmin || isStockManager) { 
                    if (isAdmin) {
                        const logBtn = document.createElement('button');
                        logBtn.id = 'log-page-btn';
                        logBtn.className = 'flex-grow md:flex-grow-0 btn btn-secondary font-bold py-1 px-3 rounded-md';
                        logBtn.textContent = 'Log';
                        logBtn.addEventListener('click', showLogPage);
                        buttonContainer.appendChild(logBtn);
                         const resetChatBtn = document.getElementById('reset-chat-btn');
                        if(resetChatBtn) {
                            resetChatBtn.classList.remove('hidden');
                            resetChatBtn.addEventListener('click', confirmAndResetChat);
                        }
                    }

                    const adminBtn = document.createElement('button');
                    adminBtn.id = 'admin-btn';
                    adminBtn.className = 'flex-grow md:flex-grow-0 btn btn-secondary font-bold py-1 px-3 rounded-md';
                    adminBtn.textContent = 'Admin';
                    adminBtn.addEventListener('click', showAdminPage);
                    buttonContainer.appendChild(adminBtn);
                }
                
                buttonContainer.appendChild(logoutBtn);
                
                initializeMainApp();
                setupIdleTimer();
                initializeFirestoreData(); 
                setupRealtimeListeners(); 
                setupCurrentBillListener();
                setupChatListener();
                startClock();

                // Initial Page Navigation
                if (currentUserRole === 'admin') {
                    showTindakanPage();
                } else {
                    showCashierPage();
                }

            } else {
                // User logged in but not verified
                mainApp.classList.add('hidden');
                authContainer.classList.remove('hidden');
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                verifyEmailMessage.classList.add('hidden');
                unverifiedUserMessage.classList.remove('hidden');
                onlineUsersFooter.classList.add('hidden');
            }
        } else {
            // User logged out
            mainApp.classList.add('hidden');
            authContainer.classList.remove('hidden');
            unverifiedUserMessage.classList.add('hidden');
            resetToLoginView(); 
            userInfoEl.innerHTML = '';
            clearTimeout(idleTimer);
            currentUserRole = 'user';
            if (unsubscribeObat) unsubscribeObat();
            if (unsubscribeTindakan) unsubscribeTindakan();
            if (unsubscribeLogs) unsubscribeLogs();
            if (unsubscribeOnlineUsers) unsubscribeOnlineUsers();
            stopClock();
            if (unsubscribeChat) unsubscribeChat();
            onlineUsersFooter.classList.add('hidden');
            chatToggle.classList.add('hidden');
        }
    });

    // --- AUTH EVENT LISTENERS ---
    document.getElementById('register').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAuthMessages();
        showLoader();
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            await setPersistence(auth, browserSessionPersistence);
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: username });
            await sendEmailVerification(userCredential.user);
            await signOut(auth);
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            verifyEmailMessage.classList.remove('hidden');
        } catch (error) { authErrorEl.textContent = error.message; 
        } finally { hideLoader(); }
    });

    document.getElementById('login').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAuthMessages();
        showLoader();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('remember-me').checked;
        try {
            const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
            await setPersistence(auth, persistence);
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) { authErrorEl.textContent = "Email atau password salah."; 
        } finally { hideLoader(); }
    });

    document.getElementById('reset-password').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAuthMessages();
        showLoader();
        const email = document.getElementById('reset-email').value;
        try {
            await sendPasswordResetEmail(auth, email);
            authSuccessEl.textContent = 'Email reset password telah dikirim! Silakan periksa kotak masuk Anda.';
            forgotPasswordForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        } catch (error) {
            authErrorEl.textContent = 'Gagal mengirim email. Pastikan email sudah benar.';
        } finally {
            hideLoader();
        }
    });


    document.getElementById('resend-verification-btn').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (user) {
            try {
                await sendEmailVerification(user);
                showToast('Email verifikasi baru telah dikirim!', 'success');
            } catch (error) { showToast('Gagal mengirim email. Coba lagi nanti.', 'error'); }
        }
    });

    document.getElementById('unverified-logout-btn').addEventListener('click', () => signOut(auth));
    
    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault(); clearAuthMessages(); loginForm.classList.add('hidden'); forgotPasswordForm.classList.add('hidden');
        unverifiedUserMessage.classList.add('hidden'); registerForm.classList.remove('hidden'); verifyEmailMessage.classList.add('hidden');
    });

    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault(); clearAuthMessages(); loginForm.classList.add('hidden');
        forgotPasswordForm.classList.remove('hidden');
    });

    const resetToLoginView = (e) => {
        if (e) e.preventDefault(); clearAuthMessages(); registerForm.classList.add('hidden');
        forgotPasswordForm.classList.add('hidden');
        verifyEmailMessage.classList.add('hidden'); unverifiedUserMessage.classList.add('hidden'); loginForm.classList.remove('hidden');
    };
    
    showLoginLink.addEventListener('click', resetToLoginView);
    backToLoginLink.addEventListener('click', resetToLoginView);
    document.getElementById('back-to-login-from-reset').addEventListener('click', resetToLoginView);

    // Show/Hide Password Toggle
    passwordToggleBtn.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        if (isPassword) {
            passwordInput.type = 'text';
            eyeIcon.classList.add('hidden');
            eyeSlashIcon.classList.remove('hidden');
        } else {
            passwordInput.type = 'password';
            eyeIcon.classList.remove('hidden');
            eyeSlashIcon.classList.add('hidden');
        }
    });
</script>
</body>
</html>