// appointments.js - Appointment Management
import { auth, getIdToken } from './vps-auth.js';
import { showSuccess, showError, showWarning } from './toast.js';

const VPS_API_BASE = 'https://praktekdrdibya.com';

let allAppointments = [];
let allPatients = [];
let isEditMode = false;

// Initialize appointments module
export function initAppointments() {
    console.log('ðŸ”§ Initializing Appointments...');
    loadPatients();
    loadAppointments();
    bindEventListeners();
}

// Load all patients for dropdown
async function loadPatients() {
    try {
        const response = await fetch(`${VPS_API_BASE}/public/patients`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                allPatients = result.data;
                console.log('âœ… Loaded', allPatients.length, 'patients');
            }
        }
    } catch (error) {
        console.error('Error loading patients:', error);
    }
}

// Load appointments from VPS
async function loadAppointments() {
    try {
        const response = await fetch(`${VPS_API_BASE}/public/appointments`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
                allAppointments = result.data;
                console.log('âœ… Loaded', allAppointments.length, 'appointments');
                renderTodayAppointments();
                renderAppointmentsList(allAppointments);
            }
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
        showError('Gagal memuat appointments: ' + error.message);
    }
}

// Render today's appointments
function renderTodayAppointments() {
    const container = document.getElementById('appointments-today-list');
    if (!container) return;
    
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    const todayAppts = allAppointments
        .filter(apt => apt.appointment_date === todayStr && 
                      (apt.status === 'scheduled' || apt.status === 'confirmed'))
        .sort((a, b) => a.appointment_time.localeCompare(b.appointment_time));
    
    if (todayAppts.length === 0) {
        container.innerHTML = '<p class="text-center text-muted mb-0">Tidak ada appointment hari ini.</p>';
        return;
    }
    
    container.innerHTML = todayAppts.map(apt => `
        <div class="border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${apt.patient_name}</strong><br>
                    <small class="text-muted">${apt.appointment_type}</small>
                </div>
                <div>
                    <span class="badge badge-primary">${apt.appointment_time.substring(0, 5)}</span><br>
                    <button class="btn btn-sm btn-warning mt-1" onclick="window.editAppointment('${apt.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
            ${apt.notes ? `<p class="small mb-0 mt-2"><em>${apt.notes}</em></p>` : ''}
        </div>
    `).join('');
}

// Render appointments list
function renderAppointmentsList(appointments) {
    const tbody = document.getElementById('appointments-list-body');
    if (!tbody) return;
    
    if (appointments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">Tidak ada appointment</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = appointments.map((apt, index) => {
        const statusBadge = getStatusBadge(apt.status);
        const appointmentDate = new Date(apt.appointment_date);
        const dateStr = appointmentDate.toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
        });
        
        return `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${apt.patient_name}</strong></td>
                <td>${apt.appointment_type}</td>
                <td>${dateStr}</td>
                <td><span class="badge badge-info">${apt.appointment_time.substring(0, 5)}</span></td>
                <td>${statusBadge}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning mr-1" onclick="window.editAppointment('${apt.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${apt.status !== 'completed' && apt.status !== 'cancelled' ? `
                        <button class="btn btn-sm btn-danger" onclick="window.cancelAppointment('${apt.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'scheduled': '<span class="badge badge-secondary">Terjadwal</span>',
        'confirmed': '<span class="badge badge-primary">Dikonfirmasi</span>',
        'completed': '<span class="badge badge-success">Selesai</span>',
        'cancelled': '<span class="badge badge-danger">Dibatalkan</span>',
        'no_show': '<span class="badge badge-warning">Tidak Hadir</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Unknown</span>';
}

// Open new appointment modal
window.openNewAppointment = function() {
    isEditMode = false;
    document.getElementById('appointment-id').value = '';
    document.getElementById('appointment-modal-title').innerHTML = '<i class="fas fa-calendar-plus mr-2"></i>Tambah Appointment Baru';
    
    // Populate patient dropdown
    const select = document.getElementById('appointment-patient-select');
    select.innerHTML = '<option value="">Pilih pasien...</option>';
    allPatients.forEach(patient => {
        const option = document.createElement('option');
        option.value = patient.id;
        option.textContent = `${patient.name} (${patient.patientId})`;
        select.appendChild(option);
    });
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointment-date').value = today;
    
    // Reset form
    document.getElementById('appointment-type').value = 'Konsultasi';
    document.getElementById('appointment-time').value = '09:00';
    document.getElementById('appointment-notes').value = '';
    document.getElementById('appointment-reminder').checked = false;
    
    $('#appointment-modal').modal('show');
};

// Edit appointment
window.editAppointment = function(appointmentId) {
    const appointment = allAppointments.find(apt => apt.id == appointmentId);
    if (!appointment) return;
    
    isEditMode = true;
    document.getElementById('appointment-id').value = appointment.id;
    document.getElementById('appointment-modal-title').innerHTML = '<i class="fas fa-calendar-edit mr-2"></i>Edit Appointment';
    
    // Populate patient dropdown
    const select = document.getElementById('appointment-patient-select');
    select.innerHTML = '<option value="">Pilih pasien...</option>';
    allPatients.forEach(patient => {
        const option = document.createElement('option');
        option.value = patient.id;
        option.textContent = `${patient.name} (${patient.patientId})`;
        option.selected = patient.id == appointment.patient_id;
        select.appendChild(option);
    });
    
    // Set form values
    document.getElementById('appointment-date').value = appointment.appointment_date;
    document.getElementById('appointment-time').value = appointment.appointment_time;
    document.getElementById('appointment-type').value = appointment.appointment_type;
    document.getElementById('appointment-notes').value = appointment.notes || '';
    document.getElementById('appointment-reminder').checked = appointment.whatsapp_reminder || false;
    
    $('#appointment-modal').modal('show');
};

// Save appointment
window.saveAppointment = async function() {
    const form = document.getElementById('appointment-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const appointmentId = document.getElementById('appointment-id').value;
    const patientId = document.getElementById('appointment-patient-select').value;
    const patient = allPatients.find(p => p.id == patientId);
    
    if (!patient) {
        showError('Pilih pasien terlebih dahulu');
        return;
    }
    
    const appointmentData = {
        patient_id: patientId,
        patient_name: patient.name,
        appointment_date: document.getElementById('appointment-date').value,
        appointment_time: document.getElementById('appointment-time').value,
        appointment_type: document.getElementById('appointment-type').value,
        location: 'Klinik', // Private clinic only
        notes: document.getElementById('appointment-notes').value,
        whatsapp_reminder: document.getElementById('appointment-reminder').checked,
        reminder_time: 60,
        created_by: auth.currentUser?.name || auth.currentUser?.email || 'System'
    };
    
    try {
        const token = await getIdToken();
        if (!token) {
            showError('Anda tidak terautentikasi. Silakan login kembali.');
            return;
        }
        
        const url = isEditMode 
            ? `${VPS_API_BASE}/api/appointments/${appointmentId}`
            : `${VPS_API_BASE}/api/appointments`;
        const method = isEditMode ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(appointmentData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save appointment');
        }
        
        const result = await response.json();
        if (result.success) {
            showSuccess(isEditMode ? 'Appointment berhasil diperbarui' : 'Appointment berhasil dibuat');
            $('#appointment-modal').modal('hide');
            loadAppointments();
        } else {
            throw new Error(result.message || 'Failed to save appointment');
        }
    } catch (error) {
        console.error('Error saving appointment:', error);
        showError('Gagal menyimpan appointment: ' + error.message);
    }
};

// Cancel appointment
window.cancelAppointment = async function(appointmentId) {
    if (!confirm('Yakin ingin membatalkan appointment ini?')) return;
    
    try {
        const token = await getIdToken();
        if (!token) {
            showError('Anda tidak terautentikasi. Silakan login kembali.');
            return;
        }
        
        const response = await fetch(`${VPS_API_BASE}/api/appointments/${appointmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: 'cancelled' })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to cancel appointment');
        }
        
        const result = await response.json();
        if (result.success) {
            showSuccess('Appointment berhasil dibatalkan');
            loadAppointments();
        }
    } catch (error) {
        console.error('Error cancelling appointment:', error);
        showError('Gagal membatalkan appointment: ' + error.message);
    }
};

// Bind event listeners
function bindEventListeners() {
    // Add appointment button
    const addBtn = document.getElementById('btn-add-appointment');
    if (addBtn) {
        addBtn.addEventListener('click', window.openNewAppointment);
    }
    
    // Search
    const searchInput = document.getElementById('appointments-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            filterAppointments(searchTerm);
        });
    }
    
    // Status filter
    const statusFilter = document.getElementById('appointments-filter-status');
    if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
            filterAppointments();
        });
    }
    
    // Date filter
    const dateFilter = document.getElementById('appointments-filter-date');
    if (dateFilter) {
        dateFilter.addEventListener('change', (e) => {
            filterAppointments();
        });
    }
}

// Filter appointments
function filterAppointments(searchTerm = '') {
    let filtered = allAppointments;
    
    // Search filter
    if (searchTerm) {
        filtered = filtered.filter(apt => 
            apt.patient_name.toLowerCase().includes(searchTerm) ||
            apt.appointment_type.toLowerCase().includes(searchTerm)
        );
    }
    
    // Status filter
    const statusFilter = document.getElementById('appointments-filter-status');
    if (statusFilter && statusFilter.value) {
        filtered = filtered.filter(apt => apt.status === statusFilter.value);
    }
    
    // Date filter
    const dateFilter = document.getElementById('appointments-filter-date');
    if (dateFilter && dateFilter.value) {
        filtered = filtered.filter(apt => apt.appointment_date === dateFilter.value);
    }
    
    renderAppointmentsList(filtered);
}

