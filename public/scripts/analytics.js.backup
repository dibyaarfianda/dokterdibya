// Uses VPS API for analytics

// VPS API Configuration
const VPS_API_BASE = 'https://praktekdrdibya.com';

// Analytics data cache
let analyticsData = {
    weeklyRevenue: [],
    monthlyRevenue: [],
    topDrugs: [],
    topServices: [],
    totalRevenue: 0,
    totalVisits: 0
};

// Get date range for weekly analysis (last 7 days)
function getWeeklyDateRange() {
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 6); // Last 7 days including today
    return { start, end };
}

// Get date range for monthly analysis (last 30 days)
function getMonthlyDateRange() {
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 29); // Last 30 days including today
    return { start, end };
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

// Fetch all visits data (excluding dummy patients) from VPS API
async function fetchVisitsData() {
    try {
        const response = await fetch(`${VPS_API_BASE}/public/visits?exclude_dummy=true`);
        if (!response.ok) return [];
        
        const result = await response.json();
        if (!result.success || !result.data) return [];
        
        const visits = result.data.map(visit => {
            // Fields are already parsed by the API
            const visitDate = new Date(visit.visit_date || visit.created_at);
            const services = visit.services || [];
            const obat = visit.medications || [];
            
            return {
                id: visit.id,
                ...visit,
                date: visitDate,
                services,
                obat,
                grandTotal: parseFloat(visit.grand_total || visit.total_amount || 0)
            };
        });
        
        return visits;
    } catch (err) {
        console.error('Failed to fetch visits:', err);
        return [];
    }
}

// Analyze weekly revenue
function analyzeWeeklyRevenue(visits) {
    const { start, end } = getWeeklyDateRange();
    const dailyRevenue = {};
    
    // Initialize all days with 0
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        dailyRevenue[dateKey] = 0;
    }
    
    // Sum revenue per day
    visits.forEach(visit => {
        const visitDate = new Date(visit.date);
        if (visitDate >= start && visitDate <= end) {
            const dateKey = visitDate.toISOString().split('T')[0];
            dailyRevenue[dateKey] = (dailyRevenue[dateKey] || 0) + (visit.grandTotal || 0);
        }
    });
    
    // Convert to array for charting
    return Object.entries(dailyRevenue).map(([date, revenue]) => ({
        date,
        dateLabel: new Date(date).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' }),
        revenue
    }));
}

// Analyze monthly revenue
function analyzeMonthlyRevenue(visits) {
    const { start, end } = getMonthlyDateRange();
    const dailyRevenue = {};
    
    // Initialize all days with 0
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        dailyRevenue[dateKey] = 0;
    }
    
    // Sum revenue per day
    visits.forEach(visit => {
        const visitDate = new Date(visit.date);
        if (visitDate >= start && visitDate <= end) {
            const dateKey = visitDate.toISOString().split('T')[0];
            dailyRevenue[dateKey] = (dailyRevenue[dateKey] || 0) + (visit.grandTotal || 0);
        }
    });
    
    // Convert to array
    return Object.entries(dailyRevenue).map(([date, revenue]) => ({
        date,
        dateLabel: new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }),
        revenue
    }));
}

// Analyze top drugs sold
function analyzeTopDrugs(visits) {
    const drugStats = {};
    
    visits.forEach(visit => {
        if (visit.obat && Array.isArray(visit.obat)) {
            visit.obat.forEach(item => {
                if (item.category === 'drugs') {
                    const key = item.name;
                    if (!drugStats[key]) {
                        drugStats[key] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    drugStats[key].quantity += item.quantity || 1;
                    drugStats[key].revenue += (item.price || 0) * (item.quantity || 1);
                }
            });
        }
    });
    
    // Convert to array and sort by quantity
    return Object.values(drugStats)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 10); // Top 10
}

// Analyze top services
function analyzeTopServices(visits) {
    const serviceStats = {};
    
    visits.forEach(visit => {
        if (visit.services && Array.isArray(visit.services)) {
            visit.services.forEach(service => {
                const key = service.name || service;
                if (!serviceStats[key]) {
                    serviceStats[key] = {
                        name: key,
                        count: 0,
                        revenue: 0
                    };
                }
                serviceStats[key].count += 1;
                serviceStats[key].revenue += service.price || 0;
            });
        }
    });
    
    // Convert to array and sort by count
    return Object.values(serviceStats)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10); // Top 10
}

// Calculate total statistics
function calculateTotalStats(visits) {
    const totalRevenue = visits.reduce((sum, visit) => sum + (visit.grandTotal || 0), 0);
    const totalVisits = visits.length;
    
    return { totalRevenue, totalVisits };
}

// Main analytics function
export async function loadAnalytics() {
    try {
        const visits = await fetchVisitsData();
        
        analyticsData.weeklyRevenue = analyzeWeeklyRevenue(visits);
        analyticsData.monthlyRevenue = analyzeMonthlyRevenue(visits);
        analyticsData.topDrugs = analyzeTopDrugs(visits);
        analyticsData.topServices = analyzeTopServices(visits);
        
        const stats = calculateTotalStats(visits);
        analyticsData.totalRevenue = stats.totalRevenue;
        analyticsData.totalVisits = stats.totalVisits;
        
        return analyticsData;
    } catch (err) {
        console.error('Failed to load analytics:', err);
        return analyticsData;
    }
}

// Render weekly revenue chart
export function renderWeeklyRevenueChart(data) {
    const container = document.getElementById('weekly-revenue-chart');
    if (!container) return;
    
    const maxRevenue = Math.max(...data.map(d => d.revenue), 1);
    
    let html = '<div class="chart-container" style="height: 200px; display: flex; align-items: flex-end; gap: 5px;">';
    
    data.forEach(day => {
        const height = (day.revenue / maxRevenue) * 100;
        html += `
            <div class="chart-bar" style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                <div class="bar-value" style="font-size: 10px; margin-bottom: 5px;">${formatCurrency(day.revenue)}</div>
                <div class="bar" style="width: 100%; height: ${height}%; background: linear-gradient(to top, #007bff, #00d4ff); border-radius: 4px 4px 0 0; min-height: 5px;"></div>
                <div class="bar-label" style="font-size: 11px; margin-top: 5px; text-align: center;">${day.dateLabel}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Render monthly revenue chart
export function renderMonthlyRevenueChart(data) {
    const container = document.getElementById('monthly-revenue-chart');
    if (!container) return;
    
    const maxRevenue = Math.max(...data.map(d => d.revenue), 1);
    
    let html = '<div class="chart-container" style="height: 200px; display: flex; align-items: flex-end; gap: 2px; overflow-x: auto;">';
    
    data.forEach(day => {
        const height = (day.revenue / maxRevenue) * 100;
        html += `
            <div class="chart-bar" style="min-width: 20px; display: flex; flex-direction: column; align-items: center;">
                <div class="bar" style="width: 100%; height: ${height}%; background: linear-gradient(to top, #28a745, #7dff7d); border-radius: 4px 4px 0 0; min-height: 3px;" title="${day.dateLabel}: ${formatCurrency(day.revenue)}"></div>
                <div class="bar-label" style="font-size: 9px; margin-top: 3px; writing-mode: vertical-rl; transform: rotate(180deg);">${day.dateLabel.split(' ')[0]}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Render top drugs table
export function renderTopDrugsTable(drugs) {
    const container = document.getElementById('top-drugs-table');
    if (!container) return;
    
    if (drugs.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Belum ada data obat terjual</p>';
        return;
    }
    
    let html = '<table class="table table-sm table-hover"><thead><tr><th>Obat</th><th class="text-right">Qty</th><th class="text-right">Revenue</th></tr></thead><tbody>';
    
    drugs.forEach((drug, index) => {
        html += `
            <tr>
                <td><span class="badge badge-primary mr-2">${index + 1}</span>${drug.name}</td>
                <td class="text-right"><strong>${drug.quantity}</strong></td>
                <td class="text-right text-success">${formatCurrency(drug.revenue)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Render top services table
export function renderTopServicesTable(services) {
    const container = document.getElementById('top-services-table');
    if (!container) return;
    
    if (services.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Belum ada data tindakan</p>';
        return;
    }
    
    let html = '<table class="table table-sm table-hover"><thead><tr><th>Tindakan</th><th class="text-right">Count</th><th class="text-right">Revenue</th></tr></thead><tbody>';
    
    services.forEach((service, index) => {
        html += `
            <tr>
                <td><span class="badge badge-success mr-2">${index + 1}</span>${service.name}</td>
                <td class="text-right"><strong>${service.count}x</strong></td>
                <td class="text-right text-success">${formatCurrency(service.revenue)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Render summary stats
export function renderSummaryStats(data) {
    const weeklyTotal = data.weeklyRevenue.reduce((sum, day) => sum + day.revenue, 0);
    const monthlyTotal = data.monthlyRevenue.reduce((sum, day) => sum + day.revenue, 0);
    
    // Weekly average
    const weeklyAvg = weeklyTotal / 7;
    const weeklyTotalEl = document.getElementById('weekly-total');
    if (weeklyTotalEl) weeklyTotalEl.textContent = formatCurrency(weeklyTotal);
    const weeklyAvgEl = document.getElementById('weekly-avg');
    if (weeklyAvgEl) weeklyAvgEl.textContent = formatCurrency(weeklyAvg);
    
    // Monthly average
    const monthlyAvg = monthlyTotal / 30;
    const monthlyTotalEl = document.getElementById('monthly-total');
    if (monthlyTotalEl) monthlyTotalEl.textContent = formatCurrency(monthlyTotal);
    const monthlyAvgEl = document.getElementById('monthly-avg');
    if (monthlyAvgEl) monthlyAvgEl.textContent = formatCurrency(monthlyAvg);
    
    // Total stats (optional - if elements exist)
    const totalRevenueEl = document.getElementById('total-revenue');
    if (totalRevenueEl) totalRevenueEl.textContent = formatCurrency(data.totalRevenue);
    const totalVisitsEl = document.getElementById('total-visits');
    if (totalVisitsEl) totalVisitsEl.textContent = data.totalVisits;
}

// Initialize analytics dashboard
export async function initAnalyticsDashboard() {
    const data = await loadAnalytics();
    
    renderWeeklyRevenueChart(data.weeklyRevenue);
    renderMonthlyRevenueChart(data.monthlyRevenue);
    renderTopDrugsTable(data.topDrugs);
    renderTopServicesTable(data.topServices);
    renderSummaryStats(data);
}

