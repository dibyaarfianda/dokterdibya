// Updated billing.js to use VPS API instead of Firebase
// Replace the existing billing.js with this version

import { showSuccess, showError, showWarning } from './toast.js';
import { updateSessionServices } from './session-manager.js';

// API Base URL - Using public endpoint (no auth required)
const API_BASE = 'https://praktekdrdibya.com/public';

let allServices = [];
let selectedServices = [];
let selectedObat = [];
let currentPatient = null;

const serviceListContainer = document.getElementById('service-list');
const selectedServicesList = document.getElementById('selected-services-list');
const tindakanSearchInput = document.getElementById('tindakan-search');
const tindakanTotalEl = document.getElementById('tindakan-total');

// Category order for display
const categoryOrder = ['ADMINISTRATIF', 'LAYANAN', 'TINDAKAN MEDIS', 'KONTRASEPSI', 'VAKSINASI', 'LABORATORIUM'];

function formatCurrency(amount) {
    return 'Rp ' + amount.toLocaleString('id-ID');
}

// ==================== GET AUTH TOKEN ====================
async function getAuthToken() {
    // Get Firebase Auth token
    if (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
        try {
            const token = await window.firebase.auth().currentUser.getIdToken();
            return token;
        } catch (error) {
            console.error('Error getting auth token:', error);
            return null;
        }
    }
    return null;
}

// ==================== LOAD SERVICES FROM VPS ====================
async function loadServices() {
    try {
        const token = await getAuthToken();
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        const response = await fetch(`${API_BASE}/tindakan?active=true`, {
            method: 'GET',
            headers: headers
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            allServices = result.data;
            console.log('âœ… Loaded', allServices.length, 'services from VPS');
        } else {
            throw new Error(result.message || 'Failed to load services');
        }
        
    } catch (error) {
        console.error('âŒ Error loading services from VPS:', error);
        showError('Gagal memuat data tindakan dari server');
        allServices = [];
    }
}

// ==================== RENDER SERVICE LIST ====================
function renderServiceList(filter = '') {
    if (!serviceListContainer) return;
    serviceListContainer.innerHTML = '';

    let filtered = allServices;
    if (filter) {
        filtered = allServices.filter(s => 
            s.name.toLowerCase().includes(filter.toLowerCase())
        );
    }

    if (filtered.length === 0) {
        serviceListContainer.innerHTML = '<p class="text-center text-muted py-4">Tidak ada layanan ditemukan.</p>';
        return;
    }

    // Group by category
    const categoriesSet = new Set(filtered.map(s => s.category));
    
    // Order categories
    const orderedCategories = categoryOrder.filter(cat => categoriesSet.has(cat));
    const otherCategories = Array.from(categoriesSet)
        .filter(cat => !categoryOrder.includes(cat))
        .sort();
    const categories = [...orderedCategories, ...otherCategories];

    categories.forEach(category => {
        const header = document.createElement('div');
        header.className = 'bg-light border-bottom px-3 py-2 font-weight-bold text-uppercase small text-muted sticky-top';
        header.style.cssText = 'position: sticky; top: 0; z-index: 10;';
        header.textContent = category;
        serviceListContainer.appendChild(header);

        filtered.filter(s => s.category === category).forEach(service => {
            const isSelected = selectedServices.some(s => s.id === service.id);
            const row = document.createElement('div');
            row.className = `d-flex justify-content-between align-items-center p-2 border-bottom ${isSelected ? 'bg-primary text-white font-weight-bold' : ''}`;
            row.style.cursor = 'pointer';
            row.innerHTML = `
                <span>${service.name}</span>
                <span class="badge ${isSelected ? 'badge-light' : 'badge-secondary'}">${formatCurrency(service.price)}</span>
            `;
            row.onclick = () => toggleService(service);
            serviceListContainer.appendChild(row);
        });
    });
}

// ==================== UPDATE SELECTED LIST ====================
function updateSelectedList() {
    if (!selectedServicesList) return;
    selectedServicesList.innerHTML = '';
    
    if (selectedServices.length === 0) {
        const li = document.createElement('li');
        li.id = 'empty-state-tindakan';
        li.className = 'text-center text-muted py-4';
        li.textContent = 'Pilih layanan di sebelah kiri.';
        selectedServicesList.appendChild(li);
    } else {
        selectedServices.forEach(service => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>${service.name}</strong>
                    <br><small class="text-muted">${service.category}</small>
                </div>
                <span class="badge badge-primary badge-pill">${formatCurrency(service.price)}</span>
            `;
            selectedServicesList.appendChild(li);
        });
    }

    updateTotal();
}

// ==================== TOGGLE SERVICE ====================
function toggleService(service) {
    const index = selectedServices.findIndex(s => s.id === service.id);
    
    if (index >= 0) {
        selectedServices.splice(index, 1);
    } else {
        selectedServices.push(service);
    }
    
    renderServiceList(tindakanSearchInput?.value || '');
    updateSelectedList();
    
    // Save to session
    updateSessionServices(selectedServices);
}

// ==================== UPDATE TOTAL ====================
function updateTotal() {
    if (!tindakanTotalEl) return;
    
    const total = selectedServices.reduce((sum, s) => sum + parseFloat(s.price || 0), 0);
    tindakanTotalEl.textContent = formatCurrency(total);
}

// ==================== SEARCH ====================
if (tindakanSearchInput) {
    tindakanSearchInput.addEventListener('input', (e) => {
        renderServiceList(e.target.value);
    });
}

// ==================== INIT ====================
export async function initBilling() {
    console.log('ðŸ”§ Initializing Billing (VPS Mode)...');
    
    await loadServices();
    renderServiceList();
    updateSelectedList();
    
    // Load obat (keep existing Firebase logic for now)
    // ... existing obat code ...
}

// ==================== EXPORTS ====================
export function getCurrentPatient() {
    return currentPatient;
}

export function getSelectedServices() {
    return selectedServices;
}

export function getSelectedObat() {
    return selectedObat;
}

export function getCurrentPatientData() {
    // Get patient data from patients module
    const select = document.getElementById('patient-select');
    if (select && select.value) {
        // Find patient data from the select option
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.dataset) {
            return {
                id: select.value,
                name: selectedOption.dataset.name || '',
                whatsapp: selectedOption.dataset.whatsapp || '',
                birthDate: selectedOption.dataset.birthdate || '',
                age: selectedOption.dataset.age || ''
            };
        }
    }
    return currentPatient || {};
}

export function validatePatient() {
    const patientData = getCurrentPatientData();
    if (!patientData || !patientData.name) {
        showWarning('Silakan pilih atau tambah data pasien terlebih dahulu');
        return false;
    }
    return true;
}

export function validateObatUsage() {
    // Check if all selected drugs have usage instructions
    const drugs = selectedObat.filter(item => item.category === 'drugs');
    const missingUsage = drugs.filter(item => !item.usage || item.usage.trim() === '');
    
    if (missingUsage.length > 0) {
        showWarning('Mohon lengkapi cara pakai untuk semua obat');
        return false;
    }
    return true;
}

export function updatePatientDisplay() {
    // Update patient display in UI
    const patientData = getCurrentPatientData();
    const displayEl = document.getElementById('current-patient-display');
    if (displayEl && patientData && patientData.name) {
        displayEl.textContent = `${patientData.name} (${patientData.age || '-'})`;
        displayEl.classList.remove('d-none');
    } else if (displayEl) {
        displayEl.classList.add('d-none');
    }
}

