<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Avatar Test</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; }
        .debug-panel { background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .debug-item { margin: 5px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Chat Avatar Debug Test</h1>
    
    <div class="debug-panel">
        <h3>Authentication Debug</h3>
        <div class="debug-item">User ID: <span id="userId">Not loaded</span></div>
        <div class="debug-item">User Name: <span id="userName">Not loaded</span></div>
        <div class="debug-item">User Email: <span id="userEmail">Not loaded</span></div>
        <div class="debug-item">User Photo URL: <span id="userPhoto">Not loaded</span></div>
        <div class="debug-item">User Photo Status: <span id="photoStatus">Not checked</span></div>
    </div>

    <button onclick="testSendMessage()">Send Test Message</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHcQGjP9Lhhe33dRCEhYpgw3PVlC-LG5A",
            authDomain: "medico-dibyaklinik.firebaseapp.com", 
            projectId: "medico-dibyaklinik",
            storageBucket: "medico-dibyaklinik.firebasestorage.app",
            messagingSenderId: "632267441991",
            appId: "1:632267441991:web:e7a83a9b7e0b63e2d41969"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Global auth object
        window.auth = auth;
        window.getIdToken = async () => {
            const user = auth.currentUser;
            if (user) {
                return await user.getIdToken();
            }
            throw new Error('User not authenticated');
        };

        // Debug function
        function updateDebugInfo() {
            const user = auth.currentUser;
            if (user) {
                document.getElementById('userId').textContent = user.uid;
                document.getElementById('userName').textContent = user.displayName || 'No display name';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userPhoto').textContent = user.photoURL || 'No photo URL';
                
                // Test if photo URL loads
                if (user.photoURL) {
                    const img = new Image();
                    img.onload = () => {
                        document.getElementById('photoStatus').textContent = 'Photo loads successfully';
                        document.getElementById('photoStatus').style.color = 'green';
                    };
                    img.onerror = () => {
                        document.getElementById('photoStatus').textContent = 'Photo failed to load';
                        document.getElementById('photoStatus').style.color = 'red';
                    };
                    img.src = user.photoURL;
                } else {
                    document.getElementById('photoStatus').textContent = 'No photo URL available';
                    document.getElementById('photoStatus').style.color = 'orange';
                }
            }
        }

        // Test send message function
        async function testSendMessage() {
            const user = auth.currentUser;
            if (!user) {
                alert('Please log in first');
                return;
            }

            try {
                const token = await user.getIdToken();
                const response = await fetch('https://praktekdrdibya.com/api/chat/send', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: 'Test message with avatar at ' + new Date().toLocaleTimeString(),
                        user_id: user.uid,
                        user_name: user.displayName || user.email,
                        user_photo: user.photoURL || null
                    })
                });
                
                const result = await response.json();
                console.log('Send result:', result);
                
                if (result.success) {
                    alert('Test message sent successfully! Check console for details.');
                } else {
                    alert('Failed to send message: ' + (result.message || 'Unknown error'));
                }
            } catch (err) {
                console.error('Error sending test message:', err);
                alert('Error: ' + err.message);
            }
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user);
                updateDebugInfo();
            } else {
                console.log('User not authenticated');
                // Redirect to login
                window.location.href = '/login.html';
            }
        });
    </script>

    <!-- Chat popup -->
    <script src="/scripts/chat-popup.js"></script>
</body>
</html>