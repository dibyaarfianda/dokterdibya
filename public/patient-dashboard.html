<!DOCTYPE html>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pasien - Dokter Dibya</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --success: #10b981;
            --danger: #ef4444;
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #303030 100%);
        }

        body {
            background: var(--bg-gradient);
            color: #ffffff;
            font-family: 'Poppins', 'Open Sans', sans-serif;
            font-weight: 300;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-100px) rotate(180deg); }
        }
        
        a {
            color: #47C6F8;
            text-decoration: none;
        }
        
        a:hover {
            color: #0FF;
            text-decoration: none;
        }

        /* Main Content */
        .dashboard-container {
            padding: 30px 15px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Cards */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(40, 167, 233, 0.3);
            border-color: #28a7e9;
        }
        
        .dashboard-card h3 {
            color: #28a7e9;
            font-size: 24px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .dashboard-card h3 i {
            margin-right: 10px;
            width: 30px;
        }
        
        .dashboard-card h3[onclick] {
            transition: color 0.3s;
        }
        
        .dashboard-card h3[onclick]:hover {
            color: #47C6F8;
        }
        
        #welcome-toggle-icon {
            transition: transform 0.3s;
        }
        
        /* Alert */
        .alert-info-custom {
            background: rgba(40, 167, 233, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 167, 233, 0.3);
            border-left: 4px solid #28a7e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #ffffff;
        }

        .alert-info-custom i {
            color: #28a7e9;
            margin-right: 10px;
        }

        .alert-success-custom {
            background: rgba(40, 233, 112, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 233, 112, 0.3);
            border-left: 4px solid #28e970;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #ffffff;
        }

        .alert-success-custom i {
            color: #28e970;
            margin-right: 10px;
        }

        .appointment-info-box {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .appointment-info-box p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .appointment-info-box strong {
            color: #28e970;
        }

        .cancel-appointment-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px 16px;
            background: #d9534f;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .cancel-appointment-btn:hover {
            background: #c9302c;
            transform: translateY(-2px);
        }

        .cancel-appointment-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
            z-index: 9999;
        }

        .dashboard-modal.active {
            display: flex;
        }

        .dashboard-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 25px;
            color: #ffffff;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .dashboard-modal-content h4 {
            margin-top: 0;
            color: #28a7e9;
            font-weight: 600;
        }

        .dashboard-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #bbbbbb;
            font-size: 22px;
            cursor: pointer;
        }

        .dashboard-modal-close:hover {
            color: #ffffff;
        }

        .cancel-summary {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .cancel-summary strong {
            color: #28a7e9;
        }

        .dashboard-modal textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #ffffff;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .modal-actions .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .modal-actions .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .modal-actions .btn-danger {
            background: #d9534f;
            color: #ffffff;
        }

        .modal-actions .btn-danger:hover {
            background: #c9302c;
            transform: translateY(-1px);
        }

        .modal-error {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 13px;
        }

        .dashboard-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a7e9;
            color: #ffffff;
            padding: 12px 18px;
            border-radius: 6px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10000;
        }

        .dashboard-toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .dashboard-toast.error {
            background: #d9534f;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-action-btn {
            padding: 25px 15px;
            background: #303030;
            border: 2px solid #28a7e9;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #28a7e9;
            display: block;
        }
        
        .quick-action-btn:hover {
            background: #28a7e9;
            color: #ffffff;
            text-decoration: none;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(40, 167, 233, 0.4);
        }
        
        .quick-action-btn i {
            font-size: 36px;
            display: block;
            margin-bottom: 10px;
        }
        
        .quick-action-btn div {
            font-size: 13px;
            line-height: 1.4;
        }

        /* Ultrasound Gallery */
        #ultrasound-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ultrasound-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ultrasound-item:hover {
            transform: scale(1.05);
            border-color: #28a7e9;
        }

        .ultrasound-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ultrasound-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 10px;
            color: #ffffff;
            font-size: 12px;
        }

        .ultrasound-item .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ultrasound-item:hover .delete-btn {
            opacity: 1;
        }

        .ultrasound-item .delete-btn:hover {
            background: rgba(239, 68, 68, 1);
        }

        /* My Documents Section */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .document-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .document-card:hover {
            border-color: #28a7e9;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(40, 167, 233, 0.2);
        }

        .document-card .doc-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .document-card .doc-icon.resume { background: rgba(40, 167, 233, 0.2); color: #28a7e9; }
        .document-card .doc-icon.usg { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .document-card .doc-icon.lab { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .document-card .doc-icon.other { background: rgba(168, 162, 158, 0.2); color: #a8a29e; }

        .document-card .doc-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 14px;
            line-height: 1.4;
        }

        .document-card .doc-date {
            font-size: 12px;
            color: #888888;
            margin-bottom: 12px;
        }

        .document-card .doc-actions {
            display: flex;
            gap: 8px;
        }

        .document-card .doc-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .document-card .doc-btn.view-btn {
            background: rgba(40, 167, 233, 0.2);
            color: #28a7e9;
            border: 1px solid rgba(40, 167, 233, 0.3);
        }

        .document-card .doc-btn.view-btn:hover {
            background: #28a7e9;
            color: #ffffff;
        }

        .document-card .doc-btn.download-btn {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .document-card .doc-btn.download-btn:hover {
            background: #22c55e;
            color: #ffffff;
        }

        .documents-empty {
            text-align: center;
            padding: 30px;
            color: #888888;
        }

        .documents-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #555555;
        }

        .documents-empty p {
            margin: 0;
            font-size: 14px;
        }

        .document-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .document-badge.new {
            background: rgba(40, 167, 233, 0.2);
            color: #28a7e9;
        }

        /* Profile Info */
        .profile-info {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-info li {
            padding: 12px 0;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-info li:last-child {
            border-bottom: none;
        }

        .profile-info strong {
            color: #28a7e9;
            font-weight: 500;
        }

        .profile-info span {
            color: #cccccc;
            text-align: right;
        }
        
        /* Buttons */
        .action-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #28a7e9;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 15px;
            transition: all 0.3s;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: 400;
        }
        
        .action-btn:hover {
            background: #0FF;
            color: #303030;
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .action-btn i {
            margin-right: 8px;
        }
        
        .action-btn-secondary {
            background: #505050;
        }
        
        .action-btn-secondary:hover {
            background: #606060;
            color: #ffffff;
        }
        
        .logout-btn {
            background: #d9534f;
        }
        
        .logout-btn:hover {
            background: #c9302c;
            color: #ffffff;
        }
        
        /* Empty State */
        .empty-state {
            color: #808080;
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* Navigation */
        .nav-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-bar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 40px;
        }

        .nav-links {
            display: flex;
            gap: 5px;
            margin-left: 15px;
        }

        .welcome-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .welcome-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }

        .welcome-title span {
            color: #0066FF;
        }

        .welcome-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin: 2px 0 0 0;
            line-height: 1.2;
        }

        .nav-bar a {
            color: #cccccc;
            padding: 10px 15px;
            display: inline-block;
            transition: color 0.3s;
        }

        .nav-bar a:hover {
            color: #28a7e9;
        }

        .nav-bar a i {
            margin-right: 5px;
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px 15px;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        .notification-bell:hover {
            transform: scale(1.1);
        }
        .notification-bell i {
            font-size: 22px;
            color: #cccccc;
            transition: color 0.3s;
        }
        .notification-bell:hover i {
            color: #28a7e9;
        }
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 8px;
            background: #dc3545;
            color: white;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border-radius: 50%;
            padding: 0 4px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Notification Inbox Modal Styles */
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
            cursor: pointer;
        }
        .notification-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .notification-item.unread {
            background: rgba(40,167,233,0.1);
            border-left: 3px solid #28a7e9;
        }
        .notification-item .notif-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .notification-item .notif-time {
            font-size: 11px;
            color: #888;
        }
        .notification-item .notif-title {
            font-weight: 600;
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 4px;
        }
        .notification-item .notif-message {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 0;
        }

        .user-avatar-nav {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            margin-right: 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .user-avatar-nav:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
        }

        .user-info-nav {
            display: flex;
            flex-direction: column;
            text-align: right;
        }

        .user-info-nav .user-name {
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
        }

        .user-info-nav .user-role {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            line-height: 1.2;
        }

        /* Dropdown Menu */
        .dropdown-menu-custom {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            padding: 8px 0;
            z-index: 1000;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .dropdown-menu-custom.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu-custom a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #ffffff;
            text-decoration: none;
            transition: background 0.2s;
            font-size: 14px;
        }

        .dropdown-menu-custom a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #28a7e9;
        }

        .dropdown-menu-custom a i {
            width: 18px;
            text-align: center;
            font-size: 16px;
        }

        .dropdown-menu-custom a.logout {
            color: #ef4444;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 4px;
        }

        .dropdown-menu-custom a.logout:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 24px;
                margin: 15px 0 5px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card h3 {
                font-size: 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .quick-action-btn {
                padding: 20px 10px;
            }
            
            .quick-action-btn i {
                font-size: 28px;
            }
            
            .quick-action-btn div {
                font-size: 12px;
            }
            
            .profile-info li {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .profile-info span {
                text-align: left;
            }
            
            .nav-bar {
                text-align: center;
            }

            .nav-bar .container {
                flex-direction: column;
                gap: 10px;
            }

            .nav-links {
                margin-left: 0;
                width: 100%;
            }

            .welcome-text {
                text-align: center;
            }

            .welcome-title {
                font-size: 16px;
            }

            .welcome-subtitle {
                font-size: 12px;
            }

            .nav-bar a {
                padding: 8px 12px;
                font-size: 14px;
            }

            .user-info-nav {
                display: none;
            }

            .user-avatar-nav {
                margin-right: 0;
            }

            .avatar-circle {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-container {
                padding: 20px 10px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .dashboard-card h3 {
                font-size: 18px;
            }
            
            .welcome-message p {
                font-size: 14px !important;
            }
            
            .welcome-message strong[style*="font-size: 20px"] {
                font-size: 17px !important;
            }
            
            .dashboard-card p {
                font-size: 14px;
            }
        }

        /* Toast animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="container">
            <div class="nav-links">
                <div class="welcome-text">
                    <h2 class="welcome-title">dokter<span style="color: #0066FF;">DIBYA</span></h2>
                    <p class="welcome-subtitle">Portal privat milik Anda</p>
                </div>
            </div>
            <!-- Notification Bell -->
            <div class="notification-bell" id="notification-bell" onclick="openNotificationsInbox()" title="Notifikasi">
                <i class="fa fa-bell"></i>
                <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
            </div>
      <div class="user-avatar-nav" onclick="toggleDropdown(event)" style="
    padding-left: `00;
    padding-left: 300px;
">
                <div class="avatar-circle" id="user-avatar">
                    <img id="user-avatar-img" src="" alt="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="user-avatar-initials">NA</span>
                </div>
                <div class="user-info-nav">
                    <div class="user-name" id="user-name-nav">Nanda Ananda</div>
                    <div class="user-role">Pasien</div>
                </div>
                <div class="dropdown-menu-custom" id="user-dropdown">
                    <a href="#" onclick="openProfileModal(); toggleDropdown(event);">
                        <i class="fa fa-edit"></i>
                        <span>Edit Profil</span>
                    </a>
                    <a href="#" onclick="openProfileViewModal(event)">
                        <i class="fa fa-cog"></i>
                        <span>Setting</span>
                    </a>
                    <a href="#" onclick="logout(event)" class="logout">
                        <i class="fa fa-sign-out"></i>
                        <span>Log out</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Welcome Message -->
        <div class="dashboard-card welcome-message" id="welcome-card" style="margin-bottom: 30px;">
            <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleWelcomeMessage()">
                <span><i class="fa fa-heart"></i> Selamat Datang</span>
                <i class="fa fa-chevron-down" id="welcome-toggle-icon"></i>
            </h3>
            <div id="welcome-content" style="line-height: 1.9; color: #e0e0e0; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 400;">
                <p style="font-size: 16px;">Halaman ini adalah ruang khusus bagi Anda â€” tempat saya membantu Anda, memantau kehamilan atau kesehatan kandungan Anda secara berkala dan privat. Semua catatan dan informasi di sini bersifat <strong style="color: #28a7e9; font-weight: 600;">rahasia</strong>. Mohon untuk tidak membagikan halaman rekam medis kepada orang selain keluarga inti/ keluarga yang dipercaya. Karena itulah keamanan sistem ini menjadi prioritas saya dengan menerapkan proteksi berlapis dan enkripsi untuk mencegah peretasan.</p>
                                
                <p style="font-size: 16px;">Adanya <strong style="color: #28a7e9; font-weight: 600;">dokterDIBYA</strong> berawal dari keinginan <i>sederhana</i> saya, yaitu agar setiap pasien bisa tetap terhubung dengan dokter pilihannya, tanpa batasan rumah sakit, tempat, atau waktu. Update selalu dengan perubahan jadwal dari saya, reminding jadwal kontrol, booking slot dengan mudah, dan bahkan kedepan bukan tidak mungkin konsultasi secara online dengan jadwal yang disepakati!</p>
                
                <p style="font-size: 16px;">Walaupun demikian saya paham, banyak tantangan dan kesulitan dalam memulai hal baru. Tapi saya percaya, langkah kecil ini bisa membawa perubahan besar menuju pelayanan berkesinambungan dari dokter favorit Anda. Sebelum kita memulai perjalanan ini, mohon mengisi data pribadi dan riwayat medis, data kehamilan, masalah kandungan, riwayat KB. Besar harapan saya, Anda mengisi dengan lengkap sehingga dapat menjadi modalitas bagi saya dalam pemilihan terapi dan layanan terbaik untuk Anda.</p>
                
                <p style="margin-top: 20px; font-size: 16px;">Terima kasih telah menjadi bagian dari <strong style="color: #28a7e9; font-weight: 600;">"modern therapy without boundary"</strong> â€” pendampingan dan terapi berkelanjutan, di mana pun dan kapan pun Anda membutuhkannya.</p>
                
                <p style="margin-top: 30px; text-align: right; color: #28a7e9; font-size: 17px;">
                    <strong style="font-weight: 500;">Salam hangat,</strong><br>
                    <strong style="font-size: 20px; font-weight: 600;">dokter Anda</strong>
                </p>
            </div>
        </div>
        
        <!-- Alert for first-time users -->
        <div class="alert-info-custom" id="first-time-alert" style="display: none;">
            <i class="fa fa-info-circle"></i> <strong>Langkah Selanjutnya:</strong> 
            Lengkapi formulir identitas pribadi Anda untuk memulai journey Anda.
        </div>

        <!-- Announcements Section -->
        <div class="dashboard-card" id="announcements-section" style="margin-bottom: 30px;">
            <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleAnnouncementsSection()">
                <span><i class="fa fa-bullhorn"></i> Pengumuman</span>
                <i class="fa fa-chevron-down" id="announcements-toggle-icon"></i>
            </h3>
            <div id="announcements-content">
                <div id="announcements-container">
                    <!-- Announcements will be loaded here -->
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 10px;">Memuat pengumuman...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two Column Layout: Appointments & Journey Book -->
        <div class="row" style="margin-bottom: 30px;">
            <!-- Left Column: Upcoming Appointments (Smaller) -->
            <div class="col-md-5">
                <!-- Janji Temu dr. Dibya -->
                <div class="dashboard-card" id="appointments-section" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-calendar-check-o"></i> Janji Temu dr. Dibya</h3>
                    <div id="booking-status-container">
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Belum ada janji temu yang dijadwalkan
                        </p>
                    </div>
                    <a href="/booking-appointment.html" class="action-btn" id="booking-create-btn">
                        <i class="fa fa-plus"></i> Buat Janji Temu
                    </a>
                </div>

                <!-- Riwayat Janji Temu -->
                <div class="dashboard-card" id="appointments-history-section" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-history"></i> Riwayat Janji Temu</h3>
                    <div id="booking-history-container">
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Belum ada riwayat janji temu
                        </p>
                    </div>
                </div>

                <!-- Galeri USG dari Dokter -->
                <div class="dashboard-card" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-picture-o"></i> Foto USG</h3>
                    <p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">Foto USG yang dikirim oleh dokter Anda</p>
                    <div id="ultrasound-gallery-mini">
                        <p class="empty-state">
                            <i class="fa fa-image"></i>
                            Belum ada foto USG dari dokter
                        </p>
                    </div>
                </div>

                <!-- Dokumen Medis Saya -->
                <div class="dashboard-card" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-folder-open"></i> Dokumen Medis Saya</h3>
                    <div id="my-documents-container">
                        <div class="documents-loading" style="text-align: center; padding: 20px;">
                            <i class="fa fa-spinner fa-spin"></i> Memuat dokumen...
                        </div>
                    </div>
                </div>

                <!-- Rekam Medis -->
                <div class="dashboard-card" style="min-height: 400px; display: flex; flex-direction: column;">
                    <h3 style="font-size: 19.2px;"><i class="fa fa-file-text"></i> IDENTITAS PRIBADI</h3>
                    <div style="padding: 15px 0; flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                        <a href="/patient-intake.html" class="action-btn" style="display: block; text-align: center;">
                            <i class="fa fa-edit"></i> Lihat & Edit Identitas Pribadi
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column: Journey Book with Image (Larger) -->
            <div class="col-md-7">
                <div class="dashboard-card" style="cursor: pointer; position: relative; overflow: hidden; min-height: 400px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border: 1px solid rgba(212, 175, 55, 0.3);" onclick="window.location.href='/perjalanan-ibu.html'">
                    <!-- Background Pattern -->
                    <div style="position: absolute; top: 0; right: 0; bottom: 0; left: 0; opacity: 0.08; background-image: url('/images/dokter-dibya-book/1.png'); background-size: cover; background-position: center;"></div>

                    <!-- Decorative Gold Corner Accents -->
                    <div style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; border-top: 2px solid #d4af37; border-left: 2px solid #d4af37;"></div>
                    <div style="position: absolute; top: 0; right: 0; width: 60px; height: 60px; border-top: 2px solid #d4af37; border-right: 2px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 0; left: 0; width: 60px; height: 60px; border-bottom: 2px solid #d4af37; border-left: 2px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 0; right: 0; width: 60px; height: 60px; border-bottom: 2px solid #d4af37; border-right: 2px solid #d4af37;"></div>

                    <!-- Content Overlay -->
                    <div style="position: relative; z-index: 1; padding: 40px; text-align: center;">
                        <div style="background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(10px); border-radius: 12px; padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); border: 1px solid rgba(212, 175, 55, 0.2);">
                            <h2 style="color: #f5f5f5; font-size: 32px; font-weight: 400; margin-bottom: 10px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; letter-spacing: 3px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-style: italic;">Perjalanan menjadi Ibu</h2>
                            <p style="font-size: 14px; font-style: italic; margin-bottom: 25px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">by <span style="color: #ffffff; font-weight: 600;">dokter</span><span style="color: var(--primary); font-weight: 600;">DIBYA</span></p>

                            <!-- Preview Image -->
                            <div style="margin: 25px 0;">
                                <img src="/images/dokter-dibya-book/1.png" alt="Perjalanan menjadi Ibu" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); border: 2px solid rgba(212, 175, 55, 0.3);">
                            </div>

                            <div style="margin-top: 25px; padding: 15px; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border-left: 4px solid #d4af37;">
                                <p style="color: #e0e0e0; font-size: 15px; line-height: 1.6; margin: 0; font-family: 'Georgia', serif;">
                                    <i class="fa fa-hand-pointer-o" style="color: #d4af37; margin-right: 8px;"></i>
                                    <strong style="color: #d4af37;">Klik untuk membuka</strong> buku interaktif berisi momen indah perjalanan kehamilan Anda
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Quick Actions -->
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h3><i class="fa fa-bolt"></i> Aksi Cepat</h3>
                    <div class="quick-actions">
                        <a href="/patient-intake.html" class="quick-action-btn">
                            <i class="fa fa-file-text"></i>
                            <div>Formulir<br>Rekam Medis Awal</div>
                        </a>
                        <a href="/practice-locations.html" class="quick-action-btn">
                            <i class="fa fa-calendar"></i>
                            <div>Jadwal &<br>Janji Konsultasi</div>
                        </a>
                        <a href="#" class="quick-action-btn" onclick="alert('Jadwal USG segera hadir!'); return false;">
                            <i class="fa fa-heartbeat"></i>
                            <div>USG &amp;<br>Imaging</div>
                        </a>
                        <a href="#" class="quick-action-btn" onclick="alert('Layanan Lab segera hadir!'); return false;">
                            <i class="fa fa-flask"></i>
                            <div>Lab &amp;<br>Hasil Tes</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-edit"></i> Edit Profil</h4>
                </div>
                <div class="modal-body">
                    <form id="profile-form">
                        <!-- Profile Picture Upload -->
                        <div class="form-group">
                            <label style="color: #28a7e9;">Foto Profil</label>
                            <div style="text-align: center; margin-bottom: 15px;">
                                <img id="edit-profile-picture-preview"
                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E"
                                     alt="Preview"
                                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #28a7e9; margin-bottom: 10px; cursor: pointer;"
                                     onclick="document.getElementById('edit-profile-picture-file').click()">
                                <div style="margin-top: 5px;">
                                    <label for="edit-profile-picture-file" class="btn btn-sm" style="background: rgba(40,167,233,0.2); border: 1px solid #28a7e9; color: #28a7e9; cursor: pointer;">
                                        <i class="fa fa-camera"></i> Pilih Foto
                                    </label>
                                </div>
                            </div>
                            <input type="file" id="edit-profile-picture-file" accept="image/jpeg,image/png,image/webp" style="display: none;">
                            <input type="hidden" id="edit-profile-picture" value="">
                            <small style="color: #999;">Klik foto atau tombol untuk upload (Maks. 2MB, format: JPEG, PNG, WebP)</small>
                            <div id="photo-upload-progress" style="display: none; margin-top: 10px;">
                                <div style="background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div id="photo-upload-bar" style="height: 4px; background: #28a7e9; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <small style="color: #28a7e9;">Mengupload foto...</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="color: #28a7e9;">Nama Lengkap *</label>
                            <input type="text" class="form-control" id="edit-fullname" required
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Email <small style="color: #888;">(tidak dapat diubah)</small></label>
                            <input type="email" class="form-control" id="edit-email" readonly disabled
                                   style="background: rgba(255,255,255,0.02); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: #888; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Nomor WhatsApp *</label>
                            <input type="tel" class="form-control" id="edit-phone" required
                                   placeholder="+62812345678"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Tanggal Lahir</label>
                            <input type="date" class="form-control" id="edit-birthdate"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Umur</label>
                            <input type="number" class="form-control" id="edit-age"
                                   placeholder="Otomatis terisi dari tanggal lahir"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="alert" id="profile-error" style="display: none; background: rgba(217,83,79,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(217,83,79,0.3); color: #ffffff;"></div>
                        <div class="alert" id="profile-success" style="display: none; background: rgba(40,167,233,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(40,167,233,0.3); color: #ffffff;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-lock"></i> <span id="password-modal-title">Set Password</span></h4>
                </div>
                <div class="modal-body">
                    <form id="password-form">
                        <!-- Old Password (only for change password) -->
                        <div class="form-group" id="old-password-group" style="display: none;">
                            <label style="color: #28a7e9;">Password Lama *</label>
                            <input type="password" class="form-control" id="old-password" name="current_password" autocomplete="current-password" 
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        
                        <!-- New Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;"><span id="new-pass-label">Password</span> *</label>
                            <input type="password" class="form-control" id="new-password" name="new_password" autocomplete="new-password" required
                                   placeholder="Minimal 6 karakter"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                            <small style="color: #999;">Minimal 6 karakter</small>
                        </div>
                        
                        <!-- Confirm Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;">Konfirmasi Password *</label>
                            <input type="password" class="form-control" id="confirm-password" name="confirm_password" autocomplete="new-password" required
                                   placeholder="Ulangi password"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>

                        <div class="alert" id="password-error" style="display: none; background: #3a1a1a; border: 1px solid #d9534f; color: #ffffff;"></div>
                        <div class="alert" id="password-success" style="display: none; background: #1a3a2a; border: 1px solid #28a7e9; color: #ffffff;"></div>
                        
                        <div id="password-info" style="background: #1a2a3a; border: 1px solid #28a7e9; padding: 12px; border-radius: 4px; margin-top: 15px;">
                            <p style="margin: 0; font-size: 0.9em; color: #28a7e9;">
                                <i class="fa fa-info-circle"></i> 
                                <span id="password-info-text">Setelah set password, Anda dapat login menggunakan email dan password.</span>
                            </p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="savePassword()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> <span id="save-password-btn-text">Set Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View Modal (Settings) -->
    <div class="modal fade" id="profileViewModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-cog"></i> Setting</h4>
                </div>
                <div class="modal-body" id="profile-section">
                    <!-- Profile Picture -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="position: relative; display: inline-block;">
                            <img id="profile-picture"
                                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='48' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E"
                                 alt="Profile Picture"
                                 style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #28a7e9;">
                        </div>
                    </div>

                    <ul class="profile-info">
                        <li>
                            <strong>Nama Lengkap</strong>
                            <span id="profile-name">-</span>
                        </li>
                        <li>
                            <strong>Email</strong>
                            <span id="profile-email">-</span>
                        </li>
                        <li>
                            <strong>Nomor Telepon</strong>
                            <span id="profile-phone">-</span>
                        </li>
                        <li>
                            <strong>Tanggal Lahir</strong>
                            <span id="profile-birthdate">-</span>
                        </li>
                        <li>
                            <strong>Terdaftar Sejak</strong>
                            <span id="profile-registered">-</span>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040; display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-default" onclick="openProfileModal()"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        <i class="fa fa-edit"></i> Edit Profil
                    </button>
                    <button type="button" class="btn btn-primary" onclick="openPasswordModal()" id="password-btn-modal"
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-lock"></i> <span id="password-btn-text-modal">Set Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Ultrasound Modal -->
    <div class="modal fade" id="uploadUltrasoundModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-upload"></i> Upload Foto USG</h4>
                </div>
                <div class="modal-body">
                    <form id="ultrasound-upload-form">
                        <div class="form-group">
                            <label style="color: #28a7e9;">URL Foto USG *</label>
                            <input type="url" class="form-control" id="ultrasound-url" required
                                   placeholder="Masukkan URL foto USG (misalnya dari Imgur, Google Drive, dll)"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                            <small style="color: #999;">Upload foto ke Imgur atau layanan hosting gambar lainnya, lalu paste URL-nya di sini</small>
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Tanggal USG *</label>
                            <input type="date" class="form-control" id="ultrasound-date" required
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Keterangan (Opsional)</label>
                            <textarea class="form-control" id="ultrasound-notes" rows="3"
                                      placeholder="Tambahkan catatan atau keterangan foto USG"
                                      style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;"></textarea>
                        </div>
                        <div class="alert" id="ultrasound-error" style="display: none; background: rgba(217,83,79,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(217,83,79,0.3); color: #ffffff;"></div>
                        <div class="alert" id="ultrasound-success" style="display: none; background: rgba(40,167,233,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(40,167,233,0.3); color: #ffffff;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveUltrasound()"
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-modal" id="cancel-appointment-modal" aria-hidden="true">
        <div class="dashboard-modal-content" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
            <button type="button" class="dashboard-modal-close" id="cancel-modal-close" aria-label="Tutup">&times;</button>
            <h4 id="cancel-modal-title">Batalkan Janji Konsultasi</h4>
            <div class="cancel-summary" id="cancel-modal-summary"></div>
            <label for="cancel-reason-input" style="color: #28a7e9; font-weight: 600; display: block; margin-bottom: 8px;">Alasan Pembatalan *</label>
            <textarea id="cancel-reason-input" placeholder="Tuliskan alasan pembatalan Anda (minimal 10 karakter)"></textarea>
            <div id="cancel-modal-error" class="modal-error" style="display: none;"></div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="cancel-modal-cancel-btn">Batal</button>
                <button type="button" class="btn-danger" id="cancel-modal-submit-btn">Ya, Batalkan</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Socket.io for real-time announcements -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <!-- Markdown and sanitization libraries for enhanced announcements -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="js/announcements-dashboard.js?v=20251120"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
        const user = JSON.parse(localStorage.getItem('patient_user') || '{}');

        console.log('[DASHBOARD] Auth check - token:', token ? 'EXISTS' : 'MISSING');
        console.log('[DASHBOARD] Auth check - user:', user);
        console.log('[DASHBOARD] Auth check - user.id:', user.id);

        if (!token || !user.id) {
            // Not authenticated, redirect to login
            console.log('[DASHBOARD] Not authenticated, redirecting to login');
            window.location.href = '/index.html#masuk';
        } else {
            console.log('[DASHBOARD] Authenticated, loading profile...');
            // Load user profile
            loadUserProfile();
            // Load ultrasound images
            loadUltrasoundImages();
        }

        async function loadUserProfile() {
            try {
                // Add cache-busting timestamp to prevent browser caching
                const response = await fetch('/api/patients/profile?_=' + Date.now(), {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }

                const data = await response.json();
                const profile = data.user;

                // Check if profile is completed, redirect if not
                if (profile.profile_completed !== 1) {
                    window.location.href = '/complete-profile.html';
                    return;
                }

                // Update UI with profile data
                document.getElementById('profile-name').textContent = profile.fullname;
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-phone').textContent = profile.phone || 'Belum diisi';

                // Update medical record name
                const medicalRecordName = document.getElementById('medical-record-name');
                if (medicalRecordName && profile.fullname) {
                    medicalRecordName.textContent = profile.fullname;
                }

                // Update navigation avatar
                const userNameNav = document.getElementById('user-name-nav');
                if (userNameNav && profile.fullname) {
                    userNameNav.textContent = profile.fullname;
                }

                // Update avatar - show photo if available, otherwise show initials
                const avatarImg = document.getElementById('user-avatar-img');
                const avatarInitials = document.getElementById('user-avatar-initials');

                // Always prepare initials first (needed for fallback when image fails)
                let initials = 'NA';
                if (profile.fullname) {
                    const nameParts = profile.fullname.trim().split(' ');
                    if (nameParts.length === 1) {
                        initials = nameParts[0].substring(0, 2).toUpperCase();
                    } else {
                        initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                    }
                }
                if (avatarInitials) {
                    avatarInitials.textContent = initials;
                }

                if (profile.profile_picture && avatarImg && avatarInitials) {
                    avatarImg.src = profile.profile_picture;
                    avatarImg.style.display = 'block';
                    avatarInitials.style.display = 'none';
                    avatarImg.onerror = function() {
                        // If image fails to load, show initials
                        this.style.display = 'none';
                        avatarInitials.style.display = 'block';
                    };
                } else if (avatarInitials) {
                    // No profile picture, show initials
                    avatarInitials.style.display = 'block';
                    if (avatarImg) avatarImg.style.display = 'none';
                }

                // Update profile picture
                const profilePicture = document.getElementById('profile-picture');
                if (profile.profile_picture) {
                    profilePicture.src = profile.profile_picture;
                    profilePicture.onerror = function() {
                        // If image fails to load, use default
                        this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='48' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E";
                    };
                }

                // Format birth date - avoid timezone issues by parsing date parts directly
                if (profile.birth_date) {
                    let birthDateStr = profile.birth_date;
                    if (birthDateStr.includes('T')) {
                        birthDateStr = birthDateStr.split('T')[0];
                    }
                    // Parse as local date to avoid timezone shift
                    const [year, month, day] = birthDateStr.split('-').map(Number);
                    const birthDate = new Date(year, month - 1, day); // month is 0-indexed
                    document.getElementById('profile-birthdate').textContent = birthDate.toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('profile-birthdate').textContent = 'Belum diisi';
                }
                
                // Format registration date
                const regDate = new Date(profile.registration_date);
                document.getElementById('profile-registered').textContent = regDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Store profile data for editing
                window.currentProfile = profile;

                // Check if user has password set
                hasPassword = profile.has_password === 1 || profile.password !== null;
                if (hasPassword) {
                    const passwordBtnText = document.getElementById('password-btn-text-modal');
                    if (passwordBtnText) {
                        passwordBtnText.textContent = 'Ubah Password';
                    }
                } else {
                    const passwordBtnText = document.getElementById('password-btn-text-modal');
                    if (passwordBtnText) {
                        passwordBtnText.textContent = 'Set Password';
                    }
                }

                // Update intake button appearance and hide alert if completed
                if (profile.intake_completed === 1) {
                    updateIntakeButtonCompleted();
                    // Hide "Langkah Selanjutnya" alert if intake is completed
                    document.getElementById('first-time-alert').style.display = 'none';
                    // Collapse welcome message
                    document.getElementById('welcome-content').style.display = 'none';
                    document.getElementById('welcome-toggle-icon').classList.remove('fa-chevron-down');
                    document.getElementById('welcome-toggle-icon').classList.add('fa-chevron-up');
                } else {
                    // Check if first time user (registered within last 24 hours) and intake not completed
                    const hoursSinceReg = (Date.now() - regDate.getTime()) / (1000 * 60 * 60);
                    if (hoursSinceReg < 24) {
                        document.getElementById('first-time-alert').style.display = 'block';
                    }
                }

                // Load booking status and appointment alerts
                loadBookingStatus();

                // Setup real-time booking updates
                setupRealtimeBookingUpdates();

                loadVisitInvoices();

            } catch (error) {
                console.error('Error loading profile:', error);
                // Token might be invalid, logout
                logout();
            }
        }
        
        async function loadBookingStatus() {
            const container = document.getElementById('booking-status-container');

            if (!container) return;

            container.innerHTML = `
                <p style="text-align: center; color: #999;">
                    <i class="fa fa-spinner fa-spin"></i> Memuat status booking...
                </p>
            `;

            try {
                const response = await fetch('/api/sunday-appointments/patient', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Gagal memuat status booking');
                }

                const data = await response.json();
                const appointments = Array.isArray(data.appointments) ? data.appointments : [];

                renderBookingStatus(appointments);
            } catch (error) {
                console.error('Error loading appointments:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-exclamation-triangle"></i>
                        <p>Gagal memuat status booking. Silakan coba lagi.</p>
                    </div>
                `;
            }
        }

        // Real-time booking updates via Socket.IO
        function setupRealtimeBookingUpdates() {
            // Wait for socket from announcements-dashboard.js
            function waitForSocket(callback, retries = 0) {
                if (window.socket || (typeof socket !== 'undefined' && socket)) {
                    callback(window.socket || socket);
                } else if (retries < 20) {
                    setTimeout(() => waitForSocket(callback, retries + 1), 250);
                } else {
                    console.warn('[PatientDashboard] Socket not available for real-time booking updates');
                }
            }

            waitForSocket((sock) => {
                console.log('[PatientDashboard] Setting up real-time updates');

                // Listen for booking status updates
                sock.on('booking:update', (data) => {
                    console.log('[PatientDashboard] Booking updated:', data);
                    // Reload booking status to reflect changes
                    loadBookingStatus();
                    // Show notification
                    showBookingNotification(`Status booking Anda telah diupdate: ${data.booking?.status || 'diperbarui'}`, 'info');
                });

                // Listen for booking cancellations
                sock.on('booking:cancel', (data) => {
                    console.log('[PatientDashboard] Booking cancelled:', data);
                    loadBookingStatus();
                    showBookingNotification('Booking Anda telah dibatalkan', 'warning');
                });

                // Listen for new notifications
                sock.on('notification:new', (data) => {
                    console.log('[PatientDashboard] New notification:', data);
                    // Update notification badge
                    updateNotificationBadge();
                    // Show toast notification
                    showBookingNotification(data.notification?.title || 'Notifikasi baru', 'info');
                });

                console.log('[PatientDashboard] Real-time updates enabled');
            });
        }

        function showBookingNotification(message, type) {
            const bgColor = type === 'warning' ? '#f39c12' : type === 'error' ? '#e74c3c' : '#28a7e9';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                max-width: 350px;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fa fa-bell"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function renderBookingStatus(appointments) {
            const container = document.getElementById('booking-status-container');
            const historyContainer = document.getElementById('booking-history-container');
            if (!container) return;

            // Filter upcoming appointments (exclude completed, cancelled, no_show)
            const upcoming = (appointments || [])
                .filter(apt => !apt.isPast && apt.status !== 'cancelled' && apt.status !== 'no_show' && apt.status !== 'completed')
                .sort((a, b) => {
                    const dateDiff = new Date(a.appointment_date) - new Date(b.appointment_date);
                    if (dateDiff !== 0) return dateDiff;
                    const sessionDiff = (a.session || 0) - (b.session || 0);
                    if (sessionDiff !== 0) return sessionDiff;
                    return (a.slot_number || 0) - (b.slot_number || 0);
                });

            // Filter completed appointments for history
            const completed = (appointments || [])
                .filter(apt => apt.status === 'completed')
                .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date)); // Most recent first

            // Render history section
            if (historyContainer) {
                if (completed.length === 0) {
                    historyContainer.innerHTML = `
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Belum ada riwayat janji temu
                        </p>
                    `;
                } else {
                    historyContainer.innerHTML = completed.slice(0, 5).map(apt => `
                        <div class="history-item" style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #333;">${apt.dateFormatted || '-'}</div>
                                <div style="font-size: 12px; color: #666;">${apt.sessionLabel || '-'} - ${apt.time || '-'} WIB</div>
                            </div>
                            <span style="background: #28a745; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                                <i class="fa fa-check"></i> Selesai
                            </span>
                        </div>
                    `).join('');
                }
            }

            if (upcoming.length === 0) {
                container.innerHTML = `
                    <p class="empty-state">
                        <i class="fa fa-calendar-o"></i>
                        Belum ada janji temu yang dijadwalkan
                    </p>
                `;
                return;
            }

            const nextAppointment = upcoming[0];
            const statusInfo = getBookingStatusInfo(nextAppointment.status);
            const notes = nextAppointment.notes ? `<p style="margin-top: 10px;"><strong>Catatan Klinik:</strong><br>${escapeText(nextAppointment.notes)}</p>` : '';

            const startDateObj = nextAppointment.startDateTime ? new Date(nextAppointment.startDateTime) : null;
            const arrivalTime = nextAppointment.arrivalTimeFormatted
                || (startDateObj && !isNaN(startDateObj.getTime())
                    ? new Date(startDateObj.getTime() - (15 * 60 * 1000)).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    : null);

            const arrivalInfo = arrivalTime
                ? `Mohon hadir sekitar pukul ${arrivalTime} WIB (15 menit sebelum jadwal).`
                : 'Mohon hadir 15 menit sebelum waktu yang dipilih.';

            const slotNumber = Number(nextAppointment.slot_number);
            const slotInfo = Number.isFinite(slotNumber) && slotNumber > 0
                ? `<p><strong>Nomor Antrian:</strong> ${slotNumber}</p>`
                : '';

            const timeLabel = nextAppointment.time ? `${nextAppointment.time} WIB` : '-';

            const canCancel = !nextAppointment.isPast && ['pending', 'confirmed'].includes((nextAppointment.status || '').toLowerCase());
            const actionButtons = canCancel
                ? `<button type="button" class="cancel-appointment-btn" data-appointment-id="${nextAppointment.id}"><i class="fa fa-times-circle"></i> Batalkan Janji</button>`
                : '';

            container.innerHTML = `
                <div class="appointment-info-box">
                    <p><strong>Status:</strong> <span style="color: ${statusInfo.color}; font-weight: 600;">${statusInfo.label}</span></p>
                    <p><strong>Tanggal:</strong> ${nextAppointment.dateFormatted}</p>
                    <p><strong>Jam Konsultasi:</strong> ${timeLabel}</p>
                    <p><strong>Sesi:</strong> ${nextAppointment.sessionLabel || '-'}</p>
                    ${slotInfo}
                    <p>${statusInfo.message}</p>
                    <p>${arrivalInfo}</p>
                    ${notes}
                    ${actionButtons}
                </div>
            `;

            if (canCancel) {
                const cancelBtn = container.querySelector('.cancel-appointment-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => openCancelModal(nextAppointment));
                }
            }
        }

        const cancellationState = {
            appointmentId: null
        };

        function openCancelModal(appointment) {
            if (!appointment || !appointment.id) return;

            cancellationState.appointmentId = appointment.id;

            const summary = document.getElementById('cancel-modal-summary');
            if (summary) {
                const timeLabel = appointment.time ? `${escapeText(appointment.time)} WIB` : '-';
                summary.innerHTML = `
                    <p style="margin-top: 0; margin-bottom: 8px;">Anda akan membatalkan janji konsultasi berikut:</p>
                    <p style="margin: 4px 0;"><strong>Tanggal:</strong> ${escapeText(appointment.dateFormatted)}</p>
                    <p style="margin: 4px 0;"><strong>Sesi:</strong> ${escapeText(appointment.sessionLabel || '-')}</p>
                    <p style="margin: 4px 0;"><strong>Jam:</strong> ${timeLabel}</p>
                `;
            }

            const reasonInput = document.getElementById('cancel-reason-input');
            if (reasonInput) {
                reasonInput.value = '';
            }

            const errorEl = document.getElementById('cancel-modal-error');
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }

            setCancelModalLoading(false);

            const modal = document.getElementById('cancel-appointment-modal');
            if (modal) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            }

            if (reasonInput) {
                setTimeout(() => {
                    reasonInput.focus();
                }, 50);
            }
        }

        function closeCancelModal() {
            const modal = document.getElementById('cancel-appointment-modal');
            if (modal) {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
            const errorEl = document.getElementById('cancel-modal-error');
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }
            setCancelModalLoading(false);
            cancellationState.appointmentId = null;
        }

        function setCancelModalLoading(isLoading) {
            const submitBtn = document.getElementById('cancel-modal-submit-btn');
            const cancelBtn = document.getElementById('cancel-modal-cancel-btn');
            const closeBtn = document.getElementById('cancel-modal-close');

            if (submitBtn) {
                submitBtn.disabled = !!isLoading;
                submitBtn.textContent = isLoading ? 'Memproses...' : 'Ya, Batalkan';
            }

            if (cancelBtn) {
                cancelBtn.disabled = !!isLoading;
            }

            if (closeBtn) {
                closeBtn.disabled = !!isLoading;
            }
        }

        async function submitCancellation() {
            if (!cancellationState.appointmentId) return;

            const reasonInput = document.getElementById('cancel-reason-input');
            const errorEl = document.getElementById('cancel-modal-error');

            const reasonValue = reasonInput ? reasonInput.value.trim() : '';

            if (reasonValue.length < 10) {
                if (errorEl) {
                    errorEl.textContent = 'Alasan pembatalan minimal 10 karakter.';
                    errorEl.style.display = 'block';
                }
                if (reasonInput) {
                    reasonInput.focus();
                }
                return;
            }

            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }

            setCancelModalLoading(true);

            try {
                const response = await fetch(`/api/sunday-appointments/${cancellationState.appointmentId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reasonValue })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Gagal membatalkan janji temu');
                }

                closeCancelModal();
                showTemporaryAlert('Janji temu berhasil dibatalkan.');
                loadBookingStatus();
            } catch (error) {
                if (errorEl) {
                    errorEl.textContent = error.message || 'Terjadi kesalahan saat membatalkan janji temu.';
                    errorEl.style.display = 'block';
                }
            } finally {
                setCancelModalLoading(false);
            }
        }

        function showTemporaryAlert(message, type = 'success') {
            if (!message) return;

            const existing = document.getElementById('dashboard-toast');
            if (existing) {
                existing.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'dashboard-toast';
            toast.className = 'dashboard-toast';
            if (type === 'error') {
                toast.classList.add('error');
            }
            toast.textContent = message;
            document.body.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('visible');
            });

            setTimeout(() => {
                toast.classList.remove('visible');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                }, { once: true });
            }, 3200);
        }

        const cancelSubmitBtn = document.getElementById('cancel-modal-submit-btn');
        if (cancelSubmitBtn) {
            cancelSubmitBtn.addEventListener('click', submitCancellation);
        }

        const cancelCloseBtn = document.getElementById('cancel-modal-close');
        if (cancelCloseBtn) {
            cancelCloseBtn.addEventListener('click', closeCancelModal);
        }

        const cancelBackBtn = document.getElementById('cancel-modal-cancel-btn');
        if (cancelBackBtn) {
            cancelBackBtn.addEventListener('click', closeCancelModal);
        }

        const cancelModal = document.getElementById('cancel-appointment-modal');
        if (cancelModal) {
            cancelModal.addEventListener('click', (event) => {
                if (event.target === cancelModal) {
                    closeCancelModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modalElement = document.getElementById('cancel-appointment-modal');
                if (modalElement && modalElement.classList.contains('active')) {
                    event.preventDefault();
                    closeCancelModal();
                }
            }
        });

        function getBookingStatusInfo(status) {
            const normalizedStatus = (status || '').toLowerCase();
            const statusMap = {
                confirmed: {
                    label: 'Dikonfirmasi',
                    color: '#28e970',
                    message: 'Janji temu Anda telah dikonfirmasi. Tim klinik menunggu kehadiran Anda.'
                },
                pending: {
                    label: 'Menunggu Konfirmasi',
                    color: '#ffd166',
                    message: 'Permintaan booking Anda sudah kami terima dan sedang menunggu konfirmasi dari admin.'
                },
                completed: {
                    label: 'Selesai',
                    color: '#7f8c8d',
                    message: 'Janji temu ini telah selesai.'
                },
                cancelled: {
                    label: 'Dibatalkan',
                    color: '#d9534f',
                    message: 'Janji temu ini telah dibatalkan.'
                },
                no_show: {
                    label: 'Tidak Hadir',
                    color: '#d9534f',
                    message: 'Anda tidak hadir pada janji temu sebelumnya.'
                }
            };

            return statusMap[normalizedStatus] || {
                label: normalizedStatus || 'Tidak diketahui',
                color: '#cccccc',
                message: 'Status janji temu belum tersedia.'
            };
        }
        
        function toggleWelcomeMessage() {
            const content = document.getElementById('welcome-content');
            const icon = document.getElementById('welcome-toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        function toggleAnnouncementsSection() {
            const wrapper = document.getElementById('announcements-content');
            const icon = document.getElementById('announcements-toggle-icon');
            if (!wrapper || !icon) {
                return;
            }

            if (wrapper.style.display === 'none') {
                wrapper.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                wrapper.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        async function loadVisitInvoices() {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            const patientId = window.currentProfile?.id;
            if (!patientId) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>Informasi pasien belum tersedia.</p></div>`;
                return;
            }

            try {
                const response = await fetch(`/api/visit-invoices/patient/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Gagal memuat kunjungan');
                }

                const { data } = await response.json();
                renderVisitCards(data || []);
            } catch (error) {
                console.error('Error loading visit invoices:', error);
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-triangle"></i><p>Gagal memuat riwayat kunjungan.</p></div>`;
            }
        }

        function renderVisitCards(visits) {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            if (!visits || visits.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-info-circle"></i><p>Belum ada kunjungan atau invoice terkait.</p></div>`;
                return;
            }

            const cardsHtml = visits.map(visit => {
                const visitType = escapeText(visit.visit_type || 'Kunjungan Klinik');
                const visitNotes = escapeText(visit.notes || '');
                const invoiceNumber = escapeText(visit.invoice_number || '-');
                const statusLabel = visit.invoice_status ? visit.invoice_status.charAt(0).toUpperCase() + visit.invoice_status.slice(1) : 'Pending';
                const links = [];
                if (visit.invoice_url) {
                    links.push(`<a href="${visit.invoice_url}" target="_blank" rel="noreferrer">Lihat Invoice</a>`);
                }
                if (visit.etiket_url) {
                    links.push(`<a href="${visit.etiket_url}" target="_blank" rel="noreferrer">Cetak Etiket</a>`);
                }

                const actionsHtml = links.length ? `<div class="visit-actions">${links.join(' ')}</div>` : '';

                return `
                    <div class="visit-card">
                        <h4>${visitType}</h4>
                        <p><strong>Tanggal:</strong> ${formatVisitDate(visit.visit_date)}</p>
                        <p><strong>Nomor Invoice:</strong> ${invoiceNumber}</p>
                        <p><strong>Total:</strong> ${formatCurrency(visit.total_amount)}</p>
                        <p><strong>Status:</strong> ${statusLabel}</p>
                        ${visitNotes ? `<p>${visitNotes}</p>` : ''}
                        ${actionsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="visit-card-grid">${cardsHtml}</div>`;
        }

        function escapeText(value) {
            if (!value) return '';
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
        }

        function formatVisitDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function openProfileModal() {
            if (!window.currentProfile) return;

            // Populate form with current data
            document.getElementById('edit-fullname').value = window.currentProfile.fullname || '';
            document.getElementById('edit-email').value = window.currentProfile.email || '';
            document.getElementById('edit-phone').value = window.currentProfile.phone || '';
            document.getElementById('edit-profile-picture').value = window.currentProfile.profile_picture || '';

            // Update preview picture
            const previewImg = document.getElementById('edit-profile-picture-preview');
            if (window.currentProfile.profile_picture) {
                previewImg.src = window.currentProfile.profile_picture;
                previewImg.onerror = function() {
                    this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E";
                };
            } else {
                previewImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3EðŸ‘¤%3C/text%3E%3C/svg%3E";
            }

            // Reset file input and progress bar
            document.getElementById('edit-profile-picture-file').value = '';
            document.getElementById('photo-upload-progress').style.display = 'none';
            document.getElementById('photo-upload-bar').style.width = '0%';
            document.getElementById('profile-error').style.display = 'none';

            if (window.currentProfile.birth_date) {
                // Use the date string directly to avoid timezone conversion issues
                // birth_date from DB is in YYYY-MM-DD format or ISO string
                let birthDateStr = window.currentProfile.birth_date;
                if (birthDateStr.includes('T')) {
                    // If it's an ISO string, extract just the date part
                    birthDateStr = birthDateStr.split('T')[0];
                }
                document.getElementById('edit-birthdate').value = birthDateStr;
            }

            document.getElementById('edit-age').value = window.currentProfile.age || '';

            // Show modal
            $('#profileModal').modal('show');
        }

        async function saveProfile() {
            // Hide previous messages
            document.getElementById('profile-error').style.display = 'none';
            document.getElementById('profile-success').style.display = 'none';

            // Get current values from form
            const fullnameInput = document.getElementById('edit-fullname').value.trim();
            const emailInput = document.getElementById('edit-email').value.trim();
            const phoneInput = document.getElementById('edit-phone').value.trim();
            const birthdateInput = document.getElementById('edit-birthdate').value;
            const ageInput = document.getElementById('edit-age').value;
            const profilePictureInput = document.getElementById('edit-profile-picture').value.trim();

            // Get current profile data
            const currentFullname = window.currentProfile?.fullname || '';
            const currentEmail = window.currentProfile?.email || '';
            const currentPhone = window.currentProfile?.phone || '';
            const currentBirthdate = window.currentProfile?.birth_date || '';
            const currentAge = window.currentProfile?.age ? String(window.currentProfile.age) : '';
            const currentProfilePicture = window.currentProfile?.profile_picture || '';

            // Check if there are any changes
            const hasChanges =
                (fullnameInput !== currentFullname) ||
                (emailInput !== currentEmail) ||
                (phoneInput !== currentPhone) ||
                (birthdateInput !== currentBirthdate) ||
                (ageInput !== currentAge) ||
                (profilePictureInput !== currentProfilePicture);

            // If no changes, just close the modal
            if (!hasChanges) {
                console.log('No changes detected, closing modal');
                $('#profileModal').modal('hide');
                return;
            }

            // Use input values or fallback to current data
            const fullname = fullnameInput || currentFullname;
            const email = emailInput || currentEmail;
            const phone = phoneInput || currentPhone;
            const birthdate = birthdateInput || currentBirthdate || null;
            const age = ageInput || currentAge || null;
            const profilePicture = profilePictureInput || currentProfilePicture || null;

            // Validation - require essential fields
            if (!fullname || !email || !phone) {
                document.getElementById('profile-error').textContent = 'Nama, email, dan nomor telepon harus diisi!';
                document.getElementById('profile-error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/patients/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullname,
                        email,
                        phone,
                        birth_date: birthdate || null,
                        age: age ? parseInt(age) : null,
                        profile_picture: profilePicture
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal menyimpan profil');
                }

                // Show success message
                document.getElementById('profile-success').textContent = 'Profil berhasil diperbarui!';
                document.getElementById('profile-success').style.display = 'block';

                // Reload profile data
                setTimeout(() => {
                    $('#profileModal').modal('hide');
                    loadUserProfile();
                }, 1500);

            } catch (error) {
                console.error('Error saving profile:', error);
                document.getElementById('profile-error').textContent = error.message;
                document.getElementById('profile-error').style.display = 'block';
            }
        }

        // Auto-calculate age from birth date and profile photo upload
        document.addEventListener('DOMContentLoaded', function() {
            const birthdateInput = document.getElementById('edit-birthdate');
            const ageInput = document.getElementById('edit-age');

            if (birthdateInput && ageInput) {
                birthdateInput.addEventListener('change', function() {
                    const birthDate = new Date(this.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();

                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }

                    ageInput.value = age >= 0 ? age : '';
                });
            }

            // Profile photo file upload handler
            const photoFileInput = document.getElementById('edit-profile-picture-file');
            if (photoFileInput) {
                photoFileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Validate file size (2MB max)
                    if (file.size > 2 * 1024 * 1024) {
                        document.getElementById('profile-error').textContent = 'Ukuran file maksimal 2MB';
                        document.getElementById('profile-error').style.display = 'block';
                        e.target.value = '';
                        return;
                    }

                    // Validate file type
                    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                        document.getElementById('profile-error').textContent = 'Format file harus JPEG, PNG, atau WebP';
                        document.getElementById('profile-error').style.display = 'block';
                        e.target.value = '';
                        return;
                    }

                    // Show preview immediately using FileReader
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('edit-profile-picture-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Upload to server
                    document.getElementById('profile-error').style.display = 'none';
                    document.getElementById('photo-upload-progress').style.display = 'block';
                    document.getElementById('photo-upload-bar').style.width = '30%';

                    try {
                        const formData = new FormData();
                        formData.append('photo', file);

                        document.getElementById('photo-upload-bar').style.width = '60%';

                        const response = await fetch('/api/patients/upload-photo', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        document.getElementById('photo-upload-bar').style.width = '90%';

                        const data = await response.json();

                        if (data.success) {
                            document.getElementById('photo-upload-bar').style.width = '100%';
                            document.getElementById('edit-profile-picture').value = data.photo_url;

                            // Update preview with actual URL from server
                            document.getElementById('edit-profile-picture-preview').src = data.photo_url;

                            // Update currentProfile so change detection works correctly
                            if (window.currentProfile) {
                                window.currentProfile.profile_picture = data.photo_url;
                            }

                            // Also update the Settings modal profile picture
                            const settingsProfilePic = document.getElementById('profile-picture');
                            if (settingsProfilePic) {
                                settingsProfilePic.src = data.photo_url;
                            }

                            // Update navigation avatar
                            const navAvatarImg = document.getElementById('user-avatar-img');
                            const navAvatarInitials = document.getElementById('user-avatar-initials');
                            if (navAvatarImg && navAvatarInitials) {
                                navAvatarImg.src = data.photo_url;
                                navAvatarImg.style.display = 'block';
                                navAvatarInitials.style.display = 'none';
                            }

                            setTimeout(() => {
                                document.getElementById('photo-upload-progress').style.display = 'none';
                                document.getElementById('photo-upload-bar').style.width = '0%';
                            }, 500);

                            showToast('Foto profil berhasil diupload', 'success');
                        } else {
                            throw new Error(data.message || 'Gagal mengupload foto');
                        }
                    } catch (error) {
                        console.error('Photo upload error:', error);
                        document.getElementById('photo-upload-progress').style.display = 'none';
                        document.getElementById('photo-upload-bar').style.width = '0%';
                        document.getElementById('profile-error').textContent = error.message || 'Gagal mengupload foto';
                        document.getElementById('profile-error').style.display = 'block';
                        e.target.value = '';
                    }
                });
            }
        });

        function updateIntakeButtonCompleted() {
            // Find all intake buttons (both in quick actions and full list)
            const intakeButtons = document.querySelectorAll('a[href="/patient-intake.html"]');
            
            intakeButtons.forEach(btn => {
                // Change background to green
                btn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                btn.style.borderColor = '#27ae60';
                btn.style.color = '#ffffff';
                
                // Add checkmark icon with white color
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fa fa-check-circle';
                    icon.style.color = '#ffffff';
                    icon.style.fontSize = '48px';
                }
                
                // Update text with white color
                const textDiv = btn.querySelector('div');
                if (textDiv) {
                    textDiv.innerHTML = 'Formulir Identitas Pribadi<br><small style="font-size: 11px; color: #ffffff; font-weight: 600;">âœ“ Sudah Diselesaikan</small>';
                    textDiv.style.color = '#ffffff';
                    textDiv.style.fontWeight = '600';
                }
                
                // Make it clickable to view again (optional)
                btn.title = 'Formulir sudah diselesaikan';
            });
        }

        function logout(event) {
            if (event) {
                event.preventDefault();
            }
            localStorage.removeItem('vps_auth_token');
            sessionStorage.removeItem('vps_auth_token');
            localStorage.removeItem('patient_user');
            localStorage.removeItem('patient_token');
            localStorage.removeItem('auth_provider');
            localStorage.removeItem('patient_intake_draft_v3'); // Clear intake draft to prevent data leakage
            window.location.href = '/index.html';
        }

        // Toggle dropdown menu
        function toggleDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Open profile view modal (Settings)
        function openProfileViewModal(event) {
            if (event) {
                event.preventDefault();
            }
            $('#profileViewModal').modal('show');
            // Close dropdown
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Ultrasound Gallery Functions
        let ultrasoundImages = [];

        function openUploadUltrasoundModal() {
            $('#uploadUltrasoundModal').modal('show');
            // Clear form
            document.getElementById('ultrasound-upload-form').reset();
            document.getElementById('ultrasound-error').style.display = 'none';
            document.getElementById('ultrasound-success').style.display = 'none';
        }

        async function saveUltrasound() {
            const url = document.getElementById('ultrasound-url').value.trim();
            const date = document.getElementById('ultrasound-date').value;
            const notes = document.getElementById('ultrasound-notes').value.trim();

            if (!url || !date) {
                showUltrasoundError('URL dan tanggal USG harus diisi');
                return;
            }

            try {
                // Save to localStorage for now (can be changed to API call later)
                const newImage = {
                    id: Date.now(),
                    url: url,
                    date: date,
                    notes: notes,
                    created_at: new Date().toISOString()
                };

                ultrasoundImages.push(newImage);
                localStorage.setItem('ultrasound_images', JSON.stringify(ultrasoundImages));

                showUltrasoundSuccess('Foto USG berhasil disimpan');
                setTimeout(() => {
                    $('#uploadUltrasoundModal').modal('hide');
                    renderUltrasoundGallery();
                }, 1500);
            } catch (error) {
                showUltrasoundError('Gagal menyimpan foto USG');
            }
        }

        function renderUltrasoundGallery() {
            const gallery = document.getElementById('ultrasound-gallery');
            const galleryMini = document.getElementById('ultrasound-gallery-mini');

            if (ultrasoundImages.length === 0) {
                const emptyState = `
                    <p class="empty-state">
                        <i class="fa fa-image"></i>
                        Belum ada foto USG dari dokter
                    </p>
                `;
                if (gallery) gallery.innerHTML = emptyState;
                if (galleryMini) galleryMini.innerHTML = emptyState;
                return;
            }

            const galleryHTML = ultrasoundImages.map(img => {
                const imgDate = new Date(img.date);
                const formattedDate = imgDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const safeNotes = (img.notes || img.title || '').replace(/'/g, "\\'");

                return `
                    <div class="ultrasound-item" onclick="viewUltrasoundImage('${img.url}', '${formattedDate}', '${safeNotes}')" style="cursor: pointer;">
                        <img src="${img.url}" alt="USG ${formattedDate}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect width=%27200%27 height=%27200%27 fill=%27%23404040%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 font-size=%2720%27 fill=%27%2328a7e9%27 text-anchor=%27middle%27 dy=%27.3em%27%3EGambar Error%3C/text%3E%3C/svg%3E'">
                        <div class="overlay">
                            ${formattedDate}
                            ${img.title ? '<br>' + img.title : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (gallery) gallery.innerHTML = galleryHTML;
            if (galleryMini) galleryMini.innerHTML = galleryHTML;
        }

        function deleteUltrasound(event, id) {
            event.stopPropagation();
            if (confirm('Yakin ingin menghapus foto USG ini?')) {
                ultrasoundImages = ultrasoundImages.filter(img => img.id !== id);
                localStorage.setItem('ultrasound_images', JSON.stringify(ultrasoundImages));
                renderUltrasoundGallery();
            }
        }

        function viewUltrasoundImage(url, date, notes) {
            // Create a simple image viewer modal
            const modalContent = `
                <div style="text-align: center;">
                    <img src="${url}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
                    <h4 style="color: #28a7e9; margin-top: 20px;">${date}</h4>
                    ${notes ? `<p style="color: #cccccc; margin-top: 10px;">${notes}</p>` : ''}
                </div>
            `;

            // Show in a simple alert for now (can be improved with a custom modal)
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="max-width: 800px; width: 100%;">
                    ${modalContent}
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 10px 30px; background: #28a7e9; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        Tutup
                    </button>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        function showUltrasoundError(message) {
            const errorEl = document.getElementById('ultrasound-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('ultrasound-success').style.display = 'none';
        }

        function showUltrasoundSuccess(message) {
            const successEl = document.getElementById('ultrasound-success');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('ultrasound-error').style.display = 'none';
        }

        // Load ultrasound images from patient documents API (sent by staff)
        async function loadUltrasoundImages() {
            try {
                const token = localStorage.getItem('patient_token');
                if (!token) return;

                const response = await fetch('/api/patient-documents/my-documents?type=usg_photo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.documents) {
                        ultrasoundImages = result.documents.map(doc => ({
                            id: doc.id,
                            url: doc.file_url,
                            date: doc.published_at || doc.created_at,
                            notes: doc.description || doc.title,
                            title: doc.title
                        }));
                        renderUltrasoundGallery();
                    }
                }
            } catch (error) {
                console.error('Failed to load USG images:', error);
            }
        }

        // Password Management Functions
        let hasPassword = false; // Track if user has password set
        
        function openPasswordModal() {
            // Clear form
            document.getElementById('password-form').reset();
            document.getElementById('password-error').style.display = 'none';
            document.getElementById('password-success').style.display = 'none';
            
            // Check if user already has password
            if (hasPassword) {
                // Change Password mode
                document.getElementById('password-modal-title').textContent = 'Ubah Password';
                document.getElementById('old-password-group').style.display = 'block';
                document.getElementById('new-pass-label').textContent = 'Password Baru';
                document.getElementById('save-password-btn-text').textContent = 'Ubah Password';
                document.getElementById('password-info-text').textContent = 'Masukkan password lama dan password baru untuk mengubah password Anda.';
            } else {
                // Set Password mode
                document.getElementById('password-modal-title').textContent = 'Set Password';
                document.getElementById('old-password-group').style.display = 'none';
                document.getElementById('new-pass-label').textContent = 'Password';
                document.getElementById('save-password-btn-text').textContent = 'Set Password';
                document.getElementById('password-info-text').textContent = 'Setelah set password, Anda dapat login menggunakan email dan password.';
            }
            
            $('#passwordModal').modal('show');
        }
        
        async function savePassword() {
            try {
                // Hide previous messages
                document.getElementById('password-error').style.display = 'none';
                document.getElementById('password-success').style.display = 'none';
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Validation
                if (!newPassword || !confirmPassword) {
                    throw new Error('Semua field harus diisi');
                }
                
                if (newPassword !== confirmPassword) {
                    throw new Error('Password dan konfirmasi password tidak cocok');
                }
                
                if (newPassword.length < 6) {
                    throw new Error('Password minimal 6 karakter');
                }
                
                let endpoint, body;
                
                if (hasPassword) {
                    // Change Password
                    const oldPassword = document.getElementById('old-password').value;
                    if (!oldPassword) {
                        throw new Error('Password lama harus diisi');
                    }
                    
                    endpoint = '/api/patients/change-password';
                    body = {
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };
                } else {
                    // Set Password
                    endpoint = '/api/patients/set-password';
                    body = {
                        password: newPassword,
                        confirm_password: confirmPassword
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Gagal menyimpan password');
                }
                
                // Show success message
                document.getElementById('password-success').textContent = result.message;
                document.getElementById('password-success').style.display = 'block';
                
                // Update button text to "Ubah Password" if this was first set
                if (!hasPassword) {
                    hasPassword = true;
                    document.getElementById('password-btn-text').textContent = 'Ubah Password';
                }
                
                // Close modal after delay
                setTimeout(() => {
                    $('#passwordModal').modal('hide');
                }, 1500);
                
            } catch (error) {
                console.error('Error saving password:', error);
                document.getElementById('password-error').textContent = error.message;
                document.getElementById('password-error').style.display = 'block';
            }
        }

        // Auto-refresh token verification every 5 minutes
        setInterval(async () => {
            try {
                const response = await fetch('/api/patients/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    logout();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
        }, 5 * 60 * 1000);

        // Show "Atur Password" link for Google users
        document.addEventListener('DOMContentLoaded', function() {
            const googleUserPasswordSection = document.getElementById('google-user-password-section');
            const emailInput = document.getElementById('edit-email');

            if (googleUserPasswordSection && emailInput) {
                const email = emailInput.value.trim();
                
                // Check if email is from Google (ends with @gmail.com or similar)
                if (email && email.split('@')[1]) {
                    const domain = email.split('@')[1].toLowerCase();
                    const googleDomains = ['gmail.com', 'googlemail.com', 'yahoo.com', 'hotmail.com', 'live.com'];

                    if (googleDomains.includes(domain)) {
                        googleUserPasswordSection.style.display = 'block';
                    }
                }
            }
        });

        // =====================================================
        // MY DOCUMENTS SECTION
        // =====================================================

        /**
         * Load and display patient's documents
         */
        async function loadMyDocuments() {
            const container = document.getElementById('my-documents-container');
            if (!container) return;

            const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
            if (!token) {
                container.innerHTML = renderDocumentsEmpty('Silakan login untuk melihat dokumen Anda');
                return;
            }

            try {
                const response = await fetch('/api/patient-documents/my-documents', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        container.innerHTML = renderDocumentsEmpty('Sesi telah berakhir. Silakan login kembali.');
                        return;
                    }
                    throw new Error('Failed to fetch documents');
                }

                const data = await response.json();

                if (!data.success || !data.documents || data.documents.length === 0) {
                    container.innerHTML = renderDocumentsEmpty('Belum ada dokumen medis yang dikirimkan oleh dokter.');
                    return;
                }

                container.innerHTML = renderDocumentsGrid(data.documents);

            } catch (error) {
                console.error('Error loading documents:', error);
                container.innerHTML = renderDocumentsEmpty('Gagal memuat dokumen. Silakan coba lagi.');
            }
        }

        /**
         * Render empty state for documents
         */
        function renderDocumentsEmpty(message) {
            return `
                <div class="documents-empty">
                    <i class="fa fa-folder-open-o"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        /**
         * Render documents grid
         */
        function renderDocumentsGrid(documents) {
            const cards = documents.map(doc => renderDocumentCard(doc)).join('');
            return `<div class="documents-grid">${cards}</div>`;
        }

        /**
         * Render a single document card
         */
        function renderDocumentCard(doc) {
            const iconClass = getDocumentIconClass(doc.document_type);
            const iconName = getDocumentIcon(doc.document_type);
            const formattedDate = formatDocumentDate(doc.published_at);
            const isNew = isDocumentNew(doc);
            const newBadge = isNew ? '<span class="document-badge new">Baru</span>' : '';

            return `
                <div class="document-card" data-doc-id="${doc.id}">
                    <div class="doc-icon ${iconClass}">
                        <i class="fa ${iconName}"></i>
                    </div>
                    <div class="doc-title">${escapeHtml(doc.title)}${newBadge}</div>
                    <div class="doc-date">
                        <i class="fa fa-calendar-o"></i> ${formattedDate}
                    </div>
                    <div class="doc-actions">
                        <button class="doc-btn view-btn" onclick="viewDocument(${doc.id}, '${escapeHtml(doc.file_url || '')}', '${escapeHtml(doc.document_type)}')">
                            <i class="fa fa-eye"></i> Lihat
                        </button>
                        ${doc.file_url ? `
                            <button class="doc-btn download-btn" onclick="downloadDocument(${doc.id}, '${escapeHtml(doc.file_url)}', '${escapeHtml(doc.file_name || doc.title)}')">
                                <i class="fa fa-download"></i> Unduh
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Get icon class based on document type
         */
        function getDocumentIconClass(type) {
            const typeMap = {
                'resume_medis': 'resume',
                'usg_2d': 'usg',
                'usg_4d': 'usg',
                'lab_result': 'lab',
                'lab_interpretation': 'lab',
                'prescription': 'other',
                'referral': 'other',
                'certificate': 'other'
            };
            return typeMap[type] || 'other';
        }

        /**
         * Get icon name based on document type
         */
        function getDocumentIcon(type) {
            const iconMap = {
                'resume_medis': 'fa-file-text-o',
                'usg_2d': 'fa-picture-o',
                'usg_4d': 'fa-video-camera',
                'lab_result': 'fa-flask',
                'lab_interpretation': 'fa-stethoscope',
                'prescription': 'fa-medkit',
                'referral': 'fa-share-square-o',
                'certificate': 'fa-certificate'
            };
            return iconMap[type] || 'fa-file-o';
        }

        /**
         * Format date for display
         */
        function formatDocumentDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        /**
         * Check if document is new (not viewed yet)
         */
        function isDocumentNew(doc) {
            return !doc.first_viewed_at;
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Show toast notification
         */
        function showToast(message, type = 'info') {
            // Create toast container if not exists
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
                document.body.appendChild(container);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
            toast.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = message;
            container.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * View document
         */
        async function viewDocument(docId, fileUrl, docType) {
            // Track view
            try {
                await fetch(`/api/patient-documents/${docId}/track`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'view' })
                });
            } catch (e) {
                console.error('Failed to track view:', e);
            }

            // Remove "new" badge from this document
            const card = document.querySelector(`[data-doc-id="${docId}"]`);
            if (card) {
                const badge = card.querySelector('.document-badge.new');
                if (badge) badge.remove();
            }

            // Open document
            if (fileUrl) {
                window.open(fileUrl, '_blank');
            } else if (docType === 'resume_medis') {
                // For resume medis without file, fetch and show content in modal
                openResumeModal(docId);
            }
        }

        /**
         * Open resume viewer modal and fetch content
         */
        async function openResumeModal(docId) {
            const modal = $('#resumeViewerModal');
            const loadingEl = document.getElementById('resume-loading');
            const contentEl = document.getElementById('resume-content');
            const errorEl = document.getElementById('resume-error');
            const textEl = document.getElementById('resume-text');
            const titleEl = document.getElementById('resume-modal-title');

            // Reset modal state
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            titleEl.textContent = 'Resume Medis';

            // Show modal
            modal.modal('show');

            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(`/api/patient-documents/${docId}/content`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal memuat dokumen');
                }

                if (data.success && data.document) {
                    titleEl.textContent = data.document.title || 'Resume Medis';

                    if (data.document.content) {
                        textEl.textContent = data.document.content;
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                    } else if (data.document.fileUrl) {
                        // If there's a file URL after all, open it
                        modal.modal('hide');
                        window.open(data.document.fileUrl, '_blank');
                    } else {
                        throw new Error('Konten resume tidak tersedia');
                    }
                } else {
                    throw new Error(data.message || 'Gagal memuat dokumen');
                }
            } catch (error) {
                console.error('Error loading resume:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                document.getElementById('resume-error-text').textContent = error.message || 'Gagal memuat resume medis';
            }
        }

        /**
         * Download document
         */
        async function downloadDocument(docId, fileUrl, fileName) {
            // Track download
            try {
                await fetch(`/api/patient-documents/${docId}/track`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'download' })
                });
            } catch (e) {
                console.error('Failed to track download:', e);
            }

            // Download file
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load documents on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMyDocuments();
        });
    </script>

    <!-- Bubble Animation Script -->
    <script>
        function createBubbles() {
            const bgAnimation = document.getElementById('bgAnimation');
            const bubbleCount = 15;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                const size = Math.random() * 60 + 20;
                bubble.style.width = size + 'px';
                bubble.style.height = size + 'px';
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.top = Math.random() * 100 + '%';
                bubble.style.animationDelay = Math.random() * 8 + 's';
                bubble.style.animationDuration = (Math.random() * 4 + 6) + 's';

                bgAnimation.appendChild(bubble);
            }
        }

        createBubbles();
    </script>

    <!-- Resume Viewer Modal -->
    <div class="modal fade" id="resumeViewerModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-file-text-o"></i> <span id="resume-modal-title">Resume Medis</span></h4>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="resume-loading" style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #28a7e9;"></i>
                        <p style="margin-top: 15px; color: #888;">Memuat resume medis...</p>
                    </div>
                    <div id="resume-content" style="display: none;">
                        <div id="resume-text" style="
                            background: rgba(0,0,0,0.3);
                            padding: 20px;
                            border-radius: 10px;
                            white-space: pre-wrap;
                            font-family: 'Segoe UI', sans-serif;
                            line-height: 1.6;
                            font-size: 14px;
                        "></div>
                    </div>
                    <div id="resume-error" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-exclamation-triangle fa-3x" style="color: #f39c12;"></i>
                        <p style="margin-top: 15px; color: #888;" id="resume-error-text">Gagal memuat resume medis</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Inbox Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;">
                        <i class="fa fa-bell"></i> Notifikasi & Pengumuman
                        <span id="modal-unread-badge" class="badge badge-danger ml-2" style="display: none;">0</span>
                    </h4>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
                    <div id="notifications-loading" style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #28a7e9;"></i>
                        <p style="margin-top: 15px; color: #888;">Memuat notifikasi...</p>
                    </div>
                    <div id="notifications-list" style="display: none;"></div>
                    <div id="notifications-empty" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-inbox fa-3x" style="color: #666;"></i>
                        <p style="margin-top: 15px; color: #888;">Tidak ada notifikasi</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040; justify-content: space-between;">
                    <button type="button" class="btn btn-sm" onclick="markAllNotificationsRead()" style="background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #28a7e9;">
                        <i class="fa fa-check-double"></i> Tandai Semua Dibaca
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Notifications Script -->
    <script>
        // Notification variables
        let patientNotifications = [];
        const NOTIF_API = '/api/patient-notifications';

        // Initialize notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationBadge();
            // Poll for notifications every 60 seconds
            setInterval(updateNotificationBadge, 60000);
        });

        // Update notification badge count
        async function updateNotificationBadge() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (!token) return;

                const response = await fetch(NOTIF_API + '/count', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) return;

                const data = await response.json();
                const badge = document.getElementById('notification-badge');
                const modalBadge = document.getElementById('modal-unread-badge');

                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                if (modalBadge) {
                    if (data.count > 0) {
                        modalBadge.textContent = data.count + ' baru';
                        modalBadge.style.display = 'inline-block';
                    } else {
                        modalBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // Open notifications inbox modal
        function openNotificationsInbox() {
            $('#notificationsModal').modal('show');
            loadNotifications();
        }

        // Load notifications
        async function loadNotifications() {
            const loadingEl = document.getElementById('notifications-loading');
            const listEl = document.getElementById('notifications-list');
            const emptyEl = document.getElementById('notifications-empty');

            loadingEl.style.display = 'block';
            listEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(NOTIF_API + '/with-announcements?limit=30', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) throw new Error('Failed to load notifications');

                const data = await response.json();
                patientNotifications = data.items || [];

                loadingEl.style.display = 'none';

                if (patientNotifications.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                renderNotifications();
                listEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading notifications:', error);
                loadingEl.innerHTML = '<p style="color: #dc3545; padding: 20px;">Gagal memuat notifikasi</p>';
            }
        }

        // Render notifications list
        function renderNotifications() {
            const listEl = document.getElementById('notifications-list');

            const html = patientNotifications.map(n => {
                const timeAgo = formatNotifTimeAgo(n.created_at);
                const isUnread = !n.is_read;
                const iconClass = n.icon || 'fa fa-bell';
                const iconColor = n.icon_color || 'text-primary';

                // Type-specific styling
                let typeBadge = '';
                if (n.type === 'appointment') {
                    typeBadge = '<span class="badge badge-success" style="font-size: 10px;"><i class="fa fa-calendar-check"></i> Appointment</span>';
                } else if (n.type === 'document') {
                    typeBadge = '<span class="badge badge-info" style="font-size: 10px;"><i class="fa fa-file"></i> Dokumen</span>';
                } else if (n.source === 'announcement') {
                    typeBadge = '<span class="badge badge-warning" style="font-size: 10px;"><i class="fa fa-bullhorn"></i> Pengumuman</span>';
                }

                return '<div class="notification-item ' + (isUnread ? 'unread' : '') + '" data-id="' + n.id + '" data-source="' + n.source + '" onclick="handleNotifClick(' + n.id + ', \'' + n.source + '\')">' +
                    '<div style="display: flex; align-items: flex-start; gap: 12px;">' +
                        '<div class="notif-icon ' + iconColor + '">' +
                            '<i class="' + iconClass + '"></i>' +
                        '</div>' +
                        '<div style="flex: 1; min-width: 0;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                                '<div class="notif-title">' + escapeHtml(n.title) + '</div>' +
                                '<span class="notif-time">' + timeAgo + '</span>' +
                            '</div>' +
                            '<p class="notif-message">' + escapeHtml(truncateText(n.message, 120)) + '</p>' +
                            '<div style="margin-top: 5px;">' + typeBadge + (isUnread ? ' <span class="badge badge-primary" style="font-size: 10px;">Baru</span>' : '') + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            listEl.innerHTML = html;
        }

        // Handle notification click
        async function handleNotifClick(id, source) {
            if (source === 'notification') {
                try {
                    const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                    await fetch(NOTIF_API + '/' + id + '/read', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    // Update UI
                    const item = document.querySelector('.notification-item[data-id="' + id + '"][data-source="notification"]');
                    if (item) {
                        item.classList.remove('unread');
                        const newBadge = item.querySelector('.badge-primary');
                        if (newBadge) newBadge.remove();
                    }
                    updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(NOTIF_API + '/read-all', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) throw new Error('Failed');

                // Update UI
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const newBadge = item.querySelector('.badge-primary');
                    if (newBadge) newBadge.remove();
                });
                updateNotificationBadge();
                showToast('Semua notifikasi ditandai sudah dibaca');
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        // Format time ago
        function formatNotifTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Baru saja';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' menit lalu';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' jam lalu';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' hari lalu';

            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short'
            });
        }

        // Truncate text
        function truncateText(text, maxLen) {
            if (!text) return '';
            if (text.length <= maxLen) return text;
            return text.substring(0, maxLen) + '...';
        }
    </script>
</body>
</html>
