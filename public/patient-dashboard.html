<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Pasien - Dokter Dibya</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #303030;
            color: #ffffff;
            font-family: 'Open Sans', sans-serif;
            font-weight: 300;
            margin: 0;
            padding: 0;
        }
        
        a {
            color: #47C6F8;
            text-decoration: none;
        }
        
        a:hover {
            color: #0FF;
            text-decoration: none;
        }
        
        /* Header */
        header {
            background: #202020;
            padding: 20px 0;
            border-bottom: 1px solid #404040;
        }
        
        header .phone,
        header .email {
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 0;
        }
        
        header .phone i,
        header .email i {
            color: #28a7e9;
            margin-right: 5px;
        }
        
        header h1 {
            color: #28a7e9;
            font-size: 28px;
            font-weight: 700;
            margin: 20px 0 10px;
        }
        
        header p.subtitle {
            color: #cccccc;
            font-size: 14px;
            margin: 0;
        }
        
        /* Main Content */
        .dashboard-container {
            padding: 30px 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Cards */
        .dashboard-card {
            background: #202020;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(40, 167, 233, 0.3);
            border-color: #28a7e9;
        }
        
        .dashboard-card h3 {
            color: #28a7e9;
            font-size: 24px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .dashboard-card h3 i {
            margin-right: 10px;
            width: 30px;
        }
        
        .dashboard-card h3[onclick] {
            transition: color 0.3s;
        }
        
        .dashboard-card h3[onclick]:hover {
            color: #47C6F8;
        }
        
        #welcome-toggle-icon {
            transition: transform 0.3s;
        }
        
        /* Alert */
        .alert-info-custom {
            background: #1a3a4a;
            border: 1px solid #28a7e9;
            border-left: 4px solid #28a7e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #ffffff;
        }
        
        .alert-info-custom i {
            color: #28a7e9;
            margin-right: 10px;
        }
        
        .alert-success-custom {
            background: #1a4a2a;
            border: 1px solid #28e970;
            border-left: 4px solid #28e970;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #ffffff;
        }
        
        .alert-success-custom i {
            color: #28e970;
            margin-right: 10px;
        }
        
        .appointment-info-box {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .appointment-info-box p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .appointment-info-box strong {
            color: #28e970;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-action-btn {
            padding: 25px 15px;
            background: #303030;
            border: 2px solid #28a7e9;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #28a7e9;
            display: block;
        }
        
        .quick-action-btn:hover {
            background: #28a7e9;
            color: #ffffff;
            text-decoration: none;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(40, 167, 233, 0.4);
        }
        
        .quick-action-btn i {
            font-size: 36px;
            display: block;
            margin-bottom: 10px;
        }
        
        .quick-action-btn div {
            font-size: 13px;
            line-height: 1.4;
        }

        /* Kunjunganku Visit Cards */
        .visit-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .visit-card {
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 18px;
            background: #1e1e1e;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.35);
        }

        .visit-card h4 {
            margin: 0;
            color: #28a7e9;
            font-size: 18px;
            font-weight: 600;
        }

        .visit-card p {
            margin: 5px 0;
            color: #bfbfbf;
            font-size: 14px;
        }

        .visit-card .visit-actions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .visit-card .visit-actions a {
            background: #303030;
            color: #28a7e9;
            border: 1px solid #28a7e9;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }

        .visit-card .visit-actions a:hover {
            background: #28a7e9;
            color: #020202;
        }
        
        /* Profile Info */
        .profile-info {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .profile-info li {
            padding: 12px 0;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-info li:last-child {
            border-bottom: none;
        }
        
        .profile-info strong {
            color: #28a7e9;
            font-weight: 500;
        }
        
        .profile-info span {
            color: #cccccc;
            text-align: right;
        }
        
        /* Buttons */
        .action-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #28a7e9;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 15px;
            transition: all 0.3s;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: 400;
        }
        
        .action-btn:hover {
            background: #0FF;
            color: #303030;
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .action-btn i {
            margin-right: 8px;
        }
        
        .action-btn-secondary {
            background: #505050;
        }
        
        .action-btn-secondary:hover {
            background: #606060;
            color: #ffffff;
        }
        
        .logout-btn {
            background: #d9534f;
        }
        
        .logout-btn:hover {
            background: #c9302c;
            color: #ffffff;
        }
        
        /* Empty State */
        .empty-state {
            color: #808080;
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* Navigation */
        .nav-bar {
            background: #202020;
            padding: 10px 0;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-bar a {
            color: #cccccc;
            padding: 10px 15px;
            display: inline-block;
            transition: color 0.3s;
        }
        
        .nav-bar a:hover {
            color: #28a7e9;
        }
        
        .nav-bar a i {
            margin-right: 5px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 24px;
                margin: 15px 0 5px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card h3 {
                font-size: 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .quick-action-btn {
                padding: 20px 10px;
            }
            
            .quick-action-btn i {
                font-size: 28px;
            }
            
            .quick-action-btn div {
                font-size: 12px;
            }
            
            .profile-info li {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .profile-info span {
                text-align: left;
            }
            
            .nav-bar {
                text-align: center;
            }
            
            .nav-bar a {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            header .phone,
            header .email {
                font-size: 12px;
            }
            
            .dashboard-container {
                padding: 20px 10px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .dashboard-card h3 {
                font-size: 18px;
            }
            
            .welcome-message p {
                font-size: 14px !important;
            }
            
            .welcome-message strong[style*="font-size: 20px"] {
                font-size: 17px !important;
            }
            
            .dashboard-card p {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="container">
            <a href="#profile-section"><i class="fa fa-user"></i> Profil</a>
            <a href="patient-visit-history.html"><i class="fa fa-history"></i> Riwayat Kontrol</a>
            <a href="#visits-history-section"><i class="fa fa-clipboard-list"></i> Kunjunganku</a>
            <a href="#" id="logout-link"><i class="fa fa-sign-out"></i> Keluar</a>
        </div>
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-sm-6 col-xs-12">
                    <p class="phone"><i class="fa fa-phone"></i> +62 822-2950-9661</p>
                </div>
                <div class="col-md-6 col-sm-6 col-xs-12">
                    <p class="email"><i class="fa fa-envelope-o"></i> info@dokterdibya.com</p>
                </div>
                <div class="col-md-12">
                    <h1>Selamat Datang, <span id="user-name">Pasien</span>!</h1>
                    <p class="subtitle">Portal private Anda untuk mengelola kesehatan</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Welcome Message -->
        <div class="dashboard-card welcome-message" id="welcome-card" style="margin-bottom: 30px;">
            <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleWelcomeMessage()">
                <span><i class="fa fa-heart"></i> Selamat Datang</span>
                <i class="fa fa-chevron-down" id="welcome-toggle-icon"></i>
            </h3>
            <div id="welcome-content" style="line-height: 1.9; color: #e0e0e0; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 400;">
                <p style="font-size: 16px;">Halaman ini adalah ruang khusus bagi Anda — tempat saya membantu Anda, memantau kehamilan atau kesehatan kandungan Anda secara berkala dan privat. Semua catatan dan informasi di sini bersifat <strong style="color: #28a7e9; font-weight: 600;">rahasia</strong>. Mohon untuk tidak membagikan halaman rekam medis kepada orang selain keluarga inti/ keluarga yang dipercaya. Karena itulah keamanan sistem ini menjadi prioritas saya dengan menerapkan proteksi berlapis dan enkripsi untuk mencegah peretasan.</p>
                                
                <p style="font-size: 16px;">Adanya <strong style="color: #28a7e9; font-weight: 600;">dokterDIBYA</strong> berawal dari keinginan <i>sederhana</i> saya, yaitu agar setiap pasien bisa tetap terhubung dengan dokter pilihannya, tanpa batasan rumah sakit, tempat, atau waktu. Update selalu dengan perubahan jadwal dari saya, reminding jadwal kontrol, booking slot dengan mudah, dan bahkan kedepan bukan tidak mungkin konsultasi secara online dengan jadwal yang disepakati!</p>
                
                <p style="font-size: 16px;">Walaupun demikian saya paham, banyak tantangan dan kesulitan dalam memulai hal baru. Tapi saya percaya, langkah kecil ini bisa membawa perubahan besar menuju pelayanan berkesinambungan dari dokter favorit Anda. Sebelum kita memulai perjalanan ini, mohon mengisi data pribadi dan riwayat medis, data kehamilan, masalah kandungan, riwayat KB. Besar harapan saya, Anda mengisi dengan lengkap sehingga dapat menjadi modalitas bagi saya dalam pemilihan terapi dan layanan terbaik untuk Anda.</p>
                
                <p style="margin-top: 20px; font-size: 16px;">Terima kasih telah menjadi bagian dari <strong style="color: #28a7e9; font-weight: 600;">"modern therapy without boundary"</strong> — pendampingan dan terapi berkelanjutan, di mana pun dan kapan pun Anda membutuhkannya.</p>
                
                <p style="margin-top: 30px; text-align: right; color: #28a7e9; font-size: 17px;">
                    <strong style="font-weight: 500;">Salam hangat,</strong><br>
                    <strong style="font-size: 20px; font-weight: 600;">dokter Anda</strong>
                </p>
            </div>
        </div>
        
        <!-- Alert for appointment confirmation -->
        <div class="alert-success-custom" id="appointment-confirmed-alert" style="display: none;">
            <i class="fa fa-check-circle"></i> <strong>Janji Konsultasi Dikonfirmasi!</strong>
            <div id="appointment-details" style="margin-top: 10px;"></div>
        </div>
        
        <!-- Alert for first-time users -->
        <div class="alert-info-custom" id="first-time-alert" style="display: none;">
            <i class="fa fa-info-circle"></i> <strong>Langkah Selanjutnya:</strong> 
            Lengkapi formulir rekam medis awal Anda untuk memulai journey Anda.
        </div>

        <!-- Announcements Section -->
        <div class="dashboard-card" id="announcements-section" style="margin-bottom: 30px;">
            <h3><i class="fa fa-bullhorn"></i> Pengumuman Dokter</h3>
            <div id="announcements-container">
                <!-- Announcements will be loaded here -->
                <div style="text-align: center; padding: 20px; color: #999;">
                    <i class="fa fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 10px;">Memuat pengumuman...</p>
                </div>
            </div>
        </div>

        <!-- Kunjunganku Section -->
        <div class="dashboard-card" id="visits-history-section" style="margin-bottom: 30px;">
            <h3><i class="fa fa-clipboard-list"></i> Kunjunganku</h3>
            <div id="visits-list-container">
                <div class="empty-state" style="padding: 40px 20px;">
                    <i class="fa fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 10px; color: #999;">Memuat riwayat kunjungan dan invoice Anda...</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Quick Actions -->
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h3><i class="fa fa-bolt"></i> Aksi Cepat</h3>
                    <div class="quick-actions">
                        <a href="/patient-intake.html" class="quick-action-btn">
                            <i class="fa fa-file-text"></i>
                            <div>Formulir<br>Rekam Medis Awal</div>
                        </a>
                        <a href="/practice-locations.html" class="quick-action-btn">
                            <i class="fa fa-calendar"></i>
                            <div>Jadwal &<br>Janji Konsultasi</div>
                        </a>
                        <a href="#" class="quick-action-btn" onclick="alert('Jadwal USG segera hadir!'); return false;">
                            <i class="fa fa-heartbeat"></i>
                            <div>USG &amp;<br>Imaging</div>
                        </a>
                        <a href="#" class="quick-action-btn" onclick="alert('Layanan Lab segera hadir!'); return false;">
                            <i class="fa fa-flask"></i>
                            <div>Lab &amp;<br>Hasil Tes</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Profile Info -->
            <div class="col-md-6">
                <div class="dashboard-card" id="profile-section">
                    <h3><i class="fa fa-user"></i> Informasi Profil</h3>
                    <ul class="profile-info">
                        <li>
                            <strong>Nama Lengkap</strong>
                            <span id="profile-name">-</span>
                        </li>
                        <li>
                            <strong>Email</strong>
                            <span id="profile-email">-</span>
                        </li>
                        <li>
                            <strong>Nomor Telepon</strong>
                            <span id="profile-phone">-</span>
                        </li>
                        <li>
                            <strong>Tanggal Lahir</strong>
                            <span id="profile-birthdate">-</span>
                        </li>
                        <li>
                            <strong>Terdaftar Sejak</strong>
                            <span id="profile-registered">-</span>
                        </li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <button class="action-btn action-btn-secondary" onclick="openProfileModal()" style="margin-right: 10px;">
                            <i class="fa fa-edit"></i> Edit Profil
                        </button>
                        <button class="action-btn action-btn-primary" onclick="openPasswordModal()" id="password-btn">
                            <i class="fa fa-lock"></i> <span id="password-btn-text">Set Password</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Appointments & Records -->
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h3><i class="fa fa-calendar-check-o"></i> Janji Temu Mendatang</h3>
                    <p class="empty-state">
                        <i class="fa fa-calendar-o"></i>
                        Belum ada janji temu yang dijadwalkan
                    </p>
                    <a href="#" class="action-btn" onclick="alert('Fitur booking segera hadir!'); return false;">
                        <i class="fa fa-plus"></i> Buat Janji Temu
                    </a>
                </div>

                <div class="dashboard-card" style="margin-top: 20px;">
                    <h3><i class="fa fa-file-text-o"></i> Rekam Medis</h3>
                    <p class="empty-state">
                        <i class="fa fa-folder-open-o"></i>
                        Belum ada rekam medis
                    </p>
                    <a href="/patient-intake.html" class="action-btn">
                        <i class="fa fa-file-text"></i> Formulir Rekam Medis Awal
                    </a>
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div style="text-align: center; margin-top: 40px; margin-bottom: 50px;">
            <button class="action-btn logout-btn" id="logout-btn">
                <i class="fa fa-sign-out"></i> Keluar dari Akun
            </button>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202020; color: #ffffff; border: 1px solid #404040;">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-edit"></i> Edit Profil</h4>
                </div>
                <div class="modal-body">
                    <form id="profile-form">
                        <div class="form-group">
                            <label style="color: #28a7e9;">Nama Lengkap *</label>
                            <input type="text" class="form-control" id="edit-fullname" required 
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Email *</label>
                            <input type="email" class="form-control" id="edit-email" required 
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Nomor WhatsApp *</label>
                            <input type="tel" class="form-control" id="edit-phone" required 
                                   placeholder="+62812345678"
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Tanggal Lahir</label>
                            <input type="date" class="form-control" id="edit-birthdate" 
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Umur</label>
                            <input type="number" class="form-control" id="edit-age" 
                                   placeholder="Otomatis terisi dari tanggal lahir"
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        <div class="alert" id="profile-error" style="display: none; background: #3a1a1a; border: 1px solid #d9534f; color: #ffffff;"></div>
                        <div class="alert" id="profile-success" style="display: none; background: #1a3a2a; border: 1px solid #28a7e9; color: #ffffff;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: #505050; color: #ffffff; border: none;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202020; color: #ffffff; border: 1px solid #404040;">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-lock"></i> <span id="password-modal-title">Set Password</span></h4>
                </div>
                <div class="modal-body">
                    <form id="password-form">
                        <!-- Old Password (only for change password) -->
                        <div class="form-group" id="old-password-group" style="display: none;">
                            <label style="color: #28a7e9;">Password Lama *</label>
                            <input type="password" class="form-control" id="old-password" 
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>
                        
                        <!-- New Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;"><span id="new-pass-label">Password</span> *</label>
                            <input type="password" class="form-control" id="new-password" required
                                   placeholder="Minimal 6 karakter"
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                            <small style="color: #999;">Minimal 6 karakter</small>
                        </div>
                        
                        <!-- Confirm Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;">Konfirmasi Password *</label>
                            <input type="password" class="form-control" id="confirm-password" required
                                   placeholder="Ulangi password"
                                   style="background: #303030; border: 1px solid #404040; color: #ffffff;">
                        </div>

                        <div class="alert" id="password-error" style="display: none; background: #3a1a1a; border: 1px solid #d9534f; color: #ffffff;"></div>
                        <div class="alert" id="password-success" style="display: none; background: #1a3a2a; border: 1px solid #28a7e9; color: #ffffff;"></div>
                        
                        <div id="password-info" style="background: #1a2a3a; border: 1px solid #28a7e9; padding: 12px; border-radius: 4px; margin-top: 15px;">
                            <p style="margin: 0; font-size: 0.9em; color: #28a7e9;">
                                <i class="fa fa-info-circle"></i> 
                                <span id="password-info-text">Setelah set password, Anda dapat login menggunakan email dan password.</span>
                            </p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: #505050; color: #ffffff; border: none;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="savePassword()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> <span id="save-password-btn-text">Set Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Socket.io for real-time announcements -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="js/announcements-dashboard.js?v=20251115"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('patient_token');
        const user = JSON.parse(localStorage.getItem('patient_user') || '{}');

        if (!token || !user.id) {
            // Not authenticated, redirect to login
            window.location.href = '/index.html#masuk';
        } else {
            // Load user profile
            loadUserProfile();
        }

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/patients/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }

                const data = await response.json();
                const profile = data.user;

                // Check if profile is completed, redirect if not
                if (profile.profile_completed !== 1) {
                    window.location.href = '/complete-profile.html';
                    return;
                }

                // Update UI with profile data
                document.getElementById('user-name').textContent = profile.fullname;
                document.getElementById('profile-name').textContent = profile.fullname;
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-phone').textContent = profile.phone || 'Belum diisi';
                
                // Format birth date
                if (profile.birth_date) {
                    const birthDate = new Date(profile.birth_date);
                    document.getElementById('profile-birthdate').textContent = birthDate.toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('profile-birthdate').textContent = 'Belum diisi';
                }
                
                // Format registration date
                const regDate = new Date(profile.registration_date);
                document.getElementById('profile-registered').textContent = regDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Store profile data for editing
                window.currentProfile = profile;

                // Check if user has password set
                hasPassword = profile.has_password === 1 || profile.password !== null;
                if (hasPassword) {
                    document.getElementById('password-btn-text').textContent = 'Ubah Password';
                } else {
                    document.getElementById('password-btn-text').textContent = 'Set Password';
                }

                // Update intake button appearance and hide alert if completed
                if (profile.intake_completed === 1) {
                    updateIntakeButtonCompleted();
                    // Hide "Langkah Selanjutnya" alert if intake is completed
                    document.getElementById('first-time-alert').style.display = 'none';
                    // Collapse welcome message
                    document.getElementById('welcome-content').style.display = 'none';
                    document.getElementById('welcome-toggle-icon').classList.remove('fa-chevron-down');
                    document.getElementById('welcome-toggle-icon').classList.add('fa-chevron-up');
                } else {
                    // Check if first time user (registered within last 24 hours) and intake not completed
                    const hoursSinceReg = (Date.now() - regDate.getTime()) / (1000 * 60 * 60);
                    if (hoursSinceReg < 24) {
                        document.getElementById('first-time-alert').style.display = 'block';
                    }
                }

                // Check for confirmed appointments
                checkConfirmedAppointments();

                loadVisitInvoices();

            } catch (error) {
                console.error('Error loading profile:', error);
                // Token might be invalid, logout
                logout();
            }
        }
        
        async function checkConfirmedAppointments() {
            try {
                const token = localStorage.getItem('patient_token');
                const response = await fetch('/api/sunday-appointments/patient', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                const confirmedAppointments = data.appointments.filter(apt => 
                    apt.status === 'confirmed' && !apt.isPast
                );

                if (confirmedAppointments.length > 0) {
                    const apt = confirmedAppointments[0]; // Show latest confirmed
                    const detailsHtml = `
                        <div class="appointment-info-box">
                            <p><strong>Tanggal:</strong> ${apt.dateFormatted}</p>
                            <p><strong>Sesi:</strong> ${apt.sessionLabel}</p>
                            <p><strong>Waktu:</strong> ${apt.time}</p>
                            ${apt.notes ? `<p><strong>Catatan dari Staff:</strong><br>${apt.notes}</p>` : ''}
                        </div>
                    `;
                    document.getElementById('appointment-details').innerHTML = detailsHtml;
                    document.getElementById('appointment-confirmed-alert').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking appointments:', error);
            }
        }
        
        function toggleWelcomeMessage() {
            const content = document.getElementById('welcome-content');
            const icon = document.getElementById('welcome-toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        async function loadVisitInvoices() {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            const patientId = window.currentProfile?.id;
            if (!patientId) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>Informasi pasien belum tersedia.</p></div>`;
                return;
            }

            try {
                const response = await fetch(`/api/visit-invoices/patient/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Gagal memuat kunjungan');
                }

                const { data } = await response.json();
                renderVisitCards(data || []);
            } catch (error) {
                console.error('Error loading visit invoices:', error);
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-triangle"></i><p>Gagal memuat riwayat kunjungan.</p></div>`;
            }
        }

        function renderVisitCards(visits) {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            if (!visits || visits.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-info-circle"></i><p>Belum ada kunjungan atau invoice terkait.</p></div>`;
                return;
            }

            const cardsHtml = visits.map(visit => {
                const visitType = escapeText(visit.visit_type || 'Kunjungan Klinik');
                const visitNotes = escapeText(visit.notes || '');
                const invoiceNumber = escapeText(visit.invoice_number || '-');
                const statusLabel = visit.invoice_status ? visit.invoice_status.charAt(0).toUpperCase() + visit.invoice_status.slice(1) : 'Pending';
                const links = [];
                if (visit.invoice_url) {
                    links.push(`<a href="${visit.invoice_url}" target="_blank" rel="noreferrer">Lihat Invoice</a>`);
                }
                if (visit.etiket_url) {
                    links.push(`<a href="${visit.etiket_url}" target="_blank" rel="noreferrer">Cetak Etiket</a>`);
                }

                const actionsHtml = links.length ? `<div class="visit-actions">${links.join(' ')}</div>` : '';

                return `
                    <div class="visit-card">
                        <h4>${visitType}</h4>
                        <p><strong>Tanggal:</strong> ${formatVisitDate(visit.visit_date)}</p>
                        <p><strong>Nomor Invoice:</strong> ${invoiceNumber}</p>
                        <p><strong>Total:</strong> ${formatCurrency(visit.total_amount)}</p>
                        <p><strong>Status:</strong> ${statusLabel}</p>
                        ${visitNotes ? `<p>${visitNotes}</p>` : ''}
                        ${actionsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="visit-card-grid">${cardsHtml}</div>`;
        }

        function escapeText(value) {
            if (!value) return '';
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
        }

        function formatVisitDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function openProfileModal() {
            if (!window.currentProfile) return;
            
            // Populate form with current data
            document.getElementById('edit-fullname').value = window.currentProfile.fullname || '';
            document.getElementById('edit-email').value = window.currentProfile.email || '';
            document.getElementById('edit-phone').value = window.currentProfile.phone || '';
            
            if (window.currentProfile.birth_date) {
                const birthDate = new Date(window.currentProfile.birth_date);
                document.getElementById('edit-birthdate').value = birthDate.toISOString().split('T')[0];
            }
            
            document.getElementById('edit-age').value = window.currentProfile.age || '';
            
            // Show modal
            $('#profileModal').modal('show');
        }

        async function saveProfile() {
            // Hide previous messages
            document.getElementById('profile-error').style.display = 'none';
            document.getElementById('profile-success').style.display = 'none';

            // Get current values from form
            const fullnameInput = document.getElementById('edit-fullname').value.trim();
            const emailInput = document.getElementById('edit-email').value.trim();
            const phoneInput = document.getElementById('edit-phone').value.trim();
            const birthdateInput = document.getElementById('edit-birthdate').value;
            const ageInput = document.getElementById('edit-age').value;

            // Get current profile data
            const currentFullname = window.currentProfile?.fullname || '';
            const currentEmail = window.currentProfile?.email || '';
            const currentPhone = window.currentProfile?.phone || '';
            const currentBirthdate = window.currentProfile?.birth_date || '';
            const currentAge = window.currentProfile?.age ? String(window.currentProfile.age) : '';

            // Check if there are any changes
            const hasChanges = 
                (fullnameInput !== currentFullname) ||
                (emailInput !== currentEmail) ||
                (phoneInput !== currentPhone) ||
                (birthdateInput !== currentBirthdate) ||
                (ageInput !== currentAge);

            // If no changes, just close the modal
            if (!hasChanges) {
                console.log('No changes detected, closing modal');
                $('#profileModal').modal('hide');
                return;
            }

            // Use input values or fallback to current data
            const fullname = fullnameInput || currentFullname;
            const email = emailInput || currentEmail;
            const phone = phoneInput || currentPhone;
            const birthdate = birthdateInput || currentBirthdate || null;
            const age = ageInput || currentAge || null;

            // Validation - require essential fields
            if (!fullname || !email || !phone) {
                document.getElementById('profile-error').textContent = 'Nama, email, dan nomor telepon harus diisi!';
                document.getElementById('profile-error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/patients/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullname,
                        email,
                        phone,
                        birth_date: birthdate || null,
                        age: age ? parseInt(age) : null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal menyimpan profil');
                }

                // Show success message
                document.getElementById('profile-success').textContent = 'Profil berhasil diperbarui!';
                document.getElementById('profile-success').style.display = 'block';

                // Reload profile data
                setTimeout(() => {
                    $('#profileModal').modal('hide');
                    loadUserProfile();
                }, 1500);

            } catch (error) {
                console.error('Error saving profile:', error);
                document.getElementById('profile-error').textContent = error.message;
                document.getElementById('profile-error').style.display = 'block';
            }
        }

        // Auto-calculate age from birth date
        document.addEventListener('DOMContentLoaded', function() {
            const birthdateInput = document.getElementById('edit-birthdate');
            const ageInput = document.getElementById('edit-age');
            
            if (birthdateInput && ageInput) {
                birthdateInput.addEventListener('change', function() {
                    const birthDate = new Date(this.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    
                    ageInput.value = age >= 0 ? age : '';
                });
            }
        });

        function updateIntakeButtonCompleted() {
            // Find all intake buttons (both in quick actions and full list)
            const intakeButtons = document.querySelectorAll('a[href="/patient-intake.html"]');
            
            intakeButtons.forEach(btn => {
                // Change background to green
                btn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                btn.style.borderColor = '#27ae60';
                btn.style.color = '#ffffff';
                
                // Add checkmark icon with white color
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fa fa-check-circle';
                    icon.style.color = '#ffffff';
                    icon.style.fontSize = '48px';
                }
                
                // Update text with white color
                const textDiv = btn.querySelector('div');
                if (textDiv) {
                    textDiv.innerHTML = 'Formulir Rekam Medis<br><small style="font-size: 11px; color: #ffffff; font-weight: 600;">✓ Sudah Diselesaikan</small>';
                    textDiv.style.color = '#ffffff';
                    textDiv.style.fontWeight = '600';
                }
                
                // Make it clickable to view again (optional)
                btn.title = 'Formulir sudah diselesaikan';
            });
        }

        function logout() {
            localStorage.removeItem('patient_token');
            localStorage.removeItem('patient_user');
            window.location.href = '/index.html';
        }

        // Logout event listeners
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('logout-link').addEventListener('click', function(e) {
            e.preventDefault();
            logout();
        });

        // Password Management Functions
        let hasPassword = false; // Track if user has password set
        
        function openPasswordModal() {
            // Clear form
            document.getElementById('password-form').reset();
            document.getElementById('password-error').style.display = 'none';
            document.getElementById('password-success').style.display = 'none';
            
            // Check if user already has password
            if (hasPassword) {
                // Change Password mode
                document.getElementById('password-modal-title').textContent = 'Ubah Password';
                document.getElementById('old-password-group').style.display = 'block';
                document.getElementById('new-pass-label').textContent = 'Password Baru';
                document.getElementById('save-password-btn-text').textContent = 'Ubah Password';
                document.getElementById('password-info-text').textContent = 'Masukkan password lama dan password baru untuk mengubah password Anda.';
            } else {
                // Set Password mode
                document.getElementById('password-modal-title').textContent = 'Set Password';
                document.getElementById('old-password-group').style.display = 'none';
                document.getElementById('new-pass-label').textContent = 'Password';
                document.getElementById('save-password-btn-text').textContent = 'Set Password';
                document.getElementById('password-info-text').textContent = 'Setelah set password, Anda dapat login menggunakan email dan password.';
            }
            
            $('#passwordModal').modal('show');
        }
        
        async function savePassword() {
            try {
                // Hide previous messages
                document.getElementById('password-error').style.display = 'none';
                document.getElementById('password-success').style.display = 'none';
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Validation
                if (!newPassword || !confirmPassword) {
                    throw new Error('Semua field harus diisi');
                }
                
                if (newPassword !== confirmPassword) {
                    throw new Error('Password dan konfirmasi password tidak cocok');
                }
                
                if (newPassword.length < 6) {
                    throw new Error('Password minimal 6 karakter');
                }
                
                let endpoint, body;
                
                if (hasPassword) {
                    // Change Password
                    const oldPassword = document.getElementById('old-password').value;
                    if (!oldPassword) {
                        throw new Error('Password lama harus diisi');
                    }
                    
                    endpoint = '/api/patients/change-password';
                    body = {
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };
                } else {
                    // Set Password
                    endpoint = '/api/patients/set-password';
                    body = {
                        password: newPassword,
                        confirm_password: confirmPassword
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Gagal menyimpan password');
                }
                
                // Show success message
                document.getElementById('password-success').textContent = result.message;
                document.getElementById('password-success').style.display = 'block';
                
                // Update button text to "Ubah Password" if this was first set
                if (!hasPassword) {
                    hasPassword = true;
                    document.getElementById('password-btn-text').textContent = 'Ubah Password';
                }
                
                // Close modal after delay
                setTimeout(() => {
                    $('#passwordModal').modal('hide');
                }, 1500);
                
            } catch (error) {
                console.error('Error saving password:', error);
                document.getElementById('password-error').textContent = error.message;
                document.getElementById('password-error').style.display = 'block';
            }
        }

        // Auto-refresh token verification every 5 minutes
        setInterval(async () => {
            try {
                const response = await fetch('/api/patients/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    logout();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
