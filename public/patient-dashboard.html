<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard Pasien - Dokter Dibya</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --success: #10b981;
            --danger: #ef4444;
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #303030 100%);
        }

        body {
            background: var(--bg-gradient);
            color: #ffffff;
            font-family: 'Poppins', 'Open Sans', sans-serif;
            font-weight: 300;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-100px) rotate(180deg); }
        }
        
        a {
            color: #47C6F8;
            text-decoration: none;
        }
        
        a:hover {
            color: #0FF;
            text-decoration: none;
        }

        /* Main Content */
        .dashboard-container {
            padding: 30px 15px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Cards */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .dashboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(40, 167, 233, 0.3);
            border-color: #28a7e9;
        }
        
        .dashboard-card h3 {
            color: #28a7e9;
            font-size: 24px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .dashboard-card h3 i {
            margin-right: 10px;
            width: 30px;
        }
        
        .dashboard-card h3[onclick] {
            transition: color 0.3s;
        }
        
        .dashboard-card h3[onclick]:hover {
            color: #47C6F8;
        }
        
        #welcome-toggle-icon {
            transition: transform 0.3s;
        }

        /* Collapsible Card Styles */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .collapsible-header:hover .toggle-icon {
            color: #28a7e9;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
        }

        .collapsed + .collapsible-header .toggle-icon,
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        /* Alert */
        .alert-info-custom {
            background: rgba(40, 167, 233, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 167, 233, 0.3);
            border-left: 4px solid #28a7e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #ffffff;
        }

        .alert-info-custom i {
            color: #28a7e9;
            margin-right: 10px;
        }

        .alert-success-custom {
            background: rgba(40, 233, 112, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(40, 233, 112, 0.3);
            border-left: 4px solid #28e970;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #ffffff;
        }

        .alert-success-custom i {
            color: #28e970;
            margin-right: 10px;
        }

        .appointment-info-box {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .appointment-info-box p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .appointment-info-box strong {
            color: #28e970;
        }

        .cancel-appointment-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px 16px;
            background: #d9534f;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .cancel-appointment-btn:hover {
            background: #c9302c;
            transform: translateY(-2px);
        }

        .cancel-appointment-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
            z-index: 9999;
        }

        .dashboard-modal.active {
            display: flex;
        }

        .dashboard-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 25px;
            color: #ffffff;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .dashboard-modal-content h4 {
            margin-top: 0;
            color: #28a7e9;
            font-weight: 600;
        }

        .dashboard-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #bbbbbb;
            font-size: 22px;
            cursor: pointer;
        }

        .dashboard-modal-close:hover {
            color: #ffffff;
        }

        .cancel-summary {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .cancel-summary strong {
            color: #28a7e9;
        }

        .dashboard-modal textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #ffffff;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .modal-actions .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .modal-actions .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .modal-actions .btn-danger {
            background: #d9534f;
            color: #ffffff;
        }

        .modal-actions .btn-danger:hover {
            background: #c9302c;
            transform: translateY(-1px);
        }

        .modal-error {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 13px;
        }

        .dashboard-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a7e9;
            color: #ffffff;
            padding: 12px 18px;
            border-radius: 6px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10000;
        }

        .dashboard-toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .dashboard-toast.error {
            background: #d9534f;
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-action-btn {
            padding: 25px 15px;
            background: #303030;
            border: 2px solid #28a7e9;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #28a7e9;
            display: block;
        }
        
        .quick-action-btn:hover {
            background: #28a7e9;
            color: #ffffff;
            text-decoration: none;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(40, 167, 233, 0.4);
        }
        
        .quick-action-btn i {
            font-size: 36px;
            display: block;
            margin-bottom: 10px;
        }
        
        .quick-action-btn div {
            font-size: 13px;
            line-height: 1.4;
        }

        .quick-action-thumbnail .quick-thumb-container {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px auto;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(40, 167, 233, 0.1);
        }

        .quick-action-thumbnail .quick-thumb-container i {
            font-size: 28px;
            margin: 0;
        }

        .quick-action-thumbnail .quick-thumb-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .quick-action-thumbnail:hover .quick-thumb-container {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Glowing effect for new/unviewed items */
        .glow-new {
            animation: glowPulse 2s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(40, 233, 127, 0.6);
            border: 2px solid #28e97f !important;
        }

        /* Green background for dashboard cards with new items */
        .dashboard-card.glow-new {
            background: linear-gradient(135deg, rgba(40, 233, 127, 0.15) 0%, rgba(40, 233, 127, 0.05) 100%) !important;
        }

        /* Green background for quick action buttons with new items */
        .quick-action-btn.glow-new {
            background: linear-gradient(135deg, rgba(40, 233, 127, 0.3) 0%, rgba(40, 233, 127, 0.1) 100%) !important;
            border-color: #28e97f !important;
            color: #28e97f !important;
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(40, 233, 127, 0.4); }
            50% { box-shadow: 0 0 25px rgba(40, 233, 127, 0.8); }
        }

        /* Lab result item with thumbnail */
        .lab-result-item {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .lab-result-item:hover {
            transform: scale(1.02);
        }

        .lab-result-item .lab-thumb {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .lab-result-item .lab-info {
            padding: 12px;
        }

        .lab-result-item .lab-title {
            font-weight: 600;
            color: #fff;
            font-size: 13px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lab-result-item .lab-date {
            font-size: 11px;
            color: #aaa;
        }

        .lab-result-item .new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #28e97f;
            color: #000;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Ultrasound Gallery */
        #ultrasound-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ultrasound-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ultrasound-item:hover {
            transform: scale(1.05);
            border-color: #28a7e9;
        }

        .ultrasound-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ultrasound-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 10px;
            color: #ffffff;
            font-size: 12px;
        }

        .ultrasound-item .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ultrasound-item:hover .delete-btn {
            opacity: 1;
        }

        .ultrasound-item .delete-btn:hover {
            background: rgba(239, 68, 68, 1);
        }

        /* My Documents Section */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .document-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .document-card:hover {
            border-color: #28a7e9;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(40, 167, 233, 0.2);
        }

        .document-card .doc-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .document-card .doc-icon.resume { background: rgba(40, 167, 233, 0.2); color: #28a7e9; }
        .document-card .doc-icon.usg { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .document-card .doc-icon.lab { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .document-card .doc-icon.other { background: rgba(168, 162, 158, 0.2); color: #a8a29e; }

        .document-card .doc-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 14px;
            line-height: 1.4;
        }

        .document-card .doc-date {
            font-size: 12px;
            color: #888888;
            margin-bottom: 12px;
        }

        .document-card .doc-actions {
            display: flex;
            gap: 8px;
        }

        .document-card .doc-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .document-card .doc-btn.view-btn {
            background: rgba(40, 167, 233, 0.2);
            color: #28a7e9;
            border: 1px solid rgba(40, 167, 233, 0.3);
        }

        .document-card .doc-btn.view-btn:hover {
            background: #28a7e9;
            color: #ffffff;
        }

        .document-card .doc-btn.download-btn {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .document-card .doc-btn.download-btn:hover {
            background: #22c55e;
            color: #ffffff;
        }

        .document-card.glow-new {
            background: linear-gradient(135deg, rgba(40, 233, 127, 0.2) 0%, rgba(40, 233, 127, 0.05) 100%);
            border-color: #28e97f;
        }

        .documents-empty {
            text-align: center;
            padding: 30px;
            color: #888888;
        }

        .documents-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #555555;
        }

        .documents-empty p {
            margin: 0;
            font-size: 14px;
        }

        .document-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .document-badge.new {
            background: rgba(40, 167, 233, 0.2);
            color: #28a7e9;
        }

        /* Patient Upload Section - Different styling from clinic documents */
        .patient-uploads-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-color: rgba(168, 85, 247, 0.3);
        }

        .patient-uploads-section h3 {
            color: #a855f7;
        }

        .patient-upload-card {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-upload-card:hover {
            border-color: #a855f7;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(168, 85, 247, 0.2);
        }

        .patient-upload-card .doc-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .patient-upload-card .doc-icon.patient-usg { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .patient-upload-card .doc-icon.patient-lab { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .patient-upload-card .doc-icon.patient-other { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

        .patient-upload-card .doc-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 14px;
            line-height: 1.4;
        }

        .patient-upload-card .doc-date {
            font-size: 12px;
            color: #888888;
            margin-bottom: 8px;
        }

        .patient-upload-card .original-date {
            font-size: 11px;
            color: #a855f7;
            margin-bottom: 12px;
        }

        .patient-upload-card .doc-actions {
            display: flex;
            gap: 8px;
        }

        .patient-upload-card .doc-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .patient-upload-card .doc-btn.view-btn {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .patient-upload-card .doc-btn.view-btn:hover {
            background: #a855f7;
            color: #ffffff;
        }

        .patient-upload-card .doc-btn.delete-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .patient-upload-card .doc-btn.delete-btn:hover {
            background: #ef4444;
            color: #ffffff;
        }

        .patient-upload-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(168, 85, 247, 0.3);
            color: #a855f7;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .upload-btn-container {
            margin-bottom: 15px;
        }

        .upload-trigger-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-trigger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(168, 85, 247, 0.4);
        }

        .upload-trigger-btn i {
            font-size: 16px;
        }

        /* Profile Info */
        .profile-info {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-info li {
            padding: 12px 0;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-info li:last-child {
            border-bottom: none;
        }

        .profile-info strong {
            color: #28a7e9;
            font-weight: 500;
        }

        .profile-info span {
            color: #cccccc;
            text-align: right;
        }
        
        /* Buttons */
        .action-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #28a7e9;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 15px;
            transition: all 0.3s;
            border: none;
            font-size: 16px;
            cursor: pointer;
            font-weight: 400;
        }
        
        .action-btn:hover {
            background: #0FF;
            color: #303030;
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .action-btn i {
            margin-right: 8px;
        }
        
        .action-btn-secondary {
            background: #505050;
        }
        
        .action-btn-secondary:hover {
            background: #606060;
            color: #ffffff;
        }
        
        .logout-btn {
            background: #d9534f;
        }
        
        .logout-btn:hover {
            background: #c9302c;
            color: #ffffff;
        }
        
        /* Empty State */
        .empty-state {
            color: #808080;
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Visit Cards */
        .visit-card-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .visit-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .visit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .visit-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }

        .visit-card p {
            font-size: 13px;
            margin-bottom: 5px;
            color: #666;
        }

        /* Navigation */
        .nav-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-bar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 40px;
        }

        .nav-links {
            display: flex;
            gap: 5px;
            margin-left: 15px;
        }

        .welcome-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .welcome-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }

        .welcome-title span {
            color: #0066FF;
        }

        .welcome-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin: 2px 0 0 0;
            line-height: 1.2;
        }

        .nav-bar a {
            color: #cccccc;
            padding: 10px 15px;
            display: inline-block;
            transition: color 0.3s;
        }

        .nav-bar a:hover {
            color: #28a7e9;
        }

        .nav-bar a i {
            margin-right: 5px;
        }

        /* Notification Bell Styles */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px 15px;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        .notification-bell:hover {
            transform: scale(1.1);
        }
        .notification-bell i {
            font-size: 22px;
            color: #cccccc;
            transition: color 0.3s;
        }
        .notification-bell:hover i {
            color: #28a7e9;
        }
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 8px;
            background: #dc3545;
            color: white;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border-radius: 50%;
            padding: 0 4px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Notification Inbox Modal Styles */
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
            cursor: pointer;
        }
        .notification-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .notification-item.unread {
            background: rgba(40,167,233,0.1);
            border-left: 3px solid #28a7e9;
        }
        .notification-item .notif-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .notification-item .notif-time {
            font-size: 11px;
            color: #888;
        }
        .notification-item .notif-title {
            font-weight: 600;
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 4px;
        }
        .notification-item .notif-message {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 0;
        }

        .user-avatar-nav {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            margin-right: 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .user-avatar-nav:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
        }

        .user-info-nav {
            display: flex;
            flex-direction: column;
            text-align: right;
        }

        .user-info-nav .user-name {
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
        }

        .user-info-nav .user-role {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            line-height: 1.2;
        }

        /* Dropdown Menu */
        .dropdown-menu-custom {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            padding: 8px 0;
            z-index: 1000;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .dropdown-menu-custom.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu-custom a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #ffffff;
            text-decoration: none;
            transition: background 0.2s;
            font-size: 14px;
        }

        .dropdown-menu-custom a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #28a7e9;
        }

        .dropdown-menu-custom a i {
            width: 18px;
            text-align: center;
            font-size: 16px;
        }

        .dropdown-menu-custom a.logout {
            color: #ef4444;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 4px;
        }

        .dropdown-menu-custom a.logout:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 24px;
                margin: 15px 0 5px;
            }
            
            .dashboard-card {
                padding: 20px;
            }
            
            .dashboard-card h3 {
                font-size: 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .quick-action-btn {
                padding: 20px 10px;
            }
            
            .quick-action-btn i {
                font-size: 28px;
            }
            
            .quick-action-btn div {
                font-size: 12px;
            }
            
            .profile-info li {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .profile-info span {
                text-align: left;
            }
            
            .nav-bar {
                padding: 8px 0;
            }

            .nav-bar .container {
                flex-direction: row;
                gap: 10px;
                padding: 0 10px;
            }

            .nav-links {
                margin-left: 0;
                flex: 1;
            }

            .welcome-text {
                text-align: left;
            }

            .welcome-title {
                font-size: 14px;
            }

            .welcome-subtitle {
                font-size: 10px;
                margin-top: 0;
            }

            .nav-bar a {
                padding: 6px 8px;
                font-size: 13px;
            }

            .user-info-nav {
                display: none;
            }

            .notification-bell {
                padding: 6px 10px;
                margin-right: 5px;
            }

            .notification-bell i {
                font-size: 18px;
            }

            .user-avatar-nav {
                margin-right: 0;
                padding-left: 0 !important;
            }

            .avatar-circle {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .nav-bar {
                padding: 6px 0;
            }

            .nav-bar .container {
                padding: 0 8px;
            }

            .welcome-title {
                font-size: 13px;
            }

            .welcome-subtitle {
                font-size: 9px;
            }

            .notification-bell {
                padding: 4px 8px;
            }

            .notification-bell i {
                font-size: 16px;
            }

            .avatar-circle {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            .dashboard-container {
                padding: 15px 10px;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .dashboard-card h3 {
                font-size: 18px;
            }

            .welcome-message p {
                font-size: 14px !important;
            }

            .welcome-message strong[style*="font-size: 20px"] {
                font-size: 17px !important;
            }

            .dashboard-card p {
                font-size: 14px;
            }
        }

        /* Toast animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="container">
            <div class="nav-links">
                <div class="welcome-text">
                    <h2 class="welcome-title"><span style="color: #ffffff;">dokter</span><span style="color: #0066FF;">DIBYA</span></h2>
                    <p class="welcome-subtitle">Portal Privat Kandungan Anda</p>
                </div>
            </div>
            <!-- Notification Bell -->
            <div class="notification-bell" id="notification-bell" onclick="openNotificationsInbox()" title="Notifikasi">
                <i class="fa fa-bell"></i>
                <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
            </div>
      <div class="user-avatar-nav" onclick="toggleDropdown(event)">
                <div class="avatar-circle" id="user-avatar">
                    <img id="user-avatar-img" src="" alt="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                    <span id="user-avatar-initials">NA</span>
                </div>
                <div class="user-info-nav">
                    <div class="user-name" id="user-name-nav">Nanda Ananda</div>
                    <div class="user-role">Pasien</div>
                </div>
                <div class="dropdown-menu-custom" id="user-dropdown">
                    <a href="#" onclick="openProfileModal(); toggleDropdown(event);">
                        <i class="fa fa-edit"></i>
                        <span>Edit Profil</span>
                    </a>
                    <a href="#" onclick="openProfileViewModal(event)">
                        <i class="fa fa-cog"></i>
                        <span>Setting</span>
                    </a>
                    <a href="#" onclick="logout(event)" class="logout">
                        <i class="fa fa-sign-out"></i>
                        <span>Log out</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Welcome Message -->
        <div class="dashboard-card welcome-message" id="welcome-card" style="margin-bottom: 30px;">
            <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleWelcomeMessage()">
                <span><i class="fa fa-heart"></i> Selamat Datang</span>
                <i class="fa fa-chevron-down" id="welcome-toggle-icon"></i>
            </h3>
            <div id="welcome-content" style="line-height: 1.9; color: #e0e0e0; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 400;">
                <p style="font-size: 16px;">Halaman ini adalah ruang khusus bagi Anda — tempat saya membantu Anda, memantau kehamilan atau kesehatan kandungan Anda secara berkala dan privat. Semua catatan dan informasi di sini bersifat <strong style="color: #28a7e9; font-weight: 600;">rahasia</strong>. Mohon untuk tidak membagikan halaman rekam medis kepada orang selain keluarga inti/ keluarga yang dipercaya. Karena itulah keamanan sistem ini menjadi prioritas saya dengan menerapkan proteksi berlapis dan enkripsi untuk mencegah peretasan.</p>
                                
                <p style="font-size: 16px;">Adanya <strong style="font-weight: 600;"><span style="color: #ffffff;">dokter</span><span style="color: #0066FF;">DIBYA</span></strong> berawal dari keinginan <i>sederhana</i> saya, yaitu agar setiap pasien bisa tetap terhubung dengan dokter pilihannya, tanpa batasan rumah sakit, tempat, atau waktu. Update selalu dengan perubahan jadwal dari saya, reminding jadwal kontrol, booking slot dengan mudah, dan bahkan kedepan bukan tidak mungkin konsultasi secara online dengan jadwal yang disepakati!</p>
                
                <p style="font-size: 16px;">Walaupun demikian saya paham, banyak tantangan dan kesulitan dalam memulai hal baru. Tapi saya percaya, langkah kecil ini bisa membawa perubahan besar menuju pelayanan berkesinambungan dari dokter favorit Anda. Sebelum kita memulai perjalanan ini, mohon mengisi data pribadi dan riwayat medis, data kehamilan, masalah kandungan, riwayat KB. Besar harapan saya, Anda mengisi dengan lengkap sehingga dapat menjadi modalitas bagi saya dalam pemilihan terapi dan layanan terbaik untuk Anda.</p>
                
                <p style="margin-top: 20px; font-size: 16px;">Terima kasih telah menjadi bagian dari <strong style="color: #28a7e9; font-weight: 600;">"modern therapy without boundary"</strong> — pendampingan dan terapi berkelanjutan, di mana pun dan kapan pun Anda membutuhkannya.</p>
                
                <p style="margin-top: 30px; text-align: right; color: #28a7e9; font-size: 17px;">
                    <strong style="font-weight: 500;">Salam hangat,</strong><br>
                    <strong style="font-size: 20px; font-weight: 600;">dokter Anda</strong>
                </p>
            </div>
        </div>
        
        <!-- Alert for first-time users -->
        <div class="alert-info-custom" id="first-time-alert" style="display: none;">
            <i class="fa fa-info-circle"></i> <strong>Langkah Selanjutnya:</strong>
            Lengkapi formulir identitas pribadi Anda untuk memulai journey Anda.
        </div>

        <!-- Birth Congratulations Card - Hidden by default, shown when data exists -->
        <div class="row" id="birth-congrats-row" style="margin-bottom: 30px; display: none;">
            <div class="col-md-12">
                <div class="dashboard-card" id="birth-congrats-card" style="
                    background: transparent;
                    border: none;
                    position: relative;
                    overflow: visible;
                ">
                    <!-- Decorative Corner Accents -->
                    <div class="birth-corner-accent" id="birth-corner-tl" style="position: absolute; top: 0; left: 0; width: 50px; height: 50px; border-top: 3px solid #a855f7; border-left: 3px solid #a855f7; z-index: 10;"></div>
                    <div class="birth-corner-accent" id="birth-corner-tr" style="position: absolute; top: 0; right: 0; width: 50px; height: 50px; border-top: 3px solid #a855f7; border-right: 3px solid #a855f7; z-index: 10;"></div>
                    <div class="birth-corner-accent" id="birth-corner-bl" style="position: absolute; bottom: 0; left: 0; width: 50px; height: 50px; border-bottom: 3px solid #a855f7; border-left: 3px solid #a855f7; z-index: 10;"></div>
                    <div class="birth-corner-accent" id="birth-corner-br" style="position: absolute; bottom: 0; right: 0; width: 50px; height: 50px; border-bottom: 3px solid #a855f7; border-right: 3px solid #a855f7; z-index: 10;"></div>

                    <!-- Header -->
                    <div style="margin-bottom: 20px;">
                        <h2 id="birth-card-title" style="color: #a855f7; font-size: 22px; font-weight: 600; margin-bottom: 5px;">
                            <i class="fa fa-heart" id="birth-card-icon" style="color: #a855f7; margin-right: 8px;"></i>
                            Selamat atas Kelahiran Buah Hati!
                        </h2>
                        <p style="color: #888; font-size: 12px; margin: 0;" id="birth-congrats-doctor"></p>
                    </div>

                    <!-- Content Container -->
                    <div style="display: flex; align-items: flex-start; gap: 25px; flex-wrap: wrap;">
                        <!-- Photo -->
                        <div id="birth-photo-container" onclick="openBirthPhotoModal()" style="
                            width: 180px;
                            height: 180px;
                            border-radius: 15px;
                            overflow: hidden;
                            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.3);
                            border: 3px solid rgba(168, 85, 247, 0.5);
                            flex-shrink: 0;
                            cursor: pointer;
                        ">
                            <img id="birth-photo" src="" alt="Foto Kelahiran" style="width: 100%; height: 100%; object-fit: cover;" />
                        </div>

                        <!-- Details -->
                        <div style="flex: 1; min-width: 280px; text-align: left;">
                            <h3 id="birth-baby-name" style="color: #a855f7; font-size: 28px; font-weight: 700; margin-bottom: 8px;"></h3>
                            <p id="birth-subtitle" style="color: #9ca3af; font-size: 13px; margin-bottom: 15px;"></p>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;" id="birth-details-grid">
                                <div class="birth-detail-box" style="
                                    padding: 15px;
                                    border-radius: 12px;
                                    background: rgba(30, 30, 40, 0.9);
                                    border: 1px solid rgba(168, 85, 247, 0.3);
                                ">
                                    <div class="birth-detail-label" style="color: #9ca3af; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Tanggal Lahir</div>
                                    <div id="birth-date" style="color: #ffffff; font-weight: 600; font-size: 15px;"></div>
                                </div>
                                <div class="birth-detail-box" style="
                                    padding: 15px;
                                    border-radius: 12px;
                                    background: rgba(30, 30, 40, 0.9);
                                    border: 1px solid rgba(168, 85, 247, 0.3);
                                ">
                                    <div class="birth-detail-label" style="color: #9ca3af; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Jam</div>
                                    <div id="birth-time" style="color: #ffffff; font-weight: 600; font-size: 15px;"></div>
                                </div>
                                <div class="birth-detail-box" style="
                                    padding: 15px;
                                    border-radius: 12px;
                                    background: rgba(30, 30, 40, 0.9);
                                    border: 1px solid rgba(168, 85, 247, 0.3);
                                ">
                                    <div class="birth-detail-label" style="color: #9ca3af; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Berat Badan</div>
                                    <div id="birth-weight" style="color: #ffffff; font-weight: 600; font-size: 15px;"></div>
                                </div>
                                <div class="birth-detail-box" style="
                                    padding: 15px;
                                    border-radius: 12px;
                                    background: rgba(30, 30, 40, 0.9);
                                    border: 1px solid rgba(168, 85, 247, 0.3);
                                ">
                                    <div class="birth-detail-label" style="color: #9ca3af; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Panjang Badan</div>
                                    <div id="birth-length" style="color: #ffffff; font-weight: 600; font-size: 15px;"></div>
                                </div>
                            </div>

                            <!-- Message from Doctor -->
                            <div id="birth-message-container" style="
                                padding: 15px 20px;
                                border-radius: 12px;
                                background: rgba(30, 30, 40, 0.9);
                                border-left: 3px solid #a855f7;
                            ">
                                <div class="birth-message-label" style="color: #a855f7; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                                    <i class="fa fa-quote-left" style="margin-right: 5px;"></i> Pesan dari Dokter
                                </div>
                                <p id="birth-message" style="color: #e5e7eb; font-size: 14px; margin: 0; line-height: 1.6;"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Announcements Section -->
        <div class="dashboard-card" id="announcements-section" style="margin-bottom: 30px;">
            <h3 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleAnnouncementsSection()">
                <span><i class="fa fa-bullhorn"></i> Pengumuman</span>
                <i class="fa fa-chevron-down" id="announcements-toggle-icon"></i>
            </h3>
            <div id="announcements-content">
                <div id="announcements-container">
                    <!-- Announcements will be loaded here -->
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 10px;">Memuat pengumuman...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pregnancy Tracker Section -->
        <div class="row" id="pregnancy-tracker-row" style="margin-bottom: 30px; display: none;">
            <div class="col-md-12">
                <div class="dashboard-card" id="pregnancy-tracker-card" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d1b4e 50%, #1a1a2e 100%); border: 1px solid rgba(168, 85, 247, 0.3); position: relative; overflow: hidden;">
                    <!-- Decorative elements -->
                    <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%); border-radius: 50%;"></div>

                    <h3 style="color: #a855f7; position: relative; z-index: 1;">
                        <i class="fa fa-heartbeat"></i> Pregnancy Tracker
                    </h3>

                    <div id="pregnancy-tracker-content" style="position: relative; z-index: 1;">
                        <!-- Content loaded via JS -->
                        <div style="text-align: center; padding: 20px; color: #999;">
                            <i class="fa fa-spinner fa-spin fa-2x"></i>
                            <p style="margin-top: 10px;">Memuat data kehamilan...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Journey Book - Full Width after Announcements -->
        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-12">
                <div class="dashboard-card" id="journey-book-card" style="cursor: pointer; position: relative; overflow: hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); border: 1px solid rgba(212, 175, 55, 0.3);" onclick="window.location.href='/perjalanan-ibu.html'">
                    <!-- Background Pattern -->
                    <div style="position: absolute; top: 0; right: 0; bottom: 0; left: 0; opacity: 0.08; background-image: url('/images/dokter-dibya-book/1.png'); background-size: cover; background-position: center;"></div>

                    <!-- Decorative Gold Corner Accents -->
                    <div style="position: absolute; top: 0; left: 0; width: 40px; height: 40px; border-top: 2px solid #d4af37; border-left: 2px solid #d4af37;"></div>
                    <div style="position: absolute; top: 0; right: 0; width: 40px; height: 40px; border-top: 2px solid #d4af37; border-right: 2px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 0; left: 0; width: 40px; height: 40px; border-bottom: 2px solid #d4af37; border-left: 2px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 0; right: 0; width: 40px; height: 40px; border-bottom: 2px solid #d4af37; border-right: 2px solid #d4af37;"></div>

                    <!-- Content Overlay - Horizontal Layout -->
                    <div style="position: relative; z-index: 1; padding: 25px; display: flex; align-items: center; gap: 30px; flex-wrap: wrap;">
                        <!-- Book Image -->
                        <div style="flex-shrink: 0;">
                            <img src="/images/dokter-dibya-book/thumb-book.jpeg" alt="Perjalanan menjadi Ibu" style="width: 120px; height: auto; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); border: 2px solid rgba(212, 175, 55, 0.3);">
                        </div>

                        <!-- Text Content -->
                        <div style="flex: 1; min-width: 200px;">
                            <h2 style="color: #f5f5f5; font-size: 22px; font-weight: 400; margin-bottom: 5px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); font-style: italic;">Perjalanan menjadi Ibu</h2>
                            <p style="font-size: 11px; font-style: italic; margin-bottom: 10px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; color: #ccc;">by <span style="color: #ffffff; font-weight: 600;">dokter</span><span style="color: #0066FF; font-weight: 600;">DIBYA</span></p>
                            <p style="color: #e0e0e0; font-size: 13px; line-height: 1.5; margin: 0; font-family: 'Georgia', serif;">
                                <i class="fa fa-hand-pointer-o" style="color: #d4af37; margin-right: 8px;"></i>
                                <strong style="color: #d4af37;">Klik untuk membuka</strong> buku interaktif perjalanan kehamilan Anda
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ruang Membaca dari dokterDIBYA - Moved after Journey Book -->
        <div class="row" style="margin-bottom: 30px;">
            <div class="col-md-12">
                <div class="dashboard-card" id="articles-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header" id="articles-header" onclick="toggleCard('articles')">
                        <span><i class="fa fa-book"></i> Ruang Membaca</span>
                        <i class="fa fa-chevron-down toggle-icon" id="articles-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content" id="articles-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">
                            <i class="fa fa-stethoscope"></i> Artikel pilihan dari <strong><span style="color: #ffffff;">dokter</span><span style="color: #0066FF;">DIBYA</span></strong> berdasarkan jurnal terkini
                        </p>
                        <div id="articles-container">
                            <!-- Articles will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards Layout - 2 Column on Desktop -->
        <div class="row" style="margin-bottom: 30px;">
            <!-- Left Column -->
            <div class="col-md-6 col-xs-12" style="display: flex; flex-direction: column;">
                <!-- 1. Klinik Privat Minggu -->
                <div class="dashboard-card" id="appointments-section" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-calendar-check-o"></i> Klinik Privat Minggu</h3>
                    <div id="booking-status-container">
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Belum ada janji temu yang dijadwalkan
                        </p>
                    </div>
                    <a href="/booking-appointment.html" class="action-btn" id="booking-create-btn">
                        <i class="fa fa-plus"></i> Buat Janji Temu
                    </a>
                </div>

                <!-- 2. Jadwal dan Lokasi -->
                <div class="dashboard-card" id="jadwal-praktek-section" style="margin-bottom: 20px;">
                    <h3><i class="fa fa-calendar"></i> Jadwal dan Lokasi</h3>
                    <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">Lihat jadwal lengkap dan lokasi praktek</p>
                    <a href="/practice-locations.html" class="action-btn" style="display: block; text-align: center;">
                        <i class="fa fa-map-marker"></i> Lihat Semua Lokasi Praktek
                    </a>
                </div>

                <!-- Kalender Kesuburan -->
                <div class="dashboard-card" id="fertility-calendar-section" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #2e1a3d 50%, #1a1a2e 100%); border: 1px solid rgba(255, 107, 157, 0.3);">
                    <h3 style="color: #ff6b9d;"><i class="fa fa-calendar-heart" style="color: #ff6b9d;"></i> Kalender Kesuburan</h3>
                    <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">Catat siklus menstruasi dan prediksi masa subur</p>
                    <a href="/fertility-calendar.html" class="action-btn" style="display: block; text-align: center; background: linear-gradient(135deg, #ff6b9d 0%, #c850c0 100%); border: none;">
                        <i class="fa fa-heart"></i> Buka Kalender Kesuburan
                    </a>
                </div>

                <!-- 3. Janji Temu di RS (Hospital Booking) -->
                <div class="dashboard-card" id="hospital-booking-section" style="margin-bottom: 20px; display: none;">
                    <h3 class="collapsible-header" id="hospital-booking-header" onclick="toggleCard('hospital-booking')">
                        <span><i class="fa fa-hospital-o"></i> Janji Temu di RS</span>
                        <i class="fa fa-chevron-down toggle-icon" id="hospital-booking-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content" id="hospital-booking-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">Booking jadwal praktek dr. Dibya di rumah sakit</p>
                        <div id="hospital-schedules-container">
                            <p class="empty-state">
                                <i class="fa fa-spinner fa-spin"></i>
                                Memuat jadwal rumah sakit...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 4. Riwayat Kunjungan (Medical Records) - HIDDEN -->
                <div class="dashboard-card" id="visits-history-section" style="display: none; margin-bottom: 20px;">
                    <h3 class="collapsible-header collapsed" id="visits-history-header" onclick="toggleCard('visits-history')">
                        <span><i class="fa fa-stethoscope"></i> Riwayat Kunjungan</span>
                        <i class="fa fa-chevron-right toggle-icon" id="visits-history-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content collapsed" id="visits-history-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">Kunjungan Anda di berbagai lokasi praktek</p>
                        <div id="visits-list-container">
                            <p class="empty-state">
                                <i class="fa fa-spinner fa-spin"></i>
                                Memuat riwayat kunjungan...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 5. Riwayat Medis (Patient Uploads) -->
                <div class="dashboard-card patient-uploads-section" id="patient-uploads-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header collapsed" id="patient-uploads-header" onclick="toggleCard('patient-uploads')">
                        <span><i class="fa fa-history"></i> Riwayat Medis</span>
                        <i class="fa fa-chevron-right toggle-icon" id="patient-uploads-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content collapsed" id="patient-uploads-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">Upload hasil USG, lab, atau dokumen medis Anda sebelum menggunakan aplikasi ini</p>

                        <div class="upload-btn-container">
                            <button type="button" class="upload-trigger-btn" onclick="openPatientUploadModal()">
                                <i class="fa fa-cloud-upload"></i> Upload Dokumen
                            </button>
                        </div>

                        <div id="patient-uploads-container">
                            <div class="documents-loading" style="text-align: center; padding: 20px;">
                                <i class="fa fa-spinner fa-spin"></i> Memuat riwayat...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6 col-xs-12" style="display: flex; flex-direction: column;">
                <!-- 1. Jadwal Vitamin -->
                <div class="dashboard-card" id="medications-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header collapsed" id="medications-header" onclick="toggleCard('medications')">
                        <span><i class="fa fa-medkit"></i> Jadwal Vitamin</span>
                        <i class="fa fa-chevron-right toggle-icon" id="medications-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content collapsed" id="medications-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 15px;">Kelola jadwal vitamin dan obat Anda</p>
                        <div id="medications-list-container">
                            <p class="empty-state">
                                <i class="fa fa-medkit"></i>
                                Belum ada jadwal vitamin atau obat
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 2. Rekam Medis Saya -->
                <div class="dashboard-card" id="documents-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header collapsed" id="documents-header" onclick="toggleCard('documents')">
                        <span><i class="fa fa-folder-open"></i> Rekam Medis Saya</span>
                        <i class="fa fa-chevron-right toggle-icon" id="documents-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content collapsed" id="documents-content">
                        <div id="my-documents-container">
                            <div class="documents-loading" style="text-align: center; padding: 20px;">
                                <i class="fa fa-spinner fa-spin"></i> Memuat dokumen...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Album USG (renamed from Foto USG) -->
                <div class="dashboard-card" id="usg-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header" id="usg-header" onclick="toggleCard('usg')">
                        <span><i class="fa fa-picture-o"></i> Album USG</span>
                        <i class="fa fa-chevron-down toggle-icon" id="usg-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content" id="usg-content">
                        <!-- Full gallery showing all USG photos -->
                        <div id="ultrasound-gallery">
                            <p class="empty-state">
                                <i class="fa fa-image"></i>
                                Belum ada foto USG dari dokter
                            </p>
                        </div>
                        <!-- Mini gallery (hidden, used for other purposes) -->
                        <div id="ultrasound-gallery-mini" style="display: none;"></div>
                    </div>
                </div>

                <!-- 4. Hasil Lab dari Dokter -->
                <div class="dashboard-card" id="lab-section" style="margin-bottom: 20px;">
                    <h3 class="collapsible-header collapsed" id="lab-header" onclick="toggleCard('lab')">
                        <span><i class="fa fa-flask"></i> Hasil Lab</span>
                        <i class="fa fa-chevron-right toggle-icon" id="lab-toggle-icon"></i>
                    </h3>
                    <div class="collapsible-content collapsed" id="lab-content">
                        <p class="text-muted" style="font-size: 12px; margin-bottom: 10px;">Hasil laboratorium yang dikirim oleh dokter Anda</p>
                        <div id="lab-results-container">
                            <p class="empty-state">
                                <i class="fa fa-flask"></i>
                                Belum ada hasil lab dari dokter
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 5. Identitas Pribadi (moved to right column) -->
                <div class="dashboard-card" id="identity-section" style="margin-bottom: 20px;">
                    <h3 style="font-size: 19.2px;"><i class="fa fa-file-text"></i> IDENTITAS PRIBADI</h3>
                    <div style="padding: 15px 0; display: flex; align-items: center; justify-content: center;">
                        <a href="/patient-intake.html" class="action-btn" style="display: block; text-align: center;">
                            <i class="fa fa-edit"></i> Lihat & Edit Identitas Pribadi
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Kenangan - Premium Feature (HIDDEN) -->
        <div class="row" style="display: none;">
            <div class="col-md-12">
                <div class="dashboard-card gallery-kenangan-card" style="cursor: pointer; position: relative; overflow: hidden; background: linear-gradient(135deg, #fdf2f4 0%, #f9e8ea 50%, #fce4ec 100%); border: 1px solid rgba(232, 180, 184, 0.4);" onclick="window.location.href='/gallery-kenangan.html'">
                    <!-- Floating hearts decoration -->
                    <div style="position: absolute; top: 10px; right: 20px; font-size: 20px; opacity: 0.3; animation: floatHeart 3s ease-in-out infinite;">💕</div>
                    <div style="position: absolute; bottom: 15px; left: 30px; font-size: 16px; opacity: 0.2; animation: floatHeart 4s ease-in-out infinite 1s;">💗</div>

                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <!-- Icon -->
                        <div style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #e8b4b8, #d4a5a5); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(232, 180, 184, 0.4);">
                            <i class="fa fa-image" style="font-size: 28px; color: white;"></i>
                        </div>

                        <!-- Content -->
                        <div style="flex: 1; min-width: 200px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <h3 style="margin: 0; font-size: 20px; color: #5d4e5c; font-family: 'Palatino Linotype', serif;">Gallery Kenangan Anda</h3>
                                <span style="background: linear-gradient(135deg, #d4af37, #f5e6c8); color: #5d4e3c; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 600;">
                                    <i class="fa fa-crown" style="margin-right: 4px;"></i>PREMIUM
                                </span>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #8b7d8a; line-height: 1.5;">
                                Lihat momen indah USG 4D Anda dalam gallery eksklusif dengan tema romantis
                            </p>
                        </div>

                        <!-- Arrow -->
                        <div style="color: #d4a5a5; font-size: 24px;">
                            <i class="fa fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            @keyframes floatHeart {
                0%, 100% { transform: translateY(0) rotate(0deg); }
                50% { transform: translateY(-10px) rotate(5deg); }
            }
            .gallery-kenangan-card:hover {
                transform: translateY(-5px) !important;
                box-shadow: 0 15px 40px rgba(232, 180, 184, 0.4) !important;
                border-color: #e8b4b8 !important;
            }
        </style>

        <!-- AKSI CEPAT - Hidden -->
        <div class="row" style="display: none;">
            <!-- Quick Actions -->
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h3><i class="fa fa-bolt"></i> Aksi Cepat</h3>
                    <div class="quick-actions">
                        <a href="/patient-intake.html" class="quick-action-btn">
                            <i class="fa fa-file-text"></i>
                            <div>Formulir<br>Rekam Medis Awal</div>
                        </a>
                        <a href="/practice-locations.html" class="quick-action-btn" id="quick-appointment">
                            <i class="fa fa-calendar"></i>
                            <div>Jadwal &<br>Janji Konsultasi</div>
                        </a>
                        <a href="#usg-section" class="quick-action-btn quick-action-thumbnail" id="quick-usg" onclick="document.getElementById('usg-section').scrollIntoView({behavior: 'smooth', block: 'start'}); return false;">
                            <div class="quick-thumb-container" id="quick-usg-thumb">
                                <i class="fa fa-heartbeat"></i>
                            </div>
                            <div>USG &amp;<br>Imaging</div>
                        </a>
                        <a href="#lab-section" class="quick-action-btn quick-action-thumbnail" id="quick-lab" onclick="document.getElementById('lab-section').scrollIntoView({behavior: 'smooth', block: 'start'}); return false;">
                            <div class="quick-thumb-container" id="quick-lab-thumb">
                                <i class="fa fa-flask"></i>
                            </div>
                            <div>Lab &amp;<br>Hasil Tes</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-edit"></i> Edit Profil</h4>
                </div>
                <div class="modal-body">
                    <form id="profile-form">
                        <!-- Profile Picture Upload -->
                        <div class="form-group">
                            <label style="color: #28a7e9;">Foto Profil</label>
                            <div style="text-align: center; margin-bottom: 15px;">
                                <img id="edit-profile-picture-preview"
                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3E👤%3C/text%3E%3C/svg%3E"
                                     alt="Preview"
                                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #28a7e9; margin-bottom: 10px; cursor: pointer;"
                                     onclick="document.getElementById('edit-profile-picture-file').click()">
                                <div style="margin-top: 5px;">
                                    <label for="edit-profile-picture-file" class="btn btn-sm" style="background: rgba(40,167,233,0.2); border: 1px solid #28a7e9; color: #28a7e9; cursor: pointer;">
                                        <i class="fa fa-camera"></i> Pilih Foto
                                    </label>
                                </div>
                            </div>
                            <input type="file" id="edit-profile-picture-file" accept="image/jpeg,image/png,image/webp" style="display: none;">
                            <input type="hidden" id="edit-profile-picture" value="">
                            <small style="color: #999;">Klik foto atau tombol untuk upload (Maks. 2MB, format: JPEG, PNG, WebP)</small>
                            <div id="photo-upload-progress" style="display: none; margin-top: 10px;">
                                <div style="background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div id="photo-upload-bar" style="height: 4px; background: #28a7e9; width: 0%; transition: width 0.3s;"></div>
                                </div>
                                <small style="color: #28a7e9;">Mengupload foto...</small>
                            </div>
                            <div id="photo-upload-error" style="display: none; margin-top: 10px; padding: 10px 15px; background: rgba(220,53,69,0.2); border: 1px solid #dc3545; border-radius: 6px; color: #ff6b6b; font-size: 13px;">
                                <i class="fa fa-exclamation-circle"></i> <span id="photo-upload-error-text"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="color: #28a7e9;">Nama Lengkap *</label>
                            <input type="text" class="form-control" id="edit-fullname" required
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Email <small style="color: #888;">(tidak dapat diubah)</small></label>
                            <input type="email" class="form-control" id="edit-email" readonly disabled
                                   style="background: rgba(255,255,255,0.02); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: #888; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Nomor WhatsApp *</label>
                            <input type="tel" class="form-control" id="edit-phone" required
                                   placeholder="+62812345678"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Tanggal Lahir</label>
                            <input type="date" class="form-control" id="edit-birthdate"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Umur</label>
                            <input type="number" class="form-control" id="edit-age"
                                   placeholder="Otomatis terisi dari tanggal lahir"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="alert" id="profile-error" style="display: none; background: rgba(217,83,79,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(217,83,79,0.3); color: #ffffff;"></div>
                        <div class="alert" id="profile-success" style="display: none; background: rgba(40,167,233,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(40,167,233,0.3); color: #ffffff;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-lock"></i> <span id="password-modal-title">Set Password</span></h4>
                </div>
                <div class="modal-body">
                    <form id="password-form">
                        <!-- Old Password (only for change password) -->
                        <div class="form-group" id="old-password-group" style="display: none;">
                            <label style="color: #28a7e9;">Password Lama *</label>
                            <input type="password" class="form-control" id="old-password" name="current_password" autocomplete="current-password" 
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        
                        <!-- New Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;"><span id="new-pass-label">Password</span> *</label>
                            <input type="password" class="form-control" id="new-password" name="new_password" autocomplete="new-password" required
                                   placeholder="Minimal 6 karakter"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                            <small style="color: #999;">Minimal 6 karakter</small>
                        </div>
                        
                        <!-- Confirm Password -->
                        <div class="form-group">
                            <label style="color: #28a7e9;">Konfirmasi Password *</label>
                            <input type="password" class="form-control" id="confirm-password" name="confirm_password" autocomplete="new-password" required
                                   placeholder="Ulangi password"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>

                        <div class="alert" id="password-error" style="display: none; background: #3a1a1a; border: 1px solid #d9534f; color: #ffffff;"></div>
                        <div class="alert" id="password-success" style="display: none; background: #1a3a2a; border: 1px solid #28a7e9; color: #ffffff;"></div>
                        
                        <div id="password-info" style="background: #1a2a3a; border: 1px solid #28a7e9; padding: 12px; border-radius: 4px; margin-top: 15px;">
                            <p style="margin: 0; font-size: 0.9em; color: #28a7e9;">
                                <i class="fa fa-info-circle"></i> 
                                <span id="password-info-text">Setelah set password, Anda dapat login menggunakan email dan password.</span>
                            </p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal" 
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="savePassword()" 
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> <span id="save-password-btn-text">Set Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View Modal (Settings) -->
    <div class="modal fade" id="profileViewModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-cog"></i> Setting</h4>
                </div>
                <div class="modal-body" id="profile-section">
                    <!-- Profile Picture -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="position: relative; display: inline-block;">
                            <img id="profile-picture"
                                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='48' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3E👤%3C/text%3E%3C/svg%3E"
                                 alt="Profile Picture"
                                 style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #28a7e9;">
                        </div>
                    </div>

                    <ul class="profile-info">
                        <li>
                            <strong>Nama Lengkap</strong>
                            <span id="profile-name">-</span>
                        </li>
                        <li>
                            <strong>Email</strong>
                            <span id="profile-email">-</span>
                        </li>
                        <li>
                            <strong>Nomor Telepon</strong>
                            <span id="profile-phone">-</span>
                        </li>
                        <li>
                            <strong>Tanggal Lahir</strong>
                            <span id="profile-birthdate">-</span>
                        </li>
                        <li>
                            <strong>Terdaftar Sejak</strong>
                            <span id="profile-registered">-</span>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040; display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-primary" onclick="openPasswordModal()" id="password-btn-modal"
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-lock"></i> <span id="password-btn-text-modal">Set Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Ultrasound Modal -->
    <div class="modal fade" id="uploadUltrasoundModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-upload"></i> Upload Foto USG</h4>
                </div>
                <div class="modal-body">
                    <form id="ultrasound-upload-form">
                        <div class="form-group">
                            <label style="color: #28a7e9;">URL Foto USG *</label>
                            <input type="url" class="form-control" id="ultrasound-url" required
                                   placeholder="Masukkan URL foto USG (misalnya dari Imgur, Google Drive, dll)"
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                            <small style="color: #999;">Upload foto ke Imgur atau layanan hosting gambar lainnya, lalu paste URL-nya di sini</small>
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Tanggal USG *</label>
                            <input type="date" class="form-control" id="ultrasound-date" required
                                   style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>
                        <div class="form-group">
                            <label style="color: #28a7e9;">Keterangan (Opsional)</label>
                            <textarea class="form-control" id="ultrasound-notes" rows="3"
                                      placeholder="Tambahkan catatan atau keterangan foto USG"
                                      style="background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;"></textarea>
                        </div>
                        <div class="alert" id="ultrasound-error" style="display: none; background: rgba(217,83,79,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(217,83,79,0.3); color: #ffffff;"></div>
                        <div class="alert" id="ultrasound-success" style="display: none; background: rgba(40,167,233,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(40,167,233,0.3); color: #ffffff;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveUltrasound()"
                            style="background: #28a7e9; border: none;">
                        <i class="fa fa-save"></i> Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-modal" id="cancel-appointment-modal" aria-hidden="true">
        <div class="dashboard-modal-content" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
            <button type="button" class="dashboard-modal-close" id="cancel-modal-close" aria-label="Tutup">&times;</button>
            <h4 id="cancel-modal-title">Batalkan Janji Konsultasi</h4>
            <div class="cancel-summary" id="cancel-modal-summary"></div>
            <label for="cancel-reason-input" style="color: #28a7e9; font-weight: 600; display: block; margin-bottom: 8px;">Alasan Pembatalan *</label>
            <textarea id="cancel-reason-input" placeholder="Tuliskan alasan pembatalan Anda (minimal 10 karakter)"></textarea>
            <div id="cancel-modal-error" class="modal-error" style="display: none;"></div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="cancel-modal-cancel-btn">Batal</button>
                <button type="button" class="btn-danger" id="cancel-modal-submit-btn">Ya, Batalkan</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Socket.io for real-time announcements -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <!-- Markdown and sanitization libraries for enhanced announcements -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="js/announcements-dashboard.js?v=20251120"></script>
    <script>
        // Handle token from URL (for mobile app deep link)
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlUser = urlParams.get('user');
            if (urlToken) {
                console.log('[DASHBOARD] Token received from URL (from mobile app), saving...');
                localStorage.setItem('vps_auth_token', urlToken);
                // Mark that user came from mobile app
                localStorage.setItem('from_mobile_app', 'true');
                if (urlUser) {
                    try {
                        localStorage.setItem('patient_user', decodeURIComponent(urlUser));
                    } catch(e) {}
                }
                // Remove token from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        })();

        // Check authentication
        const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
        const user = JSON.parse(localStorage.getItem('patient_user') || '{}');

        console.log('[DASHBOARD] Auth check - token:', token ? 'EXISTS' : 'MISSING');
        console.log('[DASHBOARD] Auth check - user:', user);
        console.log('[DASHBOARD] Auth check - user.id:', user.id);

        if (!token || !user.id) {
            // Not authenticated, redirect to login
            console.log('[DASHBOARD] Not authenticated, redirecting to login');
            // Check if from mobile app
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('token')) {
                window.location.href = 'dokterdibya://logout';
            } else {
                window.location.href = '/patient-login.html';
            }
        } else {
            console.log('[DASHBOARD] Authenticated, loading profile...');
            // Load user profile
            loadUserProfile();
            // Load pregnancy tracker
            loadPregnancyTracker();
            // Load medications
            loadMedications();
            // Load health articles
            loadArticles();
            // Load ultrasound images
            loadUltrasoundImages();
            // Load lab results
            loadLabResults();
        }

        async function loadUserProfile() {
            try {
                // Add cache-busting timestamp to prevent browser caching
                const response = await fetch('/api/patients/profile?', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }

                const data = await response.json();
                const profile = data.user;

                // Check if profile is completed, redirect if not
                if (profile.profile_completed !== 1) {
                    window.location.href = '/complete-profile.html';
                    return;
                }

                // Update UI with profile data
                document.getElementById('profile-name').textContent = profile.fullname;
                document.getElementById('profile-email').textContent = profile.email;
                document.getElementById('profile-phone').textContent = profile.phone || 'Belum diisi';

                // Update medical record name
                const medicalRecordName = document.getElementById('medical-record-name');
                if (medicalRecordName && profile.fullname) {
                    medicalRecordName.textContent = profile.fullname;
                }

                // Update navigation avatar
                const userNameNav = document.getElementById('user-name-nav');
                if (userNameNav && profile.fullname) {
                    userNameNav.textContent = profile.fullname;
                }

                // Update avatar - show photo if available, otherwise show initials
                const avatarImg = document.getElementById('user-avatar-img');
                const avatarInitials = document.getElementById('user-avatar-initials');

                // Always prepare initials first (needed for fallback when image fails)
                let initials = 'NA';
                if (profile.fullname) {
                    const nameParts = profile.fullname.trim().split(' ');
                    if (nameParts.length === 1) {
                        initials = nameParts[0].substring(0, 2).toUpperCase();
                    } else {
                        initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                    }
                }
                if (avatarInitials) {
                    avatarInitials.textContent = initials;
                }

                if (profile.profile_picture && avatarImg && avatarInitials) {
                    avatarImg.src = profile.profile_picture;
                    avatarImg.style.display = 'block';
                    avatarInitials.style.display = 'none';
                    avatarImg.onerror = function() {
                        // If image fails to load, show initials
                        this.style.display = 'none';
                        avatarInitials.style.display = 'block';
                    };
                } else if (avatarInitials) {
                    // No profile picture, show initials
                    avatarInitials.style.display = 'block';
                    if (avatarImg) avatarImg.style.display = 'none';
                }

                // Update profile picture
                const profilePicture = document.getElementById('profile-picture');
                if (profile.profile_picture) {
                    profilePicture.src = profile.profile_picture;
                    profilePicture.onerror = function() {
                        // If image fails to load, use default
                        this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='48' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3E👤%3C/text%3E%3C/svg%3E";
                    };
                }

                // Format birth date - avoid timezone issues by parsing date parts directly
                if (profile.birth_date) {
                    let birthDateStr = profile.birth_date;
                    if (birthDateStr.includes('T')) {
                        birthDateStr = birthDateStr.split('T')[0];
                    }
                    // Parse as local date to avoid timezone shift
                    const [year, month, day] = birthDateStr.split('-').map(Number);
                    const birthDate = new Date(year, month - 1, day); // month is 0-indexed
                    document.getElementById('profile-birthdate').textContent = birthDate.toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('profile-birthdate').textContent = 'Belum diisi';
                }
                
                // Format registration date
                const regDate = new Date(profile.registration_date);
                document.getElementById('profile-registered').textContent = regDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Store profile data for editing
                window.currentProfile = profile;

                // Check if user has password set
                hasPassword = profile.has_password === 1 || profile.password !== null;
                if (hasPassword) {
                    const passwordBtnText = document.getElementById('password-btn-text-modal');
                    if (passwordBtnText) {
                        passwordBtnText.textContent = 'Ubah Password';
                    }
                } else {
                    const passwordBtnText = document.getElementById('password-btn-text-modal');
                    if (passwordBtnText) {
                        passwordBtnText.textContent = 'Set Password';
                    }
                }

                // Update intake button appearance and hide alert if completed
                if (profile.intake_completed === 1) {
                    updateIntakeButtonCompleted();
                    // Hide "Langkah Selanjutnya" alert if intake is completed
                    document.getElementById('first-time-alert').style.display = 'none';
                    // Collapse welcome message
                    document.getElementById('welcome-content').style.display = 'none';
                    document.getElementById('welcome-toggle-icon').classList.remove('fa-chevron-down');
                    document.getElementById('welcome-toggle-icon').classList.add('fa-chevron-up');
                } else {
                    // Check if first time user (registered within last 24 hours) and intake not completed
                    const hoursSinceReg = (Date.now() - regDate.getTime()) / (1000 * 60 * 60);
                    if (hoursSinceReg < 24) {
                        document.getElementById('first-time-alert').style.display = 'block';
                    }
                }

                // Load booking status and appointment alerts
                loadBookingStatus();

                // Load hospital schedules (shows after Sunday 21:00)
                loadHospitalSchedules();

                // Setup real-time booking updates
                setupRealtimeBookingUpdates();

                loadVisitInvoices();

                // Load birth congratulations card
                loadBirthCongratulations();

            } catch (error) {
                console.error('Error loading profile:', error);
                // Token might be invalid, logout
                logout();
            }
        }

        // ==================== BIRTH CONGRATULATIONS ====================
        async function loadBirthCongratulations() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                // Add cache-busting timestamp
                const response = await fetch('/api/patient/birth-congratulations?', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        
                    }
                });

                if (!response.ok) {
                    console.warn('Birth congratulations fetch failed:', response.status);
                    return;
                }

                const result = await response.json();
                if (!result.success || !result.data) return;

                const data = result.data;
                const row = document.getElementById('birth-congrats-row');
                if (!row) return;

                // Fill in the data
                document.getElementById('birth-baby-name').textContent = data.baby_name || 'Baby';
                document.getElementById('birth-congrats-doctor').textContent = 'Dari ' + (data.doctor_name || 'dr. Dibya Arfianda, SpOG, M.Ked.Klin.');

                // Format date
                if (data.birth_date) {
                    const birthDate = new Date(data.birth_date);
                    document.getElementById('birth-date').textContent = birthDate.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                // Format time
                if (data.birth_time) {
                    const timeParts = data.birth_time.split(':');
                    document.getElementById('birth-time').textContent = timeParts[0] + ':' + timeParts[1] + ' WIB';
                }

                document.getElementById('birth-weight').textContent = data.birth_weight || '-';
                document.getElementById('birth-length').textContent = data.birth_length || '-';
                document.getElementById('birth-message').textContent = data.message || 'Selamat atas kelahiran buah hati Anda!';

                // Define theme colors (dark style with accent colors)
                const themeColors = {
                    pink: {
                        accent: '#ec4899',
                        accentLight: 'rgba(236, 72, 153, 0.3)',
                        shadow: 'rgba(236, 72, 153, 0.3)'
                    },
                    blue: {
                        accent: '#3b82f6',
                        accentLight: 'rgba(59, 130, 246, 0.3)',
                        shadow: 'rgba(59, 130, 246, 0.3)'
                    },
                    green: {
                        accent: '#22c55e',
                        accentLight: 'rgba(34, 197, 94, 0.3)',
                        shadow: 'rgba(34, 197, 94, 0.3)'
                    },
                    purple: {
                        accent: '#a855f7',
                        accentLight: 'rgba(168, 85, 247, 0.3)',
                        shadow: 'rgba(168, 85, 247, 0.3)'
                    },
                    gold: {
                        accent: '#f59e0b',
                        accentLight: 'rgba(245, 158, 11, 0.3)',
                        shadow: 'rgba(245, 158, 11, 0.3)'
                    },
                    peach: {
                        accent: '#fb923c',
                        accentLight: 'rgba(251, 146, 60, 0.3)',
                        shadow: 'rgba(251, 146, 60, 0.3)'
                    }
                };

                const theme = themeColors[data.theme_color] || themeColors.purple;

                // Handle photo with theme-appropriate colors
                const photoContainer = document.getElementById('birth-photo-container');
                const photoImg = document.getElementById('birth-photo');
                if (data.photo_url) {
                    photoImg.src = data.photo_url;
                    photoImg.onerror = function() {
                        photoContainer.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(30,30,40,0.8);"><i class="fa fa-baby" style="font-size:60px;color:${theme.accent};"></i></div>`;
                    };
                } else {
                    // No photo - show icon placeholder with theme colors
                    photoContainer.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(30,30,40,0.8);"><i class="fa fa-heart" style="font-size:60px;color:${theme.accent};"></i></div>`;
                }

                // Update photo container border and shadow
                if (photoContainer) {
                    photoContainer.style.border = `3px solid ${theme.accentLight}`;
                    photoContainer.style.boxShadow = `0 8px 25px ${theme.shadow}`;
                }

                // Update title and icon colors
                const cardTitle = document.getElementById('birth-card-title');
                const cardIcon = document.getElementById('birth-card-icon');
                const babyName = document.getElementById('birth-baby-name');
                if (cardTitle) cardTitle.style.color = theme.accent;
                if (cardIcon) cardIcon.style.color = theme.accent;
                if (babyName) babyName.style.color = theme.accent;

                // Apply theme to detail boxes
                document.querySelectorAll('.birth-detail-box').forEach(box => {
                    box.style.background = 'rgba(30, 30, 40, 0.9)';
                    box.style.border = `1px solid ${theme.accentLight}`;
                });

                // Apply theme to message container
                const msgContainer = document.getElementById('birth-message-container');
                if (msgContainer) {
                    msgContainer.style.background = 'rgba(30, 30, 40, 0.9)';
                    msgContainer.style.borderLeft = `3px solid ${theme.accent}`;
                }

                // Update message label color
                const msgLabel = msgContainer?.querySelector('.birth-message-label');
                if (msgLabel) msgLabel.style.color = theme.accent;

                // Update corner accent colors
                document.querySelectorAll('.birth-corner-accent').forEach(corner => {
                    corner.style.borderColor = theme.accent;
                });

                // Show the card and hide pregnancy tracker
                row.style.display = 'block';
                const pregnancyRow = document.getElementById('pregnancy-tracker-row');
                if (pregnancyRow) pregnancyRow.style.display = 'none';

            } catch (error) {
                console.error('Error loading birth congratulations:', error);
            }
        }

        // ==================== PREGNANCY TRACKER ====================
        async function loadPregnancyTracker() {
            const trackerRow = document.getElementById('pregnancy-tracker-row');
            const trackerContent = document.getElementById('pregnancy-tracker-content');

            if (!trackerRow || !trackerContent) return;

            try {
                const response = await fetch('/api/patients/pregnancy-tracker', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        
                    }
                });

                const result = await response.json();

                if (!result.success || !result.data) {
                    // No pregnancy data - hide the section
                    trackerRow.style.display = 'none';
                    return;
                }

                const data = result.data;

                // Show the section
                trackerRow.style.display = 'block';

                // Render pregnancy tracker
                trackerContent.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 30px; align-items: center;">
                        <!-- Baby Size Visual -->
                        <div style="flex: 0 0 auto; text-align: center; min-width: 150px;">
                            <div style="font-size: 80px; line-height: 1; margin-bottom: 10px; animation: pulse 2s infinite;">
                                ${data.babySize.emoji}
                            </div>
                            <div style="color: #e0e0e0; font-size: 14px;">
                                Ukuran bayi seperti<br>
                                <strong style="color: #a855f7; font-size: 18px;">${data.babySize.size}</strong>
                            </div>
                            <div style="color: #999; font-size: 12px; margin-top: 5px;">
                                ~${data.babySize.length}
                            </div>
                        </div>

                        <!-- Main Info -->
                        <div style="flex: 1; min-width: 250px;">
                            <!-- Week Counter -->
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 48px; font-weight: 700; color: #fff; line-height: 1;">
                                    ${data.weeksPregnant}<span style="font-size: 24px; color: #a855f7;"> minggu</span>
                                    <span style="font-size: 20px; color: #999;">${data.daysExtra} hari</span>
                                </div>
                                <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                    Trimester ${data.trimester} • Progress ${data.progressPercent}%
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 15px;">
                                <div style="background: linear-gradient(90deg, #a855f7 0%, #ec4899 100%); height: 100%; width: ${data.progressPercent}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>

                            <!-- HPL Countdown -->
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="background: rgba(168, 85, 247, 0.2); padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                                    <div style="color: #a855f7; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">HPL (USG)</div>
                                    <div style="color: #fff; font-size: 18px; font-weight: 600; margin-top: 5px;">
                                        ${data.eddFormatted}
                                    </div>
                                </div>
                                <div style="background: rgba(236, 72, 153, 0.2); padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(236, 72, 153, 0.3);">
                                    <div style="color: #ec4899; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Countdown</div>
                                    <div style="color: #fff; font-size: 18px; font-weight: 600; margin-top: 5px;">
                                        <i class="fa fa-clock-o"></i> ${data.daysUntilEdd} hari lagi
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Tip -->
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #a855f7;">
                        <div style="color: #a855f7; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">
                            <i class="fa fa-lightbulb-o"></i> Tips Minggu Ini
                        </div>
                        <div style="color: #e0e0e0; font-size: 14px; line-height: 1.6;">
                            ${data.tip}
                        </div>
                    </div>

                    <style>
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                        }
                    </style>
                `;

            } catch (error) {
                console.error('Error loading pregnancy tracker:', error);
                trackerRow.style.display = 'none';
            }
        }

        // ==================== MEDICATIONS ====================
        function getCustomMedications() {
            return JSON.parse(localStorage.getItem('custom_medications') || '[]');
        }

        function saveCustomMedications(meds) {
            localStorage.setItem('custom_medications', JSON.stringify(meds));
        }

        // ============ ARTIKEL KESEHATAN ============
        // Cache for loaded articles
        let cachedArticles = [];

        async function loadArticles() {
            const container = document.getElementById('articles-container');
            if (!container) return;

            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #999;">
                    <i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <p style="margin-top: 10px; font-size: 14px;">Memuat artikel...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/articles?limit=3');
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #999;">
                            <i class="fa fa-newspaper-o" style="font-size: 32px; margin-bottom: 10px;"></i>
                            <p style="font-size: 14px;">Belum ada artikel kesehatan.</p>
                        </div>
                    `;
                    return;
                }

                cachedArticles = result.data;
                const totalArticles = result.total || result.data.length;
                let html = '';

                result.data.forEach((article) => {
                    const color = article.color || '#28a7e9';
                    const icon = article.icon || 'fa-book-reader';
                    const dateStr = formatArticleDate(article.created_at);

                    html += `
                        <div class="article-card" onclick="openArticle(${article.id})" style="
                            background: rgba(255, 255, 255, 0.6);
                            backdrop-filter: blur(15px);
                            -webkit-backdrop-filter: blur(15px);
                            border-radius: 16px;
                            padding: 16px;
                            margin-bottom: 12px;
                            border: 1px solid rgba(0, 0, 0, 0.08);
                            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.05)'">
                            <div style="display: flex; gap: 12px;">
                                <div style="
                                    background: ${color}20;
                                    width: 48px;
                                    height: 48px;
                                    border-radius: 12px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    flex-shrink: 0;
                                ">
                                    <i class="fa ${icon}" style="color: ${color}; font-size: 20px;"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="
                                            background: ${color};
                                            color: white;
                                            font-size: 9px;
                                            font-weight: 600;
                                            padding: 2px 8px;
                                            border-radius: 10px;
                                            text-transform: uppercase;
                                        ">${article.category || 'Kehamilan'}</span>
                                        <span style="font-size: 10px; color: #999;">${dateStr}</span>
                                    </div>
                                    <h4 style="
                                        font-size: 14px;
                                        font-weight: 600;
                                        color: #1a1a2e;
                                        margin: 0 0 6px 0;
                                        line-height: 1.3;
                                    ">${escapeHtml(article.title)}</h4>
                                    <p style="
                                        font-size: 12px;
                                        color: #666;
                                        margin: 0;
                                        line-height: 1.4;
                                        display: -webkit-box;
                                        -webkit-line-clamp: 2;
                                        -webkit-box-orient: vertical;
                                        overflow: hidden;
                                    ">${escapeHtml(article.summary || '')}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Add "See all articles" button
                html += `
                    <button onclick="openArticlesPage()" style="
                        width: 100%;
                        background: linear-gradient(135deg, var(--primary), #1e88e5);
                        color: white;
                        border: none;
                        padding: 14px;
                        border-radius: 14px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        box-shadow: 0 4px 15px rgba(40, 167, 233, 0.3);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <i class="fa fa-book"></i> Lihat Semua Artikel (${totalArticles})
                    </button>
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading articles:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #dc3545;">
                        <i class="fa fa-exclamation-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
                        <p style="font-size: 14px;">Gagal memuat artikel.</p>
                    </div>
                `;
            }
        }

        function formatArticleDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function openArticle(articleId) {
            // Show loading modal
            const loadingHtml = `
                <div id="article-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(10px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                ">
                    <div style="color: white; text-align: center;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 32px;"></i>
                        <p style="margin-top: 15px;">Memuat artikel...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);

            try {
                const response = await fetch(`/api/articles/${articleId}`);
                const result = await response.json();

                if (!result.success || !result.data) {
                    throw new Error('Article not found');
                }

                const article = result.data;
                const color = article.color || '#28a7e9';
                const icon = article.icon || 'fa-book-reader';
                const dateStr = formatArticleDate(article.updated_at || article.created_at);

                // Remove loading and show article
                closeArticleModal();

                const modalHtml = `
                    <div id="article-modal" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.8);
                        backdrop-filter: blur(10px);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    " onclick="if(event.target.id === 'article-modal') closeArticleModal()">
                        <div style="
                            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 24px;
                            max-width: 500px;
                            width: 100%;
                            max-height: 80vh;
                            overflow-y: auto;
                            position: relative;
                            border: 1px solid rgba(255,255,255,0.1);
                        ">
                            <!-- Header -->
                            <div style="
                                background: ${color};
                                padding: 30px 24px;
                                border-radius: 24px 24px 0 0;
                                position: relative;
                            ">
                                <button onclick="closeArticleModal()" style="
                                    position: absolute;
                                    top: 15px;
                                    right: 15px;
                                    background: rgba(255,255,255,0.2);
                                    border: none;
                                    width: 36px;
                                    height: 36px;
                                    border-radius: 50%;
                                    color: white;
                                    font-size: 18px;
                                    cursor: pointer;
                                ">
                                    <i class="fa fa-times"></i>
                                </button>
                                <div style="
                                    width: 60px;
                                    height: 60px;
                                    background: rgba(255,255,255,0.2);
                                    border-radius: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 15px;
                                ">
                                    <i class="fa ${icon}" style="color: white; font-size: 28px;"></i>
                                </div>
                                <span style="
                                    background: rgba(255,255,255,0.2);
                                    color: white;
                                    font-size: 10px;
                                    font-weight: 600;
                                    padding: 4px 12px;
                                    border-radius: 12px;
                                    text-transform: uppercase;
                                ">${article.category || 'Kehamilan'}</span>
                                <h2 style="
                                    color: white;
                                    font-size: 20px;
                                    font-weight: 700;
                                    margin: 12px 0 0 0;
                                    line-height: 1.3;
                                ">${escapeHtml(article.title)}</h2>
                            </div>

                            <!-- Content -->
                            <div style="padding: 24px;">
                                ${article.content ? `
                                    <div style="
                                        color: #ccc;
                                        font-size: 15px;
                                        line-height: 1.7;
                                        margin: 0 0 20px 0;
                                    ">${typeof marked !== 'undefined' ? marked.parse(article.content) : article.content}</div>
                                ` : `
                                    <p style="
                                        color: #ccc;
                                        font-size: 15px;
                                        line-height: 1.7;
                                        margin: 0 0 20px 0;
                                    ">${escapeHtml(article.summary || '')}</p>
                                `}

                                <div style="
                                    background: rgba(255,255,255,0.05);
                                    border-radius: 12px;
                                    padding: 15px;
                                    margin-bottom: 20px;
                                ">
                                    ${article.source ? `
                                        <p style="color: #888; font-size: 12px; margin: 0;">
                                            <i class="fa fa-book" style="margin-right: 8px;"></i>
                                            Sumber: <strong style="color: #aaa;">${escapeHtml(article.source)}</strong>
                                        </p>
                                    ` : ''}
                                    <p style="color: #888; font-size: 12px; margin: ${article.source ? '8px' : '0'} 0 0 0;">
                                        <i class="fa fa-calendar" style="margin-right: 8px;"></i>
                                        Diperbarui: ${dateStr}
                                    </p>
                                    <p style="color: #888; font-size: 12px; margin: 8px 0 0 0;">
                                        <i class="fa fa-eye" style="margin-right: 8px;"></i>
                                        Dibaca: ${article.view_count || 0}x
                                    </p>
                                </div>

                                <!-- Like Button -->
                                <button id="article-like-btn-${article.id}" onclick="toggleArticleLike(${article.id})" style="
                                    width: 100%;
                                    background: linear-gradient(135deg, rgba(40,167,69,0.1), rgba(32,201,151,0.1));
                                    border: 2px solid rgba(40,167,69,0.3);
                                    border-radius: 14px;
                                    padding: 14px;
                                    margin-bottom: 20px;
                                    color: #28a745;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 10px;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.borderColor='rgba(40,167,69,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(40,167,69,0.3)'">
                                    <i class="fa fa-thumbs-up" id="article-like-icon-${article.id}" style="color: #ffc107;"></i>
                                    <span id="article-like-text-${article.id}">Loading...</span>
                                </button>

                                <div style="
                                    background: linear-gradient(135deg, rgba(40,167,69,0.1), rgba(32,201,151,0.1));
                                    border: 1px solid rgba(40,167,69,0.2);
                                    border-radius: 12px;
                                    padding: 15px;
                                ">
                                    <p style="color: #28a745; font-size: 13px; margin: 0; display: flex; align-items: flex-start; gap: 10px;">
                                        <i class="fa fa-info-circle" style="margin-top: 2px;"></i>
                                        <span>Artikel ini disusun oleh <strong><span style="color: #ffffff;">dokter</span><span style="color: #0066FF;">DIBYA</span></strong> berdasarkan jurnal dan panduan medis terkini. Untuk kondisi spesifik, konsultasikan langsung dengan dokter Anda.</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Check if user has liked this article
                checkArticleLikeStatus(article.id, article.like_count || 0);

            } catch (error) {
                console.error('Error loading article:', error);
                closeArticleModal();
                alert('Gagal memuat artikel');
            }
        }

        function closeArticleModal() {
            const modal = document.getElementById('article-modal');
            if (modal) modal.remove();
        }

        // Get authentication token
        function getToken() {
            return localStorage.getItem('vps_auth_token') ||
                   sessionStorage.getItem('vps_auth_token') ||
                   localStorage.getItem('patient_token');
        }

        // Check if user has liked an article
        async function checkArticleLikeStatus(articleId, likeCount) {
            try {
                const token = getToken();
                if (!token) {
                    // User not logged in - show generic like button
                    updateLikeButton(articleId, false, likeCount);
                    return;
                }

                const response = await fetch(`/api/articles/${articleId}/liked`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    updateLikeButton(articleId, result.liked, likeCount);
                } else {
                    updateLikeButton(articleId, false, likeCount);
                }
            } catch (error) {
                console.error('Error checking like status:', error);
                updateLikeButton(articleId, false, likeCount);
            }
        }

        // Update like button UI
        function updateLikeButton(articleId, isLiked, likeCount) {
            const btn = document.getElementById(`article-like-btn-${articleId}`);
            const icon = document.getElementById(`article-like-icon-${articleId}`);
            const text = document.getElementById(`article-like-text-${articleId}`);

            if (!btn || !icon || !text) return;

            if (isLiked) {
                btn.style.background = 'linear-gradient(135deg, rgba(40,167,69,0.3), rgba(32,201,151,0.3))';
                btn.style.borderColor = 'rgba(40,167,69,0.6)';
                btn.style.color = '#28a745';
                icon.className = 'fa fa-thumbs-up';
                icon.style.color = '#ffc107';
                text.textContent = `Anda & ${likeCount > 1 ? (likeCount - 1) + ' lainnya' : '0 lainnya'} menyukai artikel ini`;
            } else {
                btn.style.background = 'linear-gradient(135deg, rgba(40,167,69,0.1), rgba(32,201,151,0.1))';
                btn.style.borderColor = 'rgba(40,167,69,0.3)';
                btn.style.color = '#28a745';
                icon.className = 'fa fa-thumbs-o-up';
                icon.style.color = '#ffc107';
                text.textContent = `${likeCount || 0} orang menyukai artikel ini`;
            }
        }

        // Toggle like status
        async function toggleArticleLike(articleId) {
            try {
                const token = getToken();
                if (!token) {
                    alert('Silakan login terlebih dahulu untuk menyukai artikel');
                    return;
                }

                const btn = document.getElementById(`article-like-btn-${articleId}`);
                if (!btn) return;

                // Disable button during request
                btn.disabled = true;
                btn.style.opacity = '0.6';

                const response = await fetch(`/api/articles/${articleId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to toggle like');

                const result = await response.json();

                // Re-check like status to update UI with new count
                const statusResponse = await fetch(`/api/articles/${articleId}/liked`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (statusResponse.ok) {
                    const statusResult = await statusResponse.json();

                    // Get updated article to get new like count
                    const articleResponse = await fetch(`/api/articles/${articleId}`);
                    if (articleResponse.ok) {
                        const articleResult = await articleResponse.json();
                        updateLikeButton(articleId, statusResult.liked, articleResult.data.like_count || 0);
                    }
                }

                // Re-enable button
                btn.disabled = false;
                btn.style.opacity = '1';

            } catch (error) {
                console.error('Error toggling like:', error);
                alert('Gagal menyukai artikel. Silakan coba lagi.');

                // Re-enable button
                const btn = document.getElementById(`article-like-btn-${articleId}`);
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }
        }

        function openArticlesPage() {
            // Navigate to full articles page
            window.location.href = '/artikel-kesehatan.html';
        }

        async function loadMedications() {
            const container = document.getElementById('medications-list-container');
            if (!container) return;

            // Get custom medications from localStorage
            const customMeds = getCustomMedications();

            let html = '';

            // Add button to add custom medication - Balanced prominent style
            html += `
                <div style="margin-bottom: 16px;">
                    <button onclick="showAddMedicationForm()" style="
                        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
                        color: white;
                        border: none;
                        padding: 14px 22px;
                        border-radius: 16px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        width: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        box-shadow: 0 4px 20px rgba(255, 107, 107, 0.35);
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(255,107,107,0.45)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(255,107,107,0.35)'">
                        <i class="fa fa-plus-circle" style="font-size: 16px;"></i> Tambah Obat/Vitamin
                    </button>
                </div>
            `;

            // Add medication form (hidden by default) - Ultra transparent glassmorphism
            html += `
                <div id="add-medication-form" style="
                    display: none;
                    background: rgba(255, 255, 255, 0.3);
                    backdrop-filter: blur(25px);
                    -webkit-backdrop-filter: blur(25px);
                    border-radius: 24px;
                    padding: 24px;
                    margin-bottom: 20px;
                    border: 2px solid rgba(255, 255, 255, 0.6);
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
                ">
                    <h4 style="
                        margin: 0 0 18px 0;
                        font-size: 15px;
                        font-weight: 600;
                        color: #1a1a2e;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="
                            background: linear-gradient(135deg, #28a745, #20c997);
                            width: 32px;
                            height: 32px;
                            border-radius: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fa fa-pills" style="color: white; font-size: 14px;"></i>
                        </span>
                        Tambah Obat Baru
                    </h4>
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="med-name" placeholder="Nama obat (cth: Asam Folat)" style="
                            width: 100%;
                            padding: 14px 16px;
                            border: none;
                            border-radius: 14px;
                            font-size: 14px;
                            font-weight: 450;
                            box-sizing: border-box;
                            background: rgba(255, 255, 255, 0.9);
                            color: #222;
                            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
                            transition: all 0.3s ease;
                            outline: none;
                        " onfocus="this.style.boxShadow='inset 0 2px 8px rgba(0,0,0,0.06), 0 0 0 3px rgba(40,167,69,0.2)'" onblur="this.style.boxShadow='inset 0 2px 8px rgba(0,0,0,0.06)'">
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <input type="number" id="med-quantity" placeholder="Jumlah" min="1" value="1" style="
                                width: 100%;
                                padding: 14px 16px;
                                border: none;
                                border-radius: 14px;
                                font-size: 14px;
                                font-weight: 450;
                                box-sizing: border-box;
                                background: rgba(255, 255, 255, 0.9);
                                color: #222;
                                box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
                                transition: all 0.3s ease;
                                outline: none;
                            " onfocus="this.style.boxShadow='inset 0 2px 8px rgba(0,0,0,0.06), 0 0 0 3px rgba(40,167,69,0.2)'" onblur="this.style.boxShadow='inset 0 2px 8px rgba(0,0,0,0.06)'">
                        </div>
                        <div style="flex: 2;">
                            <select id="med-unit" style="
                                width: 100%;
                                padding: 14px 16px;
                                border: none;
                                border-radius: 14px;
                                font-size: 14px;
                                font-weight: 450;
                                box-sizing: border-box;
                                background: rgba(255, 255, 255, 0.9);
                                color: #222;
                                box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
                                cursor: pointer;
                                appearance: none;
                                background-image: url('data:image/svg+xml;utf8,<svg fill=\"%23222\" height=\"24\" viewBox=\"0 0 24 24\" width=\"24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M7 10l5 5 5-5z\"/></svg>');
                                background-repeat: no-repeat;
                                background-position: right 12px center;
                            ">
                                <option value="tablet">Tablet</option>
                                <option value="kapsul">Kapsul</option>
                                <option value="strip">Strip</option>
                                <option value="botol">Botol</option>
                                <option value="tube">Tube</option>
                                <option value="sachet">Sachet</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <select id="med-frequency" onchange="updateTimeInputs()" style="
                            width: 100%;
                            padding: 14px 16px;
                            border: none;
                            border-radius: 14px;
                            font-size: 14px;
                            font-weight: 450;
                            box-sizing: border-box;
                            background: rgba(255, 255, 255, 0.9);
                            color: #222;
                            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
                            cursor: pointer;
                            appearance: none;
                            background-image: url('data:image/svg+xml;utf8,<svg fill=\"%23222\" height=\"24\" viewBox=\"0 0 24 24\" width=\"24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M7 10l5 5 5-5z\"/></svg>');
                            background-repeat: no-repeat;
                            background-position: right 12px center;
                        ">
                            <option value="1">1x sehari</option>
                            <option value="2">2x sehari</option>
                            <option value="3">3x sehari</option>
                            <option value="4">4x sehari</option>
                        </select>
                    </div>
                    <div id="time-inputs-container" style="margin-bottom: 12px;">
                        <!-- Time inputs will be dynamically added here -->
                    </div>
                    <div style="
                        margin-bottom: 18px;
                        background: rgba(23, 162, 184, 0.1);
                        padding: 12px 14px;
                        border-radius: 12px;
                    ">
                        <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #333; cursor: pointer;">
                            <div style="position: relative;">
                                <input type="checkbox" id="med-reminder" checked style="
                                    width: 22px;
                                    height: 22px;
                                    accent-color: #17a2b8;
                                    cursor: pointer;
                                ">
                            </div>
                            <i class="fa fa-bell" style="color: #17a2b8; font-size: 16px;"></i>
                            <span>Ingatkan saya minum obat</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="addCustomMedication()" style="
                            flex: 1;
                            background: linear-gradient(135deg, #28a745, #20c997);
                            color: white;
                            border: none;
                            padding: 14px;
                            border-radius: 14px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40,167,69,0.3)'">
                            <i class="fa fa-check"></i> Simpan
                        </button>
                        <button onclick="hideAddMedicationForm()" style="
                            flex: 1;
                            background: rgba(108, 117, 125, 0.15);
                            color: #495057;
                            border: none;
                            padding: 14px;
                            border-radius: 14px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(108,117,125,0.25)'" onmouseout="this.style.background='rgba(108,117,125,0.15)'">
                            Batal
                        </button>
                    </div>
                </div>
            `;

            // Display custom medications - Modern glassmorphism style
            if (customMeds.length > 0) {
                html += '<div class="medications-list">';
                html += `<h4 style="
                    font-size: 11px;
                    color: #888;
                    margin-bottom: 12px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    font-weight: 600;
                ">Obat Saya</h4>`;

                customMeds.forEach((med, index) => {
                    const freqText = med.frequency === 1 ? '1x/hari' : `${med.frequency}x/hari`;
                    const reminderTimes = getReminderTimesForFrequency(med.frequency, med.reminderTimes);
                    const qtyText = med.quantity ? `${med.quantity} ${med.unit || 'tablet'}` : '';

                    html += `
                        <div class="medication-card" style="
                            background: rgba(255, 255, 255, 0.6);
                            backdrop-filter: blur(15px);
                            -webkit-backdrop-filter: blur(15px);
                            border-radius: 16px;
                            padding: 16px;
                            margin-bottom: 12px;
                            border: 1px solid rgba(40, 167, 69, 0.2);
                            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.1);
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 15px; font-weight: 600; color: #1a1a2e; margin-bottom: 6px; display: flex; align-items: center; gap: 10px;">
                                        <span style="
                                            background: linear-gradient(135deg, #28a745, #20c997);
                                            width: 28px;
                                            height: 28px;
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">
                                            <i class="fa fa-pills" style="color: white; font-size: 12px;"></i>
                                        </span>
                                        ${escapeHtml(med.name)}
                                        ${qtyText ? `<span style="font-size: 12px; font-weight: 500; color: #666; background: rgba(40,167,69,0.1); padding: 2px 8px; border-radius: 8px;">${qtyText}</span>` : ''}
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-left: 38px;">
                                        <i class="fa fa-clock-o" style="color: #888;"></i> ${freqText}
                                        ${med.reminder ? `<span style="margin-left: 10px; color: #17a2b8;"><i class="fa fa-bell"></i> ${reminderTimes}</span>` : '<span style="margin-left: 10px; color: #aaa;"><i class="fa fa-bell-slash"></i> Tidak aktif</span>'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button onclick="toggleMedicationReminder(${index})" style="
                                        background: ${med.reminder ? 'linear-gradient(135deg, #17a2b8, #138496)' : 'rgba(108, 117, 125, 0.2)'};
                                        color: ${med.reminder ? 'white' : '#6c757d'};
                                        border: none;
                                        width: 34px;
                                        height: 34px;
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-size: 13px;
                                        transition: all 0.3s ease;
                                        box-shadow: ${med.reminder ? '0 2px 8px rgba(23, 162, 184, 0.3)' : 'none'};
                                    " title="${med.reminder ? 'Matikan pengingat' : 'Aktifkan pengingat'}">
                                        <i class="fa fa-bell${med.reminder ? '' : '-slash'}"></i>
                                    </button>
                                    <button onclick="deleteCustomMedication(${index})" style="
                                        background: rgba(220, 53, 69, 0.15);
                                        color: #dc3545;
                                        border: none;
                                        width: 34px;
                                        height: 34px;
                                        border-radius: 10px;
                                        cursor: pointer;
                                        font-size: 13px;
                                        transition: all 0.3s ease;
                                    " title="Hapus" onmouseover="this.style.background='rgba(220,53,69,0.25)'" onmouseout="this.style.background='rgba(220,53,69,0.15)'">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Fetch prescriptions from doctor
            try {
                const response = await fetch('/api/patients/medications', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('patient_token') }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        html += '<div class="doctor-prescriptions" style="margin-top: 20px;">';
                        html += `<h4 style="
                            font-size: 11px;
                            color: #888;
                            margin-bottom: 12px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 600;
                        ">Resep dari Dokter</h4>`;

                        result.data.forEach((med) => {
                            const visitDate = new Date(med.visit_date).toLocaleDateString('id-ID', {
                                day: 'numeric', month: 'short', year: 'numeric'
                            });
                            const medLines = (med.terapi || '').split('\n').filter(line => line.trim());

                            html += `
                                <div style="
                                    background: rgba(255, 255, 255, 0.5);
                                    backdrop-filter: blur(15px);
                                    -webkit-backdrop-filter: blur(15px);
                                    border-radius: 16px;
                                    padding: 16px;
                                    margin-bottom: 12px;
                                    border: 1px solid rgba(108, 117, 125, 0.15);
                                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                                ">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                        <span style="
                                            background: linear-gradient(135deg, #6c757d, #495057);
                                            width: 24px;
                                            height: 24px;
                                            border-radius: 6px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">
                                            <i class="fa fa-stethoscope" style="color: white; font-size: 10px;"></i>
                                        </span>
                                        ${visitDate}
                                        ${med.is_current ? '<span style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 3px 10px; border-radius: 10px; font-size: 9px; font-weight: 600; margin-left: auto;">Terbaru</span>' : ''}
                                    </div>
                            `;

                            medLines.forEach(line => {
                                const displayLine = line.replace(/^R\/\s*/, '').trim();
                                if (displayLine) {
                                    html += `
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            padding: 8px 10px;
                                            margin: 4px 0;
                                            font-size: 13px;
                                            color: #333;
                                            background: rgba(255, 255, 255, 0.5);
                                            border-radius: 10px;
                                        ">
                                            <i class="fa fa-prescription" style="color: #6c757d; margin-right: 10px; width: 14px;"></i>
                                            <span style="flex: 1;">${escapeHtml(displayLine)}</span>
                                            <button onclick="addFromPrescription('${escapeHtml(displayLine).replace(/'/g, "\\'")}')" style="
                                                background: rgba(40, 167, 69, 0.15);
                                                border: none;
                                                color: #28a745;
                                                cursor: pointer;
                                                font-size: 12px;
                                                padding: 6px 10px;
                                                border-radius: 8px;
                                                transition: all 0.3s ease;
                                            " title="Tambah ke daftar saya" onmouseover="this.style.background='rgba(40,167,69,0.25)'" onmouseout="this.style.background='rgba(40,167,69,0.15)'">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    `;
                                }
                            });

                            html += '</div>';
                        });

                        html += '</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading prescriptions:', error);
            }

            if (customMeds.length === 0 && html.indexOf('Resep dari Dokter') === -1) {
                html += `
                    <p class="empty-state" style="text-align: center; color: #999; padding: 20px;">
                        <i class="fa fa-medkit" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        Belum ada obat. Klik tombol di atas untuk menambah.
                    </p>
                `;
            }

            container.innerHTML = html;
        }

        function getReminderTimesForFrequency(freq, customTimes) {
            // Use custom times if available
            if (customTimes && customTimes.length > 0) {
                return customTimes.join(', ');
            }
            // Fallback to defaults
            const times = {
                1: '08:00',
                2: '08:00, 20:00',
                3: '08:00, 14:00, 20:00',
                4: '08:00, 12:00, 18:00, 22:00'
            };
            return times[freq] || times[1];
        }

        function updateTimeInputs() {
            const frequency = parseInt(document.getElementById('med-frequency').value);
            const container = document.getElementById('time-inputs-container');

            const defaultTimes = {
                1: ['08:00'],
                2: ['08:00', '20:00'],
                3: ['08:00', '14:00', '20:00'],
                4: ['08:00', '12:00', '18:00', '22:00']
            };

            const times = defaultTimes[frequency] || ['08:00'];
            const labels = ['Pertama', 'Kedua', 'Ketiga', 'Keempat'];

            let html = '<div style="background: rgba(40, 167, 233, 0.08); padding: 14px; border-radius: 14px;">';
            html += '<div style="font-size: 12px; color: #17a2b8; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;"><i class="fa fa-clock-o"></i> Atur Jam Reminder</div>';

            times.forEach((time, index) => {
                html += `
                    <div style="margin-bottom: ${index < times.length - 1 ? '8px' : '0'};">
                        <label style="display: block; font-size: 11px; color: #666; margin-bottom: 4px; font-weight: 500;">${labels[index]}</label>
                        <input type="time" id="med-time-${index}" value="${time}" style="
                            width: 100%;
                            padding: 12px 14px;
                            border: none;
                            border-radius: 12px;
                            font-size: 14px;
                            font-weight: 500;
                            box-sizing: border-box;
                            background: rgba(255, 255, 255, 0.95);
                            color: #222;
                            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
                            cursor: pointer;
                        ">
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function showAddMedicationForm() {
            document.getElementById('add-medication-form').style.display = 'block';
            updateTimeInputs(); // Initialize time inputs
            document.getElementById('med-name').focus();
        }

        function hideAddMedicationForm() {
            document.getElementById('add-medication-form').style.display = 'none';
            document.getElementById('med-name').value = '';
            document.getElementById('med-quantity').value = '1';
            document.getElementById('med-unit').value = 'tablet';
            document.getElementById('med-frequency').value = '1';
            document.getElementById('med-reminder').checked = true;
            document.getElementById('time-inputs-container').innerHTML = '';
        }

        function addCustomMedication() {
            const name = document.getElementById('med-name').value.trim();
            const quantity = parseInt(document.getElementById('med-quantity').value) || 1;
            const unit = document.getElementById('med-unit').value;
            const frequency = parseInt(document.getElementById('med-frequency').value);
            const reminder = document.getElementById('med-reminder').checked;

            if (!name) {
                alert('Masukkan nama obat');
                return;
            }

            // Collect custom reminder times
            const reminderTimes = [];
            for (let i = 0; i < frequency; i++) {
                const timeInput = document.getElementById(`med-time-${i}`);
                if (timeInput) {
                    reminderTimes.push(timeInput.value);
                }
            }

            const meds = getCustomMedications();
            meds.push({
                id: Date.now(),
                name: name,
                quantity: quantity,
                unit: unit,
                frequency: frequency,
                reminder: reminder,
                reminderTimes: reminderTimes, // Save custom times
                created: new Date().toISOString()
            });
            saveCustomMedications(meds);

            // Request notification permission if reminder is enabled
            if (reminder && 'Notification' in window) {
                Notification.requestPermission();
            }

            hideAddMedicationForm();
            loadMedications();

            // Show confirmation
            if (reminder) {
                const times = getReminderTimesForFrequency(frequency);
                alert(`${name} berhasil ditambahkan!\nPengingat: ${times}`);
            }
        }

        function addFromPrescription(medName) {
            document.getElementById('add-medication-form').style.display = 'block';
            document.getElementById('med-name').value = medName;
            document.getElementById('med-name').focus();

            // Scroll to form
            document.getElementById('add-medication-form').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleMedicationReminder(index) {
            const meds = getCustomMedications();
            if (meds[index]) {
                meds[index].reminder = !meds[index].reminder;
                saveCustomMedications(meds);
                loadMedications();

                if (meds[index].reminder && 'Notification' in window) {
                    Notification.requestPermission();
                }
            }
        }

        function deleteCustomMedication(index) {
            if (!confirm('Hapus obat ini dari daftar?')) return;

            const meds = getCustomMedications();
            meds.splice(index, 1);
            saveCustomMedications(meds);
            loadMedications();
        }

        // Check medication reminders
        function checkMedicationReminders() {
            const meds = getCustomMedications().filter(m => m.reminder);
            if (meds.length === 0) return;

            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' +
                               now.getMinutes().toString().padStart(2, '0');

            // Get reminder times based on frequency
            const reminderSchedule = {
                1: ['08:00'],
                2: ['08:00', '20:00'],
                3: ['08:00', '14:00', '20:00'],
                4: ['08:00', '12:00', '18:00', '22:00']
            };

            meds.forEach(med => {
                const times = reminderSchedule[med.frequency] || ['08:00'];
                if (times.includes(currentTime)) {
                    if (Notification.permission === 'granted') {
                        new Notification('Waktunya Minum Obat!', {
                            body: med.name,
                            icon: '/images/logo.png',
                            tag: 'med-' + med.id,
                            requireInteraction: true
                        });
                    }
                }
            });
        }

        // Check reminders every minute
        setInterval(checkMedicationReminders, 60000);
        // Also check on page load
        if ('Notification' in window && Notification.permission === 'granted') {
            checkMedicationReminders();
        }

        async function loadBookingStatus() {
            const container = document.getElementById('booking-status-container');

            if (!container) return;

            container.innerHTML = `
                <p style="text-align: center; color: #999;">
                    <i class="fa fa-spinner fa-spin"></i> Memuat status booking...
                </p>
            `;

            try {
                const response = await fetch('/api/sunday-appointments/patient', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Gagal memuat status booking');
                }

                const data = await response.json();
                const appointments = Array.isArray(data.appointments) ? data.appointments : [];

                renderBookingStatus(appointments);
            } catch (error) {
                console.error('Error loading appointments:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-exclamation-triangle"></i>
                        <p>Gagal memuat status booking. Silakan coba lagi.</p>
                    </div>
                `;
            }
        }

        // Hospital Schedules Functions
        async function loadHospitalSchedules() {
            const section = document.getElementById('hospital-booking-section');
            const container = document.getElementById('hospital-schedules-container');

            if (!section || !container) return;

            try {
                // Load both schedules and existing appointments
                const [schedulesResponse, appointmentsResponse] = await Promise.all([
                    fetch('/api/hospital-appointments/schedules', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/hospital-appointments/patient', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                if (!schedulesResponse.ok) {
                    throw new Error('Gagal memuat jadwal rumah sakit');
                }

                const schedulesData = await schedulesResponse.json();
                const appointmentsData = appointmentsResponse.ok ? await appointmentsResponse.json() : { appointments: [] };

                if (!schedulesData.showHospitalBooking) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                renderHospitalSchedules(schedulesData.schedules, appointmentsData.appointments || []);

            } catch (error) {
                console.error('Error loading hospital schedules:', error);
                section.style.display = 'none';
            }
        }

        function renderHospitalSchedules(schedules, appointments) {
            const container = document.getElementById('hospital-schedules-container');
            if (!container) return;

            let html = '';

            // Filter upcoming appointments (not completed, not cancelled)
            const upcoming = (appointments || [])
                .filter(apt => !apt.isPast && apt.status !== 'cancelled' && apt.status !== 'completed')
                .sort((a, b) => new Date(a.appointment_date) - new Date(b.appointment_date));

            // Show upcoming appointments first (same style as Klinik Private)
            if (upcoming.length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="font-size: 13px; color: #28a7e9; margin-bottom: 12px; font-weight: 600;"><i class="fa fa-calendar-check-o"></i> Janji Temu Anda</h4>';

                upcoming.forEach(apt => {
                    const statusInfo = getBookingStatusInfo(apt.status);
                    const notes = apt.notes ? `<p style="margin-top: 10px;"><strong>Catatan:</strong><br>${escapeText(apt.notes)}</p>` : '';
                    const complaint = apt.complaint ? `<p style="margin-top: 10px;"><strong>Keluhan:</strong> ${escapeText(apt.complaint)}</p>` : '';

                    html += `
                        <div class="appointment-info-box" style="margin-bottom: 15px; border-left: 4px solid ${apt.hospitalColor || '#28a7e9'};">
                            <p><strong>Rumah Sakit:</strong> ${escapeHtml(apt.hospitalName || apt.location)}</p>
                            <p><strong>Status:</strong> <span style="color: ${statusInfo.color}; font-weight: 600;">${statusInfo.label}</span></p>
                            <p><strong>Tanggal:</strong> ${apt.dateFormatted}</p>
                            <p><strong>Jam Konsultasi:</strong> ${apt.time} WIB</p>
                            <p><strong>Tipe:</strong> ${apt.appointment_type || 'Konsultasi'}</p>
                            ${complaint}
                            ${notes}
                            <p style="margin-top: 10px;">${statusInfo.message}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Show available schedules for booking
            if (!schedules || schedules.length === 0) {
                if (upcoming.length === 0) {
                    html = `
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Tidak ada jadwal tersedia minggu ini
                        </p>
                    `;
                }
            } else {
                html += '<div>';
                html += '<h4 style="font-size: 13px; color: #888; margin-bottom: 12px; font-weight: 600; text-transform: uppercase;"><i class="fa fa-hospital-o"></i> Jadwal Tersedia</h4>';

                html += schedules.map(schedule => {
                    const isActive = schedule.isActive !== false; // default true for backwards compat
                    const cardStyle = isActive
                        ? `background: rgba(255,255,255,0.05); border-left: 4px solid ${schedule.hospitalColor || '#607d8b'};`
                        : `background: rgba(100,100,100,0.1); border-left: 4px solid #666; opacity: 0.7;`;
                    const buttonStyle = isActive
                        ? `background: ${schedule.hospitalColor || '#607d8b'}; color: white; cursor: pointer;`
                        : `background: #555; color: #999; cursor: not-allowed;`;
                    const buttonOnclick = isActive
                        ? `onclick="openHospitalBookingModal('${schedule.date}', '${schedule.location}', '${schedule.hospitalName}', '${schedule.formatted}')"`
                        : `disabled`;
                    const inactiveNote = !isActive
                        ? `<div style="font-size: 11px; color: #ff9800; margin-top: 5px;"><i class="fa fa-info-circle"></i> Jadwal tidak tersedia minggu ini</div>`
                        : '';

                    return `
                    <div class="hospital-schedule-card" style="
                        ${cardStyle}
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 10px;
                    ">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-weight: 600; color: ${isActive ? '#fff' : '#999'}; margin-bottom: 5px;">
                                <i class="fa fa-${schedule.hospitalIcon || 'hospital-o'}" style="color: ${isActive ? schedule.hospitalColor : '#666'}; margin-right: 8px;"></i>
                                ${schedule.hospitalName}
                            </div>
                            <div style="font-size: 13px; color: ${isActive ? '#aaa' : '#777'};">
                                <i class="fa fa-calendar" style="margin-right: 5px;"></i>
                                ${schedule.dayName}, ${new Date(schedule.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' })}
                            </div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">
                                <i class="fa fa-clock-o" style="margin-right: 5px;"></i>
                                ${schedule.startTime} - ${schedule.endTime} WIB
                            </div>
                            ${inactiveNote}
                        </div>
                        <button class="btn-hospital-book" ${buttonOnclick} style="
                            ${buttonStyle}
                            border: none;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-size: 13px;
                            transition: all 0.3s;
                        ">
                            <i class="fa fa-${isActive ? 'calendar-plus-o' : 'ban'}"></i> ${isActive ? 'Booking' : 'Tidak Tersedia'}
                        </button>
                    </div>
                `;
                }).join('');
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Hospital Booking Modal State
        let hospitalBookingData = {
            date: null,
            location: null,
            hospitalName: null,
            formatted: null
        };

        function openHospitalBookingModal(date, location, hospitalName, formatted) {
            hospitalBookingData = { date, location, hospitalName, formatted };

            const modalHtml = `
                <div class="dashboard-modal active" id="hospital-booking-modal" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 450px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border: 1px solid rgba(255,255,255,0.1);">
                        <div class="modal-header" style="background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%); padding: 20px; border-radius: 8px 8px 0 0;">
                            <h4 style="margin: 0; color: white;"><i class="fa fa-hospital-o"></i> Booking ${hospitalName}</h4>
                            <button onclick="closeHospitalBookingModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; right: 15px; top: 15px;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 25px;">
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,102,255,0.1); border-radius: 8px; border-left: 4px solid #0066FF;">
                                <div style="font-weight: 600; color: #fff; margin-bottom: 5px;">${formatted}</div>
                                <div style="font-size: 13px; color: #aaa;">${hospitalName}</div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #fff; font-weight: 500;">Jenis Konsultasi</label>
                                <select id="hospital-consultation-type" style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 1px solid rgba(255,255,255,0.2);
                                    border-radius: 8px;
                                    background: rgba(255,255,255,0.05);
                                    color: #fff;
                                    font-size: 14px;
                                ">
                                    <option value="obstetri" style="background: #fff; color: #000;">Kehamilan (Obstetri)</option>
                                    <option value="gyn_repro" style="background: #fff; color: #000;">Program Hamil (Reproduksi)</option>
                                    <option value="gyn_special" style="background: #fff; color: #000;">Ginekologi Umum</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #fff; font-weight: 500;">Keluhan / Tujuan Konsultasi (opsional)</label>
                                <textarea id="hospital-complaint" placeholder="Contoh: Kontrol kehamilan rutin, USG, dll..." style="
                                    width: 100%;
                                    padding: 12px;
                                    border: 1px solid rgba(255,255,255,0.2);
                                    border-radius: 8px;
                                    background: rgba(255,255,255,0.05);
                                    color: #fff;
                                    font-size: 14px;
                                    min-height: 80px;
                                    resize: vertical;
                                "></textarea>
                            </div>

                            <div style="background: rgba(40, 167, 69, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                                <div style="color: #28a745; font-size: 13px;">
                                    <i class="fa fa-check-circle"></i> Booking akan langsung terkonfirmasi
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 15px 25px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeHospitalBookingModal()" style="
                                background: rgba(255,255,255,0.1);
                                color: #fff;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                            ">Batal</button>
                            <button onclick="submitHospitalBooking()" id="btn-submit-hospital-booking" style="
                                background: linear-gradient(135deg, #0066FF 0%, #00D4FF 100%);
                                color: white;
                                border: none;
                                padding: 10px 25px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            "><i class="fa fa-check"></i> Konfirmasi Booking</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('hospital-booking-modal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeHospitalBookingModal() {
            const modal = document.getElementById('hospital-booking-modal');
            if (modal) modal.remove();
        }

        async function submitHospitalBooking() {
            const btn = document.getElementById('btn-submit-hospital-booking');
            const consultationType = document.getElementById('hospital-consultation-type').value;
            const complaint = document.getElementById('hospital-complaint').value;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Memproses...';

            try {
                const response = await fetch('/api/hospital-appointments/book', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: hospitalBookingData.date,
                        location: hospitalBookingData.location,
                        complaint: complaint,
                        consultation_category: consultationType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal membuat booking');
                }

                closeHospitalBookingModal();

                // Show success notification
                showBookingNotification(`Booking berhasil! ${data.details.hospital} - ${data.details.date}`, 'success');

                // Reload hospital schedules and booking status
                loadHospitalSchedules();
                loadBookingStatus();

            } catch (error) {
                console.error('Error booking hospital:', error);
                showBookingNotification(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-check"></i> Konfirmasi Booking';
            }
        }

        // Real-time booking updates via Socket.IO
        function setupRealtimeBookingUpdates() {
            // Wait for socket from announcements-dashboard.js
            function waitForSocket(callback, retries = 0) {
                if (window.socket || (typeof socket !== 'undefined' && socket)) {
                    callback(window.socket || socket);
                } else if (retries < 20) {
                    setTimeout(() => waitForSocket(callback, retries + 1), 250);
                } else {
                    console.warn('[PatientDashboard] Socket not available for real-time booking updates');
                }
            }

            waitForSocket((sock) => {
                console.log('[PatientDashboard] Setting up real-time updates');

                // Listen for booking status updates
                sock.on('booking:update', (data) => {
                    console.log('[PatientDashboard] Booking updated:', data);
                    // Reload booking status to reflect changes
                    loadBookingStatus();
                    // Show notification
                    showBookingNotification(`Status booking Anda telah diupdate: ${data.booking?.status || 'diperbarui'}`, 'info');
                });

                // Listen for booking cancellations
                sock.on('booking:cancel', (data) => {
                    console.log('[PatientDashboard] Booking cancelled:', data);
                    loadBookingStatus();
                    showBookingNotification('Booking Anda telah dibatalkan', 'warning');
                });

                // Listen for new notifications
                sock.on('notification:new', (data) => {
                    console.log('[PatientDashboard] New notification:', data);
                    // Update notification badge
                    updateNotificationBadge();
                    // Show toast notification
                    showBookingNotification(data.notification?.title || 'Notifikasi baru', 'info');
                });

                console.log('[PatientDashboard] Real-time updates enabled');
            });
        }

        function showBookingNotification(message, type) {
            const bgColor = type === 'warning' ? '#f39c12' : type === 'error' ? '#e74c3c' : '#28a7e9';
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 9999;
                max-width: 350px;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fa fa-bell"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function renderBookingStatus(appointments) {
            const container = document.getElementById('booking-status-container');
            const historyContainer = document.getElementById('booking-history-container');
            if (!container) return;

            // Filter upcoming appointments (exclude completed, cancelled, no_show)
            const upcoming = (appointments || [])
                .filter(apt => !apt.isPast && apt.status !== 'cancelled' && apt.status !== 'no_show' && apt.status !== 'completed')
                .sort((a, b) => {
                    const dateDiff = new Date(a.appointment_date) - new Date(b.appointment_date);
                    if (dateDiff !== 0) return dateDiff;
                    const sessionDiff = (a.session || 0) - (b.session || 0);
                    if (sessionDiff !== 0) return sessionDiff;
                    return (a.slot_number || 0) - (b.slot_number || 0);
                });

            // Filter completed appointments for history
            const completed = (appointments || [])
                .filter(apt => apt.status === 'completed')
                .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date)); // Most recent first

            // Render history section
            if (historyContainer) {
                if (completed.length === 0) {
                    historyContainer.innerHTML = `
                        <p class="empty-state">
                            <i class="fa fa-calendar-o"></i>
                            Belum ada riwayat janji temu
                        </p>
                    `;
                } else {
                    historyContainer.innerHTML = completed.slice(0, 5).map(apt => `
                        <div class="history-item" style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #fff;">${apt.dateFormatted || '-'}</div>
                                <div style="font-size: 12px; color: #aaa;">${apt.sessionLabel || '-'} - ${apt.time || '-'} WIB</div>
                            </div>
                            <span style="background: #28a745; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                                <i class="fa fa-check"></i> Selesai
                            </span>
                        </div>
                    `).join('');
                }
            }

            if (upcoming.length === 0) {
                container.innerHTML = `
                    <p class="empty-state">
                        <i class="fa fa-calendar-o"></i>
                        Belum ada janji temu yang dijadwalkan
                    </p>
                `;
                // Remove glow when no upcoming appointments
                const appointmentSection = document.getElementById('appointments-section');
                const quickAppointmentBtn = document.getElementById('quick-appointment');
                if (appointmentSection) appointmentSection.classList.remove('glow-new');
                if (quickAppointmentBtn) quickAppointmentBtn.classList.remove('glow-new');
                return;
            }

            const nextAppointment = upcoming[0];
            const statusInfo = getBookingStatusInfo(nextAppointment.status);
            const notes = nextAppointment.notes ? `<p style="margin-top: 10px;"><strong>Catatan Klinik:</strong><br>${escapeText(nextAppointment.notes)}</p>` : '';

            const startDateObj = nextAppointment.startDateTime ? new Date(nextAppointment.startDateTime) : null;
            const arrivalTime = nextAppointment.arrivalTimeFormatted
                || (startDateObj && !isNaN(startDateObj.getTime())
                    ? new Date(startDateObj.getTime() - (15 * 60 * 1000)).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    : null);

            const arrivalInfo = arrivalTime
                ? `Mohon hadir sekitar pukul ${arrivalTime} WIB (15 menit sebelum jadwal).`
                : 'Mohon hadir 15 menit sebelum waktu yang dipilih.';

            const slotNumber = Number(nextAppointment.slot_number);
            const slotInfo = Number.isFinite(slotNumber) && slotNumber > 0
                ? `<p><strong>Nomor Antrian:</strong> ${slotNumber}</p>`
                : '';

            const timeLabel = nextAppointment.time ? `${nextAppointment.time} WIB` : '-';

            const canCancel = !nextAppointment.isPast && ['pending', 'confirmed'].includes((nextAppointment.status || '').toLowerCase());
            const actionButtons = canCancel
                ? `<button type="button" class="cancel-appointment-btn" data-appointment-id="${nextAppointment.id}"><i class="fa fa-times-circle"></i> Batalkan Janji</button>`
                : '';

            container.innerHTML = `
                <div class="appointment-info-box">
                    <p><strong>Status:</strong> <span style="color: ${statusInfo.color}; font-weight: 600;">${statusInfo.label}</span></p>
                    <p><strong>Tanggal:</strong> ${nextAppointment.dateFormatted}</p>
                    <p><strong>Jam Konsultasi:</strong> ${timeLabel}</p>
                    <p><strong>Sesi:</strong> ${nextAppointment.sessionLabel || '-'}</p>
                    ${slotInfo}
                    <p>${statusInfo.message}</p>
                    <p>${arrivalInfo}</p>
                    ${notes}
                    ${actionButtons}
                </div>
            `;

            if (canCancel) {
                const cancelBtn = container.querySelector('.cancel-appointment-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => openCancelModal(nextAppointment));
                }
            }

            // Add glow effect for confirmed appointments
            const appointmentSection = document.getElementById('appointments-section');
            const quickAppointmentBtn = document.getElementById('quick-appointment');
            const isConfirmed = (nextAppointment.status || '').toLowerCase() === 'confirmed';

            if (appointmentSection) {
                if (isConfirmed) {
                    appointmentSection.classList.add('glow-new');
                } else {
                    appointmentSection.classList.remove('glow-new');
                }
            }

            if (quickAppointmentBtn) {
                if (isConfirmed) {
                    quickAppointmentBtn.classList.add('glow-new');
                } else {
                    quickAppointmentBtn.classList.remove('glow-new');
                }
            }
        }

        const cancellationState = {
            appointmentId: null
        };

        function openCancelModal(appointment) {
            if (!appointment || !appointment.id) return;

            cancellationState.appointmentId = appointment.id;

            const summary = document.getElementById('cancel-modal-summary');
            if (summary) {
                const timeLabel = appointment.time ? `${escapeText(appointment.time)} WIB` : '-';
                summary.innerHTML = `
                    <p style="margin-top: 0; margin-bottom: 8px;">Anda akan membatalkan janji konsultasi berikut:</p>
                    <p style="margin: 4px 0;"><strong>Tanggal:</strong> ${escapeText(appointment.dateFormatted)}</p>
                    <p style="margin: 4px 0;"><strong>Sesi:</strong> ${escapeText(appointment.sessionLabel || '-')}</p>
                    <p style="margin: 4px 0;"><strong>Jam:</strong> ${timeLabel}</p>
                `;
            }

            const reasonInput = document.getElementById('cancel-reason-input');
            if (reasonInput) {
                reasonInput.value = '';
            }

            const errorEl = document.getElementById('cancel-modal-error');
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }

            setCancelModalLoading(false);

            const modal = document.getElementById('cancel-appointment-modal');
            if (modal) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            }

            if (reasonInput) {
                setTimeout(() => {
                    reasonInput.focus();
                }, 50);
            }
        }

        function closeCancelModal() {
            const modal = document.getElementById('cancel-appointment-modal');
            if (modal) {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
            const errorEl = document.getElementById('cancel-modal-error');
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }
            setCancelModalLoading(false);
            cancellationState.appointmentId = null;
        }

        function setCancelModalLoading(isLoading) {
            const submitBtn = document.getElementById('cancel-modal-submit-btn');
            const cancelBtn = document.getElementById('cancel-modal-cancel-btn');
            const closeBtn = document.getElementById('cancel-modal-close');

            if (submitBtn) {
                submitBtn.disabled = !!isLoading;
                submitBtn.textContent = isLoading ? 'Memproses...' : 'Ya, Batalkan';
            }

            if (cancelBtn) {
                cancelBtn.disabled = !!isLoading;
            }

            if (closeBtn) {
                closeBtn.disabled = !!isLoading;
            }
        }

        async function submitCancellation() {
            if (!cancellationState.appointmentId) return;

            const reasonInput = document.getElementById('cancel-reason-input');
            const errorEl = document.getElementById('cancel-modal-error');

            const reasonValue = reasonInput ? reasonInput.value.trim() : '';

            if (reasonValue.length < 10) {
                if (errorEl) {
                    errorEl.textContent = 'Alasan pembatalan minimal 10 karakter.';
                    errorEl.style.display = 'block';
                }
                if (reasonInput) {
                    reasonInput.focus();
                }
                return;
            }

            if (errorEl) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }

            setCancelModalLoading(true);

            try {
                const response = await fetch(`/api/sunday-appointments/${cancellationState.appointmentId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reasonValue })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Gagal membatalkan janji temu');
                }

                closeCancelModal();
                showTemporaryAlert('Janji temu berhasil dibatalkan.');
                loadBookingStatus();
            } catch (error) {
                if (errorEl) {
                    errorEl.textContent = error.message || 'Terjadi kesalahan saat membatalkan janji temu.';
                    errorEl.style.display = 'block';
                }
            } finally {
                setCancelModalLoading(false);
            }
        }

        function showTemporaryAlert(message, type = 'success') {
            if (!message) return;

            const existing = document.getElementById('dashboard-toast');
            if (existing) {
                existing.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'dashboard-toast';
            toast.className = 'dashboard-toast';
            if (type === 'error') {
                toast.classList.add('error');
            }
            toast.textContent = message;
            document.body.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('visible');
            });

            setTimeout(() => {
                toast.classList.remove('visible');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                }, { once: true });
            }, 3200);
        }

        const cancelSubmitBtn = document.getElementById('cancel-modal-submit-btn');
        if (cancelSubmitBtn) {
            cancelSubmitBtn.addEventListener('click', submitCancellation);
        }

        const cancelCloseBtn = document.getElementById('cancel-modal-close');
        if (cancelCloseBtn) {
            cancelCloseBtn.addEventListener('click', closeCancelModal);
        }

        const cancelBackBtn = document.getElementById('cancel-modal-cancel-btn');
        if (cancelBackBtn) {
            cancelBackBtn.addEventListener('click', closeCancelModal);
        }

        const cancelModal = document.getElementById('cancel-appointment-modal');
        if (cancelModal) {
            cancelModal.addEventListener('click', (event) => {
                if (event.target === cancelModal) {
                    closeCancelModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modalElement = document.getElementById('cancel-appointment-modal');
                if (modalElement && modalElement.classList.contains('active')) {
                    event.preventDefault();
                    closeCancelModal();
                }
            }
        });

        function getBookingStatusInfo(status) {
            const normalizedStatus = (status || '').toLowerCase();
            const statusMap = {
                confirmed: {
                    label: 'Dikonfirmasi',
                    color: '#28e970',
                    message: 'Janji temu Anda telah dikonfirmasi. Tim klinik menunggu kehadiran Anda.'
                },
                pending: {
                    label: 'Menunggu Konfirmasi',
                    color: '#ffd166',
                    message: 'Permintaan booking Anda sudah kami terima dan sedang menunggu konfirmasi dari admin.'
                },
                completed: {
                    label: 'Selesai',
                    color: '#7f8c8d',
                    message: 'Janji temu ini telah selesai.'
                },
                cancelled: {
                    label: 'Dibatalkan',
                    color: '#d9534f',
                    message: 'Janji temu ini telah dibatalkan.'
                },
                no_show: {
                    label: 'Tidak Hadir',
                    color: '#d9534f',
                    message: 'Anda tidak hadir pada janji temu sebelumnya.'
                }
            };

            return statusMap[normalizedStatus] || {
                label: normalizedStatus || 'Tidak diketahui',
                color: '#cccccc',
                message: 'Status janji temu belum tersedia.'
            };
        }
        
        function toggleWelcomeMessage() {
            const content = document.getElementById('welcome-content');
            const icon = document.getElementById('welcome-toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        function toggleAnnouncementsSection() {
            const wrapper = document.getElementById('announcements-content');
            const icon = document.getElementById('announcements-toggle-icon');
            if (!wrapper || !icon) {
                return;
            }

            if (wrapper.style.display === 'none') {
                wrapper.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                wrapper.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // Generic toggle function for collapsible cards
        function toggleCard(cardId) {
            const content = document.getElementById(cardId + '-content');
            const icon = document.getElementById(cardId + '-toggle-icon');
            const header = document.getElementById(cardId + '-header');
            if (!content || !icon) return;

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
                if (header) header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
                if (header) header.classList.add('collapsed');
            }
        }

        async function loadVisitInvoices() {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            const patientId = window.currentProfile?.id;
            if (!patientId) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-circle"></i><p>Informasi pasien belum tersedia.</p></div>`;
                return;
            }

            try {
                // Load visit history with location info from sunday-clinic API
                const response = await fetch(`/api/sunday-clinic/patient-visits/${patientId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Gagal memuat kunjungan');
                }

                const { data } = await response.json();
                renderVisitCards(data || []);
            } catch (error) {
                console.error('Error loading visit history:', error);
                container.innerHTML = `<div class="empty-state"><i class="fa fa-exclamation-triangle"></i><p>Gagal memuat riwayat kunjungan.</p></div>`;
            }
        }

        function renderVisitCards(visits) {
            const container = document.getElementById('visits-list-container');
            if (!container) return;

            if (!visits || visits.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="fa fa-info-circle"></i><p>Belum ada riwayat kunjungan.</p></div>`;
                return;
            }

            const cardsHtml = visits.map(visit => {
                const category = visit.mr_category === 'ginekologi' ? 'Ginekologi' : 'Obstetri';
                const locationName = escapeText(visit.location_short || visit.location_name || 'Klinik');
                const locationColor = visit.location_color || '#3c8dbc';
                const locationLogo = visit.location_logo;

                // Build location badge with logo
                const locationBadge = locationLogo
                    ? `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <img src="${locationLogo}" alt="${locationName}" style="height: 30px; width: auto; object-fit: contain;">
                        <span style="color: ${locationColor}; font-weight: 500;">${locationName}</span>
                       </div>`
                    : `<div style="margin-bottom: 10px;">
                        <span style="background: ${locationColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                            <i class="fa fa-hospital-o"></i> ${locationName}
                        </span>
                       </div>`;

                return `
                    <div class="visit-card" style="border-left: 4px solid ${locationColor};">
                        ${locationBadge}
                        <h4 style="margin-top: 0;">Kunjungan ${category}</h4>
                        <p><strong>Tanggal:</strong> ${formatVisitDate(visit.visit_date)}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="visit-card-grid">${cardsHtml}</div>`;
        }

        function escapeText(value) {
            if (!value) return '';
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') {
                amount = parseFloat(amount) || 0;
            }
            return amount.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
        }

        function formatVisitDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function openProfileModal() {
            if (!window.currentProfile) return;

            // Populate form with current data
            document.getElementById('edit-fullname').value = window.currentProfile.fullname || '';
            document.getElementById('edit-email').value = window.currentProfile.email || '';
            document.getElementById('edit-phone').value = window.currentProfile.phone || '';
            document.getElementById('edit-profile-picture').value = window.currentProfile.profile_picture || '';

            // Update preview picture
            const previewImg = document.getElementById('edit-profile-picture-preview');
            if (window.currentProfile.profile_picture) {
                previewImg.src = window.currentProfile.profile_picture;
                previewImg.onerror = function() {
                    this.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3E👤%3C/text%3E%3C/svg%3E";
                };
            } else {
                previewImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23404040'/%3E%3Ctext x='50%25' y='50%25' font-size='40' fill='%2328a7e9' text-anchor='middle' dy='.3em'%3E👤%3C/text%3E%3C/svg%3E";
            }

            // Reset file input and progress bar
            document.getElementById('edit-profile-picture-file').value = '';
            document.getElementById('photo-upload-progress').style.display = 'none';
            document.getElementById('photo-upload-bar').style.width = '0%';
            document.getElementById('profile-error').style.display = 'none';

            if (window.currentProfile.birth_date) {
                // Use the date string directly to avoid timezone conversion issues
                // birth_date from DB is in YYYY-MM-DD format or ISO string
                let birthDateStr = window.currentProfile.birth_date;
                if (birthDateStr.includes('T')) {
                    // If it's an ISO string, extract just the date part
                    birthDateStr = birthDateStr.split('T')[0];
                }
                document.getElementById('edit-birthdate').value = birthDateStr;
            }

            document.getElementById('edit-age').value = window.currentProfile.age || '';

            // Show modal
            $('#profileModal').modal('show');
        }

        async function saveProfile() {
            // Hide previous messages
            document.getElementById('profile-error').style.display = 'none';
            document.getElementById('profile-success').style.display = 'none';

            // Get current values from form
            const fullnameInput = document.getElementById('edit-fullname').value.trim();
            const emailInput = document.getElementById('edit-email').value.trim();
            const phoneInput = document.getElementById('edit-phone').value.trim();
            const birthdateInput = document.getElementById('edit-birthdate').value;
            const ageInput = document.getElementById('edit-age').value;
            const profilePictureInput = document.getElementById('edit-profile-picture').value.trim();

            // Get current profile data
            const currentFullname = window.currentProfile?.fullname || '';
            const currentEmail = window.currentProfile?.email || '';
            const currentPhone = window.currentProfile?.phone || '';
            const currentBirthdate = window.currentProfile?.birth_date || '';
            const currentAge = window.currentProfile?.age ? String(window.currentProfile.age) : '';
            const currentProfilePicture = window.currentProfile?.profile_picture || '';

            // Check if there are any changes
            const hasChanges =
                (fullnameInput !== currentFullname) ||
                (emailInput !== currentEmail) ||
                (phoneInput !== currentPhone) ||
                (birthdateInput !== currentBirthdate) ||
                (ageInput !== currentAge) ||
                (profilePictureInput !== currentProfilePicture);

            // If no changes, just close the modal
            if (!hasChanges) {
                console.log('No changes detected, closing modal');
                $('#profileModal').modal('hide');
                return;
            }

            // Use input values or fallback to current data
            const fullname = fullnameInput || currentFullname;
            const email = emailInput || currentEmail;
            const phone = phoneInput || currentPhone;
            const birthdate = birthdateInput || currentBirthdate || null;
            const age = ageInput || currentAge || null;
            const profilePicture = profilePictureInput || currentProfilePicture || null;

            // Validation - require essential fields
            if (!fullname || !email || !phone) {
                document.getElementById('profile-error').textContent = 'Nama, email, dan nomor telepon harus diisi!';
                document.getElementById('profile-error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/patients/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fullname,
                        email,
                        phone,
                        birth_date: birthdate || null,
                        age: age ? parseInt(age) : null,
                        profile_picture: profilePicture
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal menyimpan profil');
                }

                // Show success message
                document.getElementById('profile-success').textContent = 'Profil berhasil diperbarui!';
                document.getElementById('profile-success').style.display = 'block';

                // Reload profile data
                setTimeout(() => {
                    $('#profileModal').modal('hide');
                    loadUserProfile();
                }, 1500);

            } catch (error) {
                console.error('Error saving profile:', error);
                document.getElementById('profile-error').textContent = error.message;
                document.getElementById('profile-error').style.display = 'block';
            }
        }

        // Auto-calculate age from birth date and profile photo upload
        document.addEventListener('DOMContentLoaded', function() {
            const birthdateInput = document.getElementById('edit-birthdate');
            const ageInput = document.getElementById('edit-age');

            if (birthdateInput && ageInput) {
                birthdateInput.addEventListener('change', function() {
                    const birthDate = new Date(this.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();

                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }

                    ageInput.value = age >= 0 ? age : '';
                });
            }

            // Profile photo file upload handler
            const photoFileInput = document.getElementById('edit-profile-picture-file');
            if (photoFileInput) {
                photoFileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Hide any previous photo error
                    document.getElementById('photo-upload-error').style.display = 'none';

                    // Validate file size (2MB max)
                    if (file.size > 2 * 1024 * 1024) {
                        document.getElementById('photo-upload-error-text').textContent = 'Ukuran file melebihi batas maksimal 2 MB';
                        document.getElementById('photo-upload-error').style.display = 'block';
                        e.target.value = '';
                        return;
                    }

                    // Validate file type
                    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                        document.getElementById('photo-upload-error-text').textContent = 'Format file harus JPEG, PNG, atau WebP';
                        document.getElementById('photo-upload-error').style.display = 'block';
                        e.target.value = '';
                        return;
                    }

                    // Show preview immediately using FileReader
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('edit-profile-picture-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Upload to server
                    document.getElementById('photo-upload-error').style.display = 'none';
                    document.getElementById('photo-upload-progress').style.display = 'block';
                    document.getElementById('photo-upload-bar').style.width = '30%';

                    try {
                        const formData = new FormData();
                        formData.append('photo', file);

                        document.getElementById('photo-upload-bar').style.width = '60%';

                        const response = await fetch('/api/patients/upload-photo', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        document.getElementById('photo-upload-bar').style.width = '90%';

                        const data = await response.json();

                        if (data.success) {
                            document.getElementById('photo-upload-bar').style.width = '100%';
                            document.getElementById('edit-profile-picture').value = data.photo_url;

                            // Update preview with actual URL from server
                            document.getElementById('edit-profile-picture-preview').src = data.photo_url;

                            // Update currentProfile so change detection works correctly
                            if (window.currentProfile) {
                                window.currentProfile.profile_picture = data.photo_url;
                            }

                            // Also update the Settings modal profile picture
                            const settingsProfilePic = document.getElementById('profile-picture');
                            if (settingsProfilePic) {
                                settingsProfilePic.src = data.photo_url;
                            }

                            // Update navigation avatar
                            const navAvatarImg = document.getElementById('user-avatar-img');
                            const navAvatarInitials = document.getElementById('user-avatar-initials');
                            if (navAvatarImg && navAvatarInitials) {
                                navAvatarImg.src = data.photo_url;
                                navAvatarImg.style.display = 'block';
                                navAvatarInitials.style.display = 'none';
                            }

                            setTimeout(() => {
                                document.getElementById('photo-upload-progress').style.display = 'none';
                                document.getElementById('photo-upload-bar').style.width = '0%';
                            }, 500);

                            showToast('Foto profil berhasil diupload', 'success');
                        } else {
                            throw new Error(data.message || 'Gagal mengupload foto');
                        }
                    } catch (error) {
                        console.error('Photo upload error:', error);
                        document.getElementById('photo-upload-progress').style.display = 'none';
                        document.getElementById('photo-upload-bar').style.width = '0%';
                        document.getElementById('photo-upload-error-text').textContent = error.message || 'Gagal mengupload foto';
                        document.getElementById('photo-upload-error').style.display = 'block';
                        e.target.value = '';
                    }
                });
            }
        });

        function updateIntakeButtonCompleted() {
            // Find all intake buttons (both in quick actions and full list)
            const intakeButtons = document.querySelectorAll('a[href="/patient-intake.html"]');
            
            intakeButtons.forEach(btn => {
                // Change background to green
                btn.style.background = 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)';
                btn.style.borderColor = '#27ae60';
                btn.style.color = '#ffffff';
                
                // Add checkmark icon with white color
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fa fa-check-circle';
                    icon.style.color = '#ffffff';
                    icon.style.fontSize = '48px';
                }
                
                // Update text with white color
                const textDiv = btn.querySelector('div');
                if (textDiv) {
                    textDiv.innerHTML = 'Formulir Identitas Pribadi<br><small style="font-size: 11px; color: #ffffff; font-weight: 600;">✓ Sudah Diselesaikan</small>';
                    textDiv.style.color = '#ffffff';
                    textDiv.style.fontWeight = '600';
                }
                
                // Make it clickable to view again (optional)
                btn.title = 'Formulir sudah diselesaikan';
            });
        }

        function logout(event) {
            if (event) {
                event.preventDefault();
            }

            // Read mobile app flag BEFORE clearing (important!)
            const fromMobileApp = localStorage.getItem('from_mobile_app') === 'true';
            const urlParams = new URLSearchParams(window.location.search);
            const hasTokenParam = urlParams.has('token');
            const isCapacitor = window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform();

            // Clear all auth data
            localStorage.removeItem('vps_auth_token');
            sessionStorage.removeItem('vps_auth_token');
            localStorage.removeItem('patient_user');
            localStorage.removeItem('patient_token');
            localStorage.removeItem('auth_provider');
            localStorage.removeItem('patient_intake_draft_v3');
            localStorage.removeItem('from_mobile_app');

            // Check if opened from mobile app
            if (hasTokenParam || isCapacitor || fromMobileApp) {
                // Return to mobile app login
                window.location.href = 'dokterdibya://logout';
            } else {
                // Web browser - go to web login
                window.location.href = '/patient-login.html';
            }
        }

        // Toggle dropdown menu
        function toggleDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Open profile view modal (Settings)
        function openProfileViewModal(event) {
            if (event) {
                event.preventDefault();
            }
            $('#profileViewModal').modal('show');
            // Close dropdown
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // Ultrasound Gallery Functions
        let ultrasoundImages = [];

        function openUploadUltrasoundModal() {
            $('#uploadUltrasoundModal').modal('show');
            // Clear form
            document.getElementById('ultrasound-upload-form').reset();
            document.getElementById('ultrasound-error').style.display = 'none';
            document.getElementById('ultrasound-success').style.display = 'none';
        }

        async function saveUltrasound() {
            const url = document.getElementById('ultrasound-url').value.trim();
            const date = document.getElementById('ultrasound-date').value;
            const notes = document.getElementById('ultrasound-notes').value.trim();

            if (!url || !date) {
                showUltrasoundError('URL dan tanggal USG harus diisi');
                return;
            }

            try {
                // Save to localStorage for now (can be changed to API call later)
                const newImage = {
                    id: Date.now(),
                    url: url,
                    date: date,
                    notes: notes,
                    created_at: new Date().toISOString()
                };

                ultrasoundImages.push(newImage);
                localStorage.setItem('ultrasound_images', JSON.stringify(ultrasoundImages));

                showUltrasoundSuccess('Foto USG berhasil disimpan');
                setTimeout(() => {
                    $('#uploadUltrasoundModal').modal('hide');
                    renderUltrasoundGallery();
                }, 1500);
            } catch (error) {
                showUltrasoundError('Gagal menyimpan foto USG');
            }
        }

        function renderUltrasoundGallery() {
            const gallery = document.getElementById('ultrasound-gallery');
            const galleryMini = document.getElementById('ultrasound-gallery-mini');

            if (ultrasoundImages.length === 0) {
                const emptyState = `
                    <p class="empty-state">
                        <i class="fa fa-image"></i>
                        Belum ada foto USG dari dokter
                    </p>
                `;
                if (gallery) gallery.innerHTML = emptyState;
                if (galleryMini) galleryMini.innerHTML = emptyState;
                return;
            }

            // Get custom thumbnail preference
            const customThumbnailId = localStorage.getItem('usg_thumbnail_id');
            const isThumbnailId = (id) => customThumbnailId && parseInt(customThumbnailId) === id;

            const galleryHTML = ultrasoundImages.map(img => {
                const imgDate = new Date(img.date);
                const formattedDate = imgDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const safeNotes = (img.notes || img.title || '').replace(/'/g, "\\'");
                const glowClass = img.isNew ? 'glow-new' : '';
                const isThumbnail = isThumbnailId(img.id);

                return `
                    <div class="ultrasound-item ${glowClass}" style="position: relative;">
                        ${img.isNew ? '<span class="new-badge" style="position: absolute; top: 8px; right: 8px; background: #28e97f; color: #000; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; z-index: 3;">BARU</span>' : ''}
                        ${isThumbnail ? '<span class="thumbnail-badge" style="position: absolute; top: 8px; left: 8px; background: #ffd700; color: #000; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; z-index: 3;"><i class="fa fa-star"></i> THUMBNAIL</span>' : ''}
                        <img src="${img.url}"
                             alt="USG ${formattedDate}"
                             onclick="viewUsgAndMarkViewed(${img.id}, '${img.url}', '${formattedDate}', '${safeNotes}', this.parentElement)"
                             style="cursor: pointer;"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect width=%27200%27 height=%27200%27 fill=%27%23404040%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 font-size=%2720%27 fill=%27%2328a7e9%27 text-anchor=%27middle%27 dy=%27.3em%27%3EGambar Error%3C/text%3E%3C/svg%3E'">
                        <div class="overlay">
                            ${formattedDate}
                            ${img.title ? '<br>' + img.title : ''}
                        </div>
                        <button onclick="event.stopPropagation(); setUsgThumbnail(${img.id})"
                                style="position: absolute; bottom: 10px; right: 10px; background: ${isThumbnail ? '#ffd700' : 'rgba(40, 167, 233, 0.9)'}; color: ${isThumbnail ? '#000' : '#fff'}; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; z-index: 3; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                            <i class="fa fa-star${isThumbnail ? '' : '-o'}"></i> ${isThumbnail ? 'Thumbnail' : 'Set Thumbnail'}
                        </button>
                    </div>
                `;
            }).join('');

            if (gallery) gallery.innerHTML = galleryHTML;

            // For mini gallery, use custom thumbnail or latest USG
            if (galleryMini) {
                let thumbnailImg;
                if (customThumbnailId) {
                    thumbnailImg = ultrasoundImages.find(img => img.id === parseInt(customThumbnailId));
                }
                // Fallback to latest if custom thumbnail not found or not set
                if (!thumbnailImg) {
                    thumbnailImg = ultrasoundImages[0];
                }

                const latestImg = thumbnailImg; // Use selected or latest
                const imgDate = new Date(latestImg.date);
                const formattedDate = imgDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const safeNotes = (latestImg.notes || latestImg.title || '').replace(/'/g, "\\'");
                const totalCount = ultrasoundImages.length;

                galleryMini.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div onclick="viewUsgAndMarkViewed(${latestImg.id}, '${latestImg.url}', '${formattedDate}', '${safeNotes}', this)"
                             style="position: relative; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.3s;"
                             onmouseover="this.style.transform='scale(1.02)'"
                             onmouseout="this.style.transform='scale(1)'">
                            ${latestImg.isNew ? '<span class="new-badge" style="position: absolute; top: 8px; right: 8px; background: #28e97f; color: #000; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; z-index: 2;">BARU</span>' : ''}
                            <img src="${latestImg.url}"
                                 alt="USG Terbaru"
                                 style="width: 100%; height: 200px; object-fit: cover; display: block;"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27200%27%3E%3Crect width=%27300%27 height=%27200%27 fill=%27%23404040%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 font-size=%2720%27 fill=%27%2328a7e9%27 text-anchor=%27middle%27 dy=%27.3em%27%3EGambar Error%3C/text%3E%3C/svg%3E'">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 15px 10px 10px; color: white;">
                                <div style="font-size: 13px; font-weight: 600;">${formattedDate}</div>
                                ${latestImg.title ? '<div style="font-size: 11px; color: #ddd; margin-top: 3px;">' + latestImg.title + '</div>' : ''}
                            </div>
                        </div>
                        ${totalCount > 1 ? `
                            <div style="text-align: center; padding: 8px; background: rgba(40, 167, 233, 0.1); border-radius: 6px; font-size: 12px; color: #28a7e9;">
                                <i class="fa fa-images"></i> ${totalCount} foto USG tersedia
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Update quick action thumbnail with first USG image
            updateQuickActionThumbnail('quick-usg-thumb', ultrasoundImages[0]?.url, 'fa-heartbeat');

            // Update section and quick action glow if has new items
            const hasNewUsg = ultrasoundImages.some(img => img.isNew);
            updateSectionGlow('usg-section', hasNewUsg);
            updateQuickActionGlow('quick-usg', hasNewUsg);
        }

        function deleteUltrasound(event, id) {
            event.stopPropagation();
            if (confirm('Yakin ingin menghapus foto USG ini?')) {
                ultrasoundImages = ultrasoundImages.filter(img => img.id !== id);
                localStorage.setItem('ultrasound_images', JSON.stringify(ultrasoundImages));
                renderUltrasoundGallery();
            }
        }

        // Set custom USG thumbnail
        function setUsgThumbnail(id) {
            localStorage.setItem('usg_thumbnail_id', id.toString());
            renderUltrasoundGallery();

            // Show success message
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ffd700; color: #000; padding: 12px 20px; border-radius: 8px; z-index: 9999; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
            msg.innerHTML = '<i class="fa fa-check-circle"></i> Thumbnail berhasil diatur!';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }

        function viewUltrasoundImage(url, date, notes) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="max-width: 900px; width: 100%; max-height: 90vh; overflow: auto; text-align: center;">
                    <h4 style="color: #28a7e9; margin-bottom: 15px;">USG - ${date}</h4>
                    ${notes ? `<p style="color: #aaa; margin-bottom: 15px; font-size: 14px;">${notes}</p>` : ''}
                    <img src="${url}" alt="USG ${date}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <a href="${url}" download="USG-${date}" style="padding: 10px 25px; background: #28e97f; color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fa fa-download"></i> Download
                        </a>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 30px; background: #555; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        function showUltrasoundError(message) {
            const errorEl = document.getElementById('ultrasound-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('ultrasound-success').style.display = 'none';
        }

        function showUltrasoundSuccess(message) {
            const successEl = document.getElementById('ultrasound-success');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('ultrasound-error').style.display = 'none';
        }

        // Load ultrasound images from patient documents API (sent by staff)
        async function loadUltrasoundImages() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (!token) return;

                // Fetch all USG types: usg_photo, usg_2d, usg_4d
                const [responsePhoto, response2d, response4d] = await Promise.all([
                    fetch('/api/patient-documents/my-documents?type=usg_photo', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/patient-documents/my-documents?type=usg_2d', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch('/api/patient-documents/my-documents?type=usg_4d', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                let allDocs = [];

                if (responsePhoto.ok) {
                    const resultPhoto = await responsePhoto.json();
                    if (resultPhoto.success && resultPhoto.documents) {
                        allDocs = allDocs.concat(resultPhoto.documents);
                    }
                }

                if (response2d.ok) {
                    const result2d = await response2d.json();
                    if (result2d.success && result2d.documents) {
                        allDocs = allDocs.concat(result2d.documents);
                    }
                }

                if (response4d.ok) {
                    const result4d = await response4d.json();
                    if (result4d.success && result4d.documents) {
                        allDocs = allDocs.concat(result4d.documents);
                    }
                }

                // Sort by date descending
                allDocs.sort((a, b) => new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at));

                ultrasoundImages = allDocs.map(doc => ({
                    id: doc.id,
                    url: doc.file_url,
                    date: doc.published_at || doc.created_at,
                    notes: doc.description || doc.title,
                    title: doc.title,
                    type: doc.document_type,
                    isNew: !doc.first_viewed_at
                }));
                renderUltrasoundGallery();
            } catch (error) {
                console.error('Failed to load USG images:', error);
            }
        }

        // Load lab results from patient documents API (sent by staff)
        let labResults = [];
        async function loadLabResults() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (!token) return;

                const response = await fetch('/api/patient-documents/my-documents?type=lab_result', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.documents) {
                        labResults = result.documents.map(doc => ({
                            id: doc.id,
                            url: doc.file_url,
                            date: doc.published_at || doc.created_at,
                            title: doc.title,
                            description: doc.description,
                            isNew: !doc.first_viewed_at,
                            fileType: doc.file_type
                        }));
                        renderLabResults();
                    }
                }
            } catch (error) {
                console.error('Failed to load lab results:', error);
            }
        }

        function renderLabResults() {
            const container = document.getElementById('lab-results-container');
            if (!container) return;

            if (labResults.length === 0) {
                container.innerHTML = `
                    <p class="empty-state">
                        <i class="fa fa-flask"></i>
                        Belum ada hasil lab dari dokter
                    </p>
                `;
                return;
            }

            const isImage = (fileType) => fileType && fileType.startsWith('image/');

            container.innerHTML = `
                <div class="lab-results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    ${labResults.map(lab => `
                        <div class="lab-result-item ${lab.isNew ? 'glow-new' : ''}"
                             style="position: relative;"
                             onclick="openLabResultAndMarkViewed(${lab.id}, '${lab.url}', this)">
                            ${isImage(lab.fileType) ? `
                                <img src="${lab.url}" alt="${lab.title}" class="lab-thumb" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="lab-thumb" style="display: none; align-items: center; justify-content: center;">
                                    <i class="fa fa-file-text-o" style="font-size: 40px; color: #28a7e9;"></i>
                                </div>
                            ` : `
                                <div class="lab-thumb" style="display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-file-pdf-o" style="font-size: 40px; color: #e74c3c;"></i>
                                </div>
                            `}
                            ${lab.isNew ? '<span class="new-badge">BARU</span>' : ''}
                            <div class="lab-info">
                                <div class="lab-title">${lab.title || 'Hasil Lab'}</div>
                                <div class="lab-date">${formatLabDate(lab.date)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Update quick action thumbnail with first lab result
            updateQuickActionThumbnail('quick-lab-thumb', labResults[0]?.url, 'fa-flask');

            // Update section and quick action glow if has new items
            const hasNewLab = labResults.some(l => l.isNew);
            updateSectionGlow('lab-section', hasNewLab);
            updateQuickActionGlow('quick-lab', hasNewLab);
        }

        function formatLabDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function openLabResult(url) {
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Open lab result and mark as viewed
        async function openLabResultAndMarkViewed(docId, url, element) {
            // Remove glow effect immediately
            if (element) {
                element.classList.remove('glow-new');
                const badge = element.querySelector('.new-badge');
                if (badge) badge.remove();
            }

            // Update local data
            const lab = labResults.find(l => l.id === docId);
            if (lab) lab.isNew = false;

            // Update section and quick action glow
            const hasNewLab = labResults.some(l => l.isNew);
            updateSectionGlow('lab-section', hasNewLab);
            updateQuickActionGlow('quick-lab', hasNewLab);

            // Show in modal
            if (url) {
                showDocumentModal(url, labResults.find(l => l.id === docId)?.title || 'Hasil Lab');
            }

            // Mark as viewed in backend
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (token) {
                    await fetch(`/api/patient-documents/${docId}/view`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
            } catch (error) {
                console.error('Failed to mark document as viewed:', error);
            }
        }

        // Show document in modal
        function showDocumentModal(url, title) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="max-width: 900px; width: 100%; max-height: 90vh; overflow: auto; text-align: center;">
                    <h4 style="color: #28a7e9; margin-bottom: 20px;">${title}</h4>
                    <img src="${url}" alt="${title}" style="max-width: 100%; max-height: 65vh; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; padding: 40px; background: #2a2a2a; border-radius: 8px;">
                        <i class="fa fa-file-pdf-o" style="font-size: 60px; color: #e74c3c;"></i>
                        <p style="color: #fff; margin-top: 15px;">File tidak dapat ditampilkan</p>
                        <a href="${url}" target="_blank" style="display: inline-block; margin-top: 15px; padding: 10px 25px; background: #28a7e9; color: #fff; text-decoration: none; border-radius: 8px;">
                            <i class="fa fa-external-link"></i> Buka di Tab Baru
                        </a>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <a href="${url}" download="${title}" style="padding: 10px 25px; background: #28e97f; color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fa fa-download"></i> Download
                        </a>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 30px; background: #555; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Update section glow effect
        function updateSectionGlow(sectionId, hasNew) {
            const section = document.getElementById(sectionId);
            if (section) {
                if (hasNew) {
                    section.classList.add('glow-new');
                } else {
                    section.classList.remove('glow-new');
                }
            }
        }

        // Update quick action button glow
        function updateQuickActionGlow(buttonId, hasNew) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (hasNew) {
                    button.classList.add('glow-new');
                } else {
                    button.classList.remove('glow-new');
                }
            }
        }

        // View USG image and mark as viewed
        async function viewUsgAndMarkViewed(docId, url, date, notes, element) {
            // Remove glow effect immediately
            if (element) {
                element.classList.remove('glow-new');
                const badge = element.querySelector('.new-badge');
                if (badge) badge.remove();
            }

            // Update local data
            const img = ultrasoundImages.find(i => i.id === docId);
            if (img) img.isNew = false;

            // Update section and quick action glow
            const hasNewUsg = ultrasoundImages.some(i => i.isNew);
            updateSectionGlow('usg-section', hasNewUsg);
            updateQuickActionGlow('quick-usg', hasNewUsg);

            // Show the image viewer
            viewUltrasoundImage(url, date, notes);

            // Mark as viewed in backend
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (token) {
                    await fetch(`/api/patient-documents/${docId}/view`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
            } catch (error) {
                console.error('Failed to mark document as viewed:', error);
            }
        }

        // Update quick action thumbnail
        function updateQuickActionThumbnail(containerId, imageUrl, fallbackIcon) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (imageUrl) {
                container.innerHTML = `<img src="${imageUrl}" alt="Thumbnail" onerror="this.parentElement.innerHTML='<i class=\\'fa ${fallbackIcon}\\'></i>'">`;
            } else {
                container.innerHTML = `<i class="fa ${fallbackIcon}"></i>`;
            }
        }

        // Password Management Functions
        let hasPassword = false; // Track if user has password set
        
        function openPasswordModal() {
            // Clear form
            document.getElementById('password-form').reset();
            document.getElementById('password-error').style.display = 'none';
            document.getElementById('password-success').style.display = 'none';
            
            // Check if user already has password
            if (hasPassword) {
                // Change Password mode
                document.getElementById('password-modal-title').textContent = 'Ubah Password';
                document.getElementById('old-password-group').style.display = 'block';
                document.getElementById('new-pass-label').textContent = 'Password Baru';
                document.getElementById('save-password-btn-text').textContent = 'Ubah Password';
                document.getElementById('password-info-text').textContent = 'Masukkan password lama dan password baru untuk mengubah password Anda.';
            } else {
                // Set Password mode
                document.getElementById('password-modal-title').textContent = 'Set Password';
                document.getElementById('old-password-group').style.display = 'none';
                document.getElementById('new-pass-label').textContent = 'Password';
                document.getElementById('save-password-btn-text').textContent = 'Set Password';
                document.getElementById('password-info-text').textContent = 'Setelah set password, Anda dapat login menggunakan email dan password.';
            }
            
            $('#passwordModal').modal('show');
        }
        
        async function savePassword() {
            try {
                // Hide previous messages
                document.getElementById('password-error').style.display = 'none';
                document.getElementById('password-success').style.display = 'none';
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Validation
                if (!newPassword || !confirmPassword) {
                    throw new Error('Semua field harus diisi');
                }
                
                if (newPassword !== confirmPassword) {
                    throw new Error('Password dan konfirmasi password tidak cocok');
                }
                
                if (newPassword.length < 6) {
                    throw new Error('Password minimal 6 karakter');
                }
                
                let endpoint, body;
                
                if (hasPassword) {
                    // Change Password
                    const oldPassword = document.getElementById('old-password').value;
                    if (!oldPassword) {
                        throw new Error('Password lama harus diisi');
                    }
                    
                    endpoint = '/api/patients/change-password';
                    body = {
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };
                } else {
                    // Set Password
                    endpoint = '/api/patients/set-password';
                    body = {
                        password: newPassword,
                        confirm_password: confirmPassword
                    };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Gagal menyimpan password');
                }
                
                // Show success message
                document.getElementById('password-success').textContent = result.message;
                document.getElementById('password-success').style.display = 'block';
                
                // Update button text to "Ubah Password" if this was first set
                if (!hasPassword) {
                    hasPassword = true;
                    document.getElementById('password-btn-text').textContent = 'Ubah Password';
                }
                
                // Close modal after delay
                setTimeout(() => {
                    $('#passwordModal').modal('hide');
                }, 1500);
                
            } catch (error) {
                console.error('Error saving password:', error);
                document.getElementById('password-error').textContent = error.message;
                document.getElementById('password-error').style.display = 'block';
            }
        }

        // Auto-refresh token verification every 5 minutes
        setInterval(async () => {
            try {
                const response = await fetch('/api/patients/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    logout();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
            }
        }, 5 * 60 * 1000);

        // Show "Atur Password" link for Google users
        document.addEventListener('DOMContentLoaded', function() {
            const googleUserPasswordSection = document.getElementById('google-user-password-section');
            const emailInput = document.getElementById('edit-email');

            if (googleUserPasswordSection && emailInput) {
                const email = emailInput.value.trim();
                
                // Check if email is from Google (ends with @gmail.com or similar)
                if (email && email.split('@')[1]) {
                    const domain = email.split('@')[1].toLowerCase();
                    const googleDomains = ['gmail.com', 'googlemail.com', 'yahoo.com', 'hotmail.com', 'live.com'];

                    if (googleDomains.includes(domain)) {
                        googleUserPasswordSection.style.display = 'block';
                    }
                }
            }
        });

        // =====================================================
        // MY DOCUMENTS SECTION
        // =====================================================

        /**
         * Load and display patient's documents
         */
        async function loadMyDocuments() {
            const container = document.getElementById('my-documents-container');
            if (!container) return;

            const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
            if (!token) {
                container.innerHTML = renderDocumentsEmpty('Silakan login untuk melihat dokumen Anda');
                return;
            }

            try {
                const response = await fetch('/api/patient-documents/my-documents', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        container.innerHTML = renderDocumentsEmpty('Sesi telah berakhir. Silakan login kembali.');
                        return;
                    }
                    throw new Error('Failed to fetch documents');
                }

                const data = await response.json();

                if (!data.success || !data.documents || data.documents.length === 0) {
                    container.innerHTML = renderDocumentsEmpty('Belum ada dokumen medis yang dikirimkan oleh dokter.');
                    return;
                }

                // Exclude USG and Lab types (they have their own dedicated sections)
                const excludedTypes = ['usg_photo', 'usg_2d', 'usg_4d', 'lab_result'];
                const filteredDocs = data.documents.filter(doc => !excludedTypes.includes(doc.document_type));

                if (filteredDocs.length === 0) {
                    container.innerHTML = renderDocumentsEmpty('Belum ada dokumen medis yang dikirimkan oleh dokter.');
                    updateSectionGlow('documents-section', false);
                    return;
                }

                // Check for new/unviewed documents
                const hasNewDocs = filteredDocs.some(doc => !doc.first_viewed_at);
                updateSectionGlow('documents-section', hasNewDocs);

                container.innerHTML = renderDocumentsGrid(filteredDocs, hasNewDocs);

            } catch (error) {
                console.error('Error loading documents:', error);
                container.innerHTML = renderDocumentsEmpty('Gagal memuat dokumen. Silakan coba lagi.');
            }
        }

        /**
         * Render empty state for documents
         */
        function renderDocumentsEmpty(message) {
            return `
                <div class="documents-empty">
                    <i class="fa fa-folder-open-o"></i>
                    <p>${message}</p>
                </div>
            `;
        }

        /**
         * Render documents grid
         */
        function renderDocumentsGrid(documents) {
            const cards = documents.map(doc => renderDocumentCard(doc)).join('');
            return `<div class="documents-grid">${cards}</div>`;
        }

        /**
         * Render a single document card
         */
        function renderDocumentCard(doc) {
            const iconClass = getDocumentIconClass(doc.document_type);
            const iconName = getDocumentIcon(doc.document_type);
            const formattedDate = formatDocumentDate(doc.published_at);
            const isNew = isDocumentNew(doc);
            const glowClass = isNew ? 'glow-new' : '';
            const newBadge = isNew ? '<span class="document-badge new" style="background: #28e97f; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: 8px;">BARU</span>' : '';

            // Location badge with logo
            const locationLogo = doc.location_logo || '/images/dibyablacklogo.svg';
            const locationName = doc.location_name || 'Klinik Privat';
            const locationColor = doc.location_color || '#3c8dbc';

            return `
                <div class="document-card ${glowClass}" data-doc-id="${doc.id}" style="border-left: 3px solid ${locationColor};">
                    <div class="doc-location" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                        <div style="background: #fff; padding: 4px 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center;">
                            <img src="${locationLogo}" alt="${escapeHtml(locationName)}" style="height: 18px; width: auto; object-fit: contain;">
                        </div>
                        <span style="font-size: 11px; color: ${locationColor}; font-weight: 500;">${escapeHtml(locationName)}</span>
                    </div>
                    <div class="doc-icon ${iconClass}">
                        <i class="fa ${iconName}"></i>
                    </div>
                    <div class="doc-title">${escapeHtml(doc.title)}${newBadge}</div>
                    <div class="doc-date">
                        <i class="fa fa-calendar-o"></i> ${formattedDate}
                    </div>
                    <div class="doc-actions">
                        <button class="doc-btn view-btn" onclick="viewDocumentAndMarkViewed(${doc.id}, '${escapeHtml(doc.file_url || '')}', '${escapeHtml(doc.document_type)}', '${escapeHtml(doc.title)}', this)">
                            <i class="fa fa-eye"></i> Lihat
                        </button>
                        ${doc.file_url ? `
                            <button class="doc-btn download-btn" onclick="downloadDocument(${doc.id}, '${escapeHtml(doc.file_url)}', '${escapeHtml(doc.file_name || doc.title)}')">
                                <i class="fa fa-download"></i> Unduh
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Get icon class based on document type
         */
        function getDocumentIconClass(type) {
            const typeMap = {
                'resume_medis': 'resume',
                'usg_2d': 'usg',
                'usg_4d': 'usg',
                'lab_result': 'lab',
                'lab_interpretation': 'lab',
                'prescription': 'other',
                'referral': 'other',
                'certificate': 'other'
            };
            return typeMap[type] || 'other';
        }

        /**
         * Get icon name based on document type
         */
        function getDocumentIcon(type) {
            const iconMap = {
                'resume_medis': 'fa-file-text-o',
                'usg_2d': 'fa-picture-o',
                'usg_4d': 'fa-video-camera',
                'lab_result': 'fa-flask',
                'lab_interpretation': 'fa-stethoscope',
                'prescription': 'fa-medkit',
                'referral': 'fa-share-square-o',
                'certificate': 'fa-certificate'
            };
            return iconMap[type] || 'fa-file-o';
        }

        /**
         * Format date for display
         */
        function formatDocumentDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        /**
         * Check if document is new (not viewed yet)
         */
        function isDocumentNew(doc) {
            return !doc.first_viewed_at;
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Show toast notification
         */
        function showToast(message, type = 'info') {
            // Create toast container if not exists
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;';
                document.body.appendChild(container);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
            toast.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = message;
            container.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * View document
         */
        async function viewDocument(docId, fileUrl, docType) {
            // Track view
            try {
                await fetch(`/api/patient-documents/${docId}/track`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'view' })
                });
            } catch (e) {
                console.error('Failed to track view:', e);
            }

            // Remove "new" badge from this document
            const card = document.querySelector(`[data-doc-id="${docId}"]`);
            if (card) {
                const badge = card.querySelector('.document-badge.new');
                if (badge) badge.remove();
            }

            // Open document
            if (fileUrl) {
                window.open(fileUrl, '_blank');
            } else if (docType === 'resume_medis') {
                // For resume medis without file, fetch and show content in modal
                openResumeModal(docId);
            }
        }

        /**
         * View document and mark as viewed (with glow removal)
         */
        async function viewDocumentAndMarkViewed(docId, fileUrl, docType, title, buttonEl) {
            // Find the card and remove glow effect
            const card = buttonEl ? buttonEl.closest('.document-card') : document.querySelector(`[data-doc-id="${docId}"]`);
            if (card) {
                card.classList.remove('glow-new');
                const badge = card.querySelector('.document-badge');
                if (badge) badge.remove();
            }

            // Mark as viewed in backend
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (token) {
                    await fetch(`/api/patient-documents/${docId}/view`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
            } catch (error) {
                console.error('Failed to mark document as viewed:', error);
            }

            // Check if there are still new documents
            const remainingNew = document.querySelectorAll('#my-documents-container .document-card.glow-new').length;
            updateSectionGlow('documents-section', remainingNew > 0);

            // Open document in modal or new tab
            if (fileUrl) {
                showDocumentModal(fileUrl, title || 'Dokumen');
            } else if (docType === 'resume_medis') {
                openResumeModal(docId);
            }
        }

        /**
         * Open resume viewer modal and fetch content
         */
        async function openResumeModal(docId) {
            const modal = $('#resumeViewerModal');
            const loadingEl = document.getElementById('resume-loading');
            const contentEl = document.getElementById('resume-content');
            const errorEl = document.getElementById('resume-error');
            const textEl = document.getElementById('resume-text');
            const titleEl = document.getElementById('resume-modal-title');

            // Reset modal state
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            titleEl.textContent = 'Resume Medis';

            // Show modal
            modal.modal('show');

            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(`/api/patient-documents/${docId}/content`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Gagal memuat dokumen');
                }

                if (data.success && data.document) {
                    titleEl.textContent = data.document.title || 'Resume Medis';

                    if (data.document.content) {
                        textEl.textContent = data.document.content;
                        loadingEl.style.display = 'none';
                        contentEl.style.display = 'block';
                    } else if (data.document.fileUrl) {
                        // If there's a file URL after all, open it
                        modal.modal('hide');
                        window.open(data.document.fileUrl, '_blank');
                    } else {
                        throw new Error('Konten resume tidak tersedia');
                    }
                } else {
                    throw new Error(data.message || 'Gagal memuat dokumen');
                }
            } catch (error) {
                console.error('Error loading resume:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                document.getElementById('resume-error-text').textContent = error.message || 'Gagal memuat resume medis';
            }
        }

        /**
         * Download document
         */
        async function downloadDocument(docId, fileUrl, fileName) {
            // Track download
            try {
                await fetch(`/api/patient-documents/${docId}/track`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'download' })
                });
            } catch (e) {
                console.error('Failed to track download:', e);
            }

            // Download file
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load documents on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMyDocuments();
            loadPatientUploads();
        });

        // =====================================================
        // PATIENT UPLOADS SECTION
        // =====================================================

        let selectedUploadFile = null;

        /**
         * Open patient upload modal
         */
        function openPatientUploadModal() {
            // Reset form
            document.getElementById('patient-upload-form').reset();
            clearUploadFile();
            document.getElementById('upload-error').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'none';
            $('#patientUploadModal').modal('show');
        }

        /**
         * Handle file selection
         */
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('upload-doc-file');
            const dropzone = document.getElementById('upload-dropzone');

            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        handleFileSelect(e.target.files[0]);
                    }
                });
            }

            if (dropzone) {
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropzone.style.borderColor = '#a855f7';
                    dropzone.style.background = 'rgba(168,85,247,0.1)';
                });

                dropzone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropzone.style.borderColor = 'rgba(168,85,247,0.4)';
                    dropzone.style.background = 'transparent';
                });

                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropzone.style.borderColor = 'rgba(168,85,247,0.4)';
                    dropzone.style.background = 'transparent';
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        handleFileSelect(e.dataTransfer.files[0]);
                    }
                });
            }
        });

        function handleFileSelect(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];

            if (!allowedTypes.includes(file.type)) {
                showUploadError('Format file tidak didukung. Gunakan JPEG, PNG, atau PDF.');
                return;
            }

            if (file.size > maxSize) {
                showUploadError('Ukuran file melebihi batas maksimal 10 MB');
                return;
            }

            selectedUploadFile = file;
            document.getElementById('upload-file-name').textContent = file.name;
            document.getElementById('upload-file-preview').style.display = 'block';
            document.getElementById('upload-dropzone').style.display = 'none';
            document.getElementById('upload-error').style.display = 'none';
        }

        function clearUploadFile() {
            selectedUploadFile = null;
            document.getElementById('upload-doc-file').value = '';
            document.getElementById('upload-file-preview').style.display = 'none';
            document.getElementById('upload-dropzone').style.display = 'block';
        }

        function showUploadError(message) {
            const errorEl = document.getElementById('upload-error');
            document.getElementById('upload-error-text').textContent = message;
            errorEl.style.display = 'block';
        }

        /**
         * Submit patient upload
         */
        async function submitPatientUpload() {
            const docType = document.getElementById('upload-doc-type').value;
            const title = document.getElementById('upload-doc-title').value.trim();
            const originalDate = document.getElementById('upload-doc-date').value;

            // Validation
            if (!docType) {
                showUploadError('Pilih jenis dokumen');
                return;
            }
            if (!title) {
                showUploadError('Masukkan judul dokumen');
                return;
            }
            if (!selectedUploadFile) {
                showUploadError('Pilih file untuk diupload');
                return;
            }

            const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
            if (!token) {
                showUploadError('Sesi telah berakhir. Silakan login kembali.');
                return;
            }

            // Show progress
            document.getElementById('upload-error').style.display = 'none';
            document.getElementById('upload-progress').style.display = 'block';
            document.getElementById('upload-submit-btn').disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', selectedUploadFile);
                formData.append('documentType', docType);
                formData.append('title', title);
                if (originalDate) {
                    formData.append('originalDate', originalDate);
                }

                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        document.getElementById('upload-progress-bar').style.width = progress + '%';
                    }
                }, 200);

                const response = await fetch('/api/patient-documents/patient-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                clearInterval(progressInterval);
                document.getElementById('upload-progress-bar').style.width = '100%';

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Upload gagal');
                }

                // Success
                $('#patientUploadModal').modal('hide');
                showToast('Dokumen berhasil diupload!', 'success');
                loadPatientUploads();

            } catch (error) {
                console.error('Upload error:', error);
                showUploadError(error.message || 'Terjadi kesalahan saat upload');
            } finally {
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('upload-progress-bar').style.width = '0%';
                document.getElementById('upload-submit-btn').disabled = false;
            }
        }

        /**
         * Load patient uploads
         */
        async function loadPatientUploads() {
            const container = document.getElementById('patient-uploads-container');
            if (!container) return;

            const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
            if (!token) {
                container.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">Silakan login untuk melihat riwayat</p>';
                return;
            }

            try {
                const response = await fetch('/api/patient-documents/my-uploads', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        container.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">Sesi telah berakhir</p>';
                        return;
                    }
                    throw new Error('Failed to fetch uploads');
                }

                const data = await response.json();

                if (!data.success || !data.documents || data.documents.length === 0) {
                    container.innerHTML = `
                        <div class="documents-empty">
                            <i class="fa fa-cloud-upload" style="color: #a855f7;"></i>
                            <p>Belum ada dokumen yang diupload</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = renderPatientUploadsGrid(data.documents);

            } catch (error) {
                console.error('Error loading patient uploads:', error);
                container.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">Gagal memuat riwayat</p>';
            }
        }

        /**
         * Render patient uploads grid
         */
        function renderPatientUploadsGrid(documents) {
            const cards = documents.map(doc => renderPatientUploadCard(doc)).join('');
            return `<div class="documents-grid">${cards}</div>`;
        }

        /**
         * Render a patient upload card
         */
        function renderPatientUploadCard(doc) {
            const iconClass = getPatientUploadIconClass(doc.document_type);
            const iconName = getPatientUploadIcon(doc.document_type);
            const formattedDate = formatDocumentDate(doc.created_at);
            const originalDateText = doc.original_date ? `<div class="original-date"><i class="fa fa-calendar-check-o"></i> Dokumen asli: ${formatDocumentDate(doc.original_date)}</div>` : '';

            return `
                <div class="patient-upload-card" data-upload-id="${doc.id}">
                    <span class="patient-upload-badge">Riwayat</span>
                    <div class="doc-icon ${iconClass}">
                        <i class="fa ${iconName}"></i>
                    </div>
                    <div class="doc-title">${escapeHtml(doc.title)}</div>
                    <div class="doc-date">
                        <i class="fa fa-clock-o"></i> Diupload: ${formattedDate}
                    </div>
                    ${originalDateText}
                    <div class="doc-actions">
                        <button class="doc-btn view-btn" onclick="viewPatientUpload('${escapeHtml(doc.file_url || '')}', '${escapeHtml(doc.title)}')">
                            <i class="fa fa-eye"></i> Lihat
                        </button>
                        <button class="doc-btn delete-btn" onclick="deletePatientUpload(${doc.id})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function getPatientUploadIconClass(type) {
            const typeMap = {
                'patient_usg': 'patient-usg',
                'patient_lab': 'patient-lab',
                'patient_other': 'patient-other'
            };
            return typeMap[type] || 'patient-other';
        }

        function getPatientUploadIcon(type) {
            const iconMap = {
                'patient_usg': 'fa-heartbeat',
                'patient_lab': 'fa-flask',
                'patient_other': 'fa-file-o'
            };
            return iconMap[type] || 'fa-file-o';
        }

        /**
         * View patient upload
         */
        function viewPatientUpload(fileUrl, title) {
            if (!fileUrl) {
                showToast('File tidak tersedia', 'error');
                return;
            }
            window.open(fileUrl, '_blank');
        }

        /**
         * Delete patient upload
         */
        async function deletePatientUpload(docId) {
            if (!confirm('Apakah Anda yakin ingin menghapus dokumen ini?')) {
                return;
            }

            const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
            if (!token) {
                showToast('Sesi telah berakhir', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/patient-documents/my-uploads/${docId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Gagal menghapus');
                }

                showToast('Dokumen berhasil dihapus', 'success');
                loadPatientUploads();

            } catch (error) {
                console.error('Delete error:', error);
                showToast(error.message || 'Gagal menghapus dokumen', 'error');
            }
        }
    </script>

    <!-- Bubble Animation Script -->
    <script>
        function createBubbles() {
            const bgAnimation = document.getElementById('bgAnimation');
            const bubbleCount = 15;

            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                const size = Math.random() * 60 + 20;
                bubble.style.width = size + 'px';
                bubble.style.height = size + 'px';
                bubble.style.left = Math.random() * 100 + '%';
                bubble.style.top = Math.random() * 100 + '%';
                bubble.style.animationDelay = Math.random() * 8 + 's';
                bubble.style.animationDuration = (Math.random() * 4 + 6) + 's';

                bgAnimation.appendChild(bubble);
            }
        }

        createBubbles();
    </script>

    <!-- Resume Viewer Modal -->
    <div class="modal fade" id="resumeViewerModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;"><i class="fa fa-file-text-o"></i> <span id="resume-modal-title">Resume Medis</span></h4>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div id="resume-loading" style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #28a7e9;"></i>
                        <p style="margin-top: 15px; color: #888;">Memuat resume medis...</p>
                    </div>
                    <div id="resume-content" style="display: none;">
                        <div id="resume-text" style="
                            background: rgba(0,0,0,0.3);
                            padding: 20px;
                            border-radius: 10px;
                            white-space: pre-wrap;
                            font-family: 'Segoe UI', sans-serif;
                            line-height: 1.6;
                            font-size: 14px;
                        "></div>
                    </div>
                    <div id="resume-error" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-exclamation-triangle fa-3x" style="color: #f39c12;"></i>
                        <p style="margin-top: 15px; color: #888;" id="resume-error-text">Gagal memuat resume medis</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040;">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Inbox Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #404040;">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #28a7e9;">
                        <i class="fa fa-bell"></i> Notifikasi & Pengumuman
                        <span id="modal-unread-badge" class="badge badge-danger ml-2" style="display: none;">0</span>
                    </h4>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
                    <div id="notifications-loading" style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin fa-3x" style="color: #28a7e9;"></i>
                        <p style="margin-top: 15px; color: #888;">Memuat notifikasi...</p>
                    </div>
                    <div id="notifications-list" style="display: none;"></div>
                    <div id="notifications-empty" style="display: none; text-align: center; padding: 40px;">
                        <i class="fa fa-inbox fa-3x" style="color: #666;"></i>
                        <p style="margin-top: 15px; color: #888;">Tidak ada notifikasi</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #404040; justify-content: space-between;">
                    <button type="button" class="btn btn-sm" onclick="markAllNotificationsRead()" style="background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #28a7e9;">
                        <i class="fa fa-check-double"></i> Tandai Semua Dibaca
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Upload Modal -->
    <div class="modal fade" id="patientUploadModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); color: #ffffff; border: 1px solid rgba(168,85,247,0.3);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(168,85,247,0.3);">
                    <button type="button" class="close" data-dismiss="modal" style="color: #ffffff; opacity: 0.8;">&times;</button>
                    <h4 class="modal-title" style="color: #a855f7;"><i class="fa fa-cloud-upload"></i> Upload Riwayat Medis</h4>
                </div>
                <div class="modal-body">
                    <form id="patient-upload-form">
                        <div class="form-group">
                            <label style="color: #a855f7;">Jenis Dokumen *</label>
                            <select id="upload-doc-type" class="form-control" required
                                    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                                <option value="">Pilih jenis dokumen...</option>
                                <option value="patient_usg">Hasil USG</option>
                                <option value="patient_lab">Hasil Laboratorium</option>
                                <option value="patient_other">Dokumen Lainnya</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="color: #a855f7;">Judul Dokumen *</label>
                            <input type="text" id="upload-doc-title" class="form-control" required
                                   placeholder="Contoh: USG Trimester 1"
                                   style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                        </div>

                        <div class="form-group">
                            <label style="color: #a855f7;">Tanggal Dokumen Asli</label>
                            <input type="date" id="upload-doc-date" class="form-control"
                                   style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">
                            <small style="color: #888;">Tanggal ketika dokumen asli dibuat (opsional)</small>
                        </div>

                        <div class="form-group">
                            <label style="color: #a855f7;">File Dokumen *</label>
                            <div id="upload-dropzone" style="
                                border: 2px dashed rgba(168,85,247,0.4);
                                border-radius: 10px;
                                padding: 30px;
                                text-align: center;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onclick="document.getElementById('upload-doc-file').click()">
                                <i class="fa fa-cloud-upload fa-3x" style="color: #a855f7; margin-bottom: 10px;"></i>
                                <p style="margin: 0; color: #888;">Klik atau seret file ke sini</p>
                                <small style="color: #666;">Maks. 10MB - Format: JPEG, PNG, PDF</small>
                            </div>
                            <input type="file" id="upload-doc-file" accept="image/jpeg,image/png,application/pdf" style="display: none;">
                            <div id="upload-file-preview" style="display: none; margin-top: 10px; padding: 10px; background: rgba(168,85,247,0.1); border-radius: 8px;">
                                <i class="fa fa-file" style="color: #a855f7;"></i>
                                <span id="upload-file-name" style="margin-left: 8px;"></span>
                                <button type="button" onclick="clearUploadFile()" style="float: right; background: none; border: none; color: #ef4444; cursor: pointer;">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div id="upload-error" style="display: none; margin-bottom: 15px; padding: 10px 15px; background: rgba(239,68,68,0.2); border: 1px solid #ef4444; border-radius: 6px; color: #ff6b6b; font-size: 13px;">
                            <i class="fa fa-exclamation-circle"></i> <span id="upload-error-text"></span>
                        </div>

                        <div id="upload-progress" style="display: none; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div id="upload-progress-bar" style="height: 6px; background: linear-gradient(90deg, #a855f7, #8b5cf6); width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <small style="color: #a855f7; margin-top: 5px; display: block;">Mengupload...</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(168,85,247,0.3);">
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: #ffffff;">Batal</button>
                    <button type="button" id="upload-submit-btn" onclick="submitPatientUpload()"
                            style="background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%); border: none; color: #ffffff; padding: 8px 20px; border-radius: 5px;">
                        <i class="fa fa-upload"></i> Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Notifications Script -->
    <script>
        // Notification variables
        let patientNotifications = [];
        const NOTIF_API = '/api/patient-notifications';

        // Initialize notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationBadge();
            // Poll for notifications every 60 seconds
            setInterval(updateNotificationBadge, 60000);
        });

        // Update notification badge count
        async function updateNotificationBadge() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                if (!token) return;

                const response = await fetch(NOTIF_API + '/count', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) return;

                const data = await response.json();
                const badge = document.getElementById('notification-badge');
                const modalBadge = document.getElementById('modal-unread-badge');

                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                if (modalBadge) {
                    if (data.count > 0) {
                        modalBadge.textContent = data.count + ' baru';
                        modalBadge.style.display = 'inline-block';
                    } else {
                        modalBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // Open notifications inbox modal
        function openNotificationsInbox() {
            $('#notificationsModal').modal('show');
            loadNotifications();
        }

        // Load notifications
        async function loadNotifications() {
            const loadingEl = document.getElementById('notifications-loading');
            const listEl = document.getElementById('notifications-list');
            const emptyEl = document.getElementById('notifications-empty');

            loadingEl.style.display = 'block';
            listEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(NOTIF_API + '/with-announcements?limit=30', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) throw new Error('Failed to load notifications');

                const data = await response.json();
                patientNotifications = data.items || [];

                loadingEl.style.display = 'none';

                if (patientNotifications.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                renderNotifications();
                listEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading notifications:', error);
                loadingEl.innerHTML = '<p style="color: #dc3545; padding: 20px;">Gagal memuat notifikasi</p>';
            }
        }

        // Render notifications list
        function renderNotifications() {
            const listEl = document.getElementById('notifications-list');

            const html = patientNotifications.map(n => {
                const timeAgo = formatNotifTimeAgo(n.created_at);
                // For announcements, check localStorage; for notifications, use is_read from API
                const isUnread = n.source === 'announcement' ? !isAnnouncementRead(n.id) : !n.is_read;
                const iconClass = n.icon || 'fa fa-bell';
                const iconColor = n.icon_color || 'text-primary';

                // Type-specific styling
                let typeBadge = '';
                if (n.type === 'appointment') {
                    typeBadge = '<span class="badge badge-success" style="font-size: 10px;"><i class="fa fa-calendar-check"></i> Appointment</span>';
                } else if (n.type === 'document') {
                    typeBadge = '<span class="badge badge-info" style="font-size: 10px;"><i class="fa fa-file"></i> Dokumen</span>';
                } else if (n.source === 'announcement') {
                    typeBadge = '<span class="badge badge-warning" style="font-size: 10px;"><i class="fa fa-bullhorn"></i> Pengumuman</span>';
                }

                return '<div class="notification-item ' + (isUnread ? 'unread' : '') + '" data-id="' + n.id + '" data-source="' + n.source + '" data-type="' + (n.type || '') + '" onclick="handleNotifClick(' + n.id + ', \'' + n.source + '\', \'' + (n.type || '') + '\')">' +
                    '<div style="display: flex; align-items: flex-start; gap: 12px;">' +
                        '<div class="notif-icon ' + iconColor + '">' +
                            '<i class="' + iconClass + '"></i>' +
                        '</div>' +
                        '<div style="flex: 1; min-width: 0;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: flex-start;">' +
                                '<div class="notif-title">' + escapeHtml(n.title) + '</div>' +
                                '<span class="notif-time">' + timeAgo + '</span>' +
                            '</div>' +
                            '<p class="notif-message">' + escapeHtml(truncateText(n.message, 120)) + '</p>' +
                            '<div style="margin-top: 5px;">' + typeBadge + (isUnread ? ' <span class="badge badge-primary" style="font-size: 10px;">Baru</span>' : '') + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');

            listEl.innerHTML = html;
        }

        // Handle notification click
        async function handleNotifClick(id, source, type) {
            if (source === 'notification') {
                try {
                    const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                    await fetch(NOTIF_API + '/' + id + '/read', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    // Update UI
                    const item = document.querySelector('.notification-item[data-id="' + id + '"][data-source="notification"]');
                    if (item) {
                        item.classList.remove('unread');
                        const newBadge = item.querySelector('.badge-primary');
                        if (newBadge) newBadge.remove();
                    }
                    updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            // Navigate to relevant section based on notification type
            if (type === 'document') {
                // Close notifications modal (Bootstrap modal)
                $('#notificationsModal').modal('hide');

                // Wait for modal to close, then scroll
                setTimeout(() => {
                    // Expand documents section if collapsed
                    const content = document.getElementById('documents-content');
                    if (content && content.classList.contains('collapsed')) {
                        toggleCard('documents');
                    }

                    // Scroll to documents section
                    const section = document.getElementById('documents-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Add highlight effect
                        section.style.boxShadow = '0 0 20px rgba(40, 167, 233, 0.5)';
                        setTimeout(() => {
                            section.style.boxShadow = '';
                        }, 2000);
                    }
                }, 300);
            } else if (type === 'appointment') {
                // Close notifications modal (Bootstrap modal)
                $('#notificationsModal').modal('hide');

                setTimeout(() => {
                    // Expand hospital booking section if collapsed
                    const content = document.getElementById('hospital-booking-content');
                    if (content && content.classList.contains('collapsed')) {
                        toggleCard('hospital-booking');
                    }

                    // Scroll to hospital booking section
                    const section = document.getElementById('hospital-booking-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        section.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
                        setTimeout(() => {
                            section.style.boxShadow = '';
                        }, 2000);
                    }
                }, 300);
            } else if (source === 'announcement') {
                // Mark announcement as read in localStorage
                markAnnouncementRead(id);

                // Update UI - remove unread styling
                const item = document.querySelector('.notification-item[data-id="' + id + '"][data-source="announcement"]');
                if (item) {
                    item.classList.remove('unread');
                    const newBadge = item.querySelector('.badge-primary');
                    if (newBadge) newBadge.remove();
                }

                // Close notifications modal (Bootstrap modal)
                $('#notificationsModal').modal('hide');

                setTimeout(() => {
                    // Expand announcements section if collapsed
                    const content = document.getElementById('announcements-content');
                    if (content && content.classList.contains('collapsed')) {
                        toggleAnnouncementsSection();
                    }

                    // Scroll to announcements section
                    const section = document.getElementById('announcements-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        section.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
                        setTimeout(() => {
                            section.style.boxShadow = '';
                        }, 2000);
                    }
                }, 300);
            }
        }

        // Track read announcements in localStorage
        function getReadAnnouncements() {
            try {
                return JSON.parse(localStorage.getItem('read_announcements') || '[]');
            } catch (e) {
                return [];
            }
        }

        function markAnnouncementRead(announcementId) {
            const readAnnouncements = getReadAnnouncements();
            if (!readAnnouncements.includes(announcementId)) {
                readAnnouncements.push(announcementId);
                localStorage.setItem('read_announcements', JSON.stringify(readAnnouncements));
            }
        }

        function isAnnouncementRead(announcementId) {
            return getReadAnnouncements().includes(announcementId);
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token') || localStorage.getItem('patient_token');
                const response = await fetch(NOTIF_API + '/read-all', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) throw new Error('Failed');

                // Update UI
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    const newBadge = item.querySelector('.badge-primary');
                    if (newBadge) newBadge.remove();
                });
                updateNotificationBadge();
                showToast('Semua notifikasi ditandai sudah dibaca');
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        // Format time ago
        function formatNotifTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Baru saja';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' menit lalu';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' jam lalu';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' hari lalu';

            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short'
            });
        }

        // Truncate text
        function truncateText(text, maxLen) {
            if (!text) return '';
            if (text.length <= maxLen) return text;
            return text.substring(0, maxLen) + '...';
        }

        // Birth Photo Modal Functions
        function openBirthPhotoModal() {
            const photoImg = document.getElementById('birth-photo');
            if (!photoImg || !photoImg.src) return;

            const modalImg = document.getElementById('birth-photo-modal-img');
            modalImg.src = photoImg.src;
            document.getElementById('birth-photo-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeBirthPhotoModal() {
            document.getElementById('birth-photo-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBirthPhotoModal();
            }
        });
    </script>

    <!-- Birth Photo Modal -->
    <div id="birth-photo-modal" onclick="closeBirthPhotoModal()" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    ">
        <button onclick="closeBirthPhotoModal()" style="
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10000;
        ">&times;</button>
        <img id="birth-photo-modal-img" src="" alt="Foto Kelahiran" onclick="event.stopPropagation()" style="
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        " />
    </div>
</body>
</html>
