<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>dokterDIBYA | Administrator</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/staff/public/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/staff/public/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/staff/public/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/staff/public/android-chrome-512x512.png">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/staff/public/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Staff Panel">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Dokter Dibya Staff">
    <meta name="msapplication-TileColor" content="#0d6efd">
    <meta name="msapplication-TileImage" content="/staff/public/icons/icon-144x144.png">

    <!-- Error Handler (load first) -->
    <script src="scripts/error-handler.js"></script>

    <!-- Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font & Icons (Font Awesome 5) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <!-- AdminLTE 3 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <style>
        /* ========================================
           DESIGN SYSTEM - CSS VARIABLES
           ======================================== */
        :root {
            /* Color Palette */
            --color-primary: #0d6efd;
            --color-primary-hover: #0b5ed7;
            --color-success: #28a745;
            --color-success-hover: #218838;
            --color-info: #17a2b8;
            --color-info-hover: #117a8b;
            --color-warning: #ffc107;
            --color-warning-hover: #e0a800;
            --color-danger: #dc3545;
            --color-danger-hover: #c82333;

            --color-dark: #343a40;
            --color-secondary: #6c757d;
            --color-light: #f8f9fa;
            --color-white: #ffffff;
            --color-text: #333333;
            --color-text-muted: #6c757d;
            --color-bg-body: #f4f6f9;

            /* Spacing Scale (Bootstrap-aligned) */
            --spacing-0: 0;
            --spacing-1: 0.25rem;  /* 4px */
            --spacing-2: 0.5rem;   /* 8px */
            --spacing-3: 1rem;     /* 16px */
            --spacing-4: 1.5rem;   /* 24px */
            --spacing-5: 3rem;     /* 48px */

            /* Typography */
            --font-family-base: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-xs: 0.65rem;   /* 10.4px */
            --font-size-sm: 0.75rem;   /* 12px */
            --font-size-base: 0.875rem; /* 14px */
            --font-size-md: 1rem;      /* 16px */
            --font-size-lg: 1.25rem;   /* 20px */
            --font-size-xl: 1.5rem;    /* 24px */
            --font-size-2xl: 1.75rem;  /* 28px */
            --font-size-3xl: 2rem;     /* 32px */

            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 6px 18px rgba(0, 0, 0, 0.15);
            --shadow-hover: 0 6px 20px rgba(0, 0, 0, 0.18);

            /* Border Radius */
            --radius-sm: 0.25rem;  /* 4px */
            --radius-md: 0.35rem;  /* 5.6px */
            --radius-lg: 0.5rem;   /* 8px */
            --radius-xl: 0.75rem;  /* 12px */

            /* Transitions */
            --transition-fast: 140ms ease;
            --transition-base: 180ms ease;
            --transition-slow: 220ms ease;
            --transition-card: 200ms ease;
        }

        /* Apply Poppins font globally */
        body, .sidebar, .main-sidebar, .content-wrapper, .card, .btn, .nav-link, .brand-text, h1, h2, h3, h4, h5, h6, p, span, div, a, input, select, textarea, table, th, td, .small-box, .info-box {
            font-family: var(--font-family-base) !important;
        }

        /* Submenu bullet icons - smaller circles */
        .sidebar .nav-treeview .nav-link i.fas.fa-circle.nav-icon,
        .nav-sidebar .nav-treeview .nav-link i.fa-circle {
            font-size: 9px !important;
            width: 1rem !important;
            margin-left: 1.3rem !important;
            margin-right: 0.5rem !important;
            text-align: center !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            vertical-align: middle !important;
        }

        /* ========================================
           TERAPI ITEMS LIST (Planning Section)
           ======================================== */
        .terapi-item {
            background-color: #f8f9fa;
            transition: background-color 0.15s ease;
        }
        .terapi-item:hover {
            background-color: #e9ecef;
        }
        .terapi-item .terapi-delete-btn {
            opacity: 0.5;
            transition: opacity 0.15s ease;
        }
        .terapi-item:hover .terapi-delete-btn {
            opacity: 1;
        }
        #terapi-items-container {
            max-height: 200px;
            overflow-y: auto;
        }

        /* ========================================
           STICKY MODAL FOOTER (Planning Modals)
           ======================================== */
        #tindakan-modal .modal-content,
        #terapi-modal .modal-content,
        #cara-pakai-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }
        #tindakan-modal .modal-body,
        #terapi-modal .modal-body,
        #cara-pakai-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: none !important;
        }
        #tindakan-modal .modal-footer,
        #terapi-modal .modal-footer,
        #cara-pakai-modal .modal-footer {
            flex-shrink: 0;
            border-top: 1px solid #dee2e6;
            background: #fff;
        }

        /* ========================================
           STANDARDIZED HEADING HIERARCHY
           ======================================== */
        #page-title,
        .page-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin: 0;
            line-height: 1.3;
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--spacing-3);
        }

        .subsection-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            margin-bottom: var(--spacing-2);
        }

        /* ========================================
           STANDARDIZED CARD STYLES
           ======================================== */
        .card {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition-card), transform var(--transition-card);
            border: none;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        /* Card Header Standardization */
        .card-header {
            padding: var(--spacing-3) var(--spacing-3);
            background-color: var(--color-white);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }

        .card-header.compact {
            padding: var(--spacing-2) var(--spacing-3);
        }

        .card-header .card-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        /* Card Body Standardization */
        .card-body {
            padding: var(--spacing-3);
        }

        .card-body.compact {
            padding: var(--spacing-2);
        }

        .card-body.no-padding {
            padding: 0;
        }

        /* Card Footer Standardization */
        .card-footer {
            padding: var(--spacing-3);
            background-color: var(--color-light);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        /* ========================================
           STANDARDIZED BUTTON STYLES
           ======================================== */
        .btn {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            border: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-sm {
            font-size: var(--font-size-sm);
            padding: var(--spacing-1) var(--spacing-2);
        }

        .btn-lg {
            font-size: var(--font-size-md);
            padding: var(--spacing-3) var(--spacing-4);
        }

        .btn-xs {
            font-size: var(--font-size-xs);
            padding: 0.15rem var(--spacing-2);
        }

        /* ========================================
           STANDARDIZED FORM STYLES
           ======================================== */
        .form-control,
        .custom-select,
        select.form-control,
        textarea.form-control {
            font-size: var(--font-size-base);
            border-radius: var(--radius-md);
            border: 1px solid #ced4da;
            transition: box-shadow var(--transition-base), border-color var(--transition-base), background-color var(--transition-base);
        }

        .form-control:focus,
        .custom-select:focus,
        select.form-control:focus,
        textarea.form-control:focus {
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.2);
            border-color: var(--color-primary);
        }

        .form-control-sm {
            font-size: var(--font-size-sm);
            padding: var(--spacing-1) var(--spacing-2);
        }

        .form-label,
        label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
            margin-bottom: var(--spacing-1);
        }

        .form-label.required::after {
            content: " *";
            color: var(--color-danger);
        }

        /* ========================================
           STANDARDIZED MODAL STYLES
           ======================================== */
        .modal-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, rgba(13, 110, 253, 0.9) 100%);
            color: var(--color-white);
            padding: var(--spacing-3) var(--spacing-4);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .modal-header .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }

        .modal-header .close {
            color: var(--color-white);
            opacity: 0.8;
            text-shadow: none;
        }

        .modal-header .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: var(--spacing-4);
        }

        .modal-footer {
            padding: var(--spacing-3) var(--spacing-4);
            background-color: var(--color-light);
        }

        /* Modal Header Variants */
        .modal-header.bg-success {
            background: linear-gradient(135deg, var(--color-success) 0%, rgba(40, 167, 69, 0.9) 100%);
        }

        .modal-header.bg-warning {
            background: linear-gradient(135deg, var(--color-warning) 0%, rgba(255, 193, 7, 0.9) 100%);
            color: var(--color-dark);
        }

        .modal-header.bg-warning .close {
            color: var(--color-dark);
        }

        .modal-header.bg-danger {
            background: linear-gradient(135deg, var(--color-danger) 0%, rgba(220, 53, 69, 0.9) 100%);
        }

        .modal-header.bg-info {
            background: linear-gradient(135deg, var(--color-info) 0%, rgba(23, 162, 184, 0.9) 100%);
        }

        /* ========================================
           UTILITY CLASSES
           ======================================== */
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }

        .text-xs { font-size: var(--font-size-xs); }
        .text-sm { font-size: var(--font-size-sm); }
        .text-base { font-size: var(--font-size-base); }
        .text-md { font-size: var(--font-size-md); }
        .text-lg { font-size: var(--font-size-lg); }
        .text-xl { font-size: var(--font-size-xl); }
        .text-2xl { font-size: var(--font-size-2xl); }

        .font-light { font-weight: var(--font-weight-light); }
        .font-normal { font-weight: var(--font-weight-normal); }
        .font-medium { font-weight: var(--font-weight-medium); }
        .font-semibold { font-weight: var(--font-weight-semibold); }
        .font-bold { font-weight: var(--font-weight-bold); }

        /* ========================================
           STANDARDIZED TABLE STYLES (All Tables)
           ======================================== */
        .table td,
        .table th {
            font-size: var(--font-size-sm) !important;
            padding: 0.4rem 0.5rem !important;
            vertical-align: middle !important;
        }

        .table thead th {
            font-weight: var(--font-weight-semibold) !important;
        }

        .table .badge {
            font-size: 0.7rem !important;
        }

        .table .btn-sm,
        .table .btn-xs {
            padding: 0.2rem 0.4rem !important;
            font-size: 0.7rem !important;
        }

        /* ========================================
           STANDARDIZED CARD/INFO-BOX STYLES
           ======================================== */
        /* Booking Settings Cards */
        #booking-settings-page .info-box-text {
            font-size: var(--font-size-sm) !important;
        }
        #booking-settings-page .info-box-number {
            font-size: 0.9rem !important;
        }
        #booking-settings-page .card-body h4 {
            font-size: 1.1rem !important;
        }
        #booking-settings-page .card-body p,
        #booking-settings-page .card-body small {
            font-size: var(--font-size-sm) !important;
        }
        #booking-settings-page .card-title {
            font-size: 0.9rem !important;
        }
        #booking-settings-page .card-footer .btn {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
        }

        /* Notifications Page - Staff Announcements */
        #notifications-page .staff-announcement-item,
        #staff-announcements-list {
            font-size: var(--font-size-sm) !important;
        }
        #staff-announcements-list h5,
        #staff-announcements-list h6 {
            font-size: 0.85rem !important;
        }
        #staff-announcements-list p,
        #staff-announcements-list div,
        #staff-announcements-list span {
            font-size: var(--font-size-sm) !important;
        }
        #staff-announcements-list .badge {
            font-size: 0.65rem !important;
        }

        /* Kelola Import Fields (embedded) */
        #import-fields-page .field-name {
            font-size: 0.85rem !important;
        }
        #import-fields-page .field-type,
        #import-fields-page .field-row small {
            font-size: 0.7rem !important;
        }
        #import-fields-page .keyword-tag {
            font-size: 0.7rem !important;
            padding: 2px 8px !important;
        }
        #import-fields-page .add-keyword-input input {
            font-size: 0.7rem !important;
            width: 100px !important;
        }
        #import-fields-page .btn-icon {
            font-size: 0.7rem !important;
            padding: 3px 8px !important;
        }
        #import-fields-page .section-card .card-header {
            font-size: 0.85rem !important;
            padding: 0.5rem 0.75rem !important;
        }
        #import-fields-page .alert {
            font-size: var(--font-size-sm) !important;
            padding: 0.5rem 0.75rem !important;
        }

        /* Smaller sidebar navigation font */
        .sidebar .nav-sidebar .nav-link {
            font-size: 14px !important;
        }

        .sidebar .nav-sidebar .nav-link .nav-icon {
            font-size: 14px !important;
        }

        /* Tighter vertical spacing for sidebar menu items */
        .sidebar .nav-sidebar .nav-item {
            margin-bottom: 0 !important;
        }

        .sidebar .nav-sidebar .nav-link {
            padding-top: 0.4rem !important;
            padding-bottom: 0.4rem !important;
            padding-left: 6px !important;
        }

        /* Sidebar color and width */
        .main-sidebar {
            background-color: #FAFAFA !important;
        }

        /* Sidebar width when expanded */
        body:not(.sidebar-collapse) .main-sidebar {
            width: 210px !important; /* Default 250px - 40px (5 spasi) */
        }

        /* Sidebar width when collapsed */
        body.sidebar-collapse .main-sidebar {
            width: 4.6rem !important; /* AdminLTE default collapsed width */
        }

        .main-sidebar .brand-link { background-color: #FAFAFA !important; }
        .sidebar-logo {
            background-color: #FAFAFA;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden; /* Keep logo within bounds */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px; /* Reduced from 130px */
            padding: 0.5rem 0.5rem; /* Reduced vertical padding */
        }

        /* Logo sizing */
        .sidebar-logo img {
            max-height: 60px; /* Reduced from 112px */
            max-width: 100%; /* Prevent overflow */
            width: auto;
            height: auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            display: block;
            will-change: transform; /* Optimize for animation */
        }

        /* Subtle hover feedback for admin logo */
        .sidebar-logo img:hover {
            transform: scale(1.1);
        }

        /* Logo when sidebar collapsed - shrink to fit with smooth scale */
        body.sidebar-collapse .sidebar-logo {
            min-height: 60px; /* Reduced from 95px */
            padding: 0.25rem;
        }

        body.sidebar-collapse .sidebar-logo img {
            max-height: 50px; /* Reduced from 78px */
            max-width: 50px;
        }
        
        /* Adjust content area to match sidebar width when expanded */
        body:not(.sidebar-collapse) .content-wrapper,
        body:not(.sidebar-collapse) .main-footer,
        body:not(.sidebar-collapse) .main-header {
            margin-left: 210px !important;
        }
        
        /* Adjust content area when sidebar collapsed */
        body.sidebar-collapse .content-wrapper,
        body.sidebar-collapse .main-footer,
        body.sidebar-collapse .main-header {
            margin-left: 4.6rem !important;
        }

        /* Default (not selected) link/icon color */
        .sidebar .nav-sidebar .nav-link { color: #000000 !important; }
        .sidebar .nav-sidebar .nav-link .nav-icon { color: #000000 !important; }

        /* Hover */
        .sidebar .nav-sidebar .nav-link:hover { background-color: rgba(0,0,0,0.08) !important; color: #000000 !important; }
        .sidebar .nav-sidebar .nav-link:hover .nav-icon { color: #000000 !important; }

        /* Active (selected) */
        .sidebar .nav-sidebar .nav-link.active { background-color: #0d6efd !important; color: #fff !important; }
        .sidebar .nav-sidebar .nav-link.active .nav-icon { color: #fff !important; }

        /* Nav section headers */
        .sidebar .nav-header { color: rgba(0,0,0,0.6) !important; }
        
        /* Hide sidebar scrollbar */
        .main-sidebar,
        .main-sidebar .sidebar,
        .sidebar-mini .main-sidebar { 
            overflow-y: auto !important;
            scrollbar-width: none !important; /* Firefox */
            -ms-overflow-style: none !important; /* IE and Edge */
        }
        .main-sidebar::-webkit-scrollbar,
        .main-sidebar .sidebar::-webkit-scrollbar,
        .sidebar-mini .main-sidebar::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
            display: none !important; /* Chrome, Safari, Opera */
        }
        .main-sidebar:hover::-webkit-scrollbar,
        .main-sidebar .sidebar:hover::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
            display: none !important;
        }
        
        /* Obstetri fields fixed width */
        .obstetri-field { max-width: 260px; }
        .obstetri-label { min-width: 140px; max-width: 140px; }
        /* Reduce all dropdown (select) vertical height ~20% */
        select.form-control, select.form-control-sm {
            padding-top: .2rem !important; /* default ~.25rem */
            padding-bottom: .2rem !important;
        }
        /* Fix DataTables length select - single dropdown arrow */
        .dataTables_length select {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.5rem center !important;
            background-size: 10px !important;
            padding-right: 1.75rem !important;
        }

        /* Modern micro-interactions */
        html { scroll-behavior: smooth; }

        /* Smooth reveal for obstetri section */
        #quick-preg-section { opacity: 0; transform: translateY(-6px); transition: opacity 220ms ease, transform 220ms ease; }
        #quick-preg-section.reveal { opacity: 1; transform: none; }
        /* Compact labels to align neatly */
        .small.text-muted { line-height: 1.2; }
        /* Align auxiliary textareas with dropdown left edge */
        .align-with-dropdown { margin-left: calc(140px + 16px); }
        .obstetri-textarea { max-width: 620px; }
        
        /* Compact styling for online users panel */
        #online-users-panel .card {
            border-radius: 0.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            font-size: 0.85rem;
        }

        #online-users-panel .card-header {
            padding: 0.4rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #online-users-panel .card-title {
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        #online-users-panel .badge {
            font-size: 0.75rem;
            padding: 0.3rem 0.55rem;
        }

        #online-users-panel .card-body {
            max-height: 220px;
            overflow-y: auto;
        }

        #online-users-panel .list-group-item {
            padding: 0.5rem 0.75rem;
            background-color: transparent;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .custom-toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            margin-bottom: 10px;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .custom-toast.fade-out {
            animation: slideOutRight 0.3s ease-out forwards;
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .custom-toast .toast-header {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            font-weight: 600;
        }
        
        .custom-toast.toast-success .toast-header {
            background-color: #28a745;
            color: white;
        }
        
        .custom-toast.toast-error .toast-header {
            background-color: #dc3545;
            color: white;
        }
        
        .custom-toast.toast-warning .toast-header {
            background-color: #ffc107;
            color: #212529;
        }
        
        .custom-toast.toast-info .toast-header {
            background-color: #17a2b8;
            color: white;
        }
        
        .custom-toast .toast-header .close {
            color: inherit;
            opacity: 0.8;
        }
        
        .custom-toast .toast-header .close:hover {
            opacity: 1;
        }
        
        /* Fix for appointments page not showing - force display */
        #appointments-page {
            width: 100% !important;
            min-height: 100px !important;
        }
        
        #appointments-page.d-none {
            display: none !important;
        }
        
        #appointments-page:not(.d-none) {
            display: block !important;
        }
        
        /* Online Users Panel Styles */
        #online-users-panel .card {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #online-users-panel .list-group-item {
            border-left: 0;
            border-right: 0;
            padding: 8px 12px;
            font-size: 0.875rem;
        }
        
        #online-users-panel .list-group-item:first-child {
            border-top: 0;
        }
        
        .user-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .user-status-online {
            background-color: #28a745;
            box-shadow: 0 0 4px rgba(40, 167, 69, 0.6);
        }
        
        .user-activity {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .user-activity-icon {
            margin-right: 4px;
            font-size: 0.7rem;
        }
        
        #online-users-panel .badge {
            font-size: 0.7rem;
            padding: 2px 6px;
        }
        
        /* Floating Kelola Pasien Panel */
        #floating-kelola-pasien {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100vw !important;
            z-index: 1040 !important;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            max-height: 50vh;
            overflow-y: auto;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        #floating-kelola-pasien.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        #floating-kelola-pasien .card {
            margin-bottom: 0;
            border-radius: 0;
        }
        
        #floating-kelola-pasien .card-header {
            cursor: pointer;
            user-select: none;
        }
        
        #floating-kelola-pasien .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        #floating-kelola-pasien.collapsed .toggle-icon {
            transform: rotate(180deg);
        }
        
        /* Adjust main content for floating panel */
        body:not(.sidebar-collapse) .content-wrapper {
            padding-bottom: 60px;
        }
        
        /* Hide on mobile */
        @media (max-width: 768px) {
            #floating-kelola-pasien {
                display: none;
            }
        }
        
        /* Finance Analysis Styles */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Remove blue outline/border on profile dropdown */
        .navbar-nav .nav-item.dropdown .nav-link:focus,
        .navbar-nav .nav-item.dropdown .nav-link:active,
        .navbar-nav .nav-item.dropdown .nav-link {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* Avatar hover animation */
        #navbar-user-avatar {
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        #navbar-user-avatar:hover {
            transform: scale(1.1);
        }

        /* Announcement card font size - increased by 30% from previous size */
        .announcement-card .card-body {
            font-size: 0.78rem !important;
        }

        .announcement-card .card-title {
            font-size: 1.17rem !important;
        }

        .announcement-card .announcement-preview {
            font-size: 0.78rem !important;
        }

        .announcement-card .btn-sm {
            font-size: 0.65rem !important;
        }

        .announcement-card small {
            font-size: 0.65rem !important;
        }

        /* Prevent announcement images from overflowing */
        .announcement-card img,
        .announcement-preview img {
            max-width: 100% !important;
            height: auto !important;
            object-fit: contain !important;
        }

        /* Chat popup position - consistent across pages */
        #chat-popup-container {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            z-index: 9999 !important;
        }

        /* Notification Badge Styles */
        #notification-dropdown .nav-link {
            color: #555;
            transition: color 0.2s ease;
        }

        #notification-dropdown .nav-link:hover {
            color: #007bff;
        }

        #notification-badge {
            animation: none;
        }

        @keyframes notification-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .notification-pulse {
            animation: notification-pulse 0.5s ease-in-out 2;
        }

        #notification-dropdown .dropdown-menu {
            min-width: 320px;
            padding: 0;
        }

        #notification-dropdown .dropdown-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        #notification-dropdown .dropdown-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            white-space: normal;
        }

        #notification-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }

        #notification-dropdown .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        #notification-dropdown .dropdown-item.bg-light {
            background-color: #e8f4ff !important;
        }

        #notification-dropdown .dropdown-footer {
            background-color: #f8f9fa;
            color: #007bff;
            font-weight: 500;
        }

        #notification-dropdown .dropdown-footer:hover {
            background-color: #e9ecef;
        }

        /* Highlight flash for announcements */
        @keyframes highlight-flash {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeeba; }
            100% { background-color: transparent; }
        }
        .highlight-flash {
            animation: highlight-flash 2s ease-out;
        }

        /* Notification Message Markdown Styles */
        .notification-message {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .notification-message h1,
        .notification-message h2,
        .notification-message h3,
        .notification-message h4,
        .notification-message h5,
        .notification-message h6 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            color: #333;
        }
        .notification-message p {
            margin: 0 0 0.5rem 0;
        }
        .notification-message strong {
            font-weight: 600;
        }
        .notification-message em {
            font-style: italic;
        }
        .notification-message ul,
        .notification-message ol {
            margin: 0 0 0.5rem 1.5rem;
            padding: 0;
        }
        .notification-message li {
            margin-bottom: 0.25rem;
        }
        .notification-message code {
            background: #f4f4f4;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.85em;
        }
        .notification-message a {
            color: #007bff;
            text-decoration: underline;
        }

        /* MEDIFY Review Section Styles */
        #review-container .patient-card {
            transition: box-shadow 0.2s ease;
            margin-bottom: 0.5rem;
        }
        #review-container .patient-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #review-container .patient-card .card-header {
            border-bottom: none;
            padding: 0.5rem 1rem;
        }
        #review-container .patient-card .card-body {
            border-top: 1px solid #ddd;
        }
        #review-container .patient-card .doc-icons i {
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        #review-container .usg-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #review-container .usg-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #review-container .resume-preview {
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 11px;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
        }
    </style>

        <!-- Mobile Responsive Styles -->
        <link rel="stylesheet" href="styles/mobile-responsive.css?v=3.0.0">
    
    <!-- Mobile App Mode Detection -->
    <script>
        // Detect ?mobile=1 parameter and add mobile-app-mode class
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isMobileApp = urlParams.get('mobile') === '1';

            if (isMobileApp) {
                // Add class immediately to prevent flash
                document.documentElement.classList.add('mobile-app-mode');

                // Also add to body when ready
                if (document.body) {
                    document.body.classList.add('mobile-app-mode');
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.classList.add('mobile-app-mode');
                    });
                }

                // Store in sessionStorage to persist across page navigations
                sessionStorage.setItem('mobileAppMode', '1');
            } else if (sessionStorage.getItem('mobileAppMode') === '1') {
                // Restore mobile mode from session
                document.documentElement.classList.add('mobile-app-mode');
                if (document.body) {
                    document.body.classList.add('mobile-app-mode');
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        document.body.classList.add('mobile-app-mode');
                    });
                }
            }

            // Global helper to check mobile mode and build URLs
            window.isMobileAppMode = function() {
                return sessionStorage.getItem('mobileAppMode') === '1' ||
                       document.body.classList.contains('mobile-app-mode');
            };

            // Helper to add mobile=1 to URL if in mobile mode
            window.buildMobileUrl = function(baseUrl) {
                if (!window.isMobileAppMode()) return baseUrl;
                const separator = baseUrl.includes('?') ? '&' : '?';
                return baseUrl + separator + 'mobile=1';
            };

        })();
    </script>

    <!-- Global Debug Function for Appointments - DISABLED -->
    <script>
        // Set up debug function immediately in head (before DOM loads)
        (function() {
            window.debugAppointments_DISABLED = function() {
                console.log('[DEBUG] ===== APPOINTMENTS DEBUG (Global) =====');
                
                // Basic checks that don't require the module
                const btn = document.getElementById('btn-add-appointment');
                const modal = document.getElementById('appointment-modal');
                const appointmentsPage = document.getElementById('appointments-page');
                
                console.log('[DEBUG] Basic DOM checks:');
                console.log('  - Button exists?', !!btn);
                console.log('  - Modal exists?', !!modal);
                console.log('  - Appointments page exists?', !!appointmentsPage);
                console.log('  - Appointments page visible?', appointmentsPage && !appointmentsPage.classList.contains('d-none'));
                console.log('  - window.openNewAppointment type:', typeof window.openNewAppointment);
                console.log('  - jQuery available?', typeof $ !== 'undefined');
                console.log('  - Bootstrap modal available?', typeof $ !== 'undefined' && $.fn.modal);
                
                if (btn) {
                    console.log('[DEBUG] Button details:');
                    console.log('  - ID:', btn.id);
                    console.log('  - Text:', btn.textContent);
                    console.log('  - onclick:', btn.onclick);
                    console.log('  - parent:', btn.parentNode);
                    console.log('  - disabled?', btn.disabled);
                    console.log('  - style.display:', btn.style.display);
                    console.log('  - style.visibility:', btn.style.visibility);
                    if (window.getComputedStyle) {
                        console.log('  - computed style:', window.getComputedStyle(btn).display);
                    }
                    
                    // If button has no onclick handler, attach one directly
                    if (!btn.onclick && typeof $ !== 'undefined' && $.fn.modal && modal) {
                        console.log('[DEBUG] Button has no onclick handler - attaching direct handler...');
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('[DEBUG] Button clicked via direct handler');
                            
                            // Try to use window.openNewAppointment if available
                            if (typeof window.openNewAppointment === 'function') {
                                console.log('[DEBUG] Using window.openNewAppointment');
                                window.openNewAppointment();
                            } else {
                                // Fallback: open modal directly
                                console.log('[DEBUG] Opening modal directly as fallback');
                                try {
                                    // Reset form
                                    const idInput = document.getElementById('appointment-id');
                                    const titleEl = document.getElementById('appointment-modal-title');
                                    const patientSelect = document.getElementById('appointment-patient-select');
                                    const dateInput = document.getElementById('appointment-date');
                                    const timeInput = document.getElementById('appointment-time');
                                    const typeInput = document.getElementById('appointment-type');
                                    const notesInput = document.getElementById('appointment-notes');
                                    
                                    if (idInput) idInput.value = '';
                                    if (titleEl) titleEl.innerHTML = '<i class="fas fa-calendar-plus mr-2"></i>Tambah Appointment Baru';
                                    if (patientSelect) patientSelect.innerHTML = '<option value="">Memuat pasien...</option>';
                                    if (dateInput) {
                                        const today = new Date().toISOString().split('T')[0];
                                        dateInput.value = today;
                                    }
                                    if (timeInput) timeInput.value = '09:00';
                                    if (typeInput) typeInput.value = 'Konsultasi';
                                    if (notesInput) notesInput.value = '';
                                    
                                    // Show modal
                                    $('#appointment-modal').modal('show');
                                } catch (err) {
                                    console.error('[DEBUG] Error opening modal:', err);
                                }
                            }
                        });
                        console.log('[DEBUG] Direct click handler attached to button');
                    }
                }
                
                // If the module is loaded, try to call openNewAppointment
                if (typeof window.openNewAppointment === 'function') {
                    console.log('[DEBUG] Module appears to be loaded (window.openNewAppointment exists)');
                    console.log('[DEBUG] Attempting to manually trigger modal...');
                    try {
                        window.openNewAppointment();
                    } catch (err) {
                        console.error('[DEBUG] Error calling openNewAppointment:', err);
                    }
                } else {
                    console.warn('[DEBUG] Appointments module not loaded yet');
                    console.warn('[DEBUG] window.openNewAppointment is not a function');
                    
                    // Try to manually open the modal as a fallback
                    if (modal && typeof $ !== 'undefined' && $.fn.modal) {
                        console.log('[DEBUG] Attempting to open modal manually using jQuery/Bootstrap...');
                        try {
                            // Reset form
                            const idInput = document.getElementById('appointment-id');
                            const titleEl = document.getElementById('appointment-modal-title');
                            const patientSelect = document.getElementById('appointment-patient-select');
                            const dateInput = document.getElementById('appointment-date');
                            const timeInput = document.getElementById('appointment-time');
                            const typeInput = document.getElementById('appointment-type');
                            const notesInput = document.getElementById('appointment-notes');
                            
                            if (idInput) idInput.value = '';
                            if (titleEl) titleEl.innerHTML = '<i class="fas fa-calendar-plus mr-2"></i>Tambah Appointment Baru';
                            if (patientSelect) patientSelect.innerHTML = '<option value="">Memuat pasien...</option>';
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.value = today;
                            }
                            if (timeInput) timeInput.value = '09:00';
                            if (typeInput) typeInput.value = 'Konsultasi';
                            if (notesInput) notesInput.value = '';
                            
                            // Show modal
                            $('#appointment-modal').modal('show');
                            console.log('[DEBUG] Modal should now be visible');
                        } catch (err) {
                            console.error('[DEBUG] Error opening modal manually:', err);
                        }
                    } else {
                        console.error('[DEBUG] Cannot open modal - missing jQuery or Bootstrap');
                    }
                    
                    // Try to reload the appointments module
                    console.log('[DEBUG] Attempting to manually load appointments module...');
                    try {
                        import('./scripts/appointments.js?v=' + Date.now()).then(module => {
                            console.log('[DEBUG] Module loaded manually:', module);
                            if (module && module.initAppointments) {
                                module.initAppointments();
                                console.log('[DEBUG] initAppointments called manually');
                                // Try again after a short delay
                                setTimeout(() => {
                                    if (typeof window.openNewAppointment === 'function') {
                                        console.log('[DEBUG] window.openNewAppointment is now available!');
                                        window.openNewAppointment();
                                    }
                                }, 500);
                            }
                        }).catch(err => {
                            console.error('[DEBUG] Failed to load appointments module:', err);
                        });
                    } catch (err) {
                        console.error('[DEBUG] Cannot use dynamic import:', err);
                    }
                }
                
                console.log('[DEBUG] ===== END DEBUG (Global) =====');
                
                return {
                    buttonExists: !!btn,
                    modalExists: !!modal,
                    pageExists: !!appointmentsPage,
                    pageVisible: appointmentsPage && !appointmentsPage.classList.contains('d-none'),
                    functionExists: typeof window.openNewAppointment === 'function',
                    jqueryExists: typeof $ !== 'undefined'
                };
            };
            console.log('[DEBUG] window.debugAppointments is now available globally');
            
            // Auto-attach button handler when appointments page is visible
            function autoAttachAppointmentButton() {
                // Check if appointments page is visible
                const appointmentsPage = document.getElementById('appointments-page');
                if (!appointmentsPage || appointmentsPage.classList.contains('d-none')) {
                    return; // Page not visible yet
                }
                
                const btn = document.getElementById('btn-add-appointment');
                if (!btn) {
                    return; // Button doesn't exist yet
                }
                
                // Check if button already has handlers
                if (btn.onclick || (btn.getAttribute('data-handler-attached') === 'true')) {
                    return; // Already has handler
                }
                
                // Attach handler
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (typeof window.openNewAppointment === 'function') {
                        window.openNewAppointment();
                    } else {
                        // Fallback: open modal directly
                        const modal = document.getElementById('appointment-modal');
                        if (modal && typeof $ !== 'undefined' && $.fn.modal) {
                            const idInput = document.getElementById('appointment-id');
                            const titleEl = document.getElementById('appointment-modal-title');
                            const patientSelect = document.getElementById('appointment-patient-select');
                            const dateInput = document.getElementById('appointment-date');
                            const timeInput = document.getElementById('appointment-time');
                            const typeInput = document.getElementById('appointment-type');
                            const notesInput = document.getElementById('appointment-notes');
                            
                            if (idInput) idInput.value = '';
                            if (titleEl) titleEl.innerHTML = '<i class="fas fa-calendar-plus mr-2"></i>Tambah Appointment Baru';
                            if (patientSelect) patientSelect.innerHTML = '<option value="">Memuat pasien...</option>';
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.value = today;
                            }
                            if (timeInput) timeInput.value = '09:00';
                            if (typeInput) typeInput.value = 'Konsultasi';
                            if (notesInput) notesInput.value = '';
                            
                            $('#appointment-modal').modal('show');
                        }
                    }
                });
                btn.setAttribute('data-handler-attached', 'true');
                console.log('[DEBUG] Auto-attached click handler to appointment button');
            }
            
            // Wait for DOM to be ready before setting up observers
            function setupObserver() {
                if (!document.body) {
                    // Body not ready yet, wait for DOMContentLoaded
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', setupObserver);
                        return;
                    }
                    // If still not ready, retry after a short delay
                    setTimeout(setupObserver, 100);
                    return;
                }
                
                // Run check immediately and periodically
                setTimeout(autoAttachAppointmentButton, 1000);
                setTimeout(autoAttachAppointmentButton, 3000);
                
                // Also check when DOM changes (using MutationObserver)
                if (typeof MutationObserver !== 'undefined' && document.body) {
                    const observer = new MutationObserver(function(mutations) {
                        autoAttachAppointmentButton();
                    });
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }
            }
            
            // Start setup
            setupObserver();
        })();
    </script>
    
    <!-- Cache Clear Script -->
    <script>
        // Force clear cache on first load
        (function() {
            const CACHE_VERSION = 'v44'; // Increment this to force refresh - MEDIFY sync improvements
            const currentVersion = localStorage.getItem('cache_version');

            if (currentVersion !== CACHE_VERSION) {
                console.log('Cache version mismatch. Clearing cache...');

                // Clear localStorage patient data (keep auth and chat read timestamps)
                const keysToKeep = ['vps_auth_token', 'user_role', 'user_email'];
                // Also keep chat_last_read_* keys
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('chat_last_read_')) keysToKeep.push(key);
                });
                const tempData = {};
                keysToKeep.forEach(key => {
                    const val = localStorage.getItem(key);
                    if (val) tempData[key] = val;
                });
                
                localStorage.clear();
                
                // Restore important keys
                Object.keys(tempData).forEach(key => {
                    localStorage.setItem(key, tempData[key]);
                });
                
                // Set new version
                localStorage.setItem('cache_version', CACHE_VERSION);
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                console.log('Cache cleared. Version updated to:', CACHE_VERSION);
                
                // Reload page once
                if (!sessionStorage.getItem('reloaded')) {
                    sessionStorage.setItem('reloaded', '1');
                    window.location.reload(true);
                }
            }
        })();
    </script>

    <!-- Global Auth Helper - ALWAYS AVAILABLE -->
    <script>
        // Define getAuthToken globally so it's available everywhere
        // This prevents "getAuthToken is not defined" errors in inline scripts
        window.getAuthToken = function() {
            return localStorage.getItem('vps_auth_token');
        };

        // Also expose TOKEN_KEY for consistency
        window.TOKEN_KEY = 'vps_auth_token';
    </script>

    <!-- Mobile Responsive CSS (using styles/ version with mobile-app-mode) -->

    <!-- Marked.js for Markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper" id="main-app">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light" style= "height: 70.76923099999999px;">
        <ul class="navbar-nav">
            <li class="nav-item d-none d-sm-inline-block">
                <span class="nav-link">
                    <i class="far fa-calendar-alt mr-1"></i>
                    <span id="date-display"></span>
                </span>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <span class="nav-link">
                    <i class="far fa-clock mr-1"></i>
                    <span id="time-display"></span>
                </span>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto" style="height: 68px; display: flex; align-items: center;">
            <li class="nav-item" style="display: flex; align-items: center;">
                <span id="status-banner" class="nav-link d-none">
                    <span class="badge badge-warning">Loading...</span>
                </span>
            </li>
            <!-- Notification Bell -->
            <li class="nav-item dropdown" id="notification-dropdown" style="display: flex; align-items: center;">
                <a class="nav-link" data-toggle="dropdown" href="#" aria-expanded="false" style="position: relative; padding: 0.5rem 1rem;">
                    <i class="far fa-bell" style="font-size: 1.25rem;"></i>
                    <span id="notification-badge" class="badge badge-danger navbar-badge" style="display: none; position: absolute; top: 5px; right: 5px; font-size: 0.65rem; padding: 2px 5px;">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" style="max-height: 400px; overflow-y: auto;">
                    <div class="dropdown-header d-flex justify-content-between align-items-center">
                        <span><strong id="notification-header-count">0</strong> Notifikasi</span>
                        <a href="#" id="mark-all-read-btn" class="text-muted text-sm" onclick="markAllNotificationsRead(); return false;">
                            <i class="fas fa-check-double"></i> Tandai semua dibaca
                        </a>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div id="notification-list">
                        <div class="dropdown-item text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i> Memuat...
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item dropdown-footer text-center" onclick="showAllNotifications(); return false;">
                        Lihat Semua Notifikasi
                    </a>
                </div>
            </li>
            <li class="nav-item dropdown user-menu" style="display: flex; align-items: center; height: 100%;">
                <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" style="display: flex !important; flex-direction: row !important; align-items: center !important; padding: 0 1rem; height: 100%;">
                    <div class="d-none d-md-block" style="text-align: right; margin-right: 10px; line-height: 1.3;">
                        <div id="navbar-user-name" style="font-weight: 600; color: #333; font-size: 14px;">User</div>
                        <span id="navbar-user-role" class="badge badge-info" style="font-size: 10px; padding: 2px 6px;">Role</span>
                    </div>
                    <img id="navbar-user-avatar" src="" alt="User" class="img-circle elevation-2" style="width: 40px; height: 40px; object-fit: cover; display: none;">
                    <span id="navbar-user-avatar-placeholder" class="img-circle elevation-2 bg-secondary text-white" style="width: 40px; height: 40px; font-size: 16px; display: none; align-items: center; justify-content: center;">
                        <i class="fas fa-user"></i>
                    </span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <a href="#" class="dropdown-item" id="navbar-profile-btn" onclick="showProfileSettings(); return false;">
                        <i class="fas fa-user-cog mr-2"></i> Profile Settings
                    </a>
                    <div class="dropdown-divider" id="navbar-divider"></div>
                    <a href="#" class="dropdown-item" id="navbar-logout-btn">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </a>
                </div>
            </li>
        </ul>
    </nav>

    <!-- Main Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
            <div class="p-3 text-center sidebar-logo">
                <img src="images/db-black.svg" alt="Logo" class="sidebar-logo-img" title="Admin Panel">
            </div>
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <!-- MAIN -->
                    <li class="nav-header">MAIN</li>
                    <li class="nav-item" id="nav-dashboard">
                        <a href="#" class="nav-link" onclick="showDashboardPage(); return false;">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav-kelola-pasien">
                        <a href="#" class="nav-link" onclick="showManagePatientsPage(); return false;">
                            <i class="nav-icon fas fa-users"></i>
                            <p>Kelola Pasien</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav-pengumuman">
                        <a href="#" class="nav-link" onclick="showKelolaPengumumanPage(); return false;">
                            <i class="nav-icon fas fa-bullhorn"></i>
                            <p>Pengumuman</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav-penjualan-obat">
                        <a href="#" class="nav-link" onclick="showPenjualanObatPage(); return false;">
                            <i class="nav-icon fas fa-pills"></i>
                            <p>Penjualan Obat</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav-notifications">
                        <a href="#" class="nav-link" onclick="showNotificationsPage(); return false;">
                            <i class="nav-icon fas fa-bell"></i>
                            <p>Notifikasi</p>
                        </a>
                    </li>
                    <li class="nav-item" id="nav-jadwal">
                        <a href="#" class="nav-link" onclick="showKelolaJadwalPage(); return false;">
                            <i class="nav-icon fas fa-calendar-alt"></i>
                            <p>Jadwal</p>
                        </a>
                    </li>
                    <li class="nav-item dokter-only d-none" id="nav-artikel-kesehatan">
                        <a href="#" class="nav-link" onclick="showArtikelKesehatanPage(); markBadgeRead('artikel'); return false;">
                            <i class="nav-icon fas fa-book-reader"></i>
                            <p>
                                Ruang Membaca
                                <span class="badge badge-success right d-none" id="badge-artikel-likes">0</span>
                            </p>
                        </a>
                    </li>

                    <!-- KLINIK -->
                    <li class="nav-header">KLINIK</li>

                    <!-- KLINIK PRIVAT (Collapsible) -->
                    <li class="nav-item has-treeview" id="nav-section-klinik-privat">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-clinic-medical" style="color: #3c8dbc;"></i>
                            <p>Klinik Privat<i class="fas fa-angle-left right"></i></p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item" id="nav-klinik-private">
                                <a href="#" class="nav-link" onclick="showKlinikPrivatePage(); markBadgeRead('klinik_private'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>
                                        Janji Temu
                                        <span class="badge badge-warning right d-none" id="badge-klinik-private">0</span>
                                    </p>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-klinik-private-pasien">
                                <a href="#" class="nav-link" onclick="showHospitalPatientsPage('klinik_private'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Pasien</p>
                                </a>
                            </li>
                            <li class="nav-item" id="management-nav-kelola-tindakan">
                                <a href="#" class="nav-link" onclick="showKelolaTindakanPage(); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Layanan</p>
                                </a>
                            </li>
                            <li class="nav-item" id="management-nav-kelola-obat">
                                <a href="#" class="nav-link" onclick="showKelolaObatManagementPage(); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Obat/Alkes</p>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-estimasi-biaya">
                                <a href="#" class="nav-link" onclick="showEstimasiBiayaPage(); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Estimasi Biaya</p>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- RSIA MELINDA (Collapsible) -->
                    <li class="nav-item has-treeview" id="nav-section-rsia-melinda">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-hospital" style="color: #e91e63;"></i>
                            <p>RSIA Melinda<i class="fas fa-angle-left right"></i></p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item" id="nav-rsia-melinda">
                                <a href="#" class="nav-link" onclick="showHospitalAppointmentsPage('rsia_melinda'); markBadgeRead('rsia_melinda'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>
                                        Janji Temu
                                        <span class="badge badge-warning right d-none" id="badge-rsia-melinda">0</span>
                                    </p>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-rsia-melinda-pasien">
                                <a href="#" class="nav-link" onclick="showHospitalPatientsPage('rsia_melinda'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Pasien</p>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- RSUD GAMBIRAN (Collapsible) -->
                    <li class="nav-item has-treeview" id="nav-section-rsud-gambiran">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-hospital" style="color: #17a2b8;"></i>
                            <p>RSUD Gambiran<i class="fas fa-angle-left right"></i></p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item" id="nav-rsud-gambiran">
                                <a href="#" class="nav-link" onclick="showHospitalAppointmentsPage('rsud_gambiran'); markBadgeRead('rsud_gambiran'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>
                                        Janji Temu
                                        <span class="badge badge-warning right d-none" id="badge-rsud-gambiran">0</span>
                                    </p>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-rsud-gambiran-pasien">
                                <a href="#" class="nav-link" onclick="showHospitalPatientsPage('rsud_gambiran'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Pasien</p>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- RS BHAYANGKARA (Collapsible) -->
                    <li class="nav-item has-treeview" id="nav-section-rs-bhayangkara">
                        <a href="#" class="nav-link">
                            <i class="nav-icon fas fa-hospital-alt" style="color: #28a745;"></i>
                            <p>RS Bhayangkara<i class="fas fa-angle-left right"></i></p>
                        </a>
                        <ul class="nav nav-treeview">
                            <li class="nav-item" id="nav-rs-bhayangkara">
                                <a href="#" class="nav-link" onclick="showHospitalAppointmentsPage('rs_bhayangkara'); markBadgeRead('rs_bhayangkara'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>
                                        Janji Temu
                                        <span class="badge badge-warning right d-none" id="badge-rs-bhayangkara">0</span>
                                    </p>
                                </a>
                            </li>
                            <li class="nav-item" id="nav-rs-bhayangkara-pasien">
                                <a href="#" class="nav-link" onclick="showHospitalPatientsPage('rs_bhayangkara'); return false;">
                                    <i class="fas fa-circle nav-icon" style="font-size: 6px;"></i>
                                    <p>Pasien</p>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- BULK UPLOAD USG (All Staff) -->
                    <li class="nav-item" id="nav-bulk-upload-usg" data-menu-key="bulk-upload-usg">
                        <a href="#" class="nav-link" onclick="showBulkUploadUSGPage(); return false;">
                            <i class="nav-icon fas fa-cloud-upload-alt" style="color: #6f42c1;"></i>
                            <p>Bulk Upload USG</p>
                        </a>
                    </li>

                    <!-- MEDIFY SYNC (Dokter Only) -->
                    <li class="nav-item dokter-only d-none" id="nav-medify-sync">
                        <a href="#" class="nav-link" onclick="showMedifySyncPage(); return false;">
                            <i class="nav-icon fas fa-hospital-user" style="color: #17a2b8;"></i>
                            <p>MEDIFY Sync</p>
                        </a>
                    </li>

                    <!-- MANAGEMENT -->
                    <li class="nav-header" id="management-header">MANAGEMENT</li>

                    <li class="nav-item dokter-only d-none" id="finance-analysis-nav">
                        <a href="#" class="nav-link" onclick="showFinanceAnalysisPage(); return false;">
                            <i class="nav-icon fas fa-chart-line"></i>
                            <p>Finance Analysis</p>
                        </a>
                    </li>

                    <li class="nav-item d-none" id="nav-birth-congrats">
                        <a href="#" class="nav-link" onclick="showBirthCongratsPage(); return false;">
                            <i class="nav-icon fas fa-baby" style="color: #007bff;"></i>
                            <p>Ucapan Kelahiran</p>
                        </a>
                    </li>

                    <li class="nav-item" id="management-nav-kelola-supplier">
                        <a href="#" class="nav-link" onclick="showKelolaSupplierPage(); return false;">
                            <i class="nav-icon fas fa-truck"></i>
                            <p>Supplier</p>
                        </a>
                    </li>

                    <li class="nav-item" id="management-nav-activity-log">
                        <a href="#" class="nav-link" onclick="showActivityLogPage(); return false;">
                            <i class="nav-icon fas fa-history"></i>
                            <p>Log Aktivitas Obat</p>
                        </a>
                    </li>

                    <li class="nav-item" id="management-nav-kelola-roles">
                        <a href="#" class="nav-link" onclick="showKelolaRolesPage(); return false;">
                            <i class="nav-icon fas fa-user-shield"></i>
                            <p>Roles Manajemen</p>
                        </a>
                    </li>

                    <li class="nav-item dokter-only d-none" id="nav-staff-activity">
                        <a href="#" class="nav-link" onclick="showStaffActivityPage(); return false;">
                            <i class="nav-icon fas fa-user-clock"></i>
                            <p>Aktivitas Staff</p>
                        </a>
                    </li>

                    <li class="nav-item dokter-only d-none" id="nav-booking-settings">
                        <a href="#" class="nav-link" onclick="showBookingSettingsPage(); return false;">
                            <i class="nav-icon fas fa-calendar-day"></i>
                            <p>Pengaturan Sesi</p>
                        </a>
                    </li>

                    <li class="nav-item dokter-only d-none" id="nav-import-fields">
                        <a href="#" class="nav-link" onclick="showImportFieldsPage(); return false;">
                            <i class="nav-icon fas fa-file-import"></i>
                            <p>Import Fields</p>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- Online Users Activity Panel -->
            <div class="mt-3 px-3" id="online-users-panel">
                <div class="card card-primary card-outline">
                    <div class="card-header compact">
                        <h3 class="card-title mb-0" style="font-size: 14px;">
                            <i class="fas fa-users fa-sm"></i>
                            <span>Online Users</span>
                        </h3>
                        <span class="badge badge-success ml-auto" id="online-count">0</span>
                    </div>
                    <div class="card-body no-padding">
                        <ul class="list-group list-group-flush" id="online-users-list">
                            <li class="list-group-item text-center text-muted py-2">
                                <small>No users online</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <div class="content-header d-none" id="content-header-wrapper">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0" id="page-title"></h1>
                    </div>
                </div>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                <!-- DASHBOARD PAGE -->
                <div id="dashboard-page">
                    <!-- Welcome Card with Registration Code -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card" id="welcome-card" style="border: none; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);">
                                <div class="card-body py-4 px-4">
                                    <!-- Header: Title + Code -->
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <p class="mb-1" style="font-size: 13px; letter-spacing: 1px; color: #6c757d;">SELAMAT DATANG DI</p>
                                            <h3 class="font-weight-bold mb-0" style="font-size: 1.75rem; color: #343a40;">dokter<span style="color: #007BFF;">DIBYA</span></h3>
                                        </div>
                                        <!-- Registration Code (Auto-generated daily at 00:00 WIB) -->
                                        <div class="text-center">
                                            <div class="bg-primary text-white rounded p-1 px-2 mb-1" style="font-size: 14px; font-weight: 700; letter-spacing: 2px; font-family: monospace;" id="dashboard-current-code">
                                                ------
                                            </div>
                                            <small class="text-muted" style="font-size: 10px;">Kode Registrasi Pasien</small>
                                        </div>
                                    </div>

                                    <!-- Content: Full width -->
                                    <h5 class="mb-3" id="welcome-greeting" style="color: #495057;">
                                        Halo, <span id="welcome-name" class="font-weight-bold" style="color: #212529;"></span>
                                    </h5>
                                    <div id="welcome-jobdesk">
                                        <div id="roles-description-list">
                                            <!-- Role descriptions will be inserted here -->
                                        </div>
                                    </div>
                                    <p class="mt-4 mb-0" id="daily-greeting" style="font-size: 17px; color: #343a40; font-weight: 500; line-height: 1.5;">
                                        Selamat bekerja, semoga harimu menyenangkan!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2 Column Layout -->
                    <div class="row">
                        <!-- LEFT COLUMN -->
                        <div class="col-lg-6">
                            <!-- Pasien Baru -->
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-user-plus mr-2"></i>Pasien Baru
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="dashboard-new-patients-table" class="table table-sm table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Nama</th>
                                                    <th>Registrasi</th>
                                                    <th style="width: 50px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="dashboard-new-patients-tbody">
                                                <tr><td colspan="3" class="text-center">Memuat...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small class="text-muted" id="dashboard-new-patients-info">0 dari 0</small>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-secondary" id="dashboard-new-patients-prev" onclick="loadDashboardNewPatients(dashboardNewPatientsPage - 1)" disabled>
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="dashboard-new-patients-next" onclick="loadDashboardNewPatients(dashboardNewPatientsPage + 1)" disabled>
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chart -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h3 class="card-title mb-0"><i class="fas fa-chart-area mr-2"></i>Kunjungan 30 Hari</h3>
                                    <span class="badge badge-primary badge-pill" id="stat-visits-30days-total">-</span>
                                </div>
                                <div class="card-body">
                                    <div id="visits-30-days-chart" class="text-center text-muted" style="min-height: 200px;">
                                        <small>Memuat data kunjungan...</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN -->
                        <div class="col-lg-6">
                            <!-- Appointment Minggu Depan -->
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-calendar-check mr-2"></i>Appointment Minggu Depan</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="dashboard-today-appointments" style="max-height: 350px; overflow-y: auto;">
                                    <p class="text-muted mb-0">Tidak ada data.</p>
                                </div>
                            </div>

                            <!-- Aktivitas Terbaru -->
                            <div class="card card-info">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-bell mr-2"></i>Aktivitas Terbaru</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="dashboard-recent-activity" style="max-height: 280px; overflow-y: auto;">
                                    <p class="text-muted mb-0">Belum ada aktivitas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="klinik-private-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary card-outline">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="mb-2 mb-md-0">
                                        <h3 class="card-title mb-1"><i class="fas nav-icon fas fa-user-plus mr-2"></i>Pasien Terjadwal</h3>
                                        <div class="text-muted small"><span id="klinik-private-date-label">-</span></div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-primary mr-3" id="klinik-private-count">0 Pasien</span>
                                        <button class="btn btn-sm btn-outline-primary" id="klinik-private-refresh-btn">
                                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body no-padding">
                                    <div id="klinik-private-loading" class="text-center py-5 text-muted">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                        <p class="mb-0">Memuat daftar pasien Klinik Privat...</p>
                                    </div>
                                    <div id="klinik-private-error" class="alert alert-danger m-3 d-none"></div>
                                    <div id="klinik-private-empty" class="text-center py-5 text-muted d-none">
                                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                        <p class="mb-0">Belum ada pasien yang terjadwal</p>
                                    </div>
                                    <div id="klinik-private-table-wrapper" class="table-responsive d-none">
                                        <table class="table table-hover mb-0">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th style="width: 8%;" class="text-center">Waktu</th>
                                                    <th style="width: 25%;">Nama Pasien</th>
                                                    <th style="width: 8%;">Usia</th>
                                                    <th style="width: 12%;">Kategori</th>
                                                    <th style="width: 25%;">Alasan Kontrol</th>
                                                    <th style="width: 12%;">Status</th>
                                                    <th style="width: 10%;" class="text-center">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="klinik-private-tbody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>

                <!-- FINANCE PAGE (Superadmin) -->
                <div id="finance-page" class="d-none">
                    <div class="row">
                        <div class="col-lg-4 col-12">
                            <div class="small-box bg-primary">
                                <div class="inner">
                                    <h3 id="kpi-total-visits">-</h3>
                                    <p>Kunjungan Hari Ini</p>
                                </div>
                                <div class="icon"><i class="fas fa-notes-medical"></i></div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-12">
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <h3 id="kpi-revenue">-</h3>
                                    <p>Pendapatan Hari Ini</p>
                                </div>
                                <div class="icon"><i class="fas fa-dollar-sign"></i></div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-12">
                            <div class="small-box bg-info">
                                <div class="inner">
                                    <h3 id="kpi-avg-bill">-</h3>
                                    <p>Rata-rata Tagihan</p>
                                </div>
                                <div class="icon"><i class="fas fa-receipt"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3"><i class="fas fa-chart-line mr-2"></i>Finance Analysis</h5>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">Pemasukan Mingguan (7 Hari Terakhir)</h3>
                                </div>
                                <div class="card-body">
                                    <div id="weekly-revenue-chart"></div>
                                    <div class="mt-3 text-center">
                                        <strong>Total:</strong> <span id="weekly-total" class="text-success">-</span><br>
                                        <small class="text-muted">Rata-rata/hari: <span id="weekly-avg">-</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-warning">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-notes-medical mr-2"></i>Top 10 Tindakan Dilakukan</h3>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="top-services-table"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- PAGES: keep IDs to match logic in index-asli.html -->

                <div id="tindakan-page" class="d-none">
                    <!-- Patient Display Card -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div id="tindakan-patient-alert" class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>Pasien belum dipilih.</strong> Silakan pilih pasien di menu <a href="#" onclick="showPatientPage(); return false;" class="alert-link font-weight-bold">Data Pasien</a> terlebih dahulu.
                            </div>
                            <div id="selected-patient-display" class="alert alert-success d-none">
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>Pasien: </strong><span id="selected-patient-name"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card card-primary card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-stethoscope mr-2"></i>Daftar Layanan Tindakan <small class="text-muted">(Opsional)</small></h3>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" id="tindakanSearchInput" class="form-control" placeholder="Cari layanan tindakan...">
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                    <div id="serviceList" style="max-height:400px; overflow-y:auto;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card card-success card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-clipboard-list mr-2"></i>Tindakan Terpilih</h3>
                                    <div class="card-tools">
                                        <button id="new-bill-btn" class="btn btn-danger btn-sm"><i class="fas fa-redo mr-1"></i>Reset</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <ul id="selectedServicesList" class="list-unstyled mb-0" style="min-height:300px;">
                                        <li id="empty-state-tindakan" class="text-center text-muted py-5">
                                            <i class="fas fa-hand-pointer fa-3x mb-3 opacity-25"></i>
                                            <p>Pilih layanan tindakan di sebelah kiri<br><small>(atau langsung lanjut ke Obat)</small></p>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0 text-bold">TOTAL TINDAKAN</span>
                                        <span id="totalAmountTindakan" class="h4 mb-0 text-success text-bold">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="obat-page" class="d-none">
                    <div class="row">
                        <div class="col-lg-7">
                            <div class="card card-info card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-pills mr-2"></i>Daftar Obat, Vial & Alkes</h3>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" id="obatSearchInput" class="form-control" placeholder="Cari obat, vial, atau alkes...">
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                    
                                    <ul class="nav nav-tabs" id="obatTabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="drugs-tab" data-toggle="tab" href="#drugs-panel" role="tab">
                                                <i class="fas fa-tablets"></i> Obat-obatan
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="ampuls-tab" data-toggle="tab" href="#ampuls-panel" role="tab">
                                                <i class="fas fa-syringe"></i> Ampul & Vial
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="consumables-tab" data-toggle="tab" href="#consumables-panel" role="tab">
                                                <i class="fas fa-box"></i> Alkes
                                            </a>
                                        </li>
                                    </ul>
                                    
                                    <div class="tab-content mt-3" id="obatTabContent">
                                        <div class="tab-pane fade show active" id="drugs-panel" role="tabpanel">
                                            <div id="drugs-container" style="max-height:450px; overflow-y:auto;"></div>
                                        </div>
                                        <div class="tab-pane fade" id="ampuls-panel" role="tabpanel">
                                            <div id="ampuls-container" style="max-height:450px; overflow-y:auto;"></div>
                                        </div>
                                        <div class="tab-pane fade" id="consumables-panel" role="tabpanel">
                                            <div id="consumables-container" style="max-height:450px; overflow-y:auto;"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="no-results-obat" class="text-center text-muted py-4 d-none">
                                        <i class="fas fa-search fa-2x mb-2"></i>
                                        <p>Tidak ada hasil ditemukan</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-5">
                            <div class="card card-warning card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-prescription-bottle mr-2"></i>Obat Terpilih</h3>
                                    <div class="card-tools">
                                        <button id="clear-obat-btn" class="btn btn-danger btn-sm"><i class="fas fa-trash mr-1"></i>Hapus Semua</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="selected-obat-list" style="min-height:400px; max-height:500px; overflow-y:auto;">
                                        <div id="empty-state-obat" class="text-center text-muted py-5">
                                            <i class="fas fa-hand-pointer fa-3x mb-3 opacity-25"></i>
                                            <p>Pilih obat dari daftar di sebelah kiri</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0 text-bold">TOTAL OBAT & ALKES</span>
                                        <span id="totalAmountObat" class="h4 mb-0 text-warning text-bold">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="cashier-page" class="d-none">
                    <!-- Summary Section -->
                    <div class="row">
                        <!-- Patient Info -->
                        <div class="col-md-6">
                            <div class="card card-primary card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user-injured mr-2"></i>Data Pasien</h3>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td width="120"><strong>Nama</strong></td>
                                            <td>: <span id="summary-patient-name">-</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>No. WhatsApp</strong></td>
                                            <td>: <span id="summary-patient-phone">-</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tanggal</strong></td>
                                            <td>: <span id="summary-date">-</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Kasir</strong></td>
                                            <td>: <span id="summary-cashier">-</span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Summary -->
                        <div class="col-md-6">
                            <div class="card card-success card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-calculator mr-2"></i>Total Tagihan</h3>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total Tindakan</strong></td>
                                            <td class="text-right"><span id="summary-tindakan-total">Rp 0</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Obat & Alkes</strong></td>
                                            <td class="text-right"><span id="summary-obat-total">Rp 0</span></td>
                                        </tr>
                                        <tr class="border-top">
                                            <td><h5 class="mb-0"><strong>GRAND TOTAL</strong></h5></td>
                                            <td class="text-right"><h4 class="mb-0 text-success"><strong id="summary-grand-total">Rp 0</strong></h4></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tindakan Detail -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-info card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-stethoscope mr-2"></i>Rincian Tindakan</h3>
                                </div>
                                <div class="card-body">
                                    <div id="summary-tindakan-list">
                                        <p class="text-muted">Tidak ada tindakan</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Obat Detail -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-warning card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-pills mr-2"></i>Rincian Obat & Alkes</h3>
                                </div>
                                <div class="card-body">
                                    <div id="summary-obat-list">
                                        <p class="text-muted">Tidak ada obat</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body text-center">
                                    <button id="finalize-bill-btn" class="btn btn-success btn-lg mr-2">
                                        <i class="fas fa-check-circle mr-2"></i>Finalisasi Pemeriksaan
                                    </button>
                                    <button id="print-etiket-btn" class="btn btn-secondary btn-lg mr-2 d-none">
                                        <i class="fas fa-tags mr-2"></i>Cetak Etiket Obat
                                    </button>
                                    <button id="print-invoice-btn" class="btn btn-primary btn-lg mr-2 d-none">
                                        <i class="fas fa-file-invoice mr-2"></i>Cetak Invoice
                                    </button>
                                    <button id="new-patient-btn" class="btn btn-info btn-lg d-none">
                                        <i class="fas fa-user-plus mr-2"></i>Periksa Pasien Baru
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hospital Appointments Page -->
                <div id="hospital-appointments-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div id="hospital-appointments-container">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Pilih rumah sakit dari sidebar untuk melihat appointment
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hospital Patients Page -->
                <div id="hospital-patients-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-users mr-2"></i>
                                        <span id="hospital-patients-title">Pasien Rumah Sakit</span>
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="hospital-patients-table" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Nama Lengkap</th>
                                                    <th>Telepon</th>
                                                    <th>Tanggal Lahir</th>
                                                    <th>Usia</th>
                                                    <th>Kunjungan Terakhir</th>
                                                    <th>Tgl Registrasi</th>
                                                    <th>Status</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="hospital-patients-tbody">
                                                <tr>
                                                    <td colspan="9" class="text-center">Memuat data...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="patient-page" class="d-none">
                    <!-- Selected Patient Display -->
                    <div id="patient-selected-for-billing" class="alert alert-success d-none mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>Pasien terpilih untuk billing:</strong> <span id="billing-patient-name" class="font-weight-bold"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <input type="text" id="patient-search-input" class="form-control" placeholder="Cari nomor rekam medis (5 angka) atau nama pasien...">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div id="patient-list" style="max-height:70vh; overflow-y:auto;" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ANAMNESA PAGE -->
                <div id="anamnesa-page" class="d-none">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-clipboard-list mr-2"></i>Anamnesa</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                Pasien: <strong id="anamnesa-patient-name">-</strong>
                                <br><small>Data akan otomatis dimuat dari formulir intake dan booking appointment</small>
                            </div>
                            
                            <form id="anamnesa-form">
                                <!-- Data Pasien Section -->
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Data Pasien</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Nama Lengkap</label>
                                                    <input type="text" id="anamnesa-patient-fullname" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Tanggal Lahir</label>
                                                    <input type="date" id="anamnesa-patient-dob" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Umur</label>
                                                    <input type="text" id="anamnesa-patient-age" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="small text-muted">Alamat</label>
                                                    <textarea id="anamnesa-patient-address" class="form-control form-control-sm" rows="2" readonly></textarea>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Telepon</label>
                                                    <input type="text" id="anamnesa-patient-phone" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Status Pernikahan</label>
                                                    <input type="text" id="anamnesa-patient-marital" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Pekerjaan</label>
                                                    <input type="text" id="anamnesa-patient-occupation" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Pendidikan</label>
                                                    <input type="text" id="anamnesa-patient-education" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Pembiayaan</label>
                                                    <input type="text" id="anamnesa-patient-payment" class="form-control form-control-sm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Keluhan Utama Section -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Keluhan Utama</label>
                                            <textarea id="anamnesa-complaint" class="form-control" rows="4" placeholder="Keluhan pasien dari appointment booking..."></textarea>
                                            <small class="text-muted">Data diambil dari appointment booking</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Riwayat Penyakit Sekarang</label>
                                            <textarea id="anamnesa-current-illness" class="form-control" rows="4" placeholder="Detail keluhan dan riwayat penyakit saat ini..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Basic Medical Info Section -->
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Informasi Medis Dasar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Tes Hamil Positif</label>
                                                    <input type="date" id="anamnesa-pregnancy-test-date" class="form-control form-control-sm">
                                                    <small class="text-muted">Dari intake pasien</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Golongan Darah</label>
                                                    <input type="text" id="anamnesa-blood-type" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake pasien</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Rhesus</label>
                                                    <input type="text" id="anamnesa-rhesus" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake pasien</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Status Kehamilan</label>
                                                    <select id="anamnesa-pregnant" class="form-control form-control-sm">
                                                        <option value="">Hamil?</option>
                                                        <option value="ya">Ya</option>
                                                        <option value="tidak">Tidak</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Alergi Obat</label>
                                                    <textarea id="anamnesa-allergy-drugs" class="form-control form-control-sm" rows="2" readonly placeholder="Dari intake pasien"></textarea>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Alergi Makanan</label>
                                                    <textarea id="anamnesa-allergy-food" class="form-control form-control-sm" rows="2" readonly placeholder="Dari intake pasien"></textarea>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Alergi Lainnya</label>
                                                    <textarea id="anamnesa-allergy-others" class="form-control form-control-sm" rows="2" readonly placeholder="Alergi lingkungan dari intake"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label class="small text-muted">Obat-obatan yang Sedang Diminum</label>
                                                    <textarea id="anamnesa-current-medications" class="form-control form-control-sm" rows="2" readonly placeholder="Dari intake pasien"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Riwayat Penyakit Section -->
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">Riwayat Penyakit</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="small text-muted">Riwayat Penyakit Sebelumnya</label>
                                                    <textarea id="anamnesa-past-conditions" class="form-control form-control-sm" rows="4" placeholder="Dari kondisi medis sebelumnya di intake"></textarea>
                                                    <small class="text-muted">Data diambil dari intake pasien</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="small text-muted">Riwayat Penyakit Keluarga</label>
                                                    <textarea id="anamnesa-family-history" class="form-control form-control-sm" rows="4" placeholder="Dari riwayat penyakit keluarga di intake"></textarea>
                                                    <small class="text-muted">Data diambil dari intake pasien</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Obstetri Section -->
                                <div class="card mb-3" id="anamnesa-obstetri-section">
                                    <div class="card-header bg-success">
                                        <h5 class="mb-0 text-white">Status Obstetri</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Riwayat Menstruasi -->
                                        <h6 class="text-muted mb-3">Riwayat Menstruasi</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Usia Menarche</label>
                                                    <input type="text" id="anamnesa-menarche-age" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Lama Siklus (hari)</label>
                                                    <input type="text" id="anamnesa-cycle-length" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">Siklus Teratur</label>
                                                    <input type="text" id="anamnesa-cycle-regular" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label class="small text-muted">HPHT</label>
                                                    <input type="date" id="anamnesa-lmp" class="form-control form-control-sm">
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                        </div>

                                        <hr>

                                        <!-- Kehamilan Sebelumnya -->
                                        <h6 class="text-muted mb-3">Kehamilan Sebelumnya</h6>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="small text-muted">Gravida</label>
                                                    <input type="text" id="anamnesa-gravida" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="small text-muted">Para</label>
                                                    <input type="text" id="anamnesa-para" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="small text-muted">Abortus</label>
                                                    <input type="text" id="anamnesa-abortus" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label class="small text-muted">Anak Hidup</label>
                                                    <input type="text" id="anamnesa-living-children" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">HPL (Hari Perkiraan Lahir)</label>
                                                    <input type="date" id="anamnesa-edd" class="form-control form-control-sm">
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tabel Kehamilan Detail -->
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>No</th>
                                                        <th>Tahun</th>
                                                        <th>Mode Persalinan</th>
                                                        <th>Komplikasi</th>
                                                        <th>Berat Bayi (gr)</th>
                                                        <th>Anak Hidup</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="anamnesa-pregnancy-history">
                                                    <!-- Data dari intake akan dimuat di sini -->
                                                </tbody>
                                            </table>
                                            <small class="text-muted">Data kehamilan sebelumnya diambil dari formulir intake pasien</small>
                                        </div>

                                        <hr>

                                        <!-- Riwayat Kontrasepsi -->
                                        <h6 class="text-muted mb-3">Riwayat Kontrasepsi</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Metode Sebelumnya</label>
                                                    <input type="text" id="anamnesa-previous-contraception" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Kegagalan KB</label>
                                                    <input type="text" id="anamnesa-kb-failure" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label class="small text-muted">Tipe Kontrasepsi Gagal</label>
                                                    <input type="text" id="anamnesa-failed-contraception" class="form-control form-control-sm" readonly>
                                                    <small class="text-muted">Dari intake</small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="alert alert-info mt-3">
                                            <strong>Diagnosis Sementara:</strong> <span id="anamnesa-diagnosis-display">-</span>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save mr-2"></i>Simpan Anamnesa
                                </button>
                                <button type="button" class="btn btn-info ml-2" onclick="loadIntakeDataToAnamnesa()">
                                    <i class="fas fa-sync-alt mr-2"></i>Muat Data dari Intake
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- PHYSICAL EXAM PAGE -->
                <div id="physical-exam-page" class="d-none">
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-stethoscope mr-2"></i>Pemeriksaan Fisik</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                Pasien: <strong id="physical-patient-name">-</strong>
                            </div>
                            
                            <form id="physical-exam-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Vital Signs</h5>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Tekanan Darah</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" id="physical-bp-systolic" class="form-control" placeholder="Sistol">
                                                    <div class="input-group-append input-group-prepend">
                                                        <span class="input-group-text">/</span>
                                                    </div>
                                                    <input type="number" id="physical-bp-diastolic" class="form-control" placeholder="Diastol">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">mmHg</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Nadi</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" id="physical-pulse" class="form-control">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">x/menit</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Suhu</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" step="0.1" id="physical-temp" class="form-control">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">C</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Pernapasan</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" id="physical-resp" class="form-control">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">x/menit</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Berat Badan</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" step="0.1" id="physical-weight" class="form-control">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">kg</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Tinggi Badan</label>
                                            <div class="col-sm-8">
                                                <div class="input-group">
                                                    <input type="number" id="physical-height" class="form-control">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">cm</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Pemeriksaan Umum</h5>
                                        <div class="form-group">
                                            <label>Keadaan Umum</label>
                                            <select id="physical-general-condition" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Baik">Baik</option>
                                                <option value="Sedang">Sedang</option>
                                                <option value="Lemah">Lemah</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Kesadaran</label>
                                            <select id="physical-consciousness" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Compos Mentis">Compos Mentis</option>
                                                <option value="Apatis">Apatis</option>
                                                <option value="Somnolen">Somnolen</option>
                                                <option value="Sopor">Sopor</option>
                                                <option value="Koma">Koma</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Catatan Pemeriksaan Fisik</label>
                                            <textarea id="physical-notes" class="form-control" rows="8" placeholder="Hasil pemeriksaan fisik lainnya..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save mr-2"></i>Simpan Pemeriksaan Fisik
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- USG EXAM PAGE -->
                <div id="usg-exam-page" class="d-none">
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-baby mr-2"></i>Pemeriksaan USG</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                Pasien: <strong id="usg-patient-name">-</strong>
                            </div>
                            
                            <form id="usg-exam-form">
                                <!-- USG Ginekologi (Tidak Hamil) -->
                                <div id="usg-gynecology-section" class="d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-3"><i class="fas fa-check-square mr-2"></i>Pemeriksaan Uterus</h5>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-uterus-normal">
                                                <label class="custom-control-label" for="usg-gyn-uterus-normal">Uterus ukuran normal</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-uterus-anteverted">
                                                <label class="custom-control-label" for="usg-gyn-uterus-anteverted">Posisi anteverted</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-uterus-retroverted">
                                                <label class="custom-control-label" for="usg-gyn-uterus-retroverted">Posisi retroverted</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-myoma">
                                                <label class="custom-control-label" for="usg-gyn-myoma">Myoma uteri</label>
                                            </div>
                                            <div id="myoma-detail-section" class="ml-4 d-none">
                                                <div class="form-group">
                                                    <label class="small text-muted">Jumlah</label>
                                                    <select id="myoma-count" class="form-control form-control-sm" style="width: 100px;">
                                                        <option value="">Pilih</option>
                                                        <option value="1">1</option>
                                                        <option value="2">2</option>
                                                        <option value="3">3</option>
                                                        <option value="4">4</option>
                                                        <option value="5">5</option>
                                                    </select>
                                                </div>
                                                <div id="myoma-sizes"></div>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-adenomyosis">
                                                <label class="custom-control-label" for="usg-gyn-adenomyosis">Adenomyosis</label>
                                            </div>
                                            <div class="form-group mt-3">
                                                <label class="small text-muted">Ukuran Uterus (cm)</label>
                                                <input type="text" id="usg-gyn-uterus-size" class="form-control form-control-sm" placeholder="Contoh: 8 x 5 x 4 cm">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3"><i class="fas fa-check-square mr-2"></i>Pemeriksaan Ovarium</h5>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-ovary-normal">
                                                <label class="custom-control-label" for="usg-gyn-ovary-normal">Ovarium kanan-kiri normal</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-cyst-right">
                                                <label class="custom-control-label" for="usg-gyn-cyst-right">Kista ovarium kanan</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-cyst-left">
                                                <label class="custom-control-label" for="usg-gyn-cyst-left">Kista ovarium kiri</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-pcos">
                                                <label class="custom-control-label" for="usg-gyn-pcos">PCOS (Polycystic Ovary Syndrome)</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-endometrioma">
                                                <label class="custom-control-label" for="usg-gyn-endometrioma">Endometrioma</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <h5 class="mb-3"><i class="fas fa-check-square mr-2"></i>Endometrium</h5>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-endo-normal">
                                                <label class="custom-control-label" for="usg-gyn-endo-normal">Endometrium normal</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-endo-thick">
                                                <label class="custom-control-label" for="usg-gyn-endo-thick">Penebalan endometrium</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-polyp">
                                                <label class="custom-control-label" for="usg-gyn-polyp">Polip endometrium</label>
                                            </div>
                                            <div class="form-group mt-3">
                                                <label class="small text-muted">Ketebalan Endometrium (mm)</label>
                                                <input type="number" step="0.1" id="usg-gyn-endo-thickness" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="mb-3"><i class="fas fa-check-square mr-2"></i>Lain-lain</h5>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-free-fluid">
                                                <label class="custom-control-label" for="usg-gyn-free-fluid">Free fluid di cavum douglas</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mb-2">
                                                <input type="checkbox" class="custom-control-input" id="usg-gyn-adhesion">
                                                <label class="custom-control-label" for="usg-gyn-adhesion">Perlengketan</label>
                                            </div>
                                            <div class="form-group mt-3">
                                                <label>Catatan Tambahan</label>
                                                <textarea id="usg-gyn-notes" class="form-control" rows="4" placeholder="Catatan hasil USG ginekologi..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- USG Obstetri (Hamil) -->
                                <div id="usg-obstetri-section" class="d-none">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Data Janin</h5>
                                        <div class="form-group">
                                            <label>Jumlah Janin</label>
                                            <select id="usg-fetus-count" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="1">Tunggal</option>
                                                <option value="2">Gemeli (2)</option>
                                                <option value="3">Triplet (3)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Presentasi</label>
                                            <select id="usg-presentation" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Kepala">Kepala</option>
                                                <option value="Bokong">Bokong</option>
                                                <option value="Lintang">Lintang</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Denyut Jantung Janin (DJJ)</label>
                                            <div class="input-group">
                                                <input type="number" id="usg-fhr" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">x/menit</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Gerakan Janin</label>
                                            <select id="usg-fetal-movement" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Aktif">Aktif</option>
                                                <option value="Kurang Aktif">Kurang Aktif</option>
                                                <option value="Tidak Ada">Tidak Ada</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Cairan Ketuban</label>
                                            <select id="usg-amniotic-fluid" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Cukup">Cukup</option>
                                                <option value="Oligohidramnion">Oligohidramnion (Kurang)</option>
                                                <option value="Polihidramnion">Polihidramnion (Berlebih)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Plasenta</label>
                                            <select id="usg-placenta" class="form-control">
                                                <option value="">Pilih...</option>
                                                <option value="Fundus">Fundus</option>
                                                <option value="Korpus">Korpus</option>
                                                <option value="Previa">Previa</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Biometri Janin</h5>
                                        <div class="form-group">
                                            <label>BPD (Biparietal Diameter)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.1" id="usg-bpd" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">cm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>FL (Femur Length)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.1" id="usg-fl" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">cm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>AC (Abdominal Circumference)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.1" id="usg-ac" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">cm</span>
                                                </div
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>HC (Head Circumference)</label>
                                            <div class="input-group">
                                                <input type="number" step="0.1" id="usg-hc" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">cm</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Taksiran Berat Janin (TBJ)</label>
                                            <div class="input-group">
                                                <input type="number" id="usg-efw" class="form-control">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">gram</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Usia Kehamilan (USG)</label>
                                            <div class="input-group">
                                                <input type="number" id="usg-ga-weeks" class="form-control" placeholder="Minggu" style="width: 80px;">
                                                <input type="number" id="usg-ga-days" class="form-control" placeholder="Hari" style="width: 70px;">
                                                <div class="input-group-append">
                                                    <span class="input-group-text">minggu hari</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Catatan USG</label>
                                            <textarea id="usg-notes" class="form-control" rows="4" placeholder="Catatan tambahan hasil USG..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <!-- End USG Obstetri Section -->
                                
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-save mr-2"></i>Simpan Hasil USG
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                </div>
                <!-- END USG EXAM PAGE -->

                <!-- LAB EXAM PAGE -->
                <div id="lab-exam-page" class="d-none">
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-flask mr-2"></i>Pemeriksaan Penunjang (Laboratorium)</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                Pasien: <strong id="lab-patient-name">-</strong>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary">
                                            <h5 class="card-title mb-0"><i class="fas fa-upload mr-2"></i>Upload Hasil Laboratorium</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label>Upload Foto/Scan Hasil Lab</label>
                                                <input type="file" id="lab-upload" class="form-control-file" accept="image/*">
                                                <small class="form-text text-muted">Format: JPG, PNG, WebP (Max 5MB)</small>
                                            </div>
                                            <div id="lab-preview" class="mt-3 d-none">
                                                <img id="lab-preview-img" src="" alt="Preview" class="img-fluid border rounded" style="max-height: 400px;">
                                            </div>
                                            <button type="button" id="lab-ai-interpret-btn" class="btn btn-success btn-lg btn-block mt-3" disabled>
                                                <i class="fas fa-robot mr-2"></i>Buat Laporan Lab dengan AI
                                            </button>
                                            <div id="lab-ai-loading" class="d-none mt-3 text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="sr-only">Loading...</span>
                                                </div>
                                                <p class="mt-2"><i class="fas fa-brain mr-2"></i>AI sedang menganalisis hasil lab...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Hasil Interpretasi</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="lab-exam-form">
                                                <div class="form-group">
                                                    <label>Jenis Pemeriksaan</label>
                                                    <input type="text" id="lab-test-type" class="form-control" placeholder="Contoh: Darah Lengkap, Urin Rutin, dll">
                                                </div>
                                                <div class="form-group">
                                                    <label>Hasil Laboratorium</label>
                                                    <textarea id="lab-results" class="form-control" rows="10" placeholder="Hasil lab akan muncul di sini setelah AI menganalisis..."></textarea>
                                                    <small class="form-text text-muted">Anda dapat mengedit hasil interpretasi AI</small>
                                                </div>
                                                <div class="form-group">
                                                    <label>Kesimpulan</label>
                                                    <textarea id="lab-conclusion" class="form-control" rows="3" placeholder="Kesimpulan hasil laboratorium..."></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-warning">
                                                    <i class="fas fa-save mr-2"></i>Simpan Hasil Lab
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STOK OPNAME PAGE -->
                <div id="admin-page" class="d-none">
                    <div class="row">
                        <!-- Add New Item Card -->
                        <div class="col-md-4">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-plus-circle mr-2"></i>Tambah Obat Baru</h3>
                                </div>
                                <form id="add-obat-form">
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="new-obat-name">Nama Obat <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="new-obat-name" placeholder="Contoh: Paracetamol 500mg" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="new-obat-category">Kategori <span class="text-danger">*</span></label>
                                            <select class="form-control" id="new-obat-category" required>
                                                <option value="">Pilih Kategori</option>
                                                <option value="drugs">Obat-obatan</option>
                                                <option value="vials">Ampul & Vial</option>
                                                <option value="alkes">Alat Kesehatan</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="new-obat-price">Harga (Rp) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="new-obat-price" placeholder="0" min="0" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="new-obat-stock">Stok Awal <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="new-obat-stock" placeholder="0" min="0" required>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button type="submit" class="btn btn-primary btn-block">
                                            <i class="fas fa-plus mr-2"></i>Tambah Obat
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Summary Card -->
                            <div class="card card-info">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-chart-pie mr-2"></i>Ringkasan Stok</h3>
                                </div>
                                <div class="card-body">
                                    <div class="info-box bg-light mb-2">
                                        <span class="info-box-icon bg-primary"><i class="fas fa-pills"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Total Item</span>
                                            <span class="info-box-number" id="summary-total-items">0</span>
                                        </div>
                                    </div>
                                    <div class="info-box bg-light mb-2">
                                        <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Stok Aman</span>
                                            <span class="info-box-number" id="summary-stock-ok">0</span>
                                        </div>
                                    </div>
                                    <div class="info-box bg-light mb-0">
                                        <span class="info-box-icon bg-danger"><i class="fas fa-exclamation-triangle"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Stok Kritis (5)</span>
                                            <span class="info-box-number" id="summary-stock-low">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stock List Card -->
                        <div class="col-md-8">
                            <div class="card card-success">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-boxes mr-2"></i>Daftar Stok Obat & Alkes</h3>
                                    <div class="card-tools">
                                        <div class="input-group input-group-sm" style="width: 250px;">
                                            <input type="text" id="stok-search" class="form-control" placeholder="Cari obat...">
                                            <div class="input-group-append">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body no-padding">
                                    <div id="stok-opname-list" style="max-height: 70vh; overflow-y: auto;">
                                        <p class="text-center text-muted p-4">Memuat data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="log-page" class="d-none">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title"><i class="fas fa-history mr-2"></i> Log Aktivitas</h3></div>
                        <div class="card-body"><div id="log-list-container" style="max-height:70vh; overflow-y:auto;"><p class="text-center text-muted">Memuat log...</p></div></div>
                        <div class="card-footer"><button id="backFromLogBtn" class="btn btn-secondary"><i class="fas fa-arrow-left mr-1"></i> Kembali ke Billing</button></div>
                    </div>
                </div>



                <!-- KELOLA PASIEN PAGE -->
                <div id="kelola-pasien-page" class="d-none"></div>

                <!-- KELOLA PENGUMUMAN PAGE -->
                <div id="kelola-pengumuman-page" class="d-none">
                    <div class="container-fluid">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary" id="btn-new-announcement-inline">
                                        <i class="fas fa-plus"></i> Buat Pengumuman Baru
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="announcements-container-inline" class="row">
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p class="mt-2">Memuat pengumuman...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PENJUALAN OBAT PAGE -->
                <div id="penjualan-obat-page" class="d-none"></div>

                <!-- BULK UPLOAD USG PAGE -->
                <div id="bulk-upload-usg-page" class="d-none"></div>

                <!-- MEDIFY SYNC PAGE -->
                <div id="medify-sync-page" class="d-none">
                    <div class="container-fluid">
                        <!-- Page Header -->
                        <div class="row mb-3">
                            <div class="col-12 d-flex justify-content-between align-items-start flex-wrap">
                                <div>
                                    <h4><i class="fas fa-hospital-user mr-2"></i>MEDIFY Sync</h4>
                                    <p class="text-muted">Sinkronisasi otomatis rekam medis dari SIMRS Melinda dan Gambiran</p>
                                </div>
                                <button class="btn btn-outline-primary" onclick="window.loadLastReview()">
                                    <i class="fas fa-history mr-1"></i>Load Last Review
                                </button>
                            </div>
                        </div>

                        <!-- Sync Status Alert -->
                        <div id="sync-status-container" style="display: none;"></div>

                        <!-- Batch Progress -->
                        <div id="batch-progress" style="display: none;"></div>

                        <!-- Review & Send to Portal Section -->
                        <div id="review-container" class="mt-4"></div>

                        <!-- Date Range Filter -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card card-secondary">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-calendar-alt mr-2"></i>Filter Tanggal SIMRS</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Tanggal Mulai</label>
                                                    <input type="date" class="form-control" id="medify-date-start">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Tanggal Akhir</label>
                                                    <input type="date" class="form-control" id="medify-date-end">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>&nbsp;</label>
                                                    <p class="form-control-plaintext text-muted small">
                                                        <i class="fas fa-info-circle mr-1"></i>Kosongkan untuk default 7 hari terakhir
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sync Buttons -->
                        <div class="row mb-4">
                            <!-- RSIA Melinda -->
                            <div class="col-md-6">
                                <div class="card card-info">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-hospital mr-2"></i>RSIA Melinda</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" onclick="window.testConnection('rsia_melinda')" id="btn-test-melinda" title="Test Connection">
                                                <i class="fas fa-plug"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" onclick="window.showCredentialsModal('rsia_melinda')" title="Set Credentials">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body text-center">
                                        <p id="melinda-cred-status" class="mb-3">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </p>
                                        <button class="btn btn-lg btn-info" id="btn-sync-melinda" onclick="window.startSync('rsia_melinda')" disabled>
                                            <i class="fas fa-sync-alt mr-2"></i>Sync RSIA Melinda
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- RSUD Gambiran -->
                            <div class="col-md-6">
                                <div class="card card-success">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-hospital mr-2"></i>RSUD Gambiran</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" onclick="window.testConnection('rsud_gambiran')" id="btn-test-gambiran" title="Test Connection">
                                                <i class="fas fa-plug"></i>
                                            </button>
                                            <button type="button" class="btn btn-tool" onclick="window.showCredentialsModal('rsud_gambiran')" title="Set Credentials">
                                                <i class="fas fa-key"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body text-center">
                                        <p id="gambiran-cred-status" class="mb-3">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </p>
                                        <button class="btn btn-lg btn-success" id="btn-sync-gambiran" onclick="window.startSync('rsud_gambiran')" disabled>
                                            <i class="fas fa-sync-alt mr-2"></i>Sync RSUD Gambiran
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sync History -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history mr-2"></i>Riwayat Sync</h3>
                            </div>
                            <div class="card-body table-responsive p-0">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Sumber</th>
                                            <th>Total</th>
                                            <th>Sukses</th>
                                            <th>Gagal</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sync-history-body">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <i class="fas fa-spinner fa-spin"></i> Loading...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Credentials Modal -->
                <div class="modal fade" id="credentials-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-key mr-2"></i>Kredensial SIMRS</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="credentials-form">
                                    <p class="text-muted mb-3">
                                        Masukkan kredensial untuk: <strong id="cred-source-label"></strong>
                                    </p>
                                    <div class="form-group">
                                        <label>Username / Email</label>
                                        <input type="text" class="form-control" id="cred-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Password</label>
                                        <input type="password" class="form-control" id="cred-password" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" id="btn-save-credentials" onclick="window.saveCredentials()">
                                    <i class="fas fa-save mr-2"></i>Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Batch Details Modal -->
                <div class="modal fade" id="batch-details-modal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-list mr-2"></i>Detail Sync</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pasien</th>
                                            <th>Status</th>
                                            <th>SIMRS ID</th>
                                            <th>Records</th>
                                            <th>Error</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batch-details-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KELOLA ROLES PAGE -->
                <div id="kelola-roles-page" class="d-none">
                    <div class="container-fluid">
                        <!-- Stats Cards -->
                        <div class="row mb-3">
                            <div class="col-lg-4 col-6">
                                <div class="small-box bg-info">
                                    <div class="inner">
                                        <h3 id="roles-stat-total">0</h3>
                                        <p>Total Roles</p>
                                    </div>
                                    <div class="icon"><i class="fas fa-user-shield"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-6">
                                <div class="small-box bg-success">
                                    <div class="inner">
                                        <h3 id="roles-stat-permissions">0</h3>
                                        <p>Total Permissions</p>
                                    </div>
                                    <div class="icon"><i class="fas fa-key"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-6">
                                <div class="small-box bg-warning">
                                    <div class="inner">
                                        <h3 id="roles-stat-users">0</h3>
                                        <p>Staff Users</p>
                                    </div>
                                    <div class="icon"><i class="fas fa-users"></i></div>
                                </div>
                            </div>
                        </div>

                        <!-- Roles Table Card -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-user-shield mr-2"></i>Daftar Roles</h3>
                                <div class="card-tools">
                                    <button class="btn btn-primary btn-sm" id="btn-add-role">
                                        <i class="fas fa-plus"></i> Tambah Role
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table id="roles-table" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th width="5%">ID</th>
                                            <th width="15%">Nama Role</th>
                                            <th width="15%">Display Name</th>
                                            <th width="30%">Deskripsi</th>
                                            <th width="10%">Permissions</th>
                                            <th width="10%">Users</th>
                                            <th width="15%">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="roles-tbody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                                <p class="mt-2 mb-0">Memuat data roles...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Permissions Card -->
                        <div class="card" id="permissions-card" style="display: none;">
                            <div class="card-header bg-secondary">
                                <h3 class="card-title"><i class="fas fa-key mr-2"></i>Kelola Permissions untuk: <span id="selected-role-name"></span></h3>
                                <div class="card-tools">
                                    <button class="btn btn-light btn-sm" id="btn-close-permissions">
                                        <i class="fas fa-times"></i> Tutup
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="btn-group">
                                            <button class="btn btn-outline-primary btn-sm" id="btn-select-all-perms">
                                                <i class="fas fa-check-double"></i> Pilih Semua
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" id="btn-deselect-all-perms">
                                                <i class="fas fa-times"></i> Hapus Semua
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <button class="btn btn-success" id="btn-save-permissions">
                                            <i class="fas fa-save"></i> Simpan Permissions
                                        </button>
                                    </div>
                                </div>
                                <div id="permissions-container" class="row">
                                    <!-- Permissions will be loaded here grouped by category -->
                                </div>
                            </div>
                        </div>

                        <!-- User Management Card -->
                        <div class="card mt-4">
                            <div class="card-header bg-info">
                                <h3 class="card-title"><i class="fas fa-users-cog mr-2"></i>Staff dan Admin</h3>
                            </div>
                            <div class="card-body">
                                <table id="users-roles-table" class="table table-bordered table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="12%">ID</th>
                                            <th width="18%">Nama</th>
                                            <th width="20%">Email</th>
                                            <th width="25%">Roles</th>
                                            <th width="10%">Status</th>
                                            <th width="10%">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-roles-tbody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                                <p class="mt-2 mb-0">Memuat data users...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Menu Visibility Settings Card -->
                        <div class="card mt-4">
                            <div class="card-header bg-warning">
                                <h3 class="card-title"><i class="fas fa-eye mr-2"></i>Pengaturan Visibility Menu</h3>
                                <div class="card-tools">
                                    <button class="btn btn-light btn-sm" id="btn-refresh-visibility" onclick="loadMenuVisibility()">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body no-padding">
                                <div class="alert alert-info m-3 mb-0">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Centang menu yang ingin ditampilkan untuk setiap role. Perubahan langsung disimpan.
                                    <br><small class="text-muted">Note: Dokter/Superadmin selalu bisa akses semua menu.</small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm mb-0" id="visibility-table">
                                        <thead class="thead-light">
                                            <tr>
                                                <th width="25%">Menu</th>
                                                <th class="text-center">Bidan</th>
                                                <th class="text-center">Administrasi</th>
                                                <th class="text-center">Managerial</th>
                                                <th class="text-center">Kasir</th>
                                            </tr>
                                        </thead>
                                        <tbody id="visibility-tbody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin"></i> Memuat...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Role Modal -->
                <div class="modal fade" id="role-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary">
                                <h5 class="modal-title" id="role-modal-title">Tambah Role Baru</h5>
                                <button type="button" class="close text-white" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <form id="role-form">
                                <div class="modal-body">
                                    <input type="hidden" id="role-id">
                                    <div class="form-group">
                                        <label for="role-name">Nama Role <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="role-name" required
                                               pattern="[a-z_]+" title="Hanya huruf kecil dan underscore">
                                        <small class="text-muted">Hanya huruf kecil dan underscore (contoh: admin_klinik)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="role-display-name">Display Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="role-display-name" required>
                                        <small class="text-muted">Nama yang ditampilkan (contoh: Admin Klinik)</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="role-description">Deskripsi</label>
                                        <textarea class="form-control" id="role-description" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                    <button type="submit" class="btn btn-primary" id="btn-save-role">
                                        <i class="fas fa-save"></i> Simpan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- User Role Assignment Modal -->
                <div class="modal fade" id="user-roles-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-info">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-tag mr-2"></i>Kelola Roles: <span id="user-roles-modal-name"></span>
                                </h5>
                                <button type="button" class="close text-white" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="user-roles-user-id">
                                <p class="text-muted mb-3">
                                    <i class="fas fa-info-circle"></i>
                                    Pilih satu atau lebih role untuk user ini. Permission akan digabungkan dari semua role yang dipilih.
                                </p>
                                <div id="user-roles-checkboxes">
                                    <!-- Checkboxes will be loaded here -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-info" id="btn-save-user-roles">
                                    <i class="fas fa-save"></i> Simpan Roles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOOKING SETTINGS PAGE (Superadmin Only) -->
                <div id="booking-settings-page" class="d-none">
                    <div class="container-fluid">
                        <!-- Session Settings Section -->
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-cog mr-2"></i>Pengaturan Sesi Booking</h3>
                                <div class="card-tools">
                                    <button class="btn btn-primary btn-sm" id="btn-add-session">
                                        <i class="fas fa-plus"></i> Tambah Sesi Baru
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Kontrol jam operasional dan jumlah slot untuk setiap sesi pada halaman booking pasien
                                </p>
                                <div id="booking-settings-container" class="row">
                                    <div class="col-12 text-center py-5">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Memuat pengaturan sesi...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bookings Management Section -->
                        <div class="card card-danger card-outline">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar-times mr-2"></i>Kelola Booking Aktif</h3>
                                <div class="card-tools">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.loadBookings()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body no-padding">
                                <div id="bookings-container" class="p-3">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Memuat data booking...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Settings Modal -->
                <div class="modal fade" id="session-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary">
                                <h5 class="modal-title" id="session-modal-title">Tambah Sesi Baru</h5>
                                <button type="button" class="close text-white" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <form id="session-form">
                                <div class="modal-body">
                                    <input type="hidden" id="session-id">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-number">Nomor Sesi <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="session-number" min="1" max="10" required>
                                                <small class="text-muted">Urutan tampil di halaman booking</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-name">Nama Sesi <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="session-name" placeholder="Contoh: Pagi, Siang, Sore" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-start-time">Waktu Mulai <span class="text-danger">*</span></label>
                                                <input type="time" class="form-control" id="session-start-time" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-end-time">Waktu Selesai <span class="text-danger">*</span></label>
                                                <input type="time" class="form-control" id="session-end-time" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-slot-duration">Durasi Per Slot (menit)</label>
                                                <input type="number" class="form-control" id="session-slot-duration" min="5" max="60" value="15">
                                                <small class="text-muted">Waktu antara setiap slot</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="session-max-slots">Maksimal Slot</label>
                                                <input type="number" class="form-control" id="session-max-slots" min="1" max="30" value="10">
                                                <small class="text-muted">Jumlah pasien per sesi</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="session-is-active" checked>
                                            <label class="custom-control-label" for="session-is-active">Sesi Aktif</label>
                                        </div>
                                        <small class="text-muted">Nonaktifkan jika sesi ini tidak tersedia untuk booking</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                    <button type="submit" class="btn btn-primary" id="btn-save-session">
                                        <i class="fas fa-save"></i> Simpan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- KELOLA APPOINTMENT PAGE -->
                <div id="kelola-appointment-page" class="d-none">
                    <!-- Kelola Appointment Page -->
<div class="container-fluid">
    <!-- Statistics -->
    <div class="row">
        <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
                <div class="inner">
                    <h3 id="stats-total">-</h3>
                    <p>Total Appointments</p>
                </div>
                <div class="icon"><i class="fas fa-calendar-alt"></i></div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3 id="stats-pending">-</h3>
                    <p>Pending</p>
                </div>
                <div class="icon"><i class="fas fa-clock"></i></div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="small-box bg-primary">
                <div class="inner">
                    <h3 id="stats-confirmed">-</h3>
                    <p>Confirmed</p>
                </div>
                <div class="icon"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
                <div class="inner">
                    <h3 id="stats-completed">-</h3>
                    <p>Completed</p>
                </div>
                <div class="icon"><i class="fas fa-user-check"></i></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Daftar Appointment (Khusus Hari Minggu)</h3>
        </div>
        <div class="card-body">
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-date">Tanggal:</label>
                        <input type="date" id="filter-date" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-session">Sesi:</label>
                        <select id="filter-session" class="form-control">
                            <option value="">Semua Sesi</option>
                            <option value="pagi">Pagi (09:00 - 12:00)</option>
                            <option value="sore">Sore (15:00 - 18:00)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-status">Status:</label>
                        <select id="filter-status" class="form-control">
                            <option value="">Semua Status</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="no_show">No Show</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="loadAppointments()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Appointments Table -->
            <table id="appointments-table" class="table table-bordered table-striped" style="width:100%">
                <thead id="appointments-thead">
                    <!-- Headers will be set by DataTables -->
                </thead>
                <tbody id="appointments-tbody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
                </div>

                <!-- KELOLA JADWAL PAGE -->
                <div id="kelola-jadwal-page" class="d-none">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Jadwal Praktik di Berbagai Lokasi</h3>
                                        <div class="card-tools">
                                            <button class="btn btn-success btn-sm" onclick="showAddModal()">
                                                <i class="fas fa-plus"></i> Tambah Jadwal
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <table id="schedules-table" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th width="5%">ID</th>
                                                    <th width="20%">Lokasi</th>
                                                    <th width="15%">Hari</th>
                                                    <th width="20%">Waktu</th>
                                                    <th width="25%">Keterangan</th>
                                                    <th width="8%">Status</th>
                                                    <th width="12%">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="schedules-tbody">
                                                <tr>
                                                    <td colspan="7" class="text-center">Memuat data...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Disabled Practice Dates -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card card-warning">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-calendar-times mr-2"></i>Hari Libur / Non-Aktif Sementara</h3>
                                        <div class="card-tools">
                                            <button class="btn btn-warning btn-sm" onclick="showDisabledDateModal()">
                                                <i class="fas fa-plus"></i> Nonaktifkan Tanggal
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-3">
                                            <i class="fas fa-info-circle"></i> Daftar tanggal yang dinonaktifkan sementara (misal: dokter ada acara, cuti, dll)
                                        </p>
                                        <table class="table table-bordered table-sm">
                                            <thead class="bg-warning">
                                                <tr>
                                                    <th width="15%">Tanggal</th>
                                                    <th width="20%">Lokasi</th>
                                                    <th width="30%">Alasan</th>
                                                    <th width="20%">Dibuat oleh</th>
                                                    <th width="15%">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="disabled-dates-tbody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">Memuat data...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KELOLA TINDAKAN PAGE -->
                <div id="kelola-tindakan-page" class="d-none"></div>

                <!-- KELOLA OBAT MANAGEMENT PAGE -->
                <div id="kelola-obat-management-page" class="d-none"></div>

                <!-- ESTIMASI BIAYA KEHAMILAN PAGE -->
                <div id="estimasi-biaya-page" class="d-none">
                    <div class="card card-primary card-outline">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-calculator mr-2"></i>Estimasi Biaya Kontrol Kehamilan</h3>
                        </div>
                        <div class="card-body">
                            <!-- Global Options -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label><i class="fas fa-baby mr-1"></i> Trimester</label>
                                        <select class="form-control" id="estimasi-fase" onchange="updateEstimasiBiaya()">
                                            <option value="t1">Trimester 1 (1-13 Minggu)</option>
                                            <option value="t2">Trimester 2 (14-27 Minggu)</option>
                                            <option value="t3">Trimester 3 (28-40 Minggu)</option>
                                            <option value="semua">Semua Trimester (Full Package)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label><i class="fas fa-child mr-1"></i> Tipe Kehamilan</label>
                                        <select class="form-control" id="estimasi-tipe" onchange="updateEstimasiBiaya()">
                                            <option value="tunggal">Tunggal</option>
                                            <option value="kembar">Kembar</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Estimation Results -->
                            <div class="row">
                                <!-- Trimester 1 -->
                                <div class="col-lg-4 mb-3" id="estimasi-card-t1">
                                    <div class="card bg-light h-100">
                                        <div class="card-header bg-info text-white py-2">
                                            <h6 class="mb-0"><i class="fas fa-seedling mr-1"></i> Trimester 1 (1-13 Minggu)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="mb-2">
                                                <label class="small font-weight-bold mb-1"><i class="fas fa-pills mr-1"></i> Obat:</label>
                                                <select class="form-control form-control-sm" id="t1-obat" onchange="updateEstimasiBiaya()">
                                                    <option value="none">Tanpa Obat</option>
                                                    <option value="cost">Cost-Effective</option>
                                                    <option value="premium">Premium</option>
                                                </select>
                                            </div>
                                            <hr class="my-2">
                                            <table class="table table-sm table-borderless mb-0" id="tabel-estimasi-t1">
                                            </table>
                                        </div>
                                        <div class="card-footer bg-info text-white py-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <strong>Subtotal (~3 kontrol):</strong>
                                                <strong id="subtotal-t1">Rp 0</strong>
                                            </div>
                                            <div class="d-flex justify-content-between small" style="opacity: 0.9;">
                                                <span>Est. 1x kontrol:</span>
                                                <span id="perkontrol-t1">Rp 0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trimester 2 -->
                                <div class="col-lg-4 mb-3" id="estimasi-card-t2">
                                    <div class="card bg-light h-100">
                                        <div class="card-header bg-warning text-dark py-2">
                                            <h6 class="mb-0"><i class="fas fa-baby mr-1"></i> Trimester 2 (14-27 Minggu)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="custom-control custom-switch mb-2">
                                                <input type="checkbox" class="custom-control-input" id="t2-skrining" onchange="updateEstimasiBiaya()">
                                                <label class="custom-control-label small" for="t2-skrining">USG Skrining Kelainan (20-24mg)</label>
                                            </div>
                                            <div class="mb-2">
                                                <label class="small font-weight-bold mb-1"><i class="fas fa-pills mr-1"></i> Obat:</label>
                                                <select class="form-control form-control-sm" id="t2-obat" onchange="updateEstimasiBiaya()">
                                                    <option value="none">Tanpa Obat</option>
                                                    <option value="cost">Cost-Effective</option>
                                                    <option value="premium">Premium</option>
                                                </select>
                                            </div>
                                            <hr class="my-2">
                                            <table class="table table-sm table-borderless mb-0" id="tabel-estimasi-t2">
                                            </table>
                                        </div>
                                        <div class="card-footer bg-warning text-dark py-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <strong>Subtotal (~4 kontrol):</strong>
                                                <strong id="subtotal-t2">Rp 0</strong>
                                            </div>
                                            <div class="d-flex justify-content-between small" style="opacity: 0.85;">
                                                <span>Est. 1x kontrol:</span>
                                                <span id="perkontrol-t2">Rp 0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trimester 3 -->
                                <div class="col-lg-4 mb-3" id="estimasi-card-t3">
                                    <div class="card bg-light h-100">
                                        <div class="card-header bg-success text-white py-2">
                                            <h6 class="mb-0"><i class="fas fa-heart mr-1"></i> Trimester 3 (28-40 Minggu)</h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="custom-control custom-switch mb-2">
                                                <input type="checkbox" class="custom-control-input" id="t3-4d" onchange="updateEstimasiBiaya()">
                                                <label class="custom-control-label small" for="t3-4d">USG 4D (28 Minggu)</label>
                                            </div>
                                            <div class="mb-2">
                                                <label class="small font-weight-bold mb-1"><i class="fas fa-pills mr-1"></i> Obat:</label>
                                                <select class="form-control form-control-sm" id="t3-obat" onchange="updateEstimasiBiaya()">
                                                    <option value="none">Tanpa Obat</option>
                                                    <option value="cost">Cost-Effective</option>
                                                    <option value="premium">Premium</option>
                                                </select>
                                            </div>
                                            <hr class="my-2">
                                            <table class="table table-sm table-borderless mb-0" id="tabel-estimasi-t3">
                                            </table>
                                        </div>
                                        <div class="card-footer bg-success text-white py-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <strong>Subtotal (~7 kontrol):</strong>
                                                <strong id="subtotal-t3">Rp 0</strong>
                                            </div>
                                            <div class="d-flex justify-content-between small" style="opacity: 0.9;">
                                                <span>Est. 1x kontrol:</span>
                                                <span id="perkontrol-t3">Rp 0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Summary -->
                            <div class="card bg-primary text-white mt-3">
                                <div class="card-body py-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h4 class="mb-1"><i class="fas fa-receipt mr-2"></i>Total Estimasi Biaya</h4>
                                            <p class="mb-0 small opacity-75">*Estimasi dapat berubah sesuai kondisi kehamilan</p>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            <h2 class="mb-0" id="total-estimasi">Rp 0</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="alert alert-info mt-3 mb-0">
                                <h6><i class="fas fa-info-circle mr-1"></i> Catatan:</h6>
                                <ul class="mb-0 pl-3">
                                    <li>USG skrining kelainan janin <strong>18-23 minggu</strong></li>
                                    <li>USG 4D direkomendasikan di usia kehamilan <strong>28 minggu</strong> untuk melihat wajah janin dengan jelas</li>
                                    <li>Frekuensi kontrol: Awal (1x/bulan) 4-27 mgg, Tengah (2x/bulan) 28-36 mgg, Akhir (1x/minggu) 37-40 mgg</li>
                                    <li>Biaya estimasi total disesuai kontrol dengan atau tanpa obat/vitamin dan pemeriksaan tambahan</li>
                                    <li>Harga dapat berubah sewaktu-waktu</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EMAIL SETTINGS PAGE -->
                <!-- REMOVED: Email Settings Page -->

                <!-- FINANCE ANALYSIS PAGE -->
                <div id="finance-analysis-page" class="d-none">
                    <div class="container-fluid">
                        <!-- Obat Profit Analysis Section -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card card-dark">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-chart-pie mr-2"></i>Analisis Profit Obat (Bulan Ini)</h3>
                                        <div class="card-tools">
                                            <button class="btn btn-tool" onclick="loadObatProfitAnalysis()">
                                                <i class="fas fa-sync"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Profit KPI Cards -->
                                        <div class="row mb-4">
                                            <div class="col-md-3 col-6">
                                                <div class="info-box bg-gradient-info">
                                                    <span class="info-box-icon"><i class="fas fa-coins"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Revenue Obat</span>
                                                        <span class="info-box-number" id="profit-revenue">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6">
                                                <div class="info-box bg-gradient-danger">
                                                    <span class="info-box-icon"><i class="fas fa-shopping-cart"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Modal/Cost</span>
                                                        <span class="info-box-number" id="profit-cost">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6">
                                                <div class="info-box bg-gradient-success">
                                                    <span class="info-box-icon"><i class="fas fa-money-bill-wave"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Gross Profit</span>
                                                        <span class="info-box-number" id="profit-gross">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-6">
                                                <div class="info-box bg-gradient-warning">
                                                    <span class="info-box-icon"><i class="fas fa-percentage"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Margin</span>
                                                        <span class="info-box-number" id="profit-margin">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Alerts Row -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="alert alert-warning mb-0" id="expiring-alert" style="display:none;">
                                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                                    <strong id="expiring-count">0</strong> item akan kadaluarsa dalam 60 hari
                                                    <button class="btn btn-xs btn-outline-warning float-right" onclick="showExpiringItems()">Lihat</button>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-danger mb-0" id="lowstock-alert" style="display:none;">
                                                    <i class="fas fa-boxes mr-2"></i>
                                                    <strong id="lowstock-count">0</strong> item stok menipis
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Profit by Item Table -->
                                        <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                                            <table class="table table-sm table-striped table-hover">
                                                <thead class="bg-light sticky-top">
                                                    <tr>
                                                        <th>Nama Obat</th>
                                                        <th class="text-right">Qty Terjual</th>
                                                        <th class="text-right">Revenue</th>
                                                        <th class="text-right">Cost</th>
                                                        <th class="text-right">Profit</th>
                                                        <th class="text-right">Margin</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="profit-items-body">
                                                    <tr>
                                                        <td colspan="6" class="text-center text-muted py-4">
                                                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                            <p class="mb-0">Memuat data...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Private Clinic (Klinik Privat) Analysis Section -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card card-purple">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-clinic-medical mr-2"></i>Analisis Keuangan Klinik Privat</h3>
                                        <div class="card-tools">
                                            <select id="private-clinic-month" class="form-control form-control-sm d-inline-block" style="width: auto;">
                                            </select>
                                            <button class="btn btn-tool" onclick="loadPrivateClinicAnalysis()">
                                                <i class="fas fa-sync"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <!-- Net Profit KPI Cards -->
                                        <div class="row mb-4">
                                            <div class="col-lg-3 col-md-6 col-6">
                                                <div class="info-box bg-gradient-purple">
                                                    <span class="info-box-icon"><i class="fas fa-coins"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Pendapatan Kotor</span>
                                                        <span class="info-box-number" id="pc-pendapatan-kotor">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 col-6">
                                                <div class="info-box bg-gradient-info">
                                                    <span class="info-box-icon"><i class="fas fa-hand-holding-usd"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Laba Kotor</span>
                                                        <span class="info-box-number" id="pc-laba-kotor">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 col-6">
                                                <div class="info-box bg-gradient-success">
                                                    <span class="info-box-icon"><i class="fas fa-money-bill-wave"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Laba Bersih</span>
                                                        <span class="info-box-number" id="pc-laba-bersih">Rp 0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6 col-6">
                                                <div class="info-box bg-gradient-warning">
                                                    <span class="info-box-icon"><i class="fas fa-percentage"></i></span>
                                                    <div class="info-box-content">
                                                        <span class="info-box-text">Margin Bersih</span>
                                                        <span class="info-box-number" id="pc-margin-bersih">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Summary Stats Row -->
                                        <div class="row mb-4">
                                            <div class="col-md-8">
                                                <div class="card card-outline card-primary mb-0">
                                                    <div class="card-header compact">
                                                        <h5 class="card-title mb-0"><i class="fas fa-chart-bar mr-2"></i>Laporan Laba Rugi</h5>
                                                    </div>
                                                    <div class="card-body no-padding">
                                                        <table class="table table-sm mb-0">
                                                            <tbody id="pc-profit-loss-table">
                                                                <tr><td colspan="2" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Memuat...</td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card card-outline card-success mb-0 h-100">
                                                    <div class="card-header compact">
                                                        <h5 class="card-title mb-0"><i class="fas fa-tachometer-alt mr-2"></i>KPI</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <span>Kunjungan:</span>
                                                            <strong id="pc-kunjungan">0</strong>
                                                        </div>
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <span>Hari Kerja:</span>
                                                            <strong id="pc-hari-kerja">0</strong>
                                                        </div>
                                                        <div class="d-flex justify-content-between mb-2">
                                                            <span>Laba/Hari:</span>
                                                            <strong id="pc-laba-per-hari" class="text-success">Rp 0</strong>
                                                        </div>
                                                        <div class="d-flex justify-content-between">
                                                            <span>Laba/Kunjungan:</span>
                                                            <strong id="pc-laba-per-kunjungan" class="text-success">Rp 0</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Breakdown Tables Row -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card card-outline card-info">
                                                    <div class="card-header compact">
                                                        <h5 class="card-title mb-0"><i class="fas fa-procedures mr-2"></i>Pendapatan Tindakan per Kategori</h5>
                                                    </div>
                                                    <div class="card-body no-padding" style="max-height: 250px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped mb-0">
                                                            <thead class="bg-light sticky-top">
                                                                <tr>
                                                                    <th>Kategori</th>
                                                                    <th class="text-right">Transaksi</th>
                                                                    <th class="text-right">Pendapatan</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="pc-tindakan-category-body">
                                                                <tr><td colspan="3" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i></td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card card-outline card-warning">
                                                    <div class="card-header compact">
                                                        <h5 class="card-title mb-0"><i class="fas fa-pills mr-2"></i>Analisis Profit Obat</h5>
                                                    </div>
                                                    <div class="card-body no-padding" style="max-height: 250px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped mb-0">
                                                            <thead class="bg-light sticky-top">
                                                                <tr>
                                                                    <th>Obat</th>
                                                                    <th class="text-right">Qty</th>
                                                                    <th class="text-right">Profit</th>
                                                                    <th class="text-right">Margin</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="pc-obat-profit-body">
                                                                <tr><td colspan="4" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i></td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Top Tindakan Table -->
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="card card-outline card-secondary collapsed-card">
                                                    <div class="card-header compact">
                                                        <h5 class="card-title mb-0"><i class="fas fa-list-ol mr-2"></i>Top 10 Tindakan</h5>
                                                        <div class="card-tools">
                                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="card-body no-padding" style="display: none;">
                                                        <table class="table table-sm table-hover mb-0">
                                                            <thead class="bg-light">
                                                                <tr>
                                                                    <th>Tindakan</th>
                                                                    <th>Kategori</th>
                                                                    <th class="text-right">Qty</th>
                                                                    <th class="text-right">Harga</th>
                                                                    <th class="text-right">Pendapatan</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="pc-top-tindakan-body">
                                                                <tr><td colspan="5" class="text-center py-3"><i class="fas fa-spinner fa-spin"></i></td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BIRTH CONGRATULATIONS PAGE (Dokter Only) -->
                <div id="birth-congrats-page" class="d-none">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="card card-primary">
                                    <div class="card-header" style="background: linear-gradient(135deg, #007bff, #0056b3);">
                                        <h3 class="card-title"><i class="fas fa-baby mr-2"></i>Ucapan Selamat Kelahiran</h3>
                                        <div class="card-tools">
                                            <button class="btn btn-light btn-sm" onclick="showAddBirthCongratsModal()">
                                                <i class="fas fa-plus mr-1"></i>Tambah Baru
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="birth-congrats-list">
                                            <div class="text-center text-muted py-5">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Memuat data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Birth Congratulations Modal -->
                <div class="modal fade" id="birthCongratsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #007bff, #0056b3); color: white;">
                                <h5 class="modal-title"><i class="fas fa-baby mr-2"></i><span id="birthCongratsModalTitle">Tambah Ucapan Kelahiran</span></h5>
                                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="birthCongratsForm">
                                    <input type="hidden" id="bc-edit-id">

                                    <!-- Patient Selection -->
                                    <div class="form-group">
                                        <label><i class="fas fa-user text-primary mr-1"></i>Pilih Pasien <span class="text-danger">*</span></label>
                                        <select class="form-control" id="bc-patient-id" style="width: 100%;" required>
                                            <option value="">-- Pilih Pasien --</option>
                                        </select>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-baby text-primary mr-1"></i>Nama Bayi</label>
                                                <input type="text" class="form-control" id="bc-baby-name" placeholder="Contoh: Baby Ananda">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-venus-mars text-primary mr-1"></i>Jenis Kelamin</label>
                                                <select class="form-control" id="bc-gender">
                                                    <option value="">-- Pilih --</option>
                                                    <option value="male">Laki-laki</option>
                                                    <option value="female">Perempuan</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-calendar text-primary mr-1"></i>Tanggal Lahir</label>
                                                <input type="date" class="form-control" id="bc-birth-date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-clock text-primary mr-1"></i>Jam Lahir</label>
                                                <input type="time" class="form-control" id="bc-birth-time">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-weight text-primary mr-1"></i>Berat Badan</label>
                                                <input type="text" class="form-control" id="bc-birth-weight" placeholder="Contoh: 3.2 kg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label><i class="fas fa-ruler-vertical text-primary mr-1"></i>Panjang Badan</label>
                                                <input type="text" class="form-control" id="bc-birth-length" placeholder="Contoh: 50 cm">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-comment-dots text-primary mr-1"></i>Pesan dari Dokter</label>
                                        <textarea class="form-control" id="bc-message" rows="3" placeholder="Tuliskan ucapan selamat..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-image text-primary mr-1"></i>Foto Kelahiran</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="bc-photo" accept="image/*">
                                            <label class="custom-file-label" for="bc-photo">Pilih foto...</label>
                                        </div>
                                        <small class="text-muted">Maks. 10MB, format: JPG, PNG</small>
                                        <div id="bc-photo-preview" class="mt-2" style="display: none;">
                                            <img src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 10px;">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label><i class="fas fa-palette text-primary mr-1"></i>Tema Warna</label>
                                        <div class="d-flex flex-wrap" id="bc-color-options">
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('pink')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #fff5f8, #ffd6e8); border: 3px solid #333;" class="color-box" data-color="pink"></div>
                                                <small class="d-block">Pink</small>
                                            </div>
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('blue')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 3px solid transparent;" class="color-box" data-color="blue"></div>
                                                <small class="d-block">Blue</small>
                                            </div>
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('green')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border: 3px solid transparent;" class="color-box" data-color="green"></div>
                                                <small class="d-block">Green</small>
                                            </div>
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('purple')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #f3e5f5, #e1bee7); border: 3px solid transparent;" class="color-box" data-color="purple"></div>
                                                <small class="d-block">Purple</small>
                                            </div>
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('gold')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #fffde7, #fff9c4); border: 3px solid transparent;" class="color-box" data-color="gold"></div>
                                                <small class="d-block">Gold</small>
                                            </div>
                                            <div class="color-option mr-2 mb-2 text-center" style="cursor: pointer;" onclick="selectBirthCongratsColor('peach')">
                                                <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 3px solid transparent;" class="color-box" data-color="peach"></div>
                                                <small class="d-block">Peach</small>
                                            </div>
                                        </div>
                                        <input type="hidden" name="bc-theme-color" id="bc-theme-color" value="pink">
                                    </div>

                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="bc-is-published" checked>
                                            <label class="custom-control-label" for="bc-is-published">Tampilkan di Dashboard Pasien</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="saveBirthCongrats()">
                                    <i class="fas fa-save mr-1"></i>Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APPOINTMENTS PAGE -->
                <div id="appointments-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-calendar-check mr-2"></i>Jadwal Appointment</h3>
                                    <div class="card-tools">
                                        <button id="btn-add-appointment" class="btn btn-success btn-sm">
                                            <i class="fas fa-plus mr-1"></i>Tambah Appointment
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Today's Appointments -->
                                    <div class="mb-4">
                                        <h5><i class="fas fa-calendar-day mr-2"></i>Appointment Minggu Depan</h5>
                                        <div id="appointments-today-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                            <p class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Memuat data...</p>
                                        </div>
                                    </div>
                                    
                                    <!-- All Appointments List -->
                                    <div>
                                        <h5><i class="fas fa-list mr-2"></i>Semua Appointment</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <input type="text" id="appointments-search" class="form-control" placeholder=" Cari pasien...">
                                            </div>
                                            <div class="col-md-3">
                                                <select id="appointments-filter-status" class="form-control">
                                                    <option value="">Semua Status</option>
                                                    <option value="scheduled">Terjadwal</option>
                                                    <option value="confirmed">Dikonfirmasi</option>
                                                    <option value="completed">Selesai</option>
                                                    <option value="cancelled">Dibatalkan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="date" id="appointments-filter-date" class="form-control">
                                            </div>
                                        </div>
                                        <div id="appointments-list" class="table-responsive">
                                            <table class="table table-bordered table-striped table-hover">
                                                <thead class="bg-light">
                                                    <tr>
                                                        <th width="50">#</th>
                                                        <th>Pasien</th>
                                                        <th width="120">Jenis</th>
                                                        <th width="100">Tanggal</th>
                                                        <th width="80">Waktu</th>
                                                        <th width="100">Status</th>
                                                        <th width="150" class="text-center">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="appointments-list-body">
                                                    <tr>
                                                        <td colspan="7" class="text-center text-muted py-4">
                                                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                            <p class="mb-0">Memuat data...</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="analytics-page" class="d-none"></div>

                <!-- IMPORT FIELDS PAGE (Dokter Only) -->
                <div id="import-fields-page" class="d-none"></div>

                <!-- ARTIKEL KESEHATAN PAGE (Dokter Only) -->
                <div id="artikel-kesehatan-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-book-reader mr-2"></i>Ruang Membaca</h3>
                                    <div class="card-tools">
                                        <button class="btn btn-primary btn-sm" onclick="showAddArticleModal()">
                                            <i class="fas fa-plus mr-1"></i> Tambah Artikel
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Filter Section -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <select id="article-filter-category" class="form-control form-control-sm" onchange="loadArticlesAdmin()">
                                                <option value="all">Semua Kategori</option>
                                                <option value="Kehamilan">Kehamilan</option>
                                                <option value="Program Hamil">Program Hamil</option>
                                                <option value="Gangguan Kandungan">Gangguan Kandungan</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <select id="article-filter-status" class="form-control form-control-sm" onchange="loadArticlesAdmin()">
                                                <option value="all">Semua Status</option>
                                                <option value="published">Published</option>
                                                <option value="draft">Draft</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="loadArticlesAdmin()">
                                                <i class="fas fa-sync-alt"></i> Refresh
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Articles Table -->
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="articles-admin-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 25%">Judul</th>
                                                    <th style="width: 12%">Kategori</th>
                                                    <th style="width: 10%">Status</th>
                                                    <th style="width: 8%">Views</th>
                                                    <th style="width: 8%">Likes</th>
                                                    <th style="width: 15%">Updated</th>
                                                    <th style="width: 22%">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="articles-admin-tbody">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin"></i> Memuat artikel...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Article Modal -->
                <div class="modal fade" id="articleModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="articleModalTitle">Tambah Artikel</h5>
                                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                            </div>
                            <div class="modal-body">
                                <form id="articleForm">
                                    <input type="hidden" id="article-id">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label>Judul Artikel <span class="text-danger">*</span></label>
                                                <input type="text" id="article-title" class="form-control" required placeholder="Masukkan judul artikel">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Kategori</label>
                                                <select id="article-category" class="form-control">
                                                    <option value="Kehamilan">Kehamilan</option>
                                                    <option value="Program Hamil">Program Hamil</option>
                                                    <option value="Gangguan Kandungan">Gangguan Kandungan</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Ringkasan</label>
                                        <textarea id="article-summary" class="form-control" rows="2" placeholder="Ringkasan singkat artikel (akan tampil di preview)"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Konten Artikel</label>
                                        <ul class="nav nav-tabs" id="articleContentTabs">
                                            <li class="nav-item">
                                                <a class="nav-link active" data-toggle="tab" href="#editor-tab">
                                                    <i class="fas fa-edit"></i> Editor
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" data-toggle="tab" href="#preview-tab">
                                                    <i class="fas fa-eye"></i> Preview
                                                </a>
                                            </li>
                                        </ul>
                                        <div class="tab-content border border-top-0 p-3">
                                            <div class="tab-pane fade show active" id="editor-tab">
                                                <textarea id="article-content" class="form-control" rows="15" placeholder="Tulis konten artikel di sini... Mendukung Markdown.

Contoh Markdown:
# Heading 1
## Heading 2
**Bold text**
*Italic text*
- List item
[Link](https://example.com)"></textarea>
                                            </div>
                                            <div class="tab-pane fade" id="preview-tab">
                                                <div id="article-preview" class="p-3" style="min-height: 400px; background-color: #f8f9fa; border-radius: 4px;">
                                                    <p class="text-muted"><i>Preview akan muncul di sini...</i></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Sumber</label>
                                                <input type="text" id="article-source" class="form-control" placeholder="Sumber atau referensi">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Icon</label>
                                                <select id="article-icon" class="form-control">
                                                    <option value="fa-heartbeat">Heartbeat</option>
                                                    <option value="fa-baby">Baby</option>
                                                    <option value="fa-utensils">Makanan</option>
                                                    <option value="fa-apple-alt">Buah</option>
                                                    <option value="fa-exclamation-triangle">Peringatan</option>
                                                    <option value="fa-stethoscope">Stethoscope</option>
                                                    <option value="fa-hospital">Hospital</option>
                                                    <option value="fa-calendar-check">Kalender</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Warna</label>
                                                <input type="color" id="article-color" class="form-control" value="#28a7e9">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="article-published">
                                            <label class="custom-control-label" for="article-published">Publish langsung</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="saveArticle()">
                                    <i class="fas fa-save mr-1"></i> Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PROFILE SETTINGS PAGE -->
                <div id="profile-settings-page" class="d-none">
                    <div class="row">
                        <!-- Profile Info Card -->
                        <div class="col-md-4">
                            <div class="card card-primary card-outline">
                                <div class="card-body box-profile">
                                    <div class="text-center">
                                        <div class="profile-avatar mb-3 position-relative" style="display: inline-block;">
                                            <img id="profile-avatar-img" src="" alt="Profile Picture" class="img-circle elevation-2" style="width: 120px; height: 120px; object-fit: cover; display: none;">
                                            <i id="profile-avatar-icon" class="fas fa-user-circle fa-5x text-primary"></i>
                                            <div class="profile-avatar-overlay" style="position: absolute; bottom: 0; right: 0;">
                                                <label for="profile-picture-input" class="btn btn-primary btn-sm rounded-circle" style="width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                    <i class="fas fa-camera"></i>
                                                </label>
                                                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                                            </div>
                                        </div>
                                        <h3 class="profile-username text-center" id="profile-display-name">-</h3>
                                        <p class="text-muted text-center" id="profile-display-email">-</p>
                                    </div>
                                    <hr>
                                    <strong><i class="fas fa-id-badge mr-1"></i> User ID</strong>
                                    <p class="text-muted" id="profile-display-uid">-</p>
                                    
                                    <strong><i class="fas fa-calendar-alt mr-1"></i> Member Since</strong>
                                    <p class="text-muted" id="profile-display-created">-</p>
                                    
                                    <strong><i class="fas fa-clock mr-1"></i> Last Login</strong>
                                    <p class="text-muted" id="profile-display-lastlogin">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Profile Card -->
                        <div class="col-md-8">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user-edit mr-2"></i>Edit Profile</h3>
                                </div>
                                <form id="profile-form">
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="profile-displayname">Display Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="profile-displayname" placeholder="Nama yang ditampilkan" required>
                                            <small class="form-text text-muted">Nama ini akan muncul di navbar dan laporan</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="profile-email">Email</label>
                                            <input type="email" class="form-control" id="profile-email" readonly disabled>
                                            <small class="form-text text-muted">Email tidak dapat diubah</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Profile Picture</label>
                                            <div class="d-flex align-items-center">
                                                <div id="profile-picture-preview" class="mr-3">
                                                    <img id="profile-picture-preview-img" src="" alt="Preview" class="img-circle elevation-2" style="width: 80px; height: 80px; object-fit: cover; display: none;">
                                                    <i id="profile-picture-preview-icon" class="fas fa-user-circle fa-4x text-muted"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('profile-picture-input').click()">
                                                        <i class="fas fa-upload mr-1"></i>Upload Photo
                                                    </button>
                                                    <button type="button" class="btn btn-danger btn-sm ml-2" id="remove-profile-picture-btn" style="display: none;">
                                                        <i class="fas fa-trash mr-1"></i>Remove
                                                    </button>
                                                    <div class="mt-2">
                                                        <small class="text-muted">Max 2MB. Format: JPG, PNG, GIF</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        <h5 class="mb-3"><i class="fas fa-key mr-2"></i>Change Password</h5>
                                        
                                        <div class="form-group">
                                            <label for="profile-current-password">Current Password</label>
                                            <input type="password" class="form-control" id="profile-current-password" placeholder="Masukkan password saat ini" autocomplete="current-password">
                                            <small class="form-text text-muted">Diperlukan untuk mengubah password</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="profile-new-password">New Password</label>
                                            <input type="password" class="form-control" id="profile-new-password" placeholder="Password baru (min. 6 karakter)" autocomplete="new-password">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="profile-confirm-password">Confirm New Password</label>
                                            <input type="password" class="form-control" id="profile-confirm-password" placeholder="Konfirmasi password baru" autocomplete="new-password">
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle mr-2"></i>
                                            <strong>Tips Keamanan:</strong>
                                            <ul class="mb-0 mt-2">
                                                <li>Gunakan minimal 6 karakter</li>
                                                <li>Kombinasi huruf besar, kecil, dan angka</li>
                                                <li>Jangan gunakan password yang mudah ditebak</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save mr-2"></i>Save Changes
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showDashboardPage(); return false;">
                                            <i class="fas fa-times mr-2"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Account Security Card -->
                            <div class="card card-warning">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-shield-alt mr-2"></i>Account Security</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="info-box bg-light">
                                                <span class="info-box-icon"><i class="fas fa-lock"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">Password Strength</span>
                                                    <span class="info-box-number" id="profile-password-strength">Strong</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="info-box bg-light">
                                                <span class="info-box-icon"><i class="fas fa-sign-in-alt"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">Login Method</span>
                                                    <span class="info-box-number">Email/Password</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pengaturan Page (Superadmin Only) -->
                <div id="pengaturan-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary card-outline">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-cogs mr-2"></i>Edit Tindakan</h3>
                                </div>
                                <div class="card-body">
                                    <!-- Add New Tindakan Form -->
                                    <div class="card card-success mb-4">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0"><i class="fas fa-plus-circle mr-2"></i>Tambah Tindakan Baru</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="add-tindakan-form">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="form-group">
                                                            <label for="tindakan-name">Nama Tindakan <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="tindakan-name" placeholder="Contoh: Konsultasi" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label for="tindakan-category">Kategori <span class="text-danger">*</span></label>
                                                            <select class="form-control" id="tindakan-category" required>
                                                                <option value="">Pilih Kategori</option>
                                                                <option value="ADMINISTRATIF">Administratif</option>
                                                                <option value="LAYANAN">Layanan</option>
                                                                <option value="TINDAKAN MEDIS">Tindakan Medis</option>
                                                                <option value="KONTRASEPSI">Kontrasepsi</option>
                                                                <option value="VAKSINASI">Vaksinasi</option>
                                                                <option value="LABORATORIUM">Laboratorium</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label for="tindakan-price">Harga (Rp) <span class="text-danger">*</span></label>
                                                            <input type="number" class="form-control" id="tindakan-price" placeholder="50000" min="0" required>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="form-group">
                                                            <label>&nbsp;</label>
                                                            <button type="submit" class="btn btn-success btn-block">
                                                                <i class="fas fa-plus mr-1"></i>Tambah
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Search and Filter -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="tindakan-search" placeholder="Cari tindakan...">
                                                <div class="input-group-append">
                                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-control" id="tindakan-filter-category">
                                                <option value="">Semua Kategori</option>
                                                <option value="ADMINISTRATIF">Administratif</option>
                                                <option value="LAYANAN">Layanan</option>
                                                <option value="TINDAKAN MEDIS">Tindakan Medis</option>
                                                <option value="KONTRASEPSI">Kontrasepsi</option>
                                                <option value="VAKSINASI">Vaksinasi</option>
                                                <option value="LABORATORIUM">Laboratorium</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="d-flex justify-content-end align-items-center">
                                                <span class="badge badge-info badge-lg p-2 mr-2">
                                                    <i class="fas fa-list mr-1"></i>Total: <span id="tindakan-total-count">0</span>
                                                </span>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="downloadTindakanPriceList()" title="Download PDF Daftar Harga">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tindakan List Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th width="5%">#</th>
                                                    <th width="35%">Nama Tindakan</th>
                                                    <th width="20%">Kategori</th>
                                                    <th width="20%">Harga</th>
                                                    <th width="20%" class="text-center">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tindakan-list-body">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                        <p>Memuat data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kelola Pasien Page -->
                <div id="manage-patients-page" class="d-none">
                    <!-- Advanced Search Card -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card card-outline card-info">
                                <div class="card-header compact">
                                    <h3 class="card-title"><i class="fas fa-search mr-2"></i>Pencarian Lanjutan</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <form id="advanced-search-form">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Nama Pasien</label>
                                                    <input type="text" id="adv-search-name" class="form-control form-control-sm" placeholder="Cari nama...">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>ID Pasien</label>
                                                    <input type="text" id="adv-search-id" class="form-control form-control-sm" placeholder="DRD0001">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>MR ID</label>
                                                    <input type="text" id="adv-search-mr" class="form-control form-control-sm" placeholder="MR-...">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Email</label>
                                                    <input type="text" id="adv-search-email" class="form-control form-control-sm" placeholder="email@...">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Umur</label>
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" id="adv-search-age-min" class="form-control" placeholder="Min" min="0" max="150">
                                                        <div class="input-group-append input-group-prepend">
                                                            <span class="input-group-text">-</span>
                                                        </div>
                                                        <input type="number" id="adv-search-age-max" class="form-control" placeholder="Max" min="0" max="150">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>No. HP</label>
                                                    <input type="text" id="adv-search-phone" class="form-control form-control-sm" placeholder="08...">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>No. WhatsApp</label>
                                                    <input type="text" id="adv-search-whatsapp" class="form-control form-control-sm" placeholder="08...">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Nama Suami</label>
                                                    <input type="text" id="adv-search-husband" class="form-control form-control-sm" placeholder="Nama suami...">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Tanggal Periksa</label>
                                                    <input type="date" id="adv-search-visit-date" class="form-control form-control-sm">
                                                </div>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <div class="form-group mb-0 w-100">
                                                    <button type="submit" class="btn btn-primary btn-sm mr-2">
                                                        <i class="fas fa-search mr-1"></i>Cari
                                                    </button>
                                                    <button type="button" class="btn btn-secondary btn-sm" onclick="resetAdvancedSearch()">
                                                        <i class="fas fa-undo mr-1"></i>Reset
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-users mr-2"></i>Kelola Pasien</h3>
                                    <div class="card-tools">
                                        <span id="adv-search-result-count" class="badge badge-light mr-2"></span>
                                        <button type="button" class="btn btn-warning btn-sm mr-2" onclick="fixPatientNames()" title="Perbaiki kapitalisasi nama pasien (RAHAYU  Rahayu)">
                                            <i class="fas fa-magic mr-1"></i>Auto-Fix Nama
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="manage-patients-table" class="table table-bordered table-striped table-sm">
                                            <thead>
                                                <tr>
                                                    <th>ID Pasien</th>
                                                    <th>MR ID</th>
                                                    <th>Nama Lengkap</th>
                                                    <th>HPL</th>
                                                    <th>Tipe</th>
                                                    <th>Status Resume</th>
                                                    <th>Tgl Registrasi</th>
                                                    <th>Status</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="manage-patients-tbody">
                                                <tr>
                                                    <td colspan="9" class="text-center">Memuat data...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kelola Obat Page (Superadmin Only) -->
                <div id="kelola-obat-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-success">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-pills mr-2"></i>Kelola Obat, Vial & Alkes</h3>
                                </div>
                                <div class="card-body">
                                    <!-- Form Tambah/Edit Obat -->
                                    <form id="kelola-obat-form" class="mb-4">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Nama Obat/Item</label>
                                                    <input type="text" id="kelola-obat-name" class="form-control" placeholder="Contoh: Paracetamol 500mg" required>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Kategori</label>
                                                    <select id="kelola-obat-category" class="form-control" required>
                                                        <option value="">Pilih Kategori</option>
                                                        <option value="Obat-obatan">Obat-obatan</option>
                                                        <option value="Ampul & Vial">Ampul & Vial</option>
                                                        <option value="Alkes">Alkes</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Supplier</label>
                                                    <select id="kelola-obat-supplier" class="form-control">
                                                        <option value="">Pilih Supplier</option>
                                                        <!-- Loaded dynamically -->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Harga (Rp)</label>
                                                    <input type="number" id="kelola-obat-price" class="form-control" placeholder="0" min="0" required>
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                <div class="form-group">
                                                    <label>Stok Awal</label>
                                                    <input type="number" id="kelola-obat-stock" class="form-control" placeholder="0" min="0" value="0">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>&nbsp;</label>
                                                    <button type="submit" class="btn btn-success btn-block">
                                                        <i class="fas fa-plus mr-1"></i>Tambah
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Row 2: Harga Beli & Diskon -->
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Harga Beli (Rp)</label>
                                                    <input type="number" id="kelola-obat-cost-price" class="form-control" placeholder="0" min="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Diskon Distributor</label>
                                                    <input type="text" id="kelola-obat-discount" class="form-control" placeholder="Contoh: 10% atau Rp 5.000">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block mt-4">
                                                    <i class="fas fa-info-circle"></i> Harga beli & diskon untuk referensi, tidak mempengaruhi perhitungan penjualan.
                                                </small>
                                            </div>
                                        </div>
                                    </form>

                                    <!-- Search & Filter -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" id="kelola-obat-search" class="form-control" placeholder=" Cari obat...">
                                        </div>
                                        <div class="col-md-4">
                                            <select id="kelola-obat-filter-category" class="form-control">
                                                <option value="">Semua Kategori</option>
                                                <option value="Obat-obatan">Obat-obatan</option>
                                                <option value="Ampul & Vial">Ampul & Vial</option>
                                                <option value="Alkes">Alkes</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="d-flex justify-content-end align-items-center">
                                                <span class="badge badge-success badge-lg p-2 mr-2">
                                                    Total: <span id="kelola-obat-total-count">0</span>
                                                </span>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="downloadObatPriceList()" title="Download PDF Daftar Harga">
                                                    <i class="fas fa-file-pdf"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table List Obat -->
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped table-hover table-sm">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th width="40">#</th>
                                                    <th>Nama Obat/Item</th>
                                                    <th width="120">Kategori</th>
                                                    <th width="120">Supplier</th>
                                                    <th width="100">Harga Jual</th>
                                                    <th width="80">Stok</th>
                                                    <th width="150" class="text-center">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="kelola-obat-list-body">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                        <p class="mb-0">Memuat data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kelola Supplier Page -->
                <div id="kelola-supplier-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-info">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-truck mr-2"></i>Kelola Supplier</h3>
                                </div>
                                <div class="card-body">
                                    <!-- Form Tambah/Edit Supplier -->
                                    <form id="kelola-supplier-form" class="mb-4">
                                        <input type="hidden" id="kelola-supplier-id">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>Nama Supplier</label>
                                                    <input type="text" id="kelola-supplier-name" class="form-control" placeholder="Nama supplier" required>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    <label>Telepon</label>
                                                    <input type="text" id="kelola-supplier-phone" class="form-control" placeholder="08xxx">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Alamat</label>
                                                    <input type="text" id="kelola-supplier-address" class="form-control" placeholder="Alamat lengkap">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label>&nbsp;</label>
                                                    <div class="btn-group btn-block">
                                                        <button type="submit" class="btn btn-info">
                                                            <i class="fas fa-plus mr-1"></i>Tambah
                                                        </button>
                                                        <button type="button" class="btn btn-secondary" onclick="resetSupplierForm()">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>

                                    <!-- Table List Supplier -->
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped table-hover table-sm">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th width="80">Kode</th>
                                                    <th>Nama Supplier</th>
                                                    <th width="120">Telepon</th>
                                                    <th>Alamat</th>
                                                    <th width="120" class="text-center">Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="kelola-supplier-list-body">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                        <p class="mb-0">Memuat data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Log Page -->
                <div id="activity-log-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-info">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-history mr-2"></i>Log Aktivitas Obat</h3>
                                    <div class="card-tools">
                                        <span class="badge badge-light" id="activity-log-count">0 records</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Filters -->
                                    <div class="row mb-3">
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Dari Tanggal</label>
                                                <input type="date" id="activity-log-start-date" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Sampai Tanggal</label>
                                                <input type="date" id="activity-log-end-date" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Tipe</label>
                                                <select id="activity-log-type" class="form-control form-control-sm">
                                                    <option value="">Semua</option>
                                                    <option value="purchase">Masuk (Purchase)</option>
                                                    <option value="sale">Keluar (Sale)</option>
                                                    <option value="adjustment">Penyesuaian</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">User</label>
                                                <select id="activity-log-user" class="form-control form-control-sm">
                                                    <option value="">Semua User</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Cari Obat</label>
                                                <input type="text" id="activity-log-search" class="form-control form-control-sm" placeholder="Nama obat...">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">&nbsp;</label>
                                                <button type="button" class="btn btn-info btn-sm btn-block" onclick="loadActivityLog()">
                                                    <i class="fas fa-search mr-1"></i>Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Summary Cards -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="small-box bg-success">
                                                <div class="inner">
                                                    <h4 id="activity-total-in">0</h4>
                                                    <p>Total Masuk</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-arrow-down"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="small-box bg-danger">
                                                <div class="inner">
                                                    <h4 id="activity-total-out">0</h4>
                                                    <p>Total Keluar</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-arrow-up"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="small-box bg-warning">
                                                <div class="inner">
                                                    <h4 id="activity-total-adjust">0</h4>
                                                    <p>Penyesuaian</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-balance-scale"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="small-box bg-info">
                                                <div class="inner">
                                                    <h4 id="activity-total-value">Rp 0</h4>
                                                    <p>Total Nilai</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-money-bill"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table -->
                                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                        <table class="table table-bordered table-striped table-hover table-sm">
                                            <thead class="bg-light sticky-top">
                                                <tr>
                                                    <th width="140">Waktu</th>
                                                    <th>Obat</th>
                                                    <th width="100" class="text-center">Tipe</th>
                                                    <th width="80" class="text-center">Qty</th>
                                                    <th width="100" class="text-right">Harga</th>
                                                    <th width="100" class="text-right">Total</th>
                                                    <th>Batch</th>
                                                    <th>Supplier</th>
                                                    <th>Oleh</th>
                                                    <th>Catatan</th>
                                                </tr>
                                            </thead>
                                            <tbody id="activity-log-body">
                                                <tr>
                                                    <td colspan="10" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                        <p class="mb-0">Memuat data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="text-muted small" id="activity-log-pagination-info">Showing 0 of 0</div>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0" id="activity-log-pagination"></ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Activity Page -->
                <div id="staff-activity-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user-clock mr-2"></i>Log Aktivitas Staff</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" onclick="loadStaffActivityLogs()">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Summary Cards -->
                                    <div class="row mb-3" id="staff-activity-summary">
                                        <div class="col-md-3">
                                            <div class="info-box bg-info">
                                                <span class="info-box-icon"><i class="fas fa-clock"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">Total Aktivitas (7 hari)</span>
                                                    <span class="info-box-number" id="staff-activity-total">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="info-box bg-success">
                                                <span class="info-box-icon"><i class="fas fa-users"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">Staff Aktif</span>
                                                    <span class="info-box-number" id="staff-activity-users">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card card-outline card-warning mb-0">
                                                <div class="card-header compact">
                                                    <h5 class="card-title text-sm">Staff Teraktif</h5>
                                                </div>
                                                <div class="card-body py-2" id="staff-activity-top-users">
                                                    <span class="text-muted">Memuat...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filters -->
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Filter Staff</label>
                                                <select id="staff-activity-user-filter" class="form-control form-control-sm">
                                                    <option value="">Semua Staff</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Filter Aksi</label>
                                                <select id="staff-activity-action-filter" class="form-control form-control-sm">
                                                    <option value="">Semua Aksi</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Dari</label>
                                                <input type="date" id="staff-activity-start-date" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">Sampai</label>
                                                <input type="date" id="staff-activity-end-date" class="form-control form-control-sm">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group mb-0">
                                                <label class="small text-muted">&nbsp;</label>
                                                <button type="button" class="btn btn-info btn-sm btn-block" onclick="loadStaffActivityLogs()">
                                                    <i class="fas fa-filter"></i> Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Activity Table -->
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover table-striped">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th style="width:160px">Waktu</th>
                                                    <th style="width:150px">Staff</th>
                                                    <th style="width:150px">Aksi</th>
                                                    <th>Detail</th>
                                                </tr>
                                            </thead>
                                            <tbody id="staff-activity-body">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-4">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                                        <p class="mb-0">Memuat data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="text-muted small" id="staff-activity-pagination-info">Menampilkan 0 dari 0</div>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0" id="staff-activity-pagination"></ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOTIFICATIONS PAGE -->
                <div id="notifications-page" class="d-none">
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h3 class="card-title"><i class="fas fa-bell mr-2"></i>Semua Notifikasi</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-sm btn-outline-primary mr-2" onclick="loadNotificationsPage()">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsReadPage()">
                                            <i class="fas fa-check-double"></i> Tandai Semua Dibaca
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Staff Announcements Section -->
                                    <div id="staff-announcements-section" class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0"><i class="fas fa-bullhorn text-warning mr-2"></i>Pengumuman Staff</h5>
                                            <button type="button" class="btn btn-sm btn-primary dokter-only d-none" onclick="showCreateStaffAnnouncement()">
                                                <i class="fas fa-plus"></i> Buat Pengumuman
                                            </button>
                                        </div>
                                        <div id="staff-announcements-list">
                                            <div class="text-center py-3 text-muted">
                                                <i class="fas fa-spinner fa-spin"></i> Memuat pengumuman...
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="mb-4">

                                    <!-- Stats Cards -->
                                    <div class="row mb-4">
                                        <div class="col-lg-3 col-6">
                                            <div class="small-box bg-primary">
                                                <div class="inner">
                                                    <h3 id="notif-stat-unread">0</h3>
                                                    <p>Belum Dibaca</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-envelope"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="small-box bg-success">
                                                <div class="inner">
                                                    <h3 id="notif-stat-read">0</h3>
                                                    <p>Sudah Dibaca</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-envelope-open"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="small-box bg-info">
                                                <div class="inner">
                                                    <h3 id="notif-stat-announcements">0</h3>
                                                    <p>Pengumuman</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-bullhorn"></i></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-6">
                                            <div class="small-box bg-secondary">
                                                <div class="inner">
                                                    <h3 id="notif-stat-total">0</h3>
                                                    <p>Total Notifikasi</p>
                                                </div>
                                                <div class="icon"><i class="fas fa-bell"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filter Tabs -->
                                    <ul class="nav nav-tabs mb-3" id="notification-tabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" href="#" data-filter="all" onclick="filterNotifications('all'); return false;">
                                                <i class="fas fa-list mr-1"></i> Semua
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-filter="unread" onclick="filterNotifications('unread'); return false;">
                                                <i class="fas fa-envelope mr-1"></i> Belum Dibaca
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-filter="notification" onclick="filterNotifications('notification'); return false;">
                                                <i class="fas fa-bell mr-1"></i> Notifikasi
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="#" data-filter="announcement" onclick="filterNotifications('announcement'); return false;">
                                                <i class="fas fa-bullhorn mr-1"></i> Pengumuman
                                            </a>
                                        </li>
                                    </ul>

                                    <!-- Notification List -->
                                    <div id="notifications-page-list">
                                        <div class="text-center py-5">
                                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                            <p class="mt-2 text-muted">Memuat notifikasi...</p>
                                        </div>
                                    </div>

                                    <!-- Pagination -->
                                    <div class="d-flex justify-content-between align-items-center mt-3" id="notifications-pagination-container" style="display: none !important;">
                                        <div class="text-muted small">
                                            Menampilkan <span id="notif-showing-start">0</span> - <span id="notif-showing-end">0</span> dari <span id="notif-showing-total">0</span> notifikasi
                                        </div>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0" id="notifications-pagination"></ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Announcement Modal -->
                <div class="modal fade" id="modal-staff-announcement" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="modal-staff-announcement-title">Buat Pengumuman Staff</h5>
                                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                            </div>
                            <div class="modal-body">
                                <form id="form-staff-announcement">
                                    <input type="hidden" id="staff-announcement-id">
                                    <div class="form-group">
                                        <label>Judul <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="staff-announcement-title" required placeholder="Judul pengumuman...">
                                    </div>
                                    <div class="form-group">
                                        <label>Isi Pengumuman <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="staff-announcement-message" rows="5" required placeholder="Isi pengumuman..."></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Prioritas</label>
                                                <select class="form-control" id="staff-announcement-priority">
                                                    <option value="normal">Normal</option>
                                                    <option value="important">Penting</option>
                                                    <option value="urgent">Urgent</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Status</label>
                                                <select class="form-control" id="staff-announcement-status">
                                                    <option value="active">Aktif</option>
                                                    <option value="inactive">Nonaktif</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                                <button type="button" class="btn btn-primary" onclick="saveStaffAnnouncement()">
                                    <i class="fas fa-save"></i> Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shared Summary (movable) -->
                <div id="total-summary-container" class="d-none bg-light border-top" style="position:sticky; bottom:0; z-index:1000;">
                    <div class="container-fluid py-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-1">Rincian Total</h5>
                                <p class="text-muted small mb-0">Pasien: <span id="patientNameDisplay" class="font-weight-bold"></span></p>
                            </div>
                            <button id="resetObatButton" class="btn btn-sm btn-danger">Reset Obat</button>
                        </div>
                        <div id="summary-tindakan-section" class="mb-3">
                            <h6 class="font-weight-bold">Layanan & Tindakan</h6>
                            <div id="summary-tindakan-list" class="border rounded p-2" style="max-height:120px; overflow-y:auto; background:white;"></div>
                        </div>
                        <h6 class="font-weight-bold">Obat & Alkes</h6>
                        <div class="border rounded p-2 mb-3" style="max-height:150px; overflow-y:auto; background:white;">
                            <div class="d-none d-sm-flex font-weight-bold small text-muted mb-2 pb-2 border-bottom">
                                <div class="col-5">Nama Item</div>
                                <div class="col-2">Jumlah</div>
                                <div class="col-2 text-right">Harga</div>
                                <div class="col-3 text-right">Subtotal</div>
                            </div>
                            <div id="selected-obat-list" class="small"></div>
                        </div>
                        <div class="border-top pt-3">
                            <div class="d-flex flex-column small mb-2">
                                <div class="d-flex justify-content-between mb-1"><span class="text-muted">Total Biaya Tindakan:</span><span id="subtotalTindakanDisplay" class="font-weight-bold">Rp 0</span></div>
                                <div class="d-flex justify-content-between mb-1"><span class="text-muted">Total Biaya Obat & Alkes:</span><span id="subtotalObatDisplay" class="font-weight-bold">Rp 0</span></div>
                                <div class="d-flex justify-content-between h4 border-top pt-2 mt-2 mb-0"><span>GRAND TOTAL:</span><span id="grandTotalDisplay" class="text-primary">Rp 0</span></div>
                            </div>
                            <div id="summary-buttons" class="d-flex flex-wrap gap-2 justify-content-end">
                                <button id="backToTindakanBtn" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left mr-1"></i> Kembali</button>
                                <button id="finalize-bill-btn-2" class="btn btn-success btn-sm d-none">Selesaikan & Siap Cetak</button>
                                <button id="print-etiket-btn-2" class="btn btn-secondary btn-sm">Cetak Etiket</button>
                                <button id="print-invoice-2" class="btn btn-primary btn-sm">Cetak Invoice</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <footer class="main-footer">
        <strong>&copy; 2025 dokterDIBYA.</strong> All rights reserved.
        <div class="float-right d-none d-sm-inline-block"><b>Version</b> 1.0</div>
    </footer>
</div>


<!-- Kelola Pengumuman Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Buat Pengumuman Baru</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="announcementForm">
                    <input type="hidden" id="announcementId">
                    <div class="form-group">
                        <label for="title">Judul Pengumuman *</label>
                        <input type="text" class="form-control" id="title" required maxlength="255">
                    </div>
                    <div class="form-group">
                        <label>Gambar (opsional)</label>
                        <div class="custom-file mb-2">
                            <input type="file" class="custom-file-input" id="imageFile" accept="image/jpeg,image/png,image/gif,image/webp">
                            <label class="custom-file-label" for="imageFile" id="imageFileLabel">Pilih gambar...</label>
                        </div>
                        <div id="imageUploadProgress" class="progress mb-2" style="display: none; height: 5px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                        <div id="imagePreviewContainer" class="mb-2" style="display: none;">
                            <img id="imagePreview" src="" class="img-fluid rounded" style="max-height: 150px;">
                            <button type="button" class="btn btn-sm btn-danger ml-2" onclick="removeAnnouncementImage()">
                                <i class="fas fa-times"></i> Hapus
                            </button>
                        </div>
                        <input type="hidden" id="imageUrl">
                        <small class="text-muted">Format: JPG, PNG, GIF, WebP. Maks 5MB</small>
                    </div>
                    <div class="form-group">
                        <label for="contentType">Tipe Konten</label>
                        <select class="form-control" id="contentType">
                            <option value="plain">Teks Biasa</option>
                            <option value="markdown">Markdown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message">Pesan *</label>
                        <textarea class="form-control" id="message" rows="8" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="priority">Prioritas</label>
                                <select class="form-control" id="priority">
                                    <option value="normal">Normal</option>
                                    <option value="important">Penting</option>
                                    <option value="urgent">Mendesak</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select class="form-control" id="status">
                                    <option value="active">Aktif</option>
                                    <option value="inactive">Tidak Aktif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btn-save">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Kelola Appointment Modals -->
<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detail Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- Detail content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Update Status Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="status-appointment-id">
                <div class="form-group">
                    <label for="status-select">Status</label>
                    <select id="status-select" class="form-control">
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="no_show">No Show</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-notes">Catatan (Opsional)</label>
                    <textarea id="status-notes" class="form-control" rows="3" placeholder="Contoh: Pasien konfirmasi via WhatsApp"></textarea>
                </div>
                <div class="form-group" id="status-cancel-reason-group" style="display: none;">
                    <label for="status-cancel-reason">Alasan Pembatalan <span class="text-danger">*</span></label>
                    <textarea id="status-cancel-reason" class="form-control" rows="3" placeholder="Contoh: Pasien tidak dapat hadir karena sakit"></textarea>
                    <small class="form-text text-muted">Isikan alasan ketika mengubah status menjadi Cancelled.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="updateStatus()">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="toast-container"></div>

<!-- Chat feature now handled by chat-popup.js -->

<!-- Appointment Modal -->
<div class="modal fade" id="appointment-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title" id="appointment-modal-title">
                    <i class="fas fa-calendar-plus mr-2"></i>Tambah Appointment Baru
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <input type="hidden" id="appointment-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointment-patient-select">Pasien <span class="text-danger">*</span></label>
                                <select class="form-control" id="appointment-patient-select" required>
                                    <option value="">Pilih pasien...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointment-type">Jenis Appointment <span class="text-danger">*</span></label>
                                <select class="form-control" id="appointment-type" required>
                                    <option value="Konsultasi">Konsultasi</option>
                                    <option value="Kontrol">Kontrol</option>
                                    <option value="USG">USG</option>
                                    <option value="Imunisasi">Imunisasi</option>
                                    <option value="Lainnya">Lainnya</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointment-date">Tanggal <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="appointment-date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="appointment-time">Waktu <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" id="appointment-time" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="appointment-reminder">Reminder</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="appointment-reminder">
                                    <label class="form-check-label" for="appointment-reminder">
                                        Kirim WhatsApp reminder
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appointment-notes">Catatan</label>
                        <textarea class="form-control" id="appointment-notes" rows="3" placeholder="Catatan tambahan..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="window.saveAppointment()">
                    <i class="fas fa-save mr-1"></i>Simpan
                </button>
            </div>
        </div>
    </div>
 </div>
</div>

<!-- Kelola Jadwal Modal Add/Edit -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Tambah Jadwal</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="schedule-id">
                <div class="form-group">
                    <label>Lokasi <span class="text-danger">*</span></label>
                    <select class="form-control" id="schedule-location">
                        <option value="">-- Pilih Lokasi --</option>
                        <option value="klinik_privat">Klinik Privat Minggu</option>
                        <option value="rsud_gambiran">Poli RSUD Gambiran Kediri</option>
                        <option value="rsia_melinda">Poli RSIA Melinda Kediri</option>
                        <option value="rs_bhayangkara">Poli RS Bhayangkara Kediri</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Hari <span class="text-danger">*</span></label>
                    <select class="form-control" id="schedule-day">
                        <option value="">-- Pilih Hari --</option>
                        <option value="0">Minggu</option>
                        <option value="1">Senin</option>
                        <option value="2">Selasa</option>
                        <option value="3">Rabu</option>
                        <option value="4">Kamis</option>
                        <option value="5">Jumat</option>
                        <option value="6">Sabtu</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Jam Mulai <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="schedule-start">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Jam Selesai <span class="text-danger">*</span></label>
                            <input type="time" class="form-control" id="schedule-end">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Keterangan</label>
                    <textarea class="form-control" id="schedule-notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="schedule-active" checked>
                        <label class="custom-control-label" for="schedule-active">Aktif</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Disabled Practice Date Modal -->
<div class="modal fade" id="disabledDateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-calendar-times mr-2"></i>Nonaktifkan Tanggal Praktek</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tanggal <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="disabled-date" required>
                </div>
                <div class="form-group">
                    <label>Lokasi</label>
                    <select class="form-control" id="disabled-location">
                        <option value="">Semua Lokasi</option>
                        <option value="klinik_privat">Klinik Privat Minggu</option>
                        <option value="rsud_gambiran">Poli RSUD Gambiran Kediri</option>
                        <option value="rsia_melinda">Poli RSIA Melinda Kediri</option>
                        <option value="rs_bhayangkara">Poli RS Bhayangkara Kediri</option>
                    </select>
                    <small class="text-muted">Kosongkan untuk menonaktifkan semua lokasi</small>
                </div>
                <div class="form-group">
                    <label>Alasan</label>
                    <textarea class="form-control" id="disabled-reason" rows="2" placeholder="Contoh: Dokter ada acara, cuti, dll"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-warning" onclick="saveDisabledDate()">
                    <i class="fas fa-calendar-times"></i> Nonaktifkan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Menu Functions - MUST be before the buttons -->
<script>
function openMobileMenu() {
    // Remove existing if any
    var existing = document.getElementById('dynamic-mobile-menu');
    if(existing) existing.remove();

    // Create menu dynamically with inline styles
    var menu = document.createElement('div');
    menu.id = 'dynamic-mobile-menu';
    menu.innerHTML = '<div onclick="closeMobileMenu()" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999999;"></div>' +
        '<div style="position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:20px 20px 0 0;max-height:70vh;overflow-y:auto;z-index:10000000;box-shadow:0 -4px 20px rgba(0,0,0,0.3);">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #eee;">' +
        '<span style="font-weight:600;font-size:16px;color:#333;">Menu Lainnya</span>' +
        '<button onclick="closeMobileMenu()" style="background:none;border:none;font-size:24px;color:#666;padding:4px 8px;">&times;</button>' +
        '</div>' +
        '<div style="padding:8px 0 16px 0;">' +
        '<a href="#" onclick="closeMobileMenu();if(typeof showKelolaPengumumanPage===\'function\')showKelolaPengumumanPage();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#333;text-decoration:none;font-size:14px;"><i class="fas fa-bullhorn" style="width:24px;font-size:18px;color:#0d6efd;text-align:center;"></i> Pengumuman</a>' +
        '<a href="#" onclick="closeMobileMenu();if(typeof showKelolaJadwalPage===\'function\')showKelolaJadwalPage();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#333;text-decoration:none;font-size:14px;"><i class="fas fa-calendar-alt" style="width:24px;font-size:18px;color:#0d6efd;text-align:center;"></i> Jadwal</a>' +
        '<a href="#" onclick="closeMobileMenu();if(typeof showKelolaTindakanPage===\'function\')showKelolaTindakanPage();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#333;text-decoration:none;font-size:14px;"><i class="fas fa-stethoscope" style="width:24px;font-size:18px;color:#0d6efd;text-align:center;"></i> Tindakan</a>' +
        '<a href="#" onclick="closeMobileMenu();if(typeof showKelolaObatManagementPage===\'function\')showKelolaObatManagementPage();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#333;text-decoration:none;font-size:14px;"><i class="fas fa-pills" style="width:24px;font-size:18px;color:#0d6efd;text-align:center;"></i> Obat</a>' +
        '<a href="#" onclick="closeMobileMenu();if(typeof showKelolaRolesPage===\'function\')showKelolaRolesPage();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#333;text-decoration:none;font-size:14px;"><i class="fas fa-user-shield" style="width:24px;font-size:18px;color:#0d6efd;text-align:center;"></i> Roles</a>' +
        '<div style="height:1px;background:#eee;margin:8px 20px;"></div>' +
        '<a href="#" onclick="closeMobileMenu();if(typeof handleLogout===\'function\')handleLogout();return false;" style="display:flex;align-items:center;gap:14px;padding:14px 20px;color:#dc3545;text-decoration:none;font-size:14px;"><i class="fas fa-sign-out-alt" style="width:24px;font-size:18px;color:#dc3545;text-align:center;"></i> Logout</a>' +
        '</div></div>';

    document.body.appendChild(menu);
    document.body.style.overflow = 'hidden';
}
function closeMobileMenu() {
    var m = document.getElementById('dynamic-mobile-menu');
    if(m) m.remove();
    document.body.style.overflow = '';
}
function mobileNavClick(btn, action) {
    document.querySelectorAll('#mobile-action-bar button:not(.mobile-profile-btn)').forEach(function(b){b.classList.remove('active');});
    if(btn && action !== 'profile' && action !== 'more') btn.classList.add('active');
}
</script>

<!-- Force mobile action bar visible in mobile-app-mode -->
<style>
body.mobile-app-mode .mobile-action-bar-force {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    z-index: 999999 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    pointer-events: auto !important;
}
body.mobile-app-mode .mobile-action-bar-force button {
    pointer-events: auto !important;
    cursor: pointer !important;
    -webkit-tap-highlight-color: rgba(0,0,0,0.2) !important;
}
</style>

<!-- Mobile quick action bar - matches sidebar menu -->
<div id="mobile-action-bar" class="d-md-none d-lg-none mobile-action-bar-force">
    <button type="button" class="mobile-profile-btn" onclick="if(typeof showProfileSettings==='function')showProfileSettings();">
        <span class="icon-wrapper profile-avatar">
            <img id="mobile-user-avatar" src="" alt="" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            <i id="mobile-user-icon" class="fas fa-user"></i>
        </span>
        <span id="mobile-user-name">Profil</span>
    </button>
    <button type="button" class="active" onclick="mobileNavClick(this,'dashboard'); if(typeof showDashboardPage==='function')showDashboardPage();">
        <span class="icon-wrapper"><i class="fas fa-tachometer-alt"></i></span>
        <span>Home</span>
    </button>
    <button type="button" onclick="mobileNavClick(this,'klinik'); if(typeof showKlinikPrivatePage==='function')showKlinikPrivatePage();">
        <span class="icon-wrapper"><i class="fas fa-clinic-medical"></i></span>
        <span>Klinik</span>
    </button>
    <button type="button" onclick="mobileNavClick(this,'pasien'); if(typeof showManagePatientsPage==='function')showManagePatientsPage();">
        <span class="icon-wrapper"><i class="fas fa-users"></i></span>
        <span>Pasien</span>
    </button>
    <button type="button" onclick="mobileNavClick(this,'appointment'); if(typeof showKelolaAppointmentPage==='function')showKelolaAppointmentPage();">
        <span class="icon-wrapper"><i class="fas fa-calendar-check"></i></span>
        <span>Janji</span>
    </button>
    <button type="button" onclick="openMobileMenu();">
        <span class="icon-wrapper"><i class="fas fa-bars"></i></span>
        <span>Menu</span>
    </button>
</div>

<!-- Mobile More Menu Overlay -->
<div id="mobile-more-menu" style="display:none; background:#fff;">
    <div class="mobile-menu-overlay" onclick="closeMobileMenu();"></div>
    <div class="mobile-menu-content">
        <div class="mobile-menu-header">
            <span>Menu Lainnya</span>
            <button onclick="closeMobileMenu();"><i class="fas fa-times"></i></button>
        </div>
        <div class="mobile-menu-items">
            <a href="#" onclick="closeMobileMenu(); if(typeof showKelolaPengumumanPage==='function')showKelolaPengumumanPage(); return false;">
                <i class="fas fa-bullhorn"></i> Pengumuman
            </a>
            <a href="#" onclick="closeMobileMenu(); if(typeof showKelolaJadwalPage==='function')showKelolaJadwalPage(); return false;">
                <i class="fas fa-calendar-alt"></i> Jadwal
            </a>
            <a href="#" onclick="closeMobileMenu(); if(typeof showKelolaTindakanPage==='function')showKelolaTindakanPage(); return false;">
                <i class="fas fa-stethoscope"></i> Tindakan
            </a>
            <a href="#" onclick="closeMobileMenu(); if(typeof showKelolaObatManagementPage==='function')showKelolaObatManagementPage(); return false;">
                <i class="fas fa-pills"></i> Obat
            </a>
            <a href="#" onclick="closeMobileMenu(); if(typeof showKelolaRolesPage==='function')showKelolaRolesPage(); return false;">
                <i class="fas fa-user-shield"></i> Roles
            </a>
            <a href="#" class="superadmin-menu-item d-none" onclick="closeMobileMenu(); if(typeof showFinanceAnalysisPage==='function')showFinanceAnalysisPage(); return false;">
                <i class="fas fa-chart-line"></i> Finance
            </a>
            <a href="#" class="superadmin-menu-item d-none" onclick="closeMobileMenu(); if(typeof showBookingSettingsPage==='function')showBookingSettingsPage(); return false;">
                <i class="fas fa-calendar-day"></i> Pengaturan Sesi
            </a>
            <div class="mobile-menu-divider"></div>
            <a href="#" id="pwa-install-btn" style="display:none;" onclick="closeMobileMenu(); installPWA(); return false;">
                <i class="fas fa-download"></i> Install Aplikasi
            </a>
            <a href="#" class="text-danger" onclick="closeMobileMenu(); if(typeof handleLogout==='function')handleLogout(); return false;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
</div>

<!-- Chat sounds (always play) -->
<audio id="chat-send-sound" src="/staff/public/sounds/send.mp3" preload="auto"></audio>
<audio id="chat-incoming-sound" src="/staff/public/sounds/incoming.mp3" preload="auto"></audio>


<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<!-- ApexCharts for Finance Analysis -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<!-- Markdown parser and HTML sanitizer for announcements -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- SweetAlert2 for dialogs -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Core app modules -->
<script>
    // Dynamic cache busting - force reload on every page load
    const cacheBuster = Date.now();
    // Note: mobile-menu.js and mobile-action-bar.js are no longer loaded
    // Mobile navigation is now handled by inline functions in the HTML above
</script>

<!-- Global Debug Function for Appointments - Available Immediately -->
<script>
    // Set up debug function immediately (before modules load) - DISABLED
    window.debugAppointments_DISABLED_2 = function() {
        console.log(' [DEBUG] ===== APPOINTMENTS DEBUG (Global) - DISABLED =====');
        
        // Basic checks that don't require the module
        const btn = document.getElementById('btn-add-appointment');
        const modal = document.getElementById('appointment-modal');
        const appointmentsPage = document.getElementById('appointments-page');
        
        console.log(' [DEBUG] Basic DOM checks:');
        console.log('  - Button exists?', !!btn);
        console.log('  - Modal exists?', !!modal);
        console.log('  - Appointments page exists?', !!appointmentsPage);
        console.log('  - Appointments page visible?', appointmentsPage && !appointmentsPage.classList.contains('d-none'));
        console.log('  - window.openNewAppointment type:', typeof window.openNewAppointment);
        console.log('  - jQuery available?', typeof $ !== 'undefined');
        console.log('  - Bootstrap modal available?', typeof $ !== 'undefined' && $.fn.modal);
        
        if (btn) {
            console.log(' [DEBUG] Button details:');
            console.log('  - ID:', btn.id);
            console.log('  - Text:', btn.textContent);
            console.log('  - onclick:', btn.onclick);
            console.log('  - parent:', btn.parentNode);
            console.log('  - disabled?', btn.disabled);
            console.log('  - style.display:', btn.style.display);
            console.log('  - style.visibility:', btn.style.visibility);
            console.log('  - computed style:', window.getComputedStyle(btn).display);
            
            // Check for event listeners (if possible)
            console.log(' [DEBUG] Trying to check event listeners...');
            try {
                const listeners = typeof getEventListeners !== 'undefined' ? getEventListeners(btn) : 'getEventListeners not available (Chrome DevTools)';
                console.log('  - Event listeners:', listeners);
            } catch (e) {
                console.log('  - Cannot check event listeners (use Chrome DevTools)');
            }
        }
        
        // If the module is loaded, try to call openNewAppointment
        if (typeof window.openNewAppointment === 'function') {
            console.log(' [DEBUG] Module appears to be loaded (window.openNewAppointment exists)');
            console.log(' [DEBUG] Attempting to manually trigger modal...');
            try {
                window.openNewAppointment();
            } catch (err) {
                console.error(' [DEBUG] Error calling openNewAppointment:', err);
            }
        } else {
            console.warn(' [DEBUG] Appointments module not loaded yet');
            console.warn(' [DEBUG] Navigate to the appointments page first, then try again');
        }
        
        console.log(' [DEBUG] ===== END DEBUG (Global) =====');
        
        return {
            buttonExists: !!btn,
            modalExists: !!modal,
            pageExists: !!appointmentsPage,
            pageVisible: appointmentsPage && !appointmentsPage.classList.contains('d-none'),
            functionExists: typeof window.openNewAppointment === 'function',
            jqueryExists: typeof $ !== 'undefined'
        };
    };
    
    console.log(' window.debugAppointments is now available globally');
</script>

<script type="module">
    // Dynamic cache busting for all imports
    const v = Date.now();
    window.__assetVersion = v;
    
    // Import modules with cache buster
    const { auth, getIdToken } = await import('./scripts/vps-auth-v2.js?v=' + v);
    // Expose auth and getIdToken globally for chat-popup.js
    window.auth = auth;
    window.getIdToken = getIdToken;
    await import('./scripts/toast.js?v=' + v); // Toast notification system
    const { initMain } = await import('./scripts/main.js?v=' + v);
    const { initBilling } = await import('./scripts/billing.js?v=' + v);
    const { initDashboard } = await import('./scripts/dashboard.js?v=' + v);
    const { initAuth } = await import('./scripts/auth.js?v=' + v);
    const { initFinanceDashboard } = await import('./scripts/finance-dashboard.js?v=' + v);
    const { initAnalyticsDashboard } = await import('./scripts/analytics.js?v=' + v);
    await import('./scripts/medical-exam.js?v=' + v); // Medical examination pages
    // Chat is now handled by chat-popup.js loaded at bottom of page
    const { initPatients } = await import('./scripts/patients.js?v=' + v);
    // initCashier now loaded dynamically when Cashier page is opened
    const { initSessionManager, restoreSessionOnLoad } = await import('./scripts/session-manager.js?v=' + v);
    const { initRealtimeSync } = await import('./scripts/realtime-sync.js?v=' + v);
    
    // Wait for auth to initialize before checking state
    const { initAuth: initAuthLib, fetchMe } = await import('./scripts/vps-auth-v2.js?v=' + v);
    await initAuthLib(); // Wait for auth initialization to complete
    
    // Now check authentication
    const user = auth.currentUser; // Use the already set currentUser
    if (!user) {
        // Not logged in, redirect to login page
        window.location.replace('login.html');
    } else {
        // User is logged in, initialize app
        initializeApp(user);
    }
    
    function initializeApp(user) {
        // Initialize core UI (pages, clock, navigation)
        try {
            initMain();
        } catch (error) {
            console.error(' Error initializing main:', error);
        }

        // Initialize feature areas
        try {
            initAuth();
        } catch (error) {
            console.error(' Error initializing auth UI:', error);
        }

        try {
            initSessionManager();
        } catch (error) {
            console.error(' Error initializing session manager:', error);
        }

        // initBilling(); - Now loaded dynamically when Tindakan/Obat pages are opened
        try {
            initDashboard();
        } catch (error) {
            console.error(' Error initializing dashboard:', error);
        }

        // Load current registration code for dashboard
        try {
            if (typeof loadDashboardCurrentCode === 'function') {
                loadDashboardCurrentCode();
            }
        } catch (error) {
            console.error(' Error loading dashboard code:', error);
        }

        if (user.role === 'superadmin') {
            try {
                initFinanceDashboard();
            } catch (error) {
                console.error(' Error initializing finance dashboard:', error);
            }

            try {
                initAnalyticsDashboard(); // Finance page charts
            } catch (error) {
                console.error(' Error initializing analytics dashboard:', error);
            }
        }

        try {
            initPatients();
        } catch (error) {
            console.error(' Error initializing patients:', error);
        }

        // Chat is now handled by chat-popup.js loaded at bottom of page
        // initCashier() - Now loaded dynamically when Cashier page is opened

        // Real-time sync is now initialized in main.js via onAuthStateChanged
        // This ensures single socket connection and proper cleanup on auth state changes
        console.log(' Real-time sync will be initialized by main.js');

        // Restore session if exists
        try {
            restoreSessionOnLoad().then(session => {
                if (session && session.patient) {
                    console.log(' Session restored for patient:', session.patient.name);
                    // TODO: Restore UI state based on session data
                }
            }).catch(error => {
                console.warn(' Session restore failed (non-critical):', error);
            });
        } catch (error) {
            console.error(' Session restoration setup failed:', error);
        }

        console.log(' AdminLTE app initialized successfully');
    }
 </script>

 <!-- Socket.IO initialization for chat -->
 <script>
    // Validate required functions are loaded before proceeding
    const requiredFunctions = [
        'showDashboardPage',
        'showKlinikPrivatePage',
        'showFinanceAnalysisPage',
        'showKelolaPasienPage',
        'showKelolaPengumumanPage',
        'showKelolaAppointmentPage',
        'showKelolaJadwalPage',
        'showKelolaTindakanPage',
        'showKelolaObatManagementPage',
        'showLogPage',
        'showPatientPage'
    ];

    // Check which functions are available
    const missingFunctions = [];
    requiredFunctions.forEach(fn => {
        if (typeof window[fn] !== 'function') {
            missingFunctions.push(fn);
        }
    });

    if (missingFunctions.length > 0) {
        console.warn(' Warning: Some navigation functions not yet loaded:', missingFunctions);
        console.log('This is normal - they will be available once their modules load');
    } else {
        console.log(' All required navigation functions are available');
    }

    // Socket.IO is now initialized via initRealtimeSync() which handles user registration
    // The socket is available as window.socket after initRealtimeSync completes
    
    // Global helper to hide floating panel
    window.hideFloatingPanel = function() {
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel && !floatingPanel.classList.contains('d-none')) {
            console.log('Hiding floating panel');
            floatingPanel.classList.add('d-none');
        }
    };

    // Helper function to get valid token
    window.getValidToken = function() {
        const token = localStorage.getItem('vps_auth_token');
        if (!token) {
            console.error(' No authentication token found');
            alert('Sesi Anda telah habis. Silakan login kembali.');
            window.location.replace('login.html');
            return null;
        }
        return token;
    };

    // Safe fetch wrapper with token validation
    window.safeFetch = async function(url, options = {}) {
        try {
            const token = window.getValidToken();
            if (!token) return null;

            // Add auth header if not already present
            if (!options.headers) options.headers = {};
            if (!options.headers['Authorization']) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, options);

            if (response.status === 401) {
                console.error(' Unauthorized - token expired');
                localStorage.removeItem('vps_auth_token');
                alert('Token Anda telah kadaluarsa. Silakan login kembali.');
                window.location.replace('login.html');
                return null;
            }

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            return response;
        } catch (error) {
            console.error(' Fetch error:', error);
            throw error;
        }
    };
    
    // Intercept all navigation clicks to hide floating panel except Kelola Pasien
    document.addEventListener('click', function(e) {
        const navLink = e.target.closest('.nav-link');
        if (navLink && navLink.getAttribute('onclick')) {
            const onclickValue = navLink.getAttribute('onclick');
            const isKelolaPasienNav = onclickValue.includes('showManagePatientsPage') || onclickValue.includes('showKelolaPasienPage');
            // Only hide if NOT navigating to Kelola Pasien page
            if (!isKelolaPasienNav) {
                setTimeout(() => hideFloatingPanel(), 100);
            }
        }
    });
    
    // Watch for page changes and hide floating panel if not on Kelola Pasien page
    const pageObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                const target = mutation.target;
                // If manage-patients-page becomes hidden, hide the floating panel
                if (target.id === 'manage-patients-page' && target.classList.contains('d-none')) {
                    setTimeout(() => hideFloatingPanel(), 50);
                }
            }
        });
    });
    
    // Start observing when DOM is ready
    setTimeout(() => {
        const managePatientsPage = document.getElementById('manage-patients-page');
        if (managePatientsPage) {
            pageObserver.observe(managePatientsPage, { attributes: true, attributeFilter: ['class'] });
        }
    }, 1000);
    
    // Manage Web Patients Page Functions
    window.showManagePatientsPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show manage patients page
        document.getElementById('manage-patients-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const kelolaPasienNav = document.querySelector('#nav-kelola-pasien .nav-link');
        if (kelolaPasienNav) {
            kelolaPasienNav.classList.add('active');
        }

        const titleEl = document.getElementById('page-title');
        if (titleEl) {
            titleEl.textContent = 'Kelola Pasien';
        }
        document.dispatchEvent(new CustomEvent('page:changed', {
            detail: { page: 'kelola-pasien' }
        }));

        // Show floating panel (only for superadmin)
        const userRole = localStorage.getItem('vps_user_role');
        if (userRole === 'superadmin') {
            const floatingPanel = document.getElementById('floating-kelola-pasien');
            if (floatingPanel) {
                floatingPanel.classList.remove('d-none');
            }
        }

        // Load patients data
        loadNewPatients(1);
        loadWebPatients();
    };

    // ==================== Medical Import Functions ====================
    let parsedImportData = null;

    window.openImportModal = function() {
        resetImportModal();
        $('#import-medical-modal').modal('show');
    };

    window.openBulkImportModal = function() {
        resetBulkImportModal();
        $('#bulk-import-modal').modal('show');
    };

    // Auto-fix patient names to proper title case
    window.fixPatientNames = async function() {
        const confirmed = await Swal.fire({
            title: 'Auto-Fix Nama Pasien?',
            html: `
                <p>Fungsi ini akan memperbaiki kapitalisasi nama pasien:</p>
                <ul class="text-left" style="font-size: 0.9rem;">
                    <li><strong>RAHAYU</strong>  <strong>Rahayu</strong></li>
                    <li><strong>perama indah hapsari</strong>  <strong>Perama Indah Hapsari</strong></li>
                    <li><strong>sITI AMINAH</strong>  <strong>Siti Aminah</strong></li>
                </ul>
                <p class="text-warning mt-2"><i class="fas fa-exclamation-triangle"></i> Proses ini tidak bisa dibatalkan!</p>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-magic mr-1"></i>Ya, Perbaiki',
            cancelButtonText: 'Batal',
            confirmButtonColor: '#f0ad4e'
        });

        if (!confirmed.isConfirmed) return;

        // Show loading
        Swal.fire({
            title: 'Memproses...',
            html: 'Memperbaiki nama pasien...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const token = getAuthToken();
            const response = await fetch('/api/patients/fix-names', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                // Show results
                let changesHtml = '';
                if (data.changes && data.changes.length > 0) {
                    changesHtml = `
                        <div class="mt-3" style="max-height: 200px; overflow-y: auto; text-align: left; font-size: 0.85rem;">
                            <table class="table table-sm table-bordered">
                                <thead><tr><th>ID</th><th>Sebelum</th><th>Sesudah</th></tr></thead>
                                <tbody>
                                    ${data.changes.map(c => `<tr><td>${c.id}</td><td>${c.before}</td><td class="text-success">${c.after}</td></tr>`).join('')}
                                </tbody>
                            </table>
                            ${data.updatedCount > 50 ? `<p class="text-muted">...dan ${data.updatedCount - 50} lainnya</p>` : ''}
                        </div>
                    `;
                }

                await Swal.fire({
                    title: 'Berhasil!',
                    html: `<p>${data.message}</p>${changesHtml}`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                // Reload patient list if function exists
                if (typeof loadPatientsForManage === 'function') {
                    loadPatientsForManage();
                }
            } else {
                throw new Error(data.message || 'Failed to fix names');
            }
        } catch (error) {
            console.error('Fix names error:', error);
            Swal.fire({
                title: 'Gagal!',
                text: error.message || 'Terjadi kesalahan saat memperbaiki nama',
                icon: 'error'
            });
        }
    };

    function resetImportModal() {
        const categoryEl = document.getElementById('import-category');
        const textEl = document.getElementById('import-text');
        const fileEl = document.getElementById('import-file');
        const step1 = document.getElementById('import-step-1');
        const step2 = document.getElementById('import-step-2');
        const parseBtn = document.getElementById('btn-import-parse');
        const backBtn = document.getElementById('btn-import-back');
        const applyBtn = document.getElementById('btn-import-apply');

        if (categoryEl) categoryEl.value = '';
        if (textEl) textEl.value = '';
        if (fileEl) fileEl.value = '';
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        if (parseBtn) parseBtn.style.display = 'inline-block';
        if (backBtn) backBtn.style.display = 'none';
        if (applyBtn) applyBtn.style.display = 'none';
        parsedImportData = null;
    }

    function resetBulkImportModal() {
        const filesInput = document.getElementById('bulk-import-files');
        if (filesInput) filesInput.value = '';
        const resultsContainer = document.getElementById('bulk-import-results');
        if (resultsContainer) resultsContainer.innerHTML = '';
        const progressContainer = document.getElementById('bulk-import-progress');
        if (progressContainer) progressContainer.style.display = 'none';
        window.bulkImportResults = null;
    }

    window.importMedicalParse = async function() {
        const category = document.getElementById('import-category').value;
        const text = document.getElementById('import-text').value.trim();

        if (!category) { alert('Silakan pilih kategori terlebih dahulu'); return; }
        if (!text) { alert('Silakan masukkan teks catatan medis atau upload file'); return; }

        const parseBtn = document.getElementById('btn-import-parse');
        const originalText = parseBtn.innerHTML;
        parseBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Parsing...';
        parseBtn.disabled = true;

        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/medical-import/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ text, category })
            });
            const result = await response.json();
            parseBtn.innerHTML = originalText;
            parseBtn.disabled = false;

            if (!result.success) { alert('Gagal parsing: ' + result.message); return; }

            parsedImportData = result.data;
            showImportPreview(result.data);
        } catch (error) {
            console.error('Import error:', error);
            alert('Error: ' + error.message);
            parseBtn.innerHTML = originalText;
            parseBtn.disabled = false;
        }
    };

    function showImportPreview(data) {
        const template = data.template;

        // Load patients for selector
        loadPatientsForImport();

        renderVisitInfoSection(data);
        document.getElementById('preview-identitas').innerHTML = renderPreviewSection(template.identitas, {
            nama: 'Nama', jenis_kelamin: 'Jenis Kelamin', tanggal_lahir: 'Tanggal Lahir', alamat: 'Alamat', no_hp: 'No HP'
        });
        document.getElementById('preview-anamnesa').innerHTML = renderPreviewSection(template.anamnesa, {
            keluhan_utama: 'Keluhan Utama', riwayat_penyakit_sekarang: 'RPS', riwayat_penyakit_dahulu: 'RPD'
        });
        document.getElementById('preview-pemeriksaan').innerHTML = renderPreviewSection(template.pemeriksaan_fisik, {
            keadaan_umum: 'Keadaan Umum', tekanan_darah: 'Tekanan Darah', nadi: 'Nadi', suhu: 'Suhu'
        });
        document.getElementById('preview-diagnosis').innerHTML = renderPreviewSection(template.diagnosis, {
            diagnosis_utama: 'Diagnosis'
        });

        const confidence = data.confidence;
        const confidenceEl = document.getElementById('import-confidence');
        confidenceEl.textContent = `Confidence: ${confidence.percentage}% (${confidence.score}/${confidence.total} fields)`;
        confidenceEl.className = `badge ${confidence.percentage >= 70 ? 'badge-success' : confidence.percentage >= 40 ? 'badge-warning' : 'badge-danger'}`;

        document.getElementById('import-step-1').style.display = 'none';
        document.getElementById('import-step-2').style.display = 'block';
        document.getElementById('btn-import-parse').style.display = 'none';
        document.getElementById('btn-import-back').style.display = 'inline-block';
        document.getElementById('btn-import-apply').style.display = 'inline-block';
    }

    function renderVisitInfoSection(data) {
        const container = document.getElementById('preview-visit-info');
        if (!container) return;
        const locationOptions = {
            'klinik_private': 'Klinik Privat', 'rsia_melinda': 'RSIA Melinda',
            'rsud_gambiran': 'RSUD Gambiran', 'rs_bhayangkara': 'RS Bhayangkara'
        };
        // Default to today's date if not detected
        const today = new Date().toISOString().split('T')[0];
        const visitDate = data.visit_date || today;

        let html = '<div class="row">';
        // Date
        html += '<div class="col-md-4"><div class="form-group mb-2">';
        html += '<label class="small font-weight-bold"><i class="fas fa-calendar-alt mr-1"></i>Tanggal';
        html += data.visit_date_detected ? ' <span class="badge badge-success badge-sm">Terdeteksi</span>' : '';
        html += `</label><input type="date" class="form-control form-control-sm" id="import-visit-date" value="${visitDate}">`;
        html += '</div></div>';
        // Time
        html += '<div class="col-md-3"><div class="form-group mb-2">';
        html += '<label class="small font-weight-bold"><i class="fas fa-clock mr-1"></i>Jam</label>';
        html += '<input type="time" class="form-control form-control-sm" id="import-visit-time" value="09:00">';
        html += '</div></div>';
        // Location
        html += '<div class="col-md-5"><div class="form-group mb-2">';
        html += '<label class="small font-weight-bold"><i class="fas fa-hospital mr-1"></i>Lokasi';
        html += data.visit_location_detected ? ' <span class="badge badge-success badge-sm">Terdeteksi</span>' : '';
        html += '</label><select class="form-control form-control-sm" id="import-visit-location">';
        for (const [v, l] of Object.entries(locationOptions)) {
            html += `<option value="${v}" ${data.visit_location === v ? 'selected' : ''}>${l}</option>`;
        }
        html += '</select></div></div></div>';
        container.innerHTML = html;
    }

    // Load patients for import selector
    async function loadPatientsForImport() {
        const select = document.getElementById('import-patient-select');
        if (!select) return;

        try {
            const token = localStorage.getItem('token') || localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/patients?limit=500', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const result = await response.json();

            if (result.success && result.data) {
                const patients = result.data.patients || result.data;
                select.innerHTML = '<option value="">-- Pilih Pasien --</option>';

                patients.forEach(p => {
                    const patientId = p.id || p.patient_id;
                    const name = p.full_name || p.name || 'Unknown';
                    const option = document.createElement('option');
                    option.value = patientId;
                    option.textContent = `${patientId} - ${name}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading patients for import:', error);
            select.innerHTML = '<option value="">-- Gagal memuat pasien --</option>';
        }
    }

    function renderPreviewSection(data, labels) {
        if (!data) return '<p class="text-muted small">Tidak ada data</p>';
        let html = '<div class="preview-fields">';
        let hasData = false;
        for (const [key, label] of Object.entries(labels)) {
            const value = data[key];
            if (value !== null && value !== undefined && value !== '') {
                hasData = true;
                const escaped = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                html += `<div class="custom-control custom-checkbox mb-1">
                    <input type="checkbox" class="custom-control-input" id="import-${key}" checked data-field="${key}">
                    <label class="custom-control-label small" for="import-${key}"><strong>${label}:</strong> ${escaped}</label>
                </div>`;
            }
        }
        html += '</div>';
        return hasData ? html : '<p class="text-muted small">Tidak ada data terdeteksi</p>';
    }

    window.importMedicalBack = function() {
        document.getElementById('import-step-1').style.display = 'block';
        document.getElementById('import-step-2').style.display = 'none';
        document.getElementById('btn-import-parse').style.display = 'inline-block';
        document.getElementById('btn-import-back').style.display = 'none';
        document.getElementById('btn-import-apply').style.display = 'none';
    };

    window.importMedicalApply = async function() {
        if (!parsedImportData) { alert('Tidak ada data untuk diterapkan'); return; }

        const patientSelect = document.getElementById('import-patient-select');
        const patientId = patientSelect?.value;

        if (!patientId) {
            alert('Silakan pilih pasien terlebih dahulu');
            patientSelect?.focus();
            return;
        }

        const visitDate = document.getElementById('import-visit-date')?.value;
        const visitTime = document.getElementById('import-visit-time')?.value || '09:00';
        const visitLocation = document.getElementById('import-visit-location')?.value || 'klinik_private';
        const category = document.getElementById('import-category')?.value || 'obstetri';

        // Get checked fields
        const checkedFields = {};
        document.querySelectorAll('#import-step-2 input[type="checkbox"]:checked').forEach(cb => {
            checkedFields[cb.dataset.field] = true;
        });

        const applyBtn = document.getElementById('btn-import-apply');
        const originalBtnText = applyBtn?.innerHTML;

        try {
            if (applyBtn) {
                applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Membuat MR...';
                applyBtn.disabled = true;
            }

            // Create new MR via API
            const token = localStorage.getItem('token') || localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/sunday-clinic/start-walk-in', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    patient_id: patientId,
                    category: category,
                    location: visitLocation
                })
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || 'Gagal membuat MR baru');
            }

            const newMR = result.data;
            console.log('[Import] Created new MR:', newMR.mrId);

            // Store parsed data in sessionStorage to apply after navigation
            const importDataToApply = {
                template: parsedImportData.template,
                checkedFields: checkedFields,
                visitDate: visitDate,
                visitTime: visitTime,
                visitLocation: visitLocation
            };
            sessionStorage.setItem('pendingImportData', JSON.stringify(importDataToApply));

            // Close modal
            $('#import-medical-modal').modal('hide');
            resetImportModal();

            // Show success and navigate
            if (window.Swal) {
                await Swal.fire({
                    icon: 'success',
                    title: 'MR Berhasil Dibuat',
                    html: `MR ID: <strong>${newMR.mrId}</strong><br>Mengalihkan ke form rekam medis...`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }

            // Navigate to sunday-clinic with the new MR
            window.location.href = `/sunday-clinic/${newMR.mrId}/identity`;

        } catch (error) {
            console.error('Import apply error:', error);
            if (applyBtn) {
                applyBtn.innerHTML = originalBtnText;
                applyBtn.disabled = false;
            }
            alert('Error: ' + error.message);
        }
    };

    // Bulk import functions
    window.handleBulkFilesSelect = async function(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        if (files.length > 50) { alert('Maksimal 50 file'); return; }

        const category = document.getElementById('bulk-import-category')?.value || 'obstetri';
        const defaultLocation = document.getElementById('bulk-import-location')?.value || '';
        const progressContainer = document.getElementById('bulk-import-progress');
        const progressBar = document.getElementById('bulk-import-progress-bar');
        const progressText = document.getElementById('bulk-import-progress-text');

        if (progressContainer) progressContainer.style.display = 'block';

        const records = [];
        for (let i = 0; i < files.length; i++) {
            const text = await readFileAsText(files[i]);
            records.push({ text, filename: files[i].name, category });
            if (progressBar) progressBar.style.width = `${((i + 1) / files.length) * 50}%`;
            if (progressText) progressText.textContent = `Membaca file ${i + 1}/${files.length}...`;
        }

        if (progressText) progressText.textContent = 'Memproses data...';

        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/medical-import/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ records, default_category: category, default_location: defaultLocation })
            });
            const result = await response.json();
            if (progressBar) progressBar.style.width = '100%';
            if (progressText) progressText.textContent = 'Selesai!';
            if (!result.success) { alert('Gagal: ' + result.message); return; }
            window.bulkImportResults = result.data;
            displayBulkImportResults(result.data, files);
        } catch (error) {
            console.error('Bulk import error:', error);
            alert('Error: ' + error.message);
        }
    };

    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    function displayBulkImportResults(data, files) {
        const container = document.getElementById('bulk-import-results');
        if (!container) return;
        const locationLabels = { 'klinik_private': 'Klinik Privat', 'rsia_melinda': 'RSIA Melinda', 'rsud_gambiran': 'RSUD Gambiran', 'rs_bhayangkara': 'RS Bhayangkara' };
        let html = `<div class="alert alert-info"><strong>Hasil:</strong> ${data.successful} berhasil, ${data.failed} gagal dari ${data.total} file</div>`;
        html += '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="thead-light"><tr>';
        html += '<th><input type="checkbox" id="bulk-select-all" checked onchange="toggleBulkSelectAll(this)"></th>';
        html += '<th>File</th><th>Nama Pasien</th><th>Tanggal</th><th>Lokasi</th><th>Confidence</th></tr></thead><tbody>';
        data.results.forEach((r, idx) => {
            const fname = files[r.index]?.name || `Record ${r.index + 1}`;
            const dateClass = r.visit_date_detected ? 'text-success' : 'text-warning';
            const locClass = r.visit_location_detected ? 'text-success' : 'text-warning';
            html += `<tr><td><input type="checkbox" class="bulk-item-check" data-index="${idx}" checked></td>`;
            html += `<td class="small">${fname}</td><td>${r.patient_name || '-'}</td>`;
            html += `<td><input type="date" class="form-control form-control-sm bulk-visit-date" data-index="${idx}" value="${r.visit_date || ''}" style="max-width:130px;"><small class="${dateClass}">${r.visit_date_detected ? '(auto)' : '(manual)'}</small></td>`;
            html += `<td><select class="form-control form-control-sm bulk-visit-location" data-index="${idx}" style="max-width:130px;"><option value="">--</option>`;
            for (const [v, l] of Object.entries(locationLabels)) html += `<option value="${v}" ${r.visit_location === v ? 'selected' : ''}>${l}</option>`;
            html += `</select><small class="${locClass}">${r.visit_location_detected ? '(auto)' : '(manual)'}</small></td>`;
            html += `<td><span class="badge ${r.confidence.percentage >= 70 ? 'badge-success' : r.confidence.percentage >= 40 ? 'badge-warning' : 'badge-danger'}">${r.confidence.percentage}%</span></td></tr>`;
        });
        html += '</tbody></table></div>';
        html += '<div class="mt-3"><button class="btn btn-success" onclick="applyBulkImport()"><i class="fas fa-check mr-1"></i>Terapkan Terpilih</button></div>';
        container.innerHTML = html;
    }

    window.toggleBulkSelectAll = function(checkbox) {
        document.querySelectorAll('.bulk-item-check').forEach(cb => cb.checked = checkbox.checked);
    };

    window.applyBulkImport = function() {
        if (!window.bulkImportResults) { alert('Tidak ada data'); return; }
        const selected = [];
        document.querySelectorAll('.bulk-item-check:checked').forEach(cb => {
            const idx = parseInt(cb.dataset.index);
            const r = window.bulkImportResults.results[idx];
            if (r) {
                const dateInput = document.querySelector(`.bulk-visit-date[data-index="${idx}"]`);
                const locSelect = document.querySelector(`.bulk-visit-location[data-index="${idx}"]`);
                selected.push({ ...r, visit_date: dateInput?.value || r.visit_date, visit_location: locSelect?.value || r.visit_location });
            }
        });
        if (selected.length === 0) { alert('Pilih minimal 1 item'); return; }
        console.log('Selected records:', selected);
        $('#bulk-import-modal').modal('hide');
        resetBulkImportModal();
        if (window.Swal) {
            Swal.fire({ icon: 'success', title: 'Berhasil', text: `${selected.length} catatan berhasil di-parse.`, timer: 2000, showConfirmButton: false });
        } else {
            alert(`${selected.length} catatan berhasil di-parse`);
        }
    };

    // File input label update and file reading
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('custom-file-input')) {
            const label = e.target.nextElementSibling;
            if (label && e.target.files.length > 0) {
                label.textContent = e.target.files.length > 1 ? `${e.target.files.length} files selected` : e.target.files[0].name;
            }

            // Read file content into textarea for single import
            if (e.target.id === 'import-file' && e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(ev) {
                    document.getElementById('import-text').value = ev.target.result;
                };
                reader.onerror = function() {
                    alert('Gagal membaca file');
                };
                reader.readAsText(file);
            }
        }
    });
    // ==================== End Medical Import Functions ====================

    // Registrasi Pasien Page Functions
    let newPatientsCurrentPage = 1;
    let newPatientsTotalPages = 1;

    window.showRegistrasiPasienPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show registrasi pasien page
        document.getElementById('registrasi-pasien-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        const regPasienNav = document.querySelector('#nav-registrasi-pasien .nav-link');
        if (regPasienNav) {
            regPasienNav.classList.add('active');
        }

        const titleEl = document.getElementById('page-title');
        if (titleEl) {
            titleEl.textContent = 'Registrasi Pasien';
        }
        document.dispatchEvent(new CustomEvent('page:changed', {
            detail: { page: 'registrasi-pasien' }
        }));

        // Load new patients
        loadNewPatients();
    };

    async function loadNewPatients(page = 1) {
        try {
            newPatientsCurrentPage = page;
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch(`/api/patients?sort=recent&limit=10&page=${page}&_=${Date.now()}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load patients');

            const data = await response.json();
            const tbody = document.getElementById('new-patients-tbody');

            // Guard against null tbody
            if (!tbody) {
                console.warn('new-patients-tbody element not found');
                return;
            }

            // Update pagination info
            const pagination = data.pagination || { total: 0, page: 1, totalPages: 1 };
            newPatientsTotalPages = pagination.totalPages;
            const start = data.data && data.data.length > 0 ? ((page - 1) * 10) + 1 : 0;
            const end = start > 0 ? start + data.data.length - 1 : 0;

            const paginationInfo = document.getElementById('new-patients-pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = `Menampilkan ${start}-${end} dari ${pagination.total}`;
            }

            // Update button states
            const prevBtn = document.getElementById('new-patients-prev-btn');
            const nextBtn = document.getElementById('new-patients-next-btn');
            if (prevBtn) prevBtn.disabled = page <= 1;
            if (nextBtn) nextBtn.disabled = page >= newPatientsTotalPages;

            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada pasien terdaftar</td></tr>';
                return;
            }

            tbody.innerHTML = data.data.map(patient => {
                const regDate = patient.created_at ? (() => { const d = new Date(patient.created_at); return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear().toString().slice(-2)}`; })() : '-';

                return `
                    <tr>
                        <td><code class="font-weight-bold">${patient.id}</code></td>
                        <td>${patient.full_name || '-'}</td>
                        <td>${patient.whatsapp || patient.phone || '-'}</td>
                        <td>${regDate}</td>
                        <td>
                            <button class="btn btn-xs btn-info" onclick="viewPatientDetail('${patient.id}')" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Load new patients error:', error);
            const tbody = document.getElementById('new-patients-tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data</td></tr>';
            }
        }
    }
    window.loadNewPatients = loadNewPatients;

    // Format patient type from last visit for display
    function formatPatientType(type) {
        if (!type) return '<span class="badge badge-light">-</span>';
        const typeMap = {
            'obstetri': '<span class="badge badge-info">Obstetri</span>',
            'gyn_repro': '<span class="badge badge-purple" style="background:#9c27b0;color:#fff">Gyn Repro</span>',
            'gyn_special': '<span class="badge badge-warning">Gyn</span>'
        };
        return typeMap[type] || `<span class="badge badge-secondary">${type}</span>`;
    }
    window.formatPatientType = formatPatientType;

    async function loadWebPatients() {
        try {
            const token = localStorage.getItem('vps_auth_token');
            console.log('Loading all patients with token:', token ? 'Token exists' : 'No token found');
            console.log('Token length:', token ? token.length : 0);
            
            // Use unified patients endpoint
            const response = await fetch(`/api/patients?_=${Date.now()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('Error response:', errorData);
                throw new Error('Failed to load patients');
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            const tbody = document.getElementById('manage-patients-tbody');
            
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Tidak ada pasien</td></tr>';
                return;
            }
            
            // IMPORTANT: Destroy DataTable FIRST before modifying DOM
            if ($.fn.DataTable && $.fn.DataTable.isDataTable('#manage-patients-table')) {
                $('#manage-patients-table').DataTable().clear().destroy();
            }

            tbody.innerHTML = data.data.map(patient => {
                const birthDate = patient.birth_date ? new Date(patient.birth_date).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
                // Format date for display (DD/MM/YY) and sorting (YYYYMMDD)
                const regDate = patient.created_at ? (() => { const d = new Date(patient.created_at); return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear().toString().slice(-2)}`; })() : '-';
                const regDateSort = patient.created_at ? (() => { const d = new Date(patient.created_at); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`; })() : '0';
                // Resume status badge
                const resumeStatusMap = {
                    'sudah_kirim_usg_resume': '<span class="badge badge-success">USG + Resume </span>',
                    'sudah_kirim_resume': '<span class="badge badge-info">Resume </span>',
                    'sudah_simpan': '<span class="badge badge-warning">Tersimpan</span>',
                    'belum_generate': '<span class="badge badge-secondary">Belum Generate</span>'
                };
                const resumeStatusBadge = resumeStatusMap[patient.resume_status] || '<span class="badge badge-light">Pasien Baru</span>';
                const statusBadge = patient.status === 'active' ?
                    '<span class="badge badge-success">Aktif</span>' :
                    '<span class="badge badge-secondary">Nonaktif</span>';

                // MR ID with link to medical records
                const locationLabels = {
                    'klinik_private': 'Prv',
                    'rsia_melinda': 'Mel',
                    'rsud_gambiran': 'Gmb',
                    'rs_bhayangkara': 'Bhy'
                };
                const locationBadge = patient.visit_location
                    ? `<span class="badge badge-sm badge-info ml-1">${locationLabels[patient.visit_location] || '?'}</span>`
                    : '';
                const escapedName = (patient.full_name || '').replace(/'/g, "\\'");
                const mrIdCell = patient.mr_id
                    ? `<a href="sunday-clinic.html?patient=${patient.id}&mr=${patient.mr_id}" class="text-primary" title="Buka Rekam Medis">${patient.mr_id}</a>${locationBadge}`
                    : `<span class="text-muted">-</span>`;

                // HPL column with color coding for obstetri patients
                let hplCell = '-';
                if (patient.is_obstetri && patient.hpl && !patient.has_delivered) {
                    const hplDate = new Date(patient.hpl);
                    const hplFormatted = `${hplDate.getDate().toString().padStart(2,'0')}/${(hplDate.getMonth()+1).toString().padStart(2,'0')}/${hplDate.getFullYear().toString().slice(-2)}`;
                    const weeksPregnant = Math.floor(patient.days_pregnant / 7);

                    // Color coding: red for >40 weeks (280+ days), yellow for 37-40 weeks (259-279 days)
                    let bgClass = '';
                    let textClass = '';
                    let icon = '';
                    if (patient.days_pregnant >= 280) {
                        bgClass = 'bg-danger';
                        textClass = 'text-white';
                        icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
                    } else if (patient.days_pregnant >= 259) {
                        bgClass = 'bg-warning';
                        textClass = '';
                        icon = '<i class="fas fa-clock mr-1"></i>';
                    }

                    hplCell = `<span class="${bgClass} ${textClass} px-2 py-1 rounded" title="Usia kehamilan: ${weeksPregnant} minggu">${icon}${hplFormatted}</span>`;
                } else if (patient.has_delivered) {
                    hplCell = '<span class="badge badge-success"><i class="fas fa-baby mr-1"></i>Sudah Lahir</span>';
                }

                // Mark as delivered button (only for obstetri patients who haven't delivered)
                let deliveryButton = '';
                if (patient.is_obstetri && !patient.has_delivered) {
                    deliveryButton = `<button class="btn btn-sm btn-success" onclick="markAsDelivered('${patient.id}', '${escapedName}')" title="Tandai Sudah Melahirkan"><i class="fas fa-baby"></i></button>`;
                }

                return `
                    <tr>
                        <td><a href="#" class="text-primary" onclick="showPatientMRList('${patient.id}', '${(patient.full_name || '').replace(/'/g, "\\'")}'); return false;" title="Lihat Daftar Rekam Medis">${patient.id}</a></td>
                        <td>${mrIdCell}</td>
                        <td>${patient.full_name || '-'}</td>
                        <td>${hplCell}</td>
                        <td>${formatPatientType(patient.last_visit_type)}</td>
                        <td>${resumeStatusBadge}</td>
                        <td data-order="${regDateSort}">${regDate}</td>
                        <td>${statusBadge}</td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-info btn-view-patient" data-patient-id="${patient.id}" title="Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${deliveryButton}
                            <button class="btn btn-sm btn-${patient.status === 'active' ? 'warning' : 'success'}"
                                    onclick="togglePatientStatus('${patient.id}', '${patient.status}', '${patient.full_name}')"
                                    title="${patient.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}">
                                <i class="fas fa-${patient.status === 'active' ? 'ban' : 'check'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePatient('${patient.id}', '${patient.full_name}')" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Initialize DataTable with fresh data (already cleared before DOM update)
            if ($.fn.DataTable) {
                $('#manage-patients-table').DataTable({
                    "pageLength": 25,
                    "order": [[6, 'desc']], // Sort by registration date (column 6: Tgl Registrasi)
                    "searching": false // Disable built-in search, use advanced search only
                });
            }
            
            // Attach event listeners to view buttons
            document.querySelectorAll('.btn-view-patient').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    console.log('View button clicked for patient:', patientId);
                    viewPatientDetail(patientId);
                });
            });
            
            // Also update floating panel if it's visible
            const floatingPanel = document.getElementById('floating-kelola-pasien');
            if (floatingPanel && !floatingPanel.classList.contains('d-none') && typeof loadFloatingPanelPatients === 'function') {
                loadFloatingPanelPatients();
            }
            
        } catch (error) {
            console.error('Error loading web patients:', error);
            document.getElementById('manage-patients-tbody').innerHTML =
                '<tr><td colspan="9" class="text-center text-danger">Gagal memuat data pasien</td></tr>';
        }
    }

    // Advanced Search Functions
    let advancedSearchActive = false;

    // Debounce function for live search
    let searchDebounceTimer = null;
    function debounceSearch(delay = 300) {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            performAdvancedSearch();
        }, delay);
    }

    // Handle advanced search form submission and live search
    document.addEventListener('DOMContentLoaded', function() {
        const advSearchForm = document.getElementById('advanced-search-form');
        if (advSearchForm) {
            advSearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                performAdvancedSearch();
            });
        }

        // Live search - trigger search on typing (with debounce)
        const searchFields = [
            'adv-search-name',
            'adv-search-id',
            'adv-search-mr',
            'adv-search-email',
            'adv-search-phone',
            'adv-search-whatsapp',
            'adv-search-husband'
        ];

        searchFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    // Trigger search after 1 character minimum
                    if (this.value.length >= 1 || this.value.length === 0) {
                        debounceSearch(400); // 400ms delay for smoother UX
                    }
                });
            }
        });

        // For age fields, trigger on change
        ['adv-search-age-min', 'adv-search-age-max'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', function() {
                    debounceSearch(500);
                });
            }
        });
    });

    async function performAdvancedSearch() {
        try {
            const token = localStorage.getItem('vps_auth_token');
            const tbody = document.getElementById('manage-patients-tbody');
            const resultCount = document.getElementById('adv-search-result-count');

            // Show loading
            tbody.innerHTML = '<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Mencari...</td></tr>';

            // Collect search parameters
            const params = new URLSearchParams();

            const name = document.getElementById('adv-search-name')?.value;
            const id = document.getElementById('adv-search-id')?.value;
            const mr_id = document.getElementById('adv-search-mr')?.value;
            const email = document.getElementById('adv-search-email')?.value;
            const age_min = document.getElementById('adv-search-age-min')?.value;
            const age_max = document.getElementById('adv-search-age-max')?.value;
            const phone = document.getElementById('adv-search-phone')?.value;
            const whatsapp = document.getElementById('adv-search-whatsapp')?.value;
            const husband = document.getElementById('adv-search-husband')?.value;
            const visit_date = document.getElementById('adv-search-visit-date')?.value;

            if (name) params.append('name', name);
            if (id) params.append('id', id);
            if (mr_id) params.append('mr_id', mr_id);
            if (email) params.append('email', email);
            if (age_min) params.append('age_min', age_min);
            if (age_max) params.append('age_max', age_max);
            if (phone) params.append('phone', phone);
            if (whatsapp) params.append('whatsapp', whatsapp);
            if (husband) params.append('husband', husband);
            if (visit_date) params.append('visit_date', visit_date);
            params.append('limit', '100');

            // Check if any filter is applied
            const hasFilters = name || id || mr_id || email || age_min || age_max || phone || whatsapp || husband || visit_date;

            if (!hasFilters) {
                // No filters, load all patients
                loadWebPatients();
                if (resultCount) resultCount.textContent = '';
                advancedSearchActive = false;
                return;
            }

            advancedSearchActive = true;

            const response = await fetch(`/api/patients/search/advanced?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache'
                }
            });

            if (!response.ok) {
                throw new Error('Search failed');
            }

            const data = await response.json();

            // Debug logging
            console.log('[SEARCH DEBUG] Search params:', { name, id, mr_id, email, phone, whatsapp, husband });
            console.log('[SEARCH DEBUG] API Response:', data);
            if (data.data) {
                console.log('[SEARCH DEBUG] Results:', data.data.map(p => ({ id: p.id, name: p.full_name })));
            }

            // Update result count
            if (resultCount) {
                resultCount.textContent = `${data.total || data.count || 0} hasil ditemukan`;
            }

            // IMPORTANT: Destroy DataTable FIRST before modifying DOM
            if ($.fn.DataTable && $.fn.DataTable.isDataTable('#manage-patients-table')) {
                $('#manage-patients-table').DataTable().clear().destroy();
            }

            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Tidak ada pasien yang sesuai dengan kriteria pencarian</td></tr>';
                return;
            }

            // Render results
            tbody.innerHTML = data.data.map(patient => {
                const birthDate = patient.birth_date ? new Date(patient.birth_date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : '-';
                // Format date for display (DD/MM/YY) and sorting (YYYYMMDD)
                const regDate = patient.created_at ? (() => { const d = new Date(patient.created_at); return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear().toString().slice(-2)}`; })() : '-';
                const regDateSort = patient.created_at ? (() => { const d = new Date(patient.created_at); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}`; })() : '0';
                // Resume status badge
                const resumeStatusMap = {
                    'sudah_kirim_usg_resume': '<span class="badge badge-success">USG + Resume </span>',
                    'sudah_kirim_resume': '<span class="badge badge-info">Resume </span>',
                    'sudah_simpan': '<span class="badge badge-warning">Tersimpan</span>',
                    'belum_generate': '<span class="badge badge-secondary">Belum Generate</span>'
                };
                const resumeStatusBadge = resumeStatusMap[patient.resume_status] || '<span class="badge badge-light">Pasien Baru</span>';
                const statusBadge = patient.status === 'active' ?
                    '<span class="badge badge-success">Aktif</span>' :
                    '<span class="badge badge-secondary">Nonaktif</span>';

                // MR ID with link to medical records
                const locationLabels = {
                    'klinik_private': 'Prv',
                    'rsia_melinda': 'Mel',
                    'rsud_gambiran': 'Gmb',
                    'rs_bhayangkara': 'Bhy'
                };
                const locationBadge = patient.visit_location
                    ? `<span class="badge badge-sm badge-info ml-1">${locationLabels[patient.visit_location] || '?'}</span>`
                    : '';
                const escapedName = (patient.full_name || '').replace(/'/g, "\\'");
                const mrIdCell = patient.mr_id
                    ? `<a href="sunday-clinic.html?patient=${patient.id}&mr=${patient.mr_id}" class="text-primary" title="Buka Rekam Medis"><small>${patient.mr_id}</small></a>${locationBadge}`
                    : `<span class="text-muted">-</span>`;

                // HPL column with color coding for obstetri patients
                let hplCell = '-';
                if (patient.is_obstetri && patient.hpl && !patient.has_delivered) {
                    const hplDate = new Date(patient.hpl);
                    const hplFormatted = `${hplDate.getDate().toString().padStart(2,'0')}/${(hplDate.getMonth()+1).toString().padStart(2,'0')}/${hplDate.getFullYear().toString().slice(-2)}`;
                    const weeksPregnant = Math.floor(patient.days_pregnant / 7);
                    let bgClass = '';
                    let textClass = '';
                    let icon = '';
                    if (patient.days_pregnant >= 280) {
                        bgClass = 'bg-danger';
                        textClass = 'text-white';
                        icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
                    } else if (patient.days_pregnant >= 259) {
                        bgClass = 'bg-warning';
                        icon = '<i class="fas fa-clock mr-1"></i>';
                    }
                    hplCell = `<span class="${bgClass} ${textClass} px-1 rounded" title="Usia kehamilan: ${weeksPregnant} minggu">${icon}${hplFormatted}</span>`;
                } else if (patient.has_delivered) {
                    hplCell = '<span class="badge badge-success"><i class="fas fa-baby mr-1"></i>Lahir</span>';
                }

                // Mark as delivered button
                let deliveryButton = '';
                if (patient.is_obstetri && !patient.has_delivered) {
                    deliveryButton = `<button class="btn btn-sm btn-success" onclick="markAsDelivered('${patient.id}', '${escapedName}')" title="Tandai Sudah Melahirkan"><i class="fas fa-baby"></i></button>`;
                }

                return `
                    <tr>
                        <td><a href="#" class="text-primary" onclick="showPatientMRList('${patient.id}', '${escapedName}'); return false;" title="Lihat Daftar Rekam Medis">${patient.id}</a></td>
                        <td>${mrIdCell}</td>
                        <td>${patient.full_name || '-'}</td>
                        <td>${hplCell}</td>
                        <td>${formatPatientType(patient.last_visit_type)}</td>
                        <td>${resumeStatusBadge}</td>
                        <td data-order="${regDateSort}">${regDate}</td>
                        <td>${statusBadge}</td>
                        <td class="text-nowrap">
                            <button type="button" class="btn btn-sm btn-info btn-view-patient" data-patient-id="${patient.id}" title="Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${deliveryButton}
                            <button class="btn btn-sm btn-${patient.status === 'active' ? 'warning' : 'success'}"
                                    onclick="togglePatientStatus('${patient.id}', '${patient.status}', '${patient.full_name}')"
                                    title="${patient.status === 'active' ? 'Nonaktifkan' : 'Aktifkan'}">
                                <i class="fas fa-${patient.status === 'active' ? 'ban' : 'check'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePatient('${patient.id}', '${escapedName}')" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Reinitialize DataTable with fresh data
            $('#manage-patients-table').DataTable({
                "pageLength": 25,
                "order": [[2, 'asc']], // Sort by name (column 2 after adding MR ID)
                "searching": false, // Disable built-in search since we have advanced search
                "paging": data.data.length > 25, // Only show pagination if more than 25 results
                "info": true
            });

            // Attach event listeners to view buttons
            document.querySelectorAll('.btn-view-patient').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    viewPatientDetail(patientId);
                });
            });

        } catch (error) {
            console.error('Error in advanced search:', error);
            document.getElementById('manage-patients-tbody').innerHTML =
                '<tr><td colspan="9" class="text-center text-danger">Gagal melakukan pencarian</td></tr>';
        }
    }

    window.resetAdvancedSearch = function() {
        // Clear all search fields
        document.getElementById('adv-search-name').value = '';
        document.getElementById('adv-search-id').value = '';
        document.getElementById('adv-search-mr').value = '';
        document.getElementById('adv-search-email').value = '';
        document.getElementById('adv-search-age-min').value = '';
        document.getElementById('adv-search-age-max').value = '';
        document.getElementById('adv-search-phone').value = '';
        document.getElementById('adv-search-whatsapp').value = '';
        document.getElementById('adv-search-husband').value = '';
        document.getElementById('adv-search-visit-date').value = '';

        // Clear result count
        const resultCount = document.getElementById('adv-search-result-count');
        if (resultCount) resultCount.textContent = '';

        // Reload all patients
        advancedSearchActive = false;
        loadWebPatients();
    };

    window.performAdvancedSearch = performAdvancedSearch;

    window.deletePatient = async function(patientId, patientName, event) {
        // Get button reference from event if provided
        const deleteBtn = event ? event.target.closest('button') : null;
        const originalHtml = deleteBtn ? deleteBtn.innerHTML : '';
        
        // Konfirmasi dengan pesan detail tentang apa yang akan dihapus
        const confirmMessage = ` PERINGATAN: Hapus Pasien dan Semua Data Terkait

Anda akan menghapus pasien: "${patientName}"

Data yang akan DIHAPUS PERMANEN:
 Data pasien (profil, email, nomor telepon)
 Riwayat billing dan invoice
 Detail item billing
 Transaksi pembayaran
 Rekam medis (medical records)
 Data pemeriksaan medis
 Riwayat kunjungan
 Janji temu (appointments)
 Form patient intake

 TINDAKAN INI TIDAK DAPAT DIBATALKAN!

Apakah Anda yakin ingin melanjutkan?`;

        if (!confirm(confirmMessage)) {
            return;
        }
        
        // Konfirmasi kedua untuk keamanan
        const secondConfirm = prompt('Ketik "HAPUS" (huruf besar) untuk konfirmasi penghapusan:');
        if (secondConfirm !== 'HAPUS') {
            alert('Penghapusan dibatalkan');
            return;
        }
        
        try {
            // Show loading
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }
            
            // Use unified patients endpoint
            const response = await fetch(`/api/patients/${patientId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`
                }
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to delete patient');
            }
            
            // Show success message with details
            let successMessage = ` Pasien "${patientName}" berhasil dihapus!\n\nData yang dihapus:`;
            if (result.deleted_data) {
                successMessage += `\n- Billing Items: ${result.deleted_data.billing_items || 0}`;
                successMessage += `\n- Payment Transactions: ${result.deleted_data.payment_transactions || 0}`;
                successMessage += `\n- Billings: ${result.deleted_data.billings || 0}`;
                successMessage += `\n- Patient Records: ${result.deleted_data.patient_records || 0}`;
                successMessage += `\n- Medical Records: ${result.deleted_data.medical_records || 0}`;
                successMessage += `\n- Medical Exams: ${result.deleted_data.medical_exams || 0}`;
                successMessage += `\n- Visits: ${result.deleted_data.visits || 0}`;
                successMessage += `\n- Appointments: ${result.deleted_data.appointments || 0}`;
                successMessage += `\n- Intake Submissions: ${result.deleted_data.patient_intake_submissions || 0}`;
            }
            
            alert(successMessage);
            loadWebPatients(); // Reload the main list
            
            // Also reload floating panel if visible
            const floatingPanel = document.getElementById('floating-kelola-pasien');
            if (floatingPanel && !floatingPanel.classList.contains('d-none') && typeof loadFloatingPanelPatients === 'function') {
                loadFloatingPanelPatients();
            }
            
            // Reload patient list in appointments module
            if (typeof window.reloadAppointmentPatients === 'function') {
                console.log(' Reloading appointment patients...');
                await window.reloadAppointmentPatients();
            }

            // Reload Klinik Private appointments if available
            if (window.klinikPrivate && typeof window.klinikPrivate.reload === 'function') {
                console.log(' Reloading Klinik Private appointments...');
                await window.klinikPrivate.reload();
            }

            console.log(' All patient lists refreshed after deletion');
            
        } catch (error) {
            console.error('Error deleting patient:', error);
            alert(' Gagal menghapus pasien:\n' + error.message);
            
            // Restore button
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHtml;
            }
        }
    };

    // Mark patient as delivered (create birth_congratulations entry)
    window.markAsDelivered = async function(patientId, patientName) {
        if (!confirm(`Tandai "${patientName}" sudah melahirkan?\n\nIni akan menghapus pasien dari daftar monitoring kehamilan.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/patients/${patientId}/mark-delivered`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Gagal menandai pasien');
            }

            alert(` ${patientName} berhasil ditandai sudah melahirkan!`);
            loadWebPatients(); // Reload the patient list

        } catch (error) {
            console.error('Error marking patient as delivered:', error);
            alert(' Gagal menandai pasien: ' + error.message);
        }
    };

    window.togglePatientStatus = async function(patientId, currentStatus, patientName) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const action = newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan';
        
        if (!confirm(`Apakah Anda yakin ingin ${action} pasien "${patientName}"?`)) {
            return;
        }
        
        try {
            // Use unified patients endpoint
            const response = await fetch(`/api/patients/${patientId}/status`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update status');
            }
            
            alert(`Status pasien berhasil diubah menjadi ${newStatus === 'active' ? 'aktif' : 'nonaktif'}`);
            loadWebPatients(); // Reload the main list
            
            // Also reload floating panel if visible
            const floatingPanel = document.getElementById('floating-kelola-pasien');
            if (floatingPanel && !floatingPanel.classList.contains('d-none') && typeof loadFloatingPanelPatients === 'function') {
                loadFloatingPanelPatients();
            }
            
        } catch (error) {
            console.error('Error updating patient status:', error);
            alert('Gagal mengubah status pasien');
        }
    };
    
    window.viewPatientDetail = async function(patientId) {
        // Redirect to showPatientDetail which has "Mulai Kunjungan" feature
        if (typeof window.showPatientDetail === 'function') {
            return window.showPatientDetail(patientId);
        }

        // Fallback to old implementation if showPatientDetail not available
        try {
            console.log('=== viewPatientDetail called ===');
            console.log('Patient ID:', patientId);
            console.log('Auth token exists:', !!localStorage.getItem('vps_auth_token'));

            const response = await fetch(`/api/admin/web-patients/${patientId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`
                }
            });

            if (!response.ok) {
                console.error('Failed to load patient details, status:', response.status);
                throw new Error('Failed to load patient details');
            }

            const data = await response.json();
            console.log('Patient data received:', data);
            const patient = data.data.patient;
            const intake = data.data.intake;
            console.log('Intake data:', intake);
            
            // Create modal for patient details
            const modal = `
                <div class="modal fade" id="patientDetailModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-info">
                                <h4 class="modal-title">
                                    <i class="fas fa-user-circle"></i> Detail Pasien
                                </h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th width="40%">ID Pasien</th>
                                                <td>${patient.id}</td>
                                            </tr>
                                            <tr>
                                                <th>Nama Lengkap</th>
                                                <td><strong>${patient.fullname}</strong></td>
                                            </tr>
                                            <tr>
                                                <th>Email</th>
                                                <td>${patient.email}</td>
                                            </tr>
                                            <tr>
                                                <th>Telepon</th>
                                                <td>${patient.phone || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Tanggal Lahir</th>
                                                <td>${patient.birth_date ? new Date(patient.birth_date).toLocaleDateString('id-ID', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Usia</th>
                                                <td>${patient.age || '-'} tahun</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-bordered">
                                            <tr>
                                                <th width="40%">Foto Profil</th>
                                                <td>
                                                    ${patient.photo_url ? 
                                                        `<img src="${patient.photo_url}" alt="Photo" style="max-width: 100px; border-radius: 50%;">` : 
                                                        '<span class="text-muted">Tidak ada foto</span>'}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Google ID</th>
                                                <td>${patient.google_id || '<span class="text-muted">Email registration</span>'}</td>
                                            </tr>
                                            <tr>
                                                <th>Profil Lengkap</th>
                                                <td>${patient.profile_completed ? 
                                                    '<span class="badge badge-success"><i class="fas fa-check"></i> Ya</span>' : 
                                                    '<span class="badge badge-warning"><i class="fas fa-times"></i> Belum</span>'}</td>
                                            </tr>
                                            <tr>
                                                <th>Status</th>
                                                <td>${patient.status === 'active' ? 
                                                    '<span class="badge badge-success">Aktif</span>' : 
                                                    '<span class="badge badge-secondary">Nonaktif</span>'}</td>
                                            </tr>
                                            <tr>
                                                <th>Tgl Registrasi</th>
                                                <td>${new Date(patient.registration_date).toLocaleString('id-ID', {
                                                    year: 'numeric', month: 'long', day: 'numeric',
                                                    hour: '2-digit', minute: '2-digit'
                                                })}</td>
                                            </tr>
                                            <tr>
                                                <th>Terakhir Update</th>
                                                <td>${patient.updated_at ? new Date(patient.updated_at).toLocaleString('id-ID', {
                                                    year: 'numeric', month: 'long', day: 'numeric',
                                                    hour: '2-digit', minute: '2-digit'
                                                }) : '-'}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                
                                ${intake ? `
                                <hr>
                                <h5 class="mb-3">
                                    <i class="fas fa-file-medical"></i> Formulir Rekam Medis Awal
                                    <span class="badge badge-${intake.highRisk ? 'danger' : 'success'} ml-2">
                                        ${intake.highRisk ? 'High Risk' : 'Normal'}
                                    </span>
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm table-bordered">
                                            <tr>
                                                <th width="40%">Nama Lengkap</th>
                                                <td>${intake.payload.full_name || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Tanggal Lahir</th>
                                                <td>${intake.payload.dob ? new Date(intake.payload.dob).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Usia</th>
                                                <td>${intake.payload.age || '-'} tahun</td>
                                            </tr>
                                            <tr>
                                                <th>Telepon</th>
                                                <td>${intake.payload.phone || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>NIK</th>
                                                <td>${intake.payload.nik || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Alamat</th>
                                                <td>${intake.payload.address || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Status Pernikahan</th>
                                                <td>${intake.payload.marital_status || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Pekerjaan Suami</th>
                                                <td>${intake.payload.husband_job || '-'}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm table-bordered">
                                            <tr>
                                                <th width="40%">Gravida</th>
                                                <td>${intake.payload.gravida || '0'}</td>
                                            </tr>
                                            <tr>
                                                <th>Para</th>
                                                <td>${intake.payload.para || '0'}</td>
                                            </tr>
                                            <tr>
                                                <th>Abortus</th>
                                                <td>${intake.payload.abortus || '0'}</td>
                                            </tr>
                                            <tr>
                                                <th>Anak Hidup</th>
                                                <td>${intake.payload.living_children || '0'}</td>
                                            </tr>
                                            <tr>
                                                <th>HPHT</th>
                                                <td>${intake.payload.lmp ? new Date(intake.payload.lmp).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>HPL</th>
                                                <td>${intake.payload.edd || '-'}</td>
                                            </tr>
                                            <tr>
                                                <th>Status</th>
                                                <td><span class="badge badge-${intake.status === 'verified' ? 'success' : 'warning'}">${intake.status}</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                ${intake.payload.medications && intake.payload.medications.length > 0 ? `
                                <div class="mt-2">
                                    <strong>Obat-obatan:</strong>
                                    <ul class="mb-0">
                                        ${intake.payload.medications.map(m => `<li>${m.name || m}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                                ${intake.payload.allergies ? `
                                <div class="mt-2">
                                    <strong>Alergi:</strong> ${intake.payload.allergies}
                                </div>
                                ` : ''}
                                <div class="mt-2 text-muted small">
                                    <i class="far fa-clock"></i> Diisi: ${new Date(intake.createdAt).toLocaleString('id-ID')}
                                    ${intake.updatedAt ? ` | Diperbarui: ${new Date(intake.updatedAt).toLocaleString('id-ID')}` : ''}
                                </div>
                                ` : '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Belum ada formulir rekam medis awal</div>'}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            $('#patientDetailModal').remove();
            
            // Add and show modal
            $('body').append(modal);
            $('#patientDetailModal').modal('show');
            
            // Clean up modal after close
            $('#patientDetailModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
            
        } catch (error) {
            console.error('Error viewing patient detail:', error);
            console.error('Error stack:', error.stack);
            alert('Gagal memuat detail pasien: ' + error.message);
        }
    };

    /**
     * Show patient's medical records list in a modal
     * @param {string} patientId - Patient ID
     * @param {string} patientName - Patient name
     */
    window.showPatientMRList = async function(patientId, patientName) {
        try {
            // Show loading modal first
            const loadingModal = `
                <div class="modal fade" id="patientMRListModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-primary">
                                <h5 class="modal-title text-white">
                                    <i class="fas fa-notes-medical mr-2"></i>
                                    Daftar Rekam Medis - ${patientName || patientId}
                                </h5>
                                <button type="button" class="close text-white" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body text-center py-5">
                                <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                                <p>Memuat data rekam medis...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            $('#patientMRListModal').remove();
            $('body').append(loadingModal);
            $('#patientMRListModal').modal('show');

            // Fetch medical records for this patient
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch(`/api/sunday-clinic/patient-visits/${patientId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('Gagal memuat data rekam medis');
            }

            const result = await response.json();
            const records = result.data || [];

            // Build records table
            let recordsHtml = '';
            const escapedPatientName = (patientName || '').replace(/'/g, "\\'");
            if (records.length === 0) {
                recordsHtml = `
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Belum ada rekam medis untuk pasien ini</p>
                    </div>
                `;
            } else {
                recordsHtml = `
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>MR ID</th>
                                    <th>Tanggal Kunjungan</th>
                                    <th>Lokasi</th>
                                    <th>Kategori</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => {
                                    const visitDate = record.visit_date ? new Date(record.visit_date).toLocaleDateString('id-ID', {
                                        weekday: 'short',
                                        day: 'numeric',
                                        month: 'short',
                                        year: 'numeric'
                                    }) : '-';
                                    const category = record.mr_category || '-';
                                    const statusBadge = record.status === 'finalized'
                                        ? '<span class="badge badge-success">Selesai</span>'
                                        : record.status === 'in_progress'
                                        ? '<span class="badge badge-warning">Dalam Proses</span>'
                                        : '<span class="badge badge-secondary">Draft</span>';

                                    return `
                                        <tr>
                                            <td>
                                                <strong class="text-primary">${record.mr_id || '-'}</strong>
                                            </td>
                                            <td>${visitDate}</td>
                                            <td><small>${record.location_short || record.visit_location || '-'}</small></td>
                                            <td><small>${category}</small></td>
                                            <td>${statusBadge}</td>
                                            <td>
                                                <a href="sunday-clinic.html?patient=${patientId}&mr=${record.mr_id}"
                                                   class="btn btn-sm btn-info" title="Buka Rekam Medis">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                <button class="btn btn-sm ${record.status === 'finalized' ? 'btn-outline-danger' : 'btn-danger'} ml-1"
                                                        onclick="deleteMedicalRecord('${record.mr_id}', ${record.status === 'finalized'})"
                                                        title="${record.status === 'finalized' ? 'Hapus (Finalized - konfirmasi ekstra)' : 'Hapus Rekam Medis'}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Update modal body content only (don't replace entire modal to avoid Bootstrap state issues)
            const modalBodyContent = `
                <p class="text-muted mb-3">
                    <i class="fas fa-user mr-1"></i> ID Pasien: <strong>${patientId}</strong>
                    <span class="badge badge-info ml-2">${records.length} rekam medis</span>
                </p>
                ${recordsHtml}
            `;

            // Update only the modal body
            $('#patientMRListModal .modal-body').html(modalBodyContent);

            // Add footer if not exists
            if ($('#patientMRListModal .modal-footer').length === 0) {
                $('#patientMRListModal .modal-content').append(`
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                    </div>
                `);
            }

            // Clean up modal after close
            $('#patientMRListModal').on('hidden.bs.modal', function () {
                $(this).remove();
                $('.modal-backdrop').remove();
            });

        } catch (error) {
            console.error('Error loading patient MR list:', error);

            // Update modal with error
            $('#patientMRListModal .modal-body').html(`
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">${error.message || 'Gagal memuat data rekam medis'}</p>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                </div>
            `);
        }
    };

    window.syncWebPatients = async function() {
        if (!confirm('Apakah Anda yakin ingin menyinkronkan semua pasien web yang sudah lengkap profil ke tabel Data Pasien?\n\nIni akan membuat ID pasien baru (P###) untuk setiap pasien web yang belum ada di Data Pasien.')) {
            return;
        }
        
        const syncBtn = document.getElementById('sync-web-patients-btn');
        const originalText = syncBtn.innerHTML;
        
        try {
            // Disable button and show loading
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Menyinkronkan...';
            
            const response = await fetch('/api/admin/sync-web-patients', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to sync patients');
            }
            
            const data = await response.json();
            const result = data.data;
            
            let message = `Sinkronisasi selesai!\n\n`;
            message += ` Berhasil disinkronkan: ${result.syncedCount} pasien\n`;
            message += ` Dilewati (sudah ada): ${result.skippedCount} pasien\n`;
            if (result.errorsCount > 0) {
                message += ` Gagal: ${result.errorsCount} pasien\n\n`;
                if (result.errors && result.errors.length > 0) {
                    message += 'Error pertama:\n';
                    result.errors.slice(0, 3).forEach(err => {
                        message += `- ${err.email}: ${err.error}\n`;
                    });
                }
            }
            
            alert(message);
            
            // Reload the web patients list
            loadWebPatients();
            
        } catch (error) {
            console.error('Error syncing web patients:', error);
            alert('Gagal menyinkronkan pasien: ' + error.message);
        } finally {
            // Re-enable button
            syncBtn.disabled = false;
            syncBtn.innerHTML = originalText;
        }
    };
    
    // Kelola Obat Page Function
    window.showKelolaObatPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));
        
        // Show kelola obat page
        document.getElementById('kelola-obat-page').classList.remove('d-none');
        
        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('#management-nav-kelola-obat .nav-link').classList.add('active');
        
        // Hide floating panel
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel) {
            floatingPanel.classList.add('d-none');
        }
    };
    
    // Kelola Supplier Page Function
    window.showKelolaSupplierPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show kelola supplier page
        document.getElementById('kelola-supplier-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('#management-nav-kelola-supplier .nav-link')?.classList.add('active');

        // Hide floating panel
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel) {
            floatingPanel.classList.add('d-none');
        }

        // Load suppliers
        loadSuppliers();
    };

    // Activity Log Page Function
    window.showActivityLogPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show activity log page
        document.getElementById('activity-log-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('#management-nav-activity-log .nav-link')?.classList.add('active');

        // Hide floating panel
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel) {
            floatingPanel.classList.add('d-none');
        }

        // Set default date range (last 7 days) - use local timezone
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);

        // Format as YYYY-MM-DD in local timezone (not UTC)
        const formatLocalDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.getElementById('activity-log-start-date').value = formatLocalDate(weekAgo);
        document.getElementById('activity-log-end-date').value = formatLocalDate(today);

        // Load activity log
        loadActivityLog();
    };

    // ============================================
    // Activity Log Functions
    // ============================================
    let activityLogPage = 0;
    const activityLogLimit = 50;

    window.loadActivityLog = async function(page = 0) {
        activityLogPage = page;
        const tbody = document.getElementById('activity-log-body');

        try {
            const token = localStorage.getItem('vps_auth_token');
            const startDate = document.getElementById('activity-log-start-date').value;
            const endDate = document.getElementById('activity-log-end-date').value;
            const movementType = document.getElementById('activity-log-type').value;
            const createdBy = document.getElementById('activity-log-user').value;
            const search = document.getElementById('activity-log-search').value;

            let url = `/api/inventory/activity-log?limit=${activityLogLimit}&offset=${page * activityLogLimit}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (movementType) url += `&movement_type=${movementType}`;
            if (createdBy) url += `&created_by=${encodeURIComponent(createdBy)}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load activity log');

            const result = await response.json();
            const data = result.data || [];
            const pagination = result.pagination || {};
            const filters = result.filters || {};

            // Populate user filter dropdown
            const userSelect = document.getElementById('activity-log-user');
            const currentUser = userSelect.value;
            userSelect.innerHTML = '<option value="">Semua User</option>';
            (filters.users || []).forEach(u => {
                userSelect.innerHTML += `<option value="${u}" ${u === currentUser ? 'selected' : ''}>${u}</option>`;
            });

            // Filter by search if provided
            let filteredData = data;
            if (search) {
                const searchLower = search.toLowerCase();
                filteredData = data.filter(d => d.obat_name?.toLowerCase().includes(searchLower));
            }

            // Calculate summaries
            let totalIn = 0, totalOut = 0, totalAdjust = 0, totalValue = 0;
            filteredData.forEach(d => {
                const qty = Math.abs(d.quantity);
                const value = qty * parseFloat(d.cost_price || 0);
                if (d.movement_type === 'purchase') {
                    totalIn += qty;
                    totalValue += value;
                } else if (d.movement_type === 'sale') {
                    totalOut += qty;
                } else if (d.movement_type === 'adjustment') {
                    totalAdjust += Math.abs(d.quantity);
                }
            });

            document.getElementById('activity-total-in').textContent = totalIn.toLocaleString('id-ID');
            document.getElementById('activity-total-out').textContent = totalOut.toLocaleString('id-ID');
            document.getElementById('activity-total-adjust').textContent = totalAdjust.toLocaleString('id-ID');
            document.getElementById('activity-total-value').textContent = 'Rp ' + totalValue.toLocaleString('id-ID');
            document.getElementById('activity-log-count').textContent = pagination.total + ' records';

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">Tidak ada data aktivitas</p></td></tr>';
                document.getElementById('activity-log-pagination-info').textContent = 'No data';
                document.getElementById('activity-log-pagination').innerHTML = '';
                return;
            }

            tbody.innerHTML = filteredData.map(d => {
                const date = new Date(d.created_at);
                const dateStr = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                let typeBadge = '';
                let qtyClass = '';
                if (d.movement_type === 'purchase') {
                    typeBadge = '<span class="badge badge-success">MASUK</span>';
                    qtyClass = 'text-success';
                } else if (d.movement_type === 'sale') {
                    typeBadge = '<span class="badge badge-danger">KELUAR</span>';
                    qtyClass = 'text-danger';
                } else if (d.movement_type === 'adjustment') {
                    typeBadge = '<span class="badge badge-warning">ADJUST</span>';
                    qtyClass = d.quantity > 0 ? 'text-success' : 'text-danger';
                }

                const qty = d.quantity > 0 ? '+' + d.quantity : d.quantity;
                const price = parseFloat(d.cost_price || 0);
                const total = Math.abs(d.quantity) * price;

                return `<tr>
                    <td><small>${dateStr}<br><span class="text-muted">${timeStr}</span></small></td>
                    <td><strong>${d.obat_name}</strong><br><small class="text-muted">${d.obat_code}</small></td>
                    <td class="text-center">${typeBadge}</td>
                    <td class="text-center ${qtyClass}"><strong>${qty}</strong></td>
                    <td class="text-right">Rp ${price.toLocaleString('id-ID')}</td>
                    <td class="text-right">Rp ${total.toLocaleString('id-ID')}</td>
                    <td><code>${d.batch_number || '-'}</code></td>
                    <td><small>${d.supplier_name || '-'}</small></td>
                    <td>${d.created_by || '-'}</td>
                    <td><small>${d.notes || '-'}</small></td>
                </tr>`;
            }).join('');

            // Pagination info
            const start = page * activityLogLimit + 1;
            const end = Math.min((page + 1) * activityLogLimit, pagination.total);
            document.getElementById('activity-log-pagination-info').textContent = `Showing ${start}-${end} of ${pagination.total}`;

            // Pagination buttons
            const paginationEl = document.getElementById('activity-log-pagination');
            let paginationHtml = '';
            if (page > 0) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadActivityLog(${page - 1}); return false;">Prev</a></li>`;
            }
            for (let i = 0; i < pagination.pages && i < 5; i++) {
                const startPage = Math.max(0, page - 2);
                const pageNum = startPage + i;
                if (pageNum >= pagination.pages) break;
                paginationHtml += `<li class="page-item ${pageNum === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadActivityLog(${pageNum}); return false;">${pageNum + 1}</a></li>`;
            }
            if (page < pagination.pages - 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadActivityLog(${page + 1}); return false;">Next</a></li>`;
            }
            paginationEl.innerHTML = paginationHtml;

        } catch (error) {
            console.error('Load activity log error:', error);
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0">Gagal memuat data</p></td></tr>';
        }
    };

    // ============================================
    // Staff Activity Log Functions (Login/Logout Audit)
    // ============================================
    let staffActivityPage = 0;
    const staffActivityLimit = 50;

    window.showStaffActivityPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show staff activity page
        document.getElementById('staff-activity-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('#nav-staff-activity .nav-link')?.classList.add('active');

        // Hide floating panel
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel) {
            floatingPanel.classList.add('d-none');
        }

        // Load data
        loadStaffActivityLogs();
    };

    window.loadStaffActivityLogs = async function(page = 0) {
        staffActivityPage = page;
        const tbody = document.getElementById('staff-activity-body');

        try {
            const token = localStorage.getItem('vps_auth_token');
            const userFilter = document.getElementById('staff-activity-user-filter')?.value || '';
            const actionFilter = document.getElementById('staff-activity-action-filter')?.value || '';
            const startDate = document.getElementById('staff-activity-start-date')?.value || '';
            const endDate = document.getElementById('staff-activity-end-date')?.value || '';

            let url = `/api/logs?limit=${staffActivityLimit}&offset=${page * staffActivityLimit}`;
            if (userFilter) url += `&user_id=${encodeURIComponent(userFilter)}`;
            if (actionFilter) url += `&action=${encodeURIComponent(actionFilter)}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load staff activity logs');

            const result = await response.json();
            const data = result.data || [];

            // Load summary
            loadStaffActivitySummary();

            // Load filter options
            loadStaffActivityFilters();

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">Tidak ada log aktivitas</p></td></tr>';
                document.getElementById('staff-activity-pagination-info').textContent = 'No data';
                document.getElementById('staff-activity-pagination').innerHTML = '';
                return;
            }

            tbody.innerHTML = data.map(d => {
                const date = new Date(d.timestamp);
                const dateStr = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                let actionBadge = '<span class="badge badge-secondary">' + d.action + '</span>';
                if (d.action === 'Login') {
                    actionBadge = '<span class="badge badge-success"><i class="fas fa-sign-in-alt mr-1"></i>Login</span>';
                } else if (d.action === 'Logout') {
                    actionBadge = '<span class="badge badge-warning"><i class="fas fa-sign-out-alt mr-1"></i>Logout</span>';
                } else if (d.action.includes('Create') || d.action.includes('Add')) {
                    actionBadge = '<span class="badge badge-primary"><i class="fas fa-plus mr-1"></i>' + d.action + '</span>';
                } else if (d.action.includes('Update') || d.action.includes('Edit')) {
                    actionBadge = '<span class="badge badge-info"><i class="fas fa-edit mr-1"></i>' + d.action + '</span>';
                } else if (d.action.includes('Delete')) {
                    actionBadge = '<span class="badge badge-danger"><i class="fas fa-trash mr-1"></i>' + d.action + '</span>';
                }

                return `<tr>
                    <td><small>${dateStr}<br><span class="text-muted">${timeStr}</span></small></td>
                    <td><strong>${d.user_name}</strong><br><small class="text-muted">${d.user_id}</small></td>
                    <td>${actionBadge}</td>
                    <td><small>${d.details || '-'}</small></td>
                </tr>`;
            }).join('');

            // Pagination info
            const total = result.count || data.length;
            const start = page * staffActivityLimit + 1;
            const end = Math.min((page + 1) * staffActivityLimit, total);
            document.getElementById('staff-activity-pagination-info').textContent = `Showing ${start}-${end} of ${total}`;

            // Pagination buttons
            const totalPages = Math.ceil(total / staffActivityLimit);
            const paginationEl = document.getElementById('staff-activity-pagination');
            let paginationHtml = '';
            if (page > 0) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadStaffActivityLogs(${page - 1}); return false;">Prev</a></li>`;
            }
            for (let i = 0; i < totalPages && i < 5; i++) {
                const startPage = Math.max(0, page - 2);
                const pageNum = startPage + i;
                if (pageNum >= totalPages) break;
                paginationHtml += `<li class="page-item ${pageNum === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadStaffActivityLogs(${pageNum}); return false;">${pageNum + 1}</a></li>`;
            }
            if (page < totalPages - 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadStaffActivityLogs(${page + 1}); return false;">Next</a></li>`;
            }
            paginationEl.innerHTML = paginationHtml;

        } catch (error) {
            console.error('Load staff activity log error:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0">Gagal memuat data</p></td></tr>';
        }
    };

    async function loadStaffActivitySummary() {
        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/logs/summary?days=7', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) return;

            const result = await response.json();
            const data = result.data || {};

            document.getElementById('staff-activity-total').textContent = data.total_activities || 0;
            document.getElementById('staff-activity-users').textContent = data.unique_users || 0;

            // Top users
            const topUsersEl = document.getElementById('staff-activity-top-users');
            if (data.most_active_users && data.most_active_users.length > 0) {
                topUsersEl.innerHTML = data.most_active_users.slice(0, 5).map(u => `
                    <div class="d-flex justify-content-between small mb-1">
                        <span>${u.user_name}</span>
                        <span class="badge badge-primary">${u.action_count}</span>
                    </div>
                `).join('');
            } else {
                topUsersEl.innerHTML = '<p class="text-muted small mb-0">No data</p>';
            }
        } catch (error) {
            console.error('Load staff activity summary error:', error);
        }
    }

    async function loadStaffActivityFilters() {
        try {
            const token = localStorage.getItem('vps_auth_token');

            // Load unique actions
            const actionsResponse = await fetch('/api/logs/actions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (actionsResponse.ok) {
                const actionsData = await actionsResponse.json();
                const actionSelect = document.getElementById('staff-activity-action-filter');
                const currentAction = actionSelect.value;
                actionSelect.innerHTML = '<option value="">Semua Aksi</option>';
                (actionsData.data || []).forEach(a => {
                    actionSelect.innerHTML += `<option value="${a}" ${a === currentAction ? 'selected' : ''}>${a}</option>`;
                });
            }

            // Load unique users from logs
            const logsResponse = await fetch('/api/logs?limit=1000', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (logsResponse.ok) {
                const logsData = await logsResponse.json();
                const users = [...new Set((logsData.data || []).map(l => l.user_id))];
                const userNames = {};
                (logsData.data || []).forEach(l => { userNames[l.user_id] = l.user_name; });

                const userSelect = document.getElementById('staff-activity-user-filter');
                const currentUser = userSelect.value;
                userSelect.innerHTML = '<option value="">Semua Staff</option>';
                users.forEach(uid => {
                    userSelect.innerHTML += `<option value="${uid}" ${uid === currentUser ? 'selected' : ''}>${userNames[uid] || uid}</option>`;
                });
            }
        } catch (error) {
            console.error('Load staff activity filters error:', error);
        }
    }

    // ============================================
    // Supplier Management Functions
    // ============================================
    let suppliersCache = [];

    async function loadSuppliers() {
        const tbody = document.getElementById('kelola-supplier-list-body');
        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/suppliers?active=true', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load suppliers');

            const data = await response.json();
            suppliersCache = data.data || [];

            if (suppliersCache.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Belum ada supplier</td></tr>';
                return;
            }

            tbody.innerHTML = suppliersCache.map((s, i) => `
                <tr>
                    <td><code>${s.code}</code></td>
                    <td>${s.name}</td>
                    <td>${s.phone || '-'}</td>
                    <td>${s.address || '-'}</td>
                    <td class="text-center">
                        <button class="btn btn-xs btn-warning" onclick="editSupplier(${s.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-xs btn-danger" onclick="deleteSupplier(${s.id})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Load suppliers error:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data</td></tr>';
        }
    }

    window.resetSupplierForm = function() {
        document.getElementById('kelola-supplier-id').value = '';
        document.getElementById('kelola-supplier-name').value = '';
        document.getElementById('kelola-supplier-phone').value = '';
        document.getElementById('kelola-supplier-address').value = '';
        document.querySelector('#kelola-supplier-form button[type="submit"]').innerHTML = '<i class="fas fa-plus mr-1"></i>Tambah';
    };

    window.editSupplier = function(id) {
        const supplier = suppliersCache.find(s => s.id === id);
        if (!supplier) return;

        document.getElementById('kelola-supplier-id').value = supplier.id;
        document.getElementById('kelola-supplier-name').value = supplier.name;
        document.getElementById('kelola-supplier-phone').value = supplier.phone || '';
        document.getElementById('kelola-supplier-address').value = supplier.address || '';
        document.querySelector('#kelola-supplier-form button[type="submit"]').innerHTML = '<i class="fas fa-save mr-1"></i>Update';
    };

    window.deleteSupplier = async function(id) {
        if (!confirm('Hapus supplier ini?')) return;

        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch(`/api/suppliers/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Gagal menghapus');

            showSuccess('Supplier berhasil dihapus');
            loadSuppliers();
        } catch (error) {
            showError('Error: ' + error.message);
        }
    };

    // Supplier form submit handler
    document.addEventListener('DOMContentLoaded', function() {
        const supplierForm = document.getElementById('kelola-supplier-form');
        if (supplierForm) {
            supplierForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const id = document.getElementById('kelola-supplier-id').value;
                const name = document.getElementById('kelola-supplier-name').value.trim();
                const phone = document.getElementById('kelola-supplier-phone').value.trim();
                const address = document.getElementById('kelola-supplier-address').value.trim();

                if (!name) {
                    showWarning('Nama supplier harus diisi');
                    return;
                }

                try {
                    const token = localStorage.getItem('vps_auth_token');
                    const method = id ? 'PUT' : 'POST';
                    const url = id ? `/api/suppliers/${id}` : '/api/suppliers';

                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, phone, address })
                    });

                    if (!response.ok) throw new Error('Gagal menyimpan');

                    showSuccess(id ? 'Supplier berhasil diupdate' : 'Supplier berhasil ditambahkan');
                    resetSupplierForm();
                    loadSuppliers();
                } catch (error) {
                    showError('Error: ' + error.message);
                }
            });
        }
    });

    // ============================================
    // Purchase Stock (Tambah Stok) Functions
    // ============================================

    window.openPurchaseModal = async function(obatId, obatName) {
        // Set obat info
        document.getElementById('purchase-obat-id').value = obatId;
        document.getElementById('purchase-obat-name').value = obatName;

        // Set default date to today
        document.getElementById('purchase-date').value = new Date().toISOString().split('T')[0];

        // Clear other fields
        document.getElementById('purchase-supplier').value = '';
        document.getElementById('purchase-quantity').value = '';
        document.getElementById('purchase-cost-price').value = '';
        document.getElementById('purchase-total-cost').value = '';
        document.getElementById('purchase-expiry-date').value = '';
        document.getElementById('purchase-batch-number').value = '';
        document.getElementById('purchase-invoice').value = '';
        document.getElementById('purchase-notes').value = '';

        // Load suppliers for dropdown and existing batches
        try {
            const token = localStorage.getItem('vps_auth_token');

            // Load suppliers
            const suppliersRes = await fetch('/api/suppliers?active=true', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const suppliersData = await suppliersRes.json();

            const select = document.getElementById('purchase-supplier');
            select.innerHTML = '<option value="">-- Pilih Supplier --</option>';
            (suppliersData.data || []).forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });

            // Load existing batches for this obat
            const batchesContainer = document.getElementById('existing-batches-container');
            batchesContainer.innerHTML = '<p class="text-muted small mb-0">Memuat batch...</p>';

            const batchesRes = await fetch(`/api/inventory/batches/${obatId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batchesData = await batchesRes.json();
            const batches = batchesData.data || [];

            if (batches.length === 0) {
                batchesContainer.innerHTML = '<p class="text-muted small mb-0"><i class="fas fa-info-circle mr-1"></i>Belum ada batch tercatat untuk obat ini</p>';
            } else {
                let html = '<table class="table table-sm table-bordered mb-0"><thead class="bg-light"><tr><th>Batch</th><th>Supplier</th><th class="text-center">Sisa</th><th>Harga Beli</th><th>Kadaluarsa</th></tr></thead><tbody>';
                batches.forEach(b => {
                    const expDate = b.expiry_date ? new Date(b.expiry_date).toLocaleDateString('id-ID') : '-';
                    const daysLeft = b.expiry_date ? Math.ceil((new Date(b.expiry_date) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                    let expBadge = '';
                    if (daysLeft !== null) {
                        if (daysLeft <= 0) expBadge = '<span class="badge badge-danger ml-1">Expired</span>';
                        else if (daysLeft <= 30) expBadge = '<span class="badge badge-warning ml-1">' + daysLeft + ' hari</span>';
                        else if (daysLeft <= 60) expBadge = '<span class="badge badge-info ml-1">' + daysLeft + ' hari</span>';
                    }
                    html += `<tr>
                        <td><code>${b.batch_number || '-'}</code></td>
                        <td>${b.supplier_name || '-'}</td>
                        <td class="text-center"><strong>${b.quantity_remaining}</strong></td>
                        <td>Rp ${parseFloat(b.cost_price).toLocaleString('id-ID')}</td>
                        <td>${expDate}${expBadge}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                batchesContainer.innerHTML = html;
            }
        } catch (error) {
            console.error('Load data error:', error);
            document.getElementById('existing-batches-container').innerHTML = '<p class="text-danger small mb-0">Gagal memuat data</p>';
        }

        $('#purchaseStockModal').modal('show');
    };

    // Calculate total on input change
    document.addEventListener('DOMContentLoaded', function() {
        const qtyInput = document.getElementById('purchase-quantity');
        const costInput = document.getElementById('purchase-cost-price');
        const totalInput = document.getElementById('purchase-total-cost');

        function updateTotal() {
            const qty = parseInt(qtyInput?.value) || 0;
            const cost = parseFloat(costInput?.value) || 0;
            if (totalInput) {
                totalInput.value = 'Rp ' + (qty * cost).toLocaleString('id-ID');
            }
        }

        qtyInput?.addEventListener('input', updateTotal);
        costInput?.addEventListener('input', updateTotal);
    });

    window.submitPurchaseStock = async function() {
        const obatId = document.getElementById('purchase-obat-id').value;
        const supplierId = document.getElementById('purchase-supplier').value;
        const quantity = document.getElementById('purchase-quantity').value;
        const costPrice = document.getElementById('purchase-cost-price').value;
        const purchaseDate = document.getElementById('purchase-date').value;
        const expiryDate = document.getElementById('purchase-expiry-date').value;
        const batchNumber = document.getElementById('purchase-batch-number').value;
        const invoiceNumber = document.getElementById('purchase-invoice').value;
        const notes = document.getElementById('purchase-notes').value;

        // Validation
        if (!quantity || quantity <= 0) {
            showWarning('Jumlah harus diisi');
            return;
        }
        if (!costPrice || costPrice <= 0) {
            showWarning('Harga beli harus diisi');
            return;
        }
        if (!purchaseDate) {
            showWarning('Tanggal pembelian harus diisi');
            return;
        }

        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/inventory/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    obat_id: obatId,
                    supplier_id: supplierId || null,
                    quantity: parseInt(quantity),
                    cost_price: parseFloat(costPrice),
                    purchase_date: purchaseDate,
                    expiry_date: expiryDate || null,
                    batch_number: batchNumber || null,
                    invoice_number: invoiceNumber || null,
                    notes: notes || null
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Gagal menyimpan');
            }

            showSuccess('Stok berhasil ditambahkan');
            $('#purchaseStockModal').modal('hide');

            // Reload obat list
            if (typeof window.loadKelolaObatList === 'function') {
                window.loadKelolaObatList();
            } else {
                // Fallback: reload kelola-obat module if available
                const { initKelolaObat } = await import('./scripts/kelola-obat.js');
                if (initKelolaObat) initKelolaObat();
            }
        } catch (error) {
            showError('Error: ' + error.message);
        }
    };

    // Kelola Tindakan (Pengaturan) Page Function
    window.showPengaturanPage = function() {
        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show pengaturan page
        document.getElementById('pengaturan-page').classList.remove('d-none');

        // Update active nav
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelector('#management-nav-kelola-tindakan .nav-link')?.classList.add('active');

        // Hide floating panel
        const floatingPanel = document.getElementById('floating-kelola-pasien');
        if (floatingPanel) {
            floatingPanel.classList.add('d-none');
        }
    };

    // Download Tindakan Price List PDF
    window.downloadTindakanPriceList = async function() {
        try {
            const token = await getIdToken();
            if (!token) {
                alert('Anda tidak terautentikasi. Silakan login kembali.');
                return;
            }

            const apiBase = ['localhost', '127.0.0.1'].includes(window.location.hostname)
                ? 'http://localhost:3001'
                : window.location.origin.replace(/\/$/, '');

            // Show loading
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const response = await fetch(`${apiBase}/api/tindakan/download/price-list`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to generate PDF');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Daftar_Harga_Tindakan_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            btn.innerHTML = originalHtml;
            btn.disabled = false;
        } catch (error) {
            console.error('Error downloading PDF:', error);
            alert('Gagal mengunduh PDF: ' + error.message);
            if (btn) {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }
    };

    // Download Obat Price List PDF
    window.downloadObatPriceList = async function() {
        try {
            const token = await getIdToken();
            if (!token) {
                alert('Anda tidak terautentikasi. Silakan login kembali.');
                return;
            }

            const apiBase = ['localhost', '127.0.0.1'].includes(window.location.hostname)
                ? 'http://localhost:3001'
                : window.location.origin.replace(/\/$/, '');

            // Show loading
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const response = await fetch(`${apiBase}/api/obat/download/price-list`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to generate PDF');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Daftar_Harga_Obat_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            btn.innerHTML = originalHtml;
            btn.disabled = false;
        } catch (error) {
            console.error('Error downloading PDF:', error);
            alert('Gagal mengunduh PDF: ' + error.message);
            if (btn) {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }
    };
 </script>

 <!-- Chat Popup Widget -->
 <script src="./scripts/chat-popup.js"></script>

</div><!-- /.wrapper -->

 <!-- Floating Kelola Pasien Panel - Completely independent, outside all wrappers -->
 <div id="floating-kelola-pasien" class="d-none collapsed" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1040;">
    <div class="card card-primary">
        <div class="card-header" onclick="toggleFloatingPanel()">
            <h3 class="card-title">
                <i class="fas fa-users mr-2"></i>Kelola Pasien
                <span class="badge badge-light ml-2" id="floating-patient-count">0</span>
            </h3>
            <div class="card-tools">
                <i class="fas fa-chevron-up toggle-icon"></i>
            </div>
        </div>
        <div class="card-body p-2">
            <div class="table-responsive" style="max-height: 40vh; overflow-y: auto;">
                <table class="table table-sm table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="floating-patients-tbody">
                        <tr><td colspan="5" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
 </div>

 <script>
    // Toggle floating panel
    window.toggleFloatingPanel = function() {
        const panel = document.getElementById('floating-kelola-pasien');
        panel.classList.toggle('collapsed');
    };
    
    // Load floating panel patients
    async function loadFloatingPanelPatients() {
        // Only load if panel is visible
        const panel = document.getElementById('floating-kelola-pasien');
        if (!panel || panel.classList.contains('d-none')) {
            console.log('Floating panel not visible, skipping load');
            return;
        }
        
        try {
            // Use unified patients endpoint
            const response = await fetch(`/api/patients?_=${Date.now()}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('vps_auth_token')}`,
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            const tbody = document.getElementById('floating-patients-tbody');
            const countBadge = document.getElementById('floating-patient-count');
            
            if (!data.data || data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Tidak ada pasien</td></tr>';
                countBadge.textContent = '0';
                return;
            }
            
            const patients = data.data;
            countBadge.textContent = patients.length;
            
            tbody.innerHTML = patients.map(p => `
                <tr>
                    <td><small>${p.id}</small></td>
                    <td><strong>${p.full_name || '-'}</strong></td>
                    <td><small>${p.email || '-'}</small></td>
                    <td>
                        <span class="badge badge-${p.status === 'active' ? 'success' : p.status === 'inactive' ? 'secondary' : 'warning'} badge-sm">
                            ${p.status || 'active'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-info btn-xs" onclick="showPatientDetail('${p.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-xs" onclick="deletePatient('${p.id}', '${(p.full_name || '').replace(/'/g, "\\'")}', event)" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
        } catch (error) {
            console.error('Error loading floating panel patients:', error);
        }
    }
    
    // Auto-refresh floating panel every 30 seconds
    setInterval(() => {
        const panel = document.getElementById('floating-kelola-pasien');
        if (panel && !panel.classList.contains('d-none')) {
            loadFloatingPanelPatients();
        }
    }, 30000);
    
    // Panel will be shown only when showManagePatientsPage() is called
    // No auto-load on page load - panel stays hidden by default
    
    // Hash Navigation Handler - Handle navigation from external pages with hash
    window.addEventListener('DOMContentLoaded', function() {
        const hash = window.location.hash;
        if (hash) {
            // Remove the # from hash
            const page = hash.substring(1);
            
            // Map hash to page functions
            const pageHandlers = {
                'kelola-pasien': showManagePatientsPage,
                'kelola-obat': showKelolaObatPage,
                'kelola-tindakan': showPengaturanPage,
                'manage-patients': showManagePatientsPage,
                'manage-obat': showKelolaObatPage,
                'pengaturan': showPengaturanPage
            };
            
            // Call the appropriate page function if it exists
            if (pageHandlers[page] && typeof pageHandlers[page] === 'function') {
                setTimeout(() => {
                    pageHandlers[page]();
                    // Clear the hash after navigation
                    history.replaceState(null, null, ' ');
                }, 500);
            }
        }

        // URL Parameter Handler - Handle showMRList param (from delete redirect)
        const urlParams = new URLSearchParams(window.location.search);
        const showMRListPatientId = urlParams.get('showMRList');
        if (showMRListPatientId) {
            const patientName = urlParams.get('patientName') || showMRListPatientId;
            // Wait for page to fully load then show modal
            setTimeout(() => {
                if (typeof showPatientMRList === 'function') {
                    showPatientMRList(showMRListPatientId, patientName);
                    // Clear URL params after showing modal
                    history.replaceState(null, null, window.location.pathname);
                }
            }, 1000);
        }
    });
 </script>

 <!-- Finance Analysis Module -->
 <script type="module">
    import { getIdToken } from './scripts/vps-auth-v2.js';

    const VPS_API_BASE = ['localhost', '127.0.0.1'].includes(window.location.hostname)
        ? 'http://localhost:3001'
        : window.location.origin.replace(/\/$/, '');

    function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount || 0);
    }

    function withCacheBuster(url) {
        const cacheBuster = `_=${Date.now()}`;
        return url.includes('?') ? `${url}&${cacheBuster}` : `${url}?${cacheBuster}`;
    }

    function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    async function fetchFinanceStats(token) {
        const today = new Date();
        const todayStr = formatDateLocal(today);

        const url = withCacheBuster(`${VPS_API_BASE}/api/visits?exclude_dummy=true&start_date=${todayStr}&end_date=${todayStr}`);
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Cache-Control': 'no-cache'
            },
            cache: 'no-store'
        });

        if (!response.ok) {
            const error = new Error('Failed to load finance stats');
            error.status = response.status;
            throw error;
        }

        const payload = await response.json();
        const visits = Array.isArray(payload.data) ? payload.data : [];

        let totalVisits = 0;
        let totalRevenue = 0;

        visits.forEach(visit => {
            totalVisits += 1;
            const total = Number(visit.grand_total ?? visit.grandTotal ?? visit.total_amount ?? 0);
            if (Number.isFinite(total)) {
                totalRevenue += total;
            }
        });

        const averageBill = totalVisits > 0 ? Math.round(totalRevenue / totalVisits) : 0;

        return {
            totalVisits,
            totalRevenue,
            averageBill
        };
    }

    async function loadKPIStats() {
        const visitsEl = document.getElementById('kpi-total-visits');
        const revenueEl = document.getElementById('kpi-revenue');
        const avgBillEl = document.getElementById('kpi-avg-bill');

        if (!visitsEl || !revenueEl || !avgBillEl) return;

        try {
            const token = await getIdToken();
            if (!token) {
                visitsEl.textContent = '0';
                revenueEl.textContent = formatCurrency(0);
                avgBillEl.textContent = formatCurrency(0);
                return;
            }

            const { totalVisits, totalRevenue, averageBill } = await fetchFinanceStats(token);

            visitsEl.textContent = totalVisits.toLocaleString('id-ID');
            revenueEl.textContent = formatCurrency(totalRevenue);
            avgBillEl.textContent = formatCurrency(averageBill);
        } catch (error) {
            console.error('Error loading KPI stats:', error);
            visitsEl.textContent = '0';
            revenueEl.textContent = formatCurrency(0);
            avgBillEl.textContent = formatCurrency(0);
        }
    }

    async function fetchAnalyticsData(token) {
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 6);
        const monthAgo = new Date(today);
        monthAgo.setDate(monthAgo.getDate() - 29);

        const startDate = formatDateLocal(monthAgo);
        const endDate = formatDateLocal(today);

        const url = withCacheBuster(`${VPS_API_BASE}/api/visits?exclude_dummy=true&start_date=${startDate}&end_date=${endDate}`);
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Cache-Control': 'no-cache'
            },
            cache: 'no-store'
        });

        if (!response.ok) throw new Error('Failed to load analytics data');

        const payload = await response.json();
        const visits = Array.isArray(payload.data) ? payload.data : [];

        return analyzeData(visits);
    }

    function analyzeData(visits) {
        const today = new Date();
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 6);
        const monthAgo = new Date(today);
        monthAgo.setDate(monthAgo.getDate() - 29);

        const weeklyData = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(weekAgo);
            date.setDate(date.getDate() + i);
            const dateStr = formatDateLocal(date);
            
            const dayVisits = visits.filter(v => {
                const visitDate = new Date(v.visit_date || v.created_at);
                return formatDateLocal(visitDate) === dateStr;
            });

            const revenue = dayVisits.reduce((sum, v) => {
                const total = Number(v.grand_total ?? v.grandTotal ?? v.total_amount ?? 0);
                return sum + (Number.isFinite(total) ? total : 0);
            }, 0);

            weeklyData.push({ date: dateStr, revenue });
        }

        const monthlyData = [];
        for (let i = 0; i < 30; i++) {
            const date = new Date(monthAgo);
            date.setDate(date.getDate() + i);
            const dateStr = formatDateLocal(date);
            
            const dayVisits = visits.filter(v => {
                const visitDate = new Date(v.visit_date || v.created_at);
                return formatDateLocal(visitDate) === dateStr;
            });

            const revenue = dayVisits.reduce((sum, v) => {
                const total = Number(v.grand_total ?? v.grandTotal ?? v.total_amount ?? 0);
                return sum + (Number.isFinite(total) ? total : 0);
            }, 0);

            monthlyData.push({ date: dateStr, revenue });
        }

        const drugStats = {};
        visits.forEach(visit => {
            let medications = [];
            if (typeof visit.medications === 'string') {
                try {
                    medications = JSON.parse(visit.medications);
                } catch (e) {
                    console.error('Error parsing medications:', e);
                }
            } else if (Array.isArray(visit.medications)) {
                medications = visit.medications;
            }

            if (Array.isArray(medications)) {
                medications.forEach(drug => {
                    const name = drug.name || 'Unknown';
                    const qty = Number(drug.quantity) || 0;
                    const price = Number(drug.price) || 0;
                    const total = qty * price;

                    if (!drugStats[name]) {
                        drugStats[name] = { name, quantity: 0, revenue: 0 };
                    }
                    drugStats[name].quantity += qty;
                    drugStats[name].revenue += total;
                });
            }
        });

        const topDrugs = Object.values(drugStats)
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 10);

        const serviceStats = {};
        visits.forEach(visit => {
            let services = [];
            if (typeof visit.services === 'string') {
                try {
                    services = JSON.parse(visit.services);
                } catch (e) {
                    console.error('Error parsing services:', e);
                }
            } else if (Array.isArray(visit.services)) {
                services = visit.services;
            }

            if (Array.isArray(services)) {
                services.forEach(service => {
                    const name = service.name || 'Unknown';
                    const price = Number(service.price) || 0;

                    if (!serviceStats[name]) {
                        serviceStats[name] = { name, count: 0, revenue: 0 };
                    }
                    serviceStats[name].count += 1;
                    serviceStats[name].revenue += price;
                });
            }
        });

        const topServices = Object.values(serviceStats)
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 10);

        return {
            weeklyRevenue: weeklyData,
            monthlyRevenue: monthlyData,
            topDrugs,
            topServices
        };
    }

    function renderWeeklyRevenueChart(data) {
        console.log(' Rendering weekly revenue chart with', data.length, 'data points');
        const container = document.getElementById('weekly-revenue-chart');
        if (!container) {
            console.error(' weekly-revenue-chart container not found');
            return;
        }

        container.innerHTML = '';

        try {
            const options = {
            series: [{
                name: 'Pemasukan',
                data: data.map(d => d.revenue)
            }],
            chart: {
                type: 'area',
                height: 250,
                toolbar: { show: false }
            },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: {
                categories: data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                })
            },
            yaxis: {
                labels: {
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.3
                }
            },
            colors: ['#007bff']
            };

            const chart = new ApexCharts(container, options);
            chart.render();
            console.log(' Weekly chart rendered');

            const total = data.reduce((sum, d) => sum + d.revenue, 0);
            const avg = total / data.length;
            const weeklyTotalEl = document.getElementById('weekly-total');
            const weeklyAvgEl = document.getElementById('weekly-avg');
            if (weeklyTotalEl) weeklyTotalEl.textContent = formatCurrency(total);
            if (weeklyAvgEl) weeklyAvgEl.textContent = formatCurrency(avg);
        } catch (error) {
            console.error(' Error rendering weekly chart:', error);
        }
    }

    function renderMonthlyRevenueChart(data) {
        console.log(' Rendering monthly revenue chart with', data.length, 'data points');
        const container = document.getElementById('monthly-revenue-chart');
        if (!container) {
            console.error(' monthly-revenue-chart container not found');
            return;
        }

        container.innerHTML = '';

        try {

        const options = {
            series: [{
                name: 'Pemasukan',
                data: data.map(d => d.revenue)
            }],
            chart: {
                type: 'line',
                height: 250,
                toolbar: { show: false }
            },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: {
                categories: data.map(d => {
                    const date = new Date(d.date);
                    return date.getDate();
                }),
                labels: {
                    rotate: -45,
                    rotateAlways: false
                }
            },
            yaxis: {
                labels: {
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                }
            },
            colors: ['#28a745']
            };

            const chart = new ApexCharts(container, options);
            chart.render();
            console.log(' Monthly chart rendered');

            const total = data.reduce((sum, d) => sum + d.revenue, 0);
            const avg = total / data.length;
            const monthlyTotalEl = document.getElementById('monthly-total');
            const monthlyAvgEl = document.getElementById('monthly-avg');
            if (monthlyTotalEl) monthlyTotalEl.textContent = formatCurrency(total);
            if (monthlyAvgEl) monthlyAvgEl.textContent = formatCurrency(avg);
        } catch (error) {
            console.error(' Error rendering monthly chart:', error);
        }
    }

    function renderTopDrugsTable(drugs) {
        console.log(' Rendering top drugs table with', drugs.length, 'items');
        const container = document.getElementById('top-drugs-table');
        if (!container) {
            console.error(' top-drugs-table container not found');
            return;
        }
        
        if (!drugs.length) {
            container.innerHTML = '<div class="text-center text-muted py-3">Tidak ada data</div>';
            console.log(' No drugs data');
            return;
        }

        let html = '<table class="table table-sm table-hover">';
        html += '<thead><tr><th>#</th><th>Nama Obat</th><th>Qty</th><th>Revenue</th></tr></thead>';
        html += '<tbody>';
        drugs.forEach((drug, idx) => {
            html += `<tr>
                <td>${idx + 1}</td>
                <td>${drug.name}</td>
                <td>${drug.quantity}</td>
                <td>${formatCurrency(drug.revenue)}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderTopServicesTable(services) {
        console.log(' Rendering top services table with', services.length, 'items');
        const container = document.getElementById('top-services-table');
        if (!container) {
            console.error(' top-services-table container not found');
            return;
        }
        
        if (!services.length) {
            container.innerHTML = '<div class="text-center text-muted py-3">Tidak ada data</div>';
            console.log(' No services data');
            return;
        }

        let html = '<table class="table table-sm table-hover">';
        html += '<thead><tr><th>#</th><th>Nama Tindakan</th><th>Jumlah</th><th>Revenue</th></tr></thead>';
        html += '<tbody>';
        services.forEach((service, idx) => {
            html += `<tr>
                <td>${idx + 1}</td>
                <td>${service.name}</td>
                <td>${service.count}</td>
                <td>${formatCurrency(service.revenue)}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function loadAnalytics() {
        try {
            const token = await getIdToken();
            if (!token) {
                throw new Error('No token');
            }

            const data = await fetchAnalyticsData(token);

            renderWeeklyRevenueChart(data.weeklyRevenue);
            renderMonthlyRevenueChart(data.monthlyRevenue);
            renderTopDrugsTable(data.topDrugs);
            renderTopServicesTable(data.topServices);
        } catch (error) {
            console.error('Error loading analytics:', error);
            const drugsTable = document.getElementById('top-drugs-table');
            const servicesTable = document.getElementById('top-services-table');
            if (drugsTable) drugsTable.innerHTML = '<div class="text-center text-danger py-3">Error loading data</div>';
            if (servicesTable) servicesTable.innerHTML = '<div class="text-center text-danger py-3">Error loading data</div>';
        }
    }

    async function initFinanceAnalysisPage() {
        console.log(' initFinanceAnalysisPage called');

        const page = document.getElementById('finance-analysis-page');
        if (!page) {
            console.error(' finance-analysis-page element not found');
            return;
        }

        console.log(' Page found, checking visibility...');

        const token = await getIdToken();
        if (!token) {
            console.error(' No auth token');
            return;
        }

        console.log(' Token obtained, loading data...');

        try {
            await loadKPIStats();
            await loadAnalytics();
            await loadObatProfitAnalysis();
            // Initialize and load Private Clinic Analysis
            initPrivateClinicMonthSelector();
            await loadPrivateClinicAnalysis();
            console.log(' Finance Analysis data loaded successfully');
        } catch (error) {
            console.error(' Error in initFinanceAnalysisPage:', error);
        }
    }

    // Load Obat Profit Analysis
    async function loadObatProfitAnalysis() {
        try {
            const token = localStorage.getItem('vps_auth_token');
            if (!token) return;

            // Get first day of current month
            const now = new Date();
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const endDate = now.toISOString().split('T')[0];

            // Fetch profit data
            const [profitRes, summaryRes] = await Promise.all([
                fetch(`/api/inventory/profit?start_date=${startDate}&end_date=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch(`/api/inventory/summary?start_date=${startDate}&end_date=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
            ]);

            if (profitRes.ok) {
                const profitData = await profitRes.json();

                // Update KPI cards
                const totals = profitData.totals || {};
                document.getElementById('profit-revenue').textContent = 'Rp ' + (totals.totalRevenue || 0).toLocaleString('id-ID');
                document.getElementById('profit-cost').textContent = 'Rp ' + (totals.totalCost || 0).toLocaleString('id-ID');
                document.getElementById('profit-gross').textContent = 'Rp ' + (totals.totalProfit || 0).toLocaleString('id-ID');
                document.getElementById('profit-margin').textContent = (totals.profitMargin || 0) + '%';

                // Update items table
                const tbody = document.getElementById('profit-items-body');
                const items = profitData.items || [];

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Belum ada data penjualan obat bulan ini</td></tr>';
                } else {
                    tbody.innerHTML = items.map(item => {
                        const revenue = parseFloat(item.revenue) || 0;
                        const cost = parseFloat(item.cost) || 0;
                        const profit = parseFloat(item.profit) || 0;
                        const margin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
                        const marginClass = margin >= 30 ? 'text-success' : margin >= 15 ? 'text-warning' : 'text-danger';

                        return `
                            <tr>
                                <td>${item.name || '-'}</td>
                                <td class="text-right">${item.qty_sold || 0}</td>
                                <td class="text-right">Rp ${revenue.toLocaleString('id-ID')}</td>
                                <td class="text-right">Rp ${cost.toLocaleString('id-ID')}</td>
                                <td class="text-right font-weight-bold ${profit >= 0 ? 'text-success' : 'text-danger'}">
                                    Rp ${profit.toLocaleString('id-ID')}
                                </td>
                                <td class="text-right ${marginClass}">${margin}%</td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            if (summaryRes.ok) {
                const summary = await summaryRes.json();

                // Show expiring items alert
                if (summary.expiringItemsCount > 0) {
                    document.getElementById('expiring-alert').style.display = 'block';
                    document.getElementById('expiring-count').textContent = summary.expiringItemsCount;
                } else {
                    document.getElementById('expiring-alert').style.display = 'none';
                }

                // Show low stock alert
                if (summary.lowStockCount > 0) {
                    document.getElementById('lowstock-alert').style.display = 'block';
                    document.getElementById('lowstock-count').textContent = summary.lowStockCount;
                } else {
                    document.getElementById('lowstock-alert').style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Load obat profit analysis error:', error);
        }
    }

    window.loadObatProfitAnalysis = loadObatProfitAnalysis;

    // Private Clinic Analysis Functions
    function initPrivateClinicMonthSelector() {
        const select = document.getElementById('private-clinic-month');
        if (!select) return;

        const now = new Date();
        select.innerHTML = '';

        // Generate last 12 months
        for (let i = 0; i < 12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const value = d.toISOString().slice(0, 7);
            const label = d.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            select.appendChild(option);
        }

        select.addEventListener('change', () => loadPrivateClinicAnalysis());
    }

    async function loadPrivateClinicAnalysis() {
        const token = localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token');
        if (!token) return;

        const monthSelect = document.getElementById('private-clinic-month');
        const month = monthSelect ? monthSelect.value : '';

        try {
            const response = await fetch(`/api/analytics/private-clinic?month=${month}&staffCount=3`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Failed to load data');

            const result = await response.json();
            const data = result.data;

            // Format currency helper
            const formatRp = (num) => 'Rp ' + Math.round(num || 0).toLocaleString('id-ID');
            const formatPercent = (num) => (num || 0).toFixed(1) + '%';

            // Update KPI cards
            document.getElementById('pc-pendapatan-kotor').textContent = formatRp(data.summary.pendapatanKotor);
            document.getElementById('pc-laba-kotor').textContent = formatRp(data.summary.labaKotor);
            document.getElementById('pc-laba-bersih').textContent = formatRp(data.netProfit.labaBersih);
            document.getElementById('pc-margin-bersih').textContent = formatPercent(data.netProfit.marginLabaBersih);

            // Update KPI side panel
            document.getElementById('pc-kunjungan').textContent = data.summary.totalKunjungan;
            document.getElementById('pc-hari-kerja').textContent = data.summary.totalHariKerja + ' hari';
            document.getElementById('pc-laba-per-hari').textContent = formatRp(data.netProfit.labaPerHari);
            document.getElementById('pc-laba-per-kunjungan').textContent = formatRp(data.netProfit.labaPerKunjungan);

            // Update Profit Loss Table
            const plTable = document.getElementById('pc-profit-loss-table');
            plTable.innerHTML = `
                <tr class="bg-light"><td colspan="2"><strong>PENDAPATAN</strong></td></tr>
                <tr><td class="pl-4">Tindakan (Jasa Medis)</td><td class="text-right">${formatRp(data.summary.pendapatanTindakan)}</td></tr>
                <tr><td class="pl-4">Penjualan Obat</td><td class="text-right">${formatRp(data.summary.pendapatanObat)}</td></tr>
                <tr class="font-weight-bold"><td>Total Pendapatan Kotor</td><td class="text-right">${formatRp(data.summary.pendapatanKotor)}</td></tr>
                <tr class="bg-light"><td colspan="2"><strong>HPP (HARGA POKOK)</strong></td></tr>
                <tr><td class="pl-4">HPP Obat</td><td class="text-right text-danger">(${formatRp(data.summary.totalHPP)})</td></tr>
                <tr class="font-weight-bold border-top"><td>Laba Kotor</td><td class="text-right text-info">${formatRp(data.summary.labaKotor)}</td></tr>
                <tr class="bg-light"><td colspan="2"><strong>BIAYA OPERASIONAL</strong></td></tr>
                <tr><td class="pl-4">Sewa, Listrik, Air</td><td class="text-right text-muted">Rp 0 <small>(ditanggung RS)</small></td></tr>
                <tr><td class="pl-4">Gaji Staff (${data.staffCost.jumlahStaff} org  ${data.staffCost.kehadiranPerStaff} hari)</td><td class="text-right text-danger">(${formatRp(data.staffCost.totalGaji)})</td></tr>
                <tr class="font-weight-bold bg-success text-white"><td>LABA BERSIH</td><td class="text-right">${formatRp(data.netProfit.labaBersih)}</td></tr>
                <tr><td class="text-muted">Margin Laba Bersih</td><td class="text-right text-success font-weight-bold">${formatPercent(data.netProfit.marginLabaBersih)}</td></tr>
            `;

            // Update Tindakan by Category
            const tindakanBody = document.getElementById('pc-tindakan-category-body');
            if (data.breakdown.tindakanByCategory.length === 0) {
                tindakanBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Tidak ada data</td></tr>';
            } else {
                tindakanBody.innerHTML = data.breakdown.tindakanByCategory.map(cat => `
                    <tr>
                        <td><span class="badge badge-secondary">${cat.category}</span></td>
                        <td class="text-right">${cat.jumlah_transaksi}</td>
                        <td class="text-right font-weight-bold">${formatRp(parseFloat(cat.total_pendapatan))}</td>
                    </tr>
                `).join('');
            }

            // Update Obat Profit
            const obatBody = document.getElementById('pc-obat-profit-body');
            if (data.breakdown.obatAnalysis.length === 0) {
                obatBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Tidak ada data</td></tr>';
            } else {
                obatBody.innerHTML = data.breakdown.obatAnalysis.map(obat => {
                    const margin = parseFloat(obat.margin_persen) || 0;
                    const marginClass = margin >= 30 ? 'text-success' : margin >= 15 ? 'text-warning' : 'text-danger';
                    const profit = parseFloat(obat.keuntungan_kotor) || 0;
                    return `
                        <tr>
                            <td>${obat.item_name}</td>
                            <td class="text-right">${obat.total_qty}</td>
                            <td class="text-right">${formatRp(profit)}</td>
                            <td class="text-right ${marginClass} font-weight-bold">${margin.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');
            }

            // Update Top Tindakan
            const topBody = document.getElementById('pc-top-tindakan-body');
            if (data.breakdown.topTindakan.length === 0) {
                topBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Tidak ada data</td></tr>';
            } else {
                topBody.innerHTML = data.breakdown.topTindakan.map(t => `
                    <tr>
                        <td>${t.item_name}</td>
                        <td><span class="badge badge-info">${t.category}</span></td>
                        <td class="text-right">${t.total_qty}</td>
                        <td class="text-right">${formatRp(parseFloat(t.avg_harga))}</td>
                        <td class="text-right font-weight-bold">${formatRp(parseFloat(t.total_pendapatan))}</td>
                    </tr>
                `).join('');
            }

        } catch (error) {
            console.error('Load private clinic analysis error:', error);
        }
    }

    window.loadPrivateClinicAnalysis = loadPrivateClinicAnalysis;

    // Show expiring items modal (optional)
    window.showExpiringItems = async function() {
        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch('/api/inventory/expiring?days=60', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) return;

            const data = await response.json();
            const items = data.data || [];

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Obat</th><th>Batch</th><th>Sisa</th><th>Kadaluarsa</th></tr></thead><tbody>';
            items.forEach(item => {
                const expDate = new Date(item.expiry_date).toLocaleDateString('id-ID');
                const daysLeft = item.days_until_expiry;
                const badge = daysLeft <= 0 ? 'badge-danger' : daysLeft <= 30 ? 'badge-warning' : 'badge-secondary';
                html += `<tr>
                    <td>${item.obat_name}</td>
                    <td><code>${item.batch_number || '-'}</code></td>
                    <td>${item.quantity_remaining}</td>
                    <td><span class="badge ${badge}">${expDate}</span> <small>(${daysLeft} hari)</small></td>
                </tr>`;
            });
            html += '</tbody></table></div>';

            // Show in simple alert or modal
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = `
                <div class="modal fade" id="expiringModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title"><i class="fas fa-exclamation-triangle mr-2"></i>Item Kadaluarsa</h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">${html}</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
            $('#expiringModal').modal('show');
            $('#expiringModal').on('hidden.bs.modal', function() {
                alertDiv.remove();
            });
        } catch (error) {
            console.error('Show expiring items error:', error);
        }
    };

    // Export to window for manual calling
    window.initFinanceAnalysisPage = initFinanceAnalysisPage;

    // Hospital Appointments Page - Store current data
    let currentHospitalAppointments = [];
    let currentHospitalLocation = '';

    window.showHospitalAppointmentsPage = async function(location) {
        console.log(' Loading hospital appointments for:', location);
        currentHospitalLocation = location;

        // Hide all pages
        document.querySelectorAll('[id$="-page"]').forEach(page => page.classList.add('d-none'));

        // Show hospital appointments page
        const hospitalPage = document.getElementById('hospital-appointments-page');
        if (hospitalPage) {
            hospitalPage.classList.remove('d-none');
        }

        const container = document.getElementById('hospital-appointments-container');
        if (!container) return;

        // Show loading
        container.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><p class="mt-3">Memuat appointment...</p></div>';

        try {
            const token = localStorage.getItem('vps_auth_token');
            const response = await fetch(`/api/appointments?hospital_location=${location}&status=scheduled,confirmed`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error('Gagal memuat appointment');
            }

            const result = await response.json();
            currentHospitalAppointments = result.data || [];

            // Hospital info mapping
            const hospitalInfo = {
                'rsia_melinda': { name: 'RSIA Melinda', color: '#e91e63' },
                'rsud_gambiran': { name: 'RSUD Gambiran', color: '#2196f3' },
                'rs_bhayangkara': { name: 'RS Bhayangkara', color: '#2196f3' }
            };

            const hospital = hospitalInfo[location] || { name: location, color: '#607d8b' };

            // Build header with search
            let html = `
                <div class="card mb-3">
                    <div class="card-header" style="background: linear-gradient(135deg, ${hospital.color} 0%, ${hospital.color}dd 100%); color: white;">
                        <h4 class="mb-0"><i class="fas fa-hospital-alt mr-2"></i>${hospital.name} - Appointment</h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    </div>
                                    <input type="text" id="hospital-patient-search" class="form-control"
                                           placeholder="Cari nama pasien..."
                                           onkeyup="window.filterHospitalAppointments(this.value)">
                                </div>
                            </div>
                            <div class="col-md-6 text-right">
                                <span class="badge badge-primary p-2" style="font-size: 14px;">
                                    <i class="fas fa-users mr-1"></i>
                                    <span id="hospital-appointments-count">${currentHospitalAppointments.length}</span> Appointment
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="hospital-appointments-cards-container"></div>
            `;

            container.innerHTML = html;

            // Render appointments
            renderHospitalAppointments(currentHospitalAppointments, hospital);

        } catch (error) {
            console.error('Error loading hospital appointments:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> ${error.message}
                </div>
            `;
        }
    };

    // Filter appointments by patient name
    window.filterHospitalAppointments = function(searchTerm) {
        const term = searchTerm.toLowerCase().trim();

        const filtered = term === ''
            ? currentHospitalAppointments
            : currentHospitalAppointments.filter(apt =>
                apt.patient_name.toLowerCase().includes(term)
            );

        // Hospital info mapping
        const hospitalInfo = {
            'rsia_melinda': { name: 'RSIA Melinda', color: '#e91e63' },
            'rsud_gambiran': { name: 'RSUD Gambiran', color: '#2196f3' },
            'rs_bhayangkara': { name: 'RS Bhayangkara', color: '#2196f3' }
        };

        const hospital = hospitalInfo[currentHospitalLocation] || {
            name: currentHospitalLocation,
            color: '#607d8b'
        };

        // Update count
        const countEl = document.getElementById('hospital-appointments-count');
        if (countEl) {
            countEl.textContent = filtered.length;
        }

        renderHospitalAppointments(filtered, hospital);
    };

    // Render appointments cards
    function renderHospitalAppointments(appointments, hospital) {
        const cardsContainer = document.getElementById('hospital-appointments-cards-container');
        if (!cardsContainer) return;

        if (appointments.length === 0) {
            cardsContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Tidak ada appointment yang sesuai
                </div>
            `;
            return;
        }

        let html = `<div class="row">`;

        appointments.forEach(apt => {
            const date = new Date(apt.appointment_date);
            const dateStr = date.toLocaleDateString('id-ID', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const statusBadge = apt.status === 'confirmed'
                ? '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Terkonfirmasi</span>'
                : '<span class="badge badge-warning"><i class="fas fa-clock"></i> Terjadwal</span>';

            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card" style="border-left: 4px solid ${hospital.color};">
                        <div class="card-header" style="background: linear-gradient(135deg, ${hospital.color}22 0%, ${hospital.color}11 100%);">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user-circle"></i> ${apt.patient_name}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><i class="fas fa-hospital text-muted mr-2"></i><strong>${hospital.name}</strong></p>
                            <p class="mb-2"><i class="fas fa-calendar text-muted mr-2"></i>${dateStr}</p>
                            <p class="mb-2"><i class="fas fa-clock text-muted mr-2"></i>${apt.appointment_time ? apt.appointment_time.substring(0,5) + ' WIB' : '-'}</p>
                            <p class="mb-2"><i class="fas fa-heartbeat text-muted mr-2"></i>${apt.appointment_type || 'Konsultasi'}</p>
                            ${apt.complaint ? `<p class="mb-2 small text-muted"><i class="fas fa-comment-medical mr-2"></i>${apt.complaint}</p>` : ''}
                            <div class="mt-3">${statusBadge}</div>
                        </div>
                        <div class="card-footer bg-white">
                            <button class="btn btn-primary btn-block" onclick="window.startHospitalExam(${apt.patient_id}, ${apt.id}, '${hospital.name}')">
                                <i class="fas fa-stethoscope mr-2"></i>PERIKSA
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        cardsContainer.innerHTML = html;
    }

    // Start hospital examination
    window.startHospitalExam = async function(patientId, appointmentId, hospitalName) {
        console.log(' Starting exam for patient:', patientId, 'appointment:', appointmentId);

        try {
            // Create or get medical record for this patient
            const token = localStorage.getItem('vps_auth_token');

            // Mark appointment as in-progress
            await fetch(`/api/appointments/${appointmentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: 'confirmed' })
            });

            // Load the Sunday Clinic exam page with this patient
            if (typeof window.loadSundayClinic === 'function') {
                await window.loadSundayClinic(patientId);
            } else {
                showError('Modul pemeriksaan tidak tersedia. Silakan refresh halaman.');
            }

        } catch (error) {
            console.error('Error starting hospital exam:', error);
            if (typeof showError === 'function') {
                showError('Gagal memulai pemeriksaan: ' + error.message);
            } else {
                alert('Gagal memulai pemeriksaan: ' + error.message);
            }
        }
    };

 </script>

 <!-- Mobile Helper Script -->
 <script src="scripts/mobile-helper.js"></script>
    <!-- Global Chat Loader -->
    <script src="/staff/public/scripts/global-chat-loader.js"></script>

<!-- Profile Completion Modal -->
<div class="modal fade" id="profile-completion-modal" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit mr-2"></i>Lengkapi Profil Anda
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Upload foto profil dan ganti password untuk mengakses website ini.</strong>
                </div>

                <form id="profile-completion-form">
                    <!-- Profile Picture Upload -->
                    <div class="form-group text-center">
                        <label class="font-weight-bold">Foto Profil <span class="text-danger">*</span></label>
                        <div class="d-flex justify-content-center mb-3">
                            <div class="position-relative" style="width: 120px; height: 120px;">
                                <div id="completion-avatar-preview" class="rounded-circle bg-secondary d-flex align-items-center justify-content-center"
                                     style="width: 120px; height: 120px; overflow: hidden; border: 3px dashed #ccc;">
                                    <i id="completion-avatar-icon" class="fas fa-camera fa-3x text-muted"></i>
                                    <img id="completion-avatar-img" src="" alt="Preview"
                                         style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                </div>
                            </div>
                        </div>
                        <input type="file" id="completion-photo-input" accept="image/*" class="d-none">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('completion-photo-input').click()">
                            <i class="fas fa-upload mr-1"></i>Pilih Foto
                        </button>
                        <small class="d-block text-muted mt-1">Format: JPG, PNG. Maksimal 2MB</small>
                    </div>

                    <hr>

                    <!-- Password Change -->
                    <div class="form-group">
                        <label class="font-weight-bold">Password Baru <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="completion-new-password"
                                   placeholder="Masukkan password baru" minlength="6" required>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleCompletionPassword('completion-new-password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <small class="text-muted">Minimal 6 karakter</small>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">Konfirmasi Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="completion-confirm-password"
                                   placeholder="Ulangi password baru" minlength="6" required>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleCompletionPassword('completion-confirm-password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" id="btn-skip-completion">
                    <i class="fas fa-sign-out-alt mr-1"></i>Keluar
                </button>
                <button type="button" class="btn btn-success" id="btn-save-completion" disabled>
                    <i class="fas fa-check mr-1"></i>Simpan & Lanjutkan
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Profile Completion Handler
window.profileCompletionData = {
    photo: null,
    password: null
};

// Toggle password visibility
window.toggleCompletionPassword = function(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
};

// Photo input handler
document.getElementById('completion-photo-input')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        Swal.fire('Error', 'File harus berupa gambar (JPG, PNG)', 'error');
        return;
    }

    if (file.size > 2 * 1024 * 1024) {
        Swal.fire('Error', 'Ukuran file maksimal 2MB', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        window.profileCompletionData.photo = event.target.result;
        document.getElementById('completion-avatar-img').src = event.target.result;
        document.getElementById('completion-avatar-img').style.display = 'block';
        document.getElementById('completion-avatar-icon').style.display = 'none';
        validateCompletionForm();
    };
    reader.readAsDataURL(file);
});

// Password input handlers
document.getElementById('completion-new-password')?.addEventListener('input', validateCompletionForm);
document.getElementById('completion-confirm-password')?.addEventListener('input', validateCompletionForm);

function validateCompletionForm() {
    const photo = window.profileCompletionData.photo;
    const newPassword = document.getElementById('completion-new-password')?.value || '';
    const confirmPassword = document.getElementById('completion-confirm-password')?.value || '';

    const isValid = photo &&
                    newPassword.length >= 6 &&
                    newPassword === confirmPassword;

    const saveBtn = document.getElementById('btn-save-completion');
    if (saveBtn) {
        saveBtn.disabled = !isValid;
    }

    return isValid;
}

// Skip button - logout
document.getElementById('btn-skip-completion')?.addEventListener('click', async function() {
    const result = await Swal.fire({
        title: 'Keluar?',
        text: 'Anda harus melengkapi profil untuk mengakses website ini.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Keluar',
        cancelButtonText: 'Batal'
    });

    if (result.isConfirmed) {
        localStorage.removeItem('vps_auth_token');
        localStorage.removeItem('vps_auth_user');
        window.location.href = 'login.html';
    }
});

// Save completion
document.getElementById('btn-save-completion')?.addEventListener('click', async function() {
    if (!validateCompletionForm()) {
        Swal.fire('Error', 'Lengkapi semua field yang diperlukan', 'error');
        return;
    }

    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Menyimpan...';

    try {
        const token = localStorage.getItem('vps_auth_token');
        const apiBase = window.location.origin;

        // Update photo
        const photoResponse = await fetch(`${apiBase}/api/auth/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ photo_url: window.profileCompletionData.photo })
        });

        if (!photoResponse.ok) {
            throw new Error('Gagal menyimpan foto profil');
        }

        // Update password - need to use default password as current
        const newPassword = document.getElementById('completion-new-password').value;
        const passwordResponse = await fetch(`${apiBase}/api/auth/set-initial-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ newPassword })
        });

        if (!passwordResponse.ok) {
            const errData = await passwordResponse.json();
            throw new Error(errData.message || 'Gagal mengubah password');
        }

        // Mark profile as completed
        await fetch(`${apiBase}/api/auth/mark-profile-completed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });

        // Update local user data
        const userData = JSON.parse(localStorage.getItem('vps_auth_user') || '{}');
        userData.photo_url = window.profileCompletionData.photo;
        userData.profile_completed = true;
        localStorage.setItem('vps_auth_user', JSON.stringify(userData));

        $('#profile-completion-modal').modal('hide');

        Swal.fire({
            title: 'Berhasil!',
            text: 'Profil Anda telah dilengkapi. Selamat bekerja!',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            // Refresh page to update UI
            window.location.reload();
        });

    } catch (error) {
        console.error('Profile completion error:', error);
        Swal.fire('Error', error.message || 'Gagal menyimpan profil', 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Function to show profile completion modal
window.showProfileCompletionModal = function() {
    // Reset form
    window.profileCompletionData.photo = null;
    document.getElementById('completion-avatar-img').style.display = 'none';
    document.getElementById('completion-avatar-icon').style.display = 'block';
    document.getElementById('completion-new-password').value = '';
    document.getElementById('completion-confirm-password').value = '';
    document.getElementById('btn-save-completion').disabled = true;

    $('#profile-completion-modal').modal('show');
};

// ============================================
// Registration Codes Functions
// ============================================

let currentGeneratedCode = null;
let currentGeneratedPhone = null;
let currentPatientName = null;
let regCodesCurrentPage = 1;
let regCodesTotalPages = 1;

// Legacy function - redirects to main page function
async function loadRegistrationCodes(page = 1) {
    if (typeof loadNewPatients === 'function') {
        loadNewPatients(page);
    }
}

async function openGenerateCodeModal() {
    document.getElementById('generated-code-result').style.display = 'none';
    document.getElementById('current-public-code').style.display = 'none';
    document.getElementById('btn-generate-code').style.display = 'inline-block';
    $('#generateCodeModal').modal('show');

    // Check for existing public code
    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch('/api/registration-codes/public', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.success && data.code) {
            document.getElementById('current-code-display').textContent = data.code;
            const expires = new Date(data.expires_at);
            document.getElementById('current-code-expires').textContent = `Berlaku sampai: ${expires.toLocaleString('id-ID')}`;
            document.getElementById('current-public-code').style.display = 'block';
        }
    } catch (e) {
        console.log('No active public code');
    }
}

async function generatePublicCode() {
    const btn = document.getElementById('btn-generate-code');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch('/api/registration-codes/generate-public', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Gagal generate kode');
        }

        document.getElementById('generated-code-display').textContent = data.code;
        document.getElementById('generated-code-result').style.display = 'block';
        document.getElementById('current-public-code').style.display = 'none';

        // Reload new patients on main page
        if (typeof loadNewPatients === 'function') {
            loadNewPatients(newPatientsCurrentPage || 1);
        }

        // Update dashboard display
        updateDashboardCodeDisplay(data.code, data.expires_at);

    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-key"></i> Generate Kode Baru';
    }
}

// Update dashboard code display
function updateDashboardCodeDisplay(code, expiresAt) {
    const el = document.getElementById('dashboard-current-code');
    if (el && code) {
        el.textContent = code;
    }
}

// Load current code for dashboard on page load
async function loadDashboardCurrentCode() {
    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch('/api/registration-codes/public', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (data.success && data.code) {
            updateDashboardCodeDisplay(data.code, data.expires_at);
        }
    } catch (e) {
        console.log('No active public code');
    }
}

// Make function globally available
window.openGenerateCodeModal = openGenerateCodeModal;
window.loadDashboardCurrentCode = loadDashboardCurrentCode;

async function sendCodeWhatsApp() {
    if (!currentGeneratedCode || !currentGeneratedPhone) {
        alert('Kode belum di-generate');
        return;
    }

    const btn = document.getElementById('btn-send-whatsapp');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch('/api/registration-codes/send-whatsapp', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: currentGeneratedCode,
                phone: currentGeneratedPhone,
                patient_name: currentPatientName
            })
        });

        const data = await response.json();

        if (data.method === 'fonnte') {
            alert('Kode berhasil dikirim via WhatsApp!');
            $('#generateCodeModal').modal('hide');
        } else if (data.waLink) {
            window.open(data.waLink, '_blank');
            alert('Link WhatsApp terbuka di tab baru. Klik kirim untuk mengirim pesan.');
            $('#generateCodeModal').modal('hide');
        } else {
            throw new Error(data.message || 'Gagal mengirim');
        }

    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fab fa-whatsapp"></i> Kirim via WhatsApp';
    }
}

async function resendCodeWhatsApp(code, phone, patientName) {
    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch('/api/registration-codes/send-whatsapp', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code, phone, patient_name: patientName })
        });

        const data = await response.json();

        if (data.method === 'fonnte') {
            alert('Kode berhasil dikirim ulang via WhatsApp!');
        } else if (data.waLink) {
            window.open(data.waLink, '_blank');
            alert('Link WhatsApp terbuka di tab baru.');
        }

    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteCode(codeId) {
    if (!confirm('Hapus kode registrasi ini?')) return;

    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch(`/api/registration-codes/${codeId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Gagal menghapus');

        // Reload new patients on main page
        if (typeof loadNewPatients === 'function') {
            loadNewPatients(newPatientsCurrentPage || 1);
        }

    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>

<!-- Generate Registration Code Modal -->
<div class="modal fade" id="generateCodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-key"></i> Generate Kode Registrasi Publik</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Kode ini dapat digunakan oleh siapa saja yang ingin mendaftar. Berlaku 24 jam atau sampai kode baru di-generate.
                </div>
                <div id="current-public-code" class="text-center mb-3" style="display: none;">
                    <p class="mb-1 text-muted">Kode Aktif Saat Ini:</p>
                    <h2 class="text-success font-weight-bold" id="current-code-display"></h2>
                    <p class="text-muted small" id="current-code-expires"></p>
                </div>
                <div id="generated-code-result" style="display: none;">
                    <hr>
                    <div class="text-center">
                        <p class="mb-2"><i class="fas fa-check-circle text-success"></i> Kode Baru:</p>
                        <h2 class="text-warning font-weight-bold" id="generated-code-display"></h2>
                        <p class="text-muted">Berlaku 24 jam</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-warning" id="btn-generate-code" onclick="generatePublicCode()">
                    <i class="fas fa-key"></i> Generate Kode Baru
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Stock Modal (Tambah Stok) -->
<div class="modal fade" id="purchaseStockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle mr-2"></i>Tambah Stok Obat</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="purchase-stock-form">
                    <input type="hidden" id="purchase-obat-id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Obat</label>
                                <input type="text" id="purchase-obat-name" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Supplier</label>
                                <select id="purchase-supplier" class="form-control">
                                    <option value="">-- Pilih Supplier --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Jumlah <span class="text-danger">*</span></label>
                                <input type="number" id="purchase-quantity" class="form-control" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Harga Beli/Unit <span class="text-danger">*</span></label>
                                <input type="number" id="purchase-cost-price" class="form-control" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Total Harga Beli</label>
                                <input type="text" id="purchase-total-cost" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tanggal Pembelian <span class="text-danger">*</span></label>
                                <input type="date" id="purchase-date" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tanggal Kadaluarsa</label>
                                <input type="date" id="purchase-expiry-date" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>No. Batch</label>
                                <input type="text" id="purchase-batch-number" class="form-control" placeholder="Opsional">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>No. Invoice</label>
                                <input type="text" id="purchase-invoice" class="form-control" placeholder="Opsional">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Catatan</label>
                                <input type="text" id="purchase-notes" class="form-control" placeholder="Opsional">
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Existing Batches Section -->
                <div class="mt-3 pt-3 border-top">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-boxes mr-1"></i>Batch yang Ada (Stok Tersisa)
                    </h6>
                    <div id="existing-batches-container" style="max-height: 150px; overflow-y: auto;">
                        <p class="text-muted small mb-0">Memuat...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" onclick="submitPurchaseStock()">
                    <i class="fas fa-save mr-1"></i>Simpan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Medical Record Import Modal -->
<div class="modal fade" id="import-medical-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Import Catatan Medis dari File Text</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Input -->
                <div id="import-step-1">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Kategori <span class="text-danger">*</span></label>
                                <select class="form-control" id="import-category">
                                    <option value="">-- Pilih Kategori --</option>
                                    <option value="obstetri">Obstetri</option>
                                    <option value="gyn_repro">Ginekologi Reproduksi</option>
                                    <option value="gyn_special">Ginekologi Khusus</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>Upload File</label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="import-file" accept=".txt,.text">
                                    <label class="custom-file-label" for="import-file">Pilih file...</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Atau Paste Teks</label>
                        <textarea class="form-control" id="import-text" rows="10" placeholder="Paste catatan medis di sini..."></textarea>
                    </div>
                </div>
                <!-- Step 2: Preview -->
                <div id="import-step-2" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-1"></i>Periksa hasil parsing sebelum mengisi form. Centang field yang ingin diisi.
                    </div>
                    <!-- Patient Selector -->
                    <div class="card card-outline card-danger mb-3" id="import-patient-select-card">
                        <div class="card-header compact bg-danger">
                            <h6 class="m-0 text-white"><i class="fas fa-user-plus mr-1"></i>Pilih Pasien</h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="form-group mb-0">
                                <select class="form-control form-control-sm" id="import-patient-select">
                                    <option value="">-- Memuat daftar pasien... --</option>
                                </select>
                                <small class="text-muted">Pilih pasien untuk membuat MR baru dengan data yang di-import</small>
                            </div>
                        </div>
                    </div>
                    <!-- Visit Info -->
                    <div class="card card-outline card-secondary mb-3">
                        <div class="card-header compact">
                            <h6 class="m-0"><i class="fas fa-calendar-check mr-1"></i>Info Kunjungan</h6>
                        </div>
                        <div class="card-body p-2" id="preview-visit-info"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-outline card-primary">
                                <div class="card-header compact"><h6 class="m-0"><i class="fas fa-id-card mr-1"></i>Identitas</h6></div>
                                <div class="card-body p-2" id="preview-identitas"></div>
                            </div>
                            <div class="card card-outline card-info">
                                <div class="card-header compact"><h6 class="m-0"><i class="fas fa-clipboard-list mr-1"></i>Anamnesa</h6></div>
                                <div class="card-body p-2" id="preview-anamnesa"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-outline card-success">
                                <div class="card-header compact"><h6 class="m-0"><i class="fas fa-stethoscope mr-1"></i>Pemeriksaan Fisik</h6></div>
                                <div class="card-body p-2" id="preview-pemeriksaan"></div>
                            </div>
                            <div class="card card-outline card-warning">
                                <div class="card-header compact"><h6 class="m-0"><i class="fas fa-diagnoses mr-1"></i>Diagnosis & Planning</h6></div>
                                <div class="card-body p-2" id="preview-diagnosis"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2"><span class="badge badge-info" id="import-confidence"></span></div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fas fa-times mr-1"></i>Batal</button>
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="btn-import-back" style="display: none;" onclick="importMedicalBack()">
                        <i class="fas fa-arrow-left mr-1"></i>Kembali
                    </button>
                    <button type="button" class="btn btn-info" id="btn-import-parse" onclick="importMedicalParse()">
                        <i class="fas fa-search mr-1"></i>Parse & Preview
                    </button>
                    <button type="button" class="btn btn-success" id="btn-import-apply" style="display: none;" onclick="importMedicalApply()">
                        <i class="fas fa-check mr-1"></i>Terapkan ke Form
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal fade" id="bulk-import-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-upload mr-2"></i>Bulk Import Catatan Medis</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle mr-1"></i>Upload multiple file text (.txt) untuk parsing sekaligus. Maksimal 50 file.
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="small font-weight-bold">Kategori Default</label>
                        <select class="form-control form-control-sm" id="bulk-import-category">
                            <option value="obstetri">Obstetri</option>
                            <option value="gyn_repro">Ginekologi Reproduksi</option>
                            <option value="gyn_special">Ginekologi Khusus</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="small font-weight-bold">Lokasi Default</label>
                        <select class="form-control form-control-sm" id="bulk-import-location">
                            <option value="">-- Auto Detect --</option>
                            <option value="klinik_private">Klinik Privat dr. Dibya</option>
                            <option value="rsia_melinda">RSIA Melinda</option>
                            <option value="rsud_gambiran">RSUD Gambiran</option>
                            <option value="rs_bhayangkara">RS Bhayangkara</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="small font-weight-bold">Pilih File</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="bulk-import-files" accept=".txt,.text" multiple onchange="handleBulkFilesSelect(event)">
                            <label class="custom-file-label" for="bulk-import-files">Pilih file...</label>
                        </div>
                    </div>
                </div>
                <div id="bulk-import-progress" style="display: none;" class="mb-3">
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="bulk-import-progress-bar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="bulk-import-progress-text">Memproses...</small>
                </div>
                <div id="bulk-import-results"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fas fa-times mr-1"></i>Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- Staff Notification System -->
<script>
// Notification system variables
let notificationPollInterval = null;
let lastNotificationCount = 0;

// Initialize notification system when auth is ready
document.addEventListener('DOMContentLoaded', function() {
    // Wait for auth to be ready
    const checkAuth = setInterval(() => {
        if (window.auth && window.auth.currentUser) {
            clearInterval(checkAuth);
            initNotificationSystem();
        }
    }, 500);

    // Timeout after 10 seconds
    setTimeout(() => clearInterval(checkAuth), 10000);
});

function initNotificationSystem() {
    console.log('[Notifications] Initializing notification system');

    // Load notifications initially
    loadNotifications();
    loadNotificationCount();

    // Poll for new notifications every 30 seconds
    notificationPollInterval = setInterval(() => {
        loadNotificationCount();
    }, 30000);

    // Load notifications when dropdown is opened
    const notificationDropdown = document.getElementById('notification-dropdown');
    if (notificationDropdown) {
        notificationDropdown.addEventListener('show.bs.dropdown', loadNotifications);
        // Also handle jQuery events for Bootstrap 4
        $(notificationDropdown).on('show.bs.dropdown', loadNotifications);
    }
}

async function loadNotificationCount() {
    try {
        const token = await window.getIdToken();
        if (!token) return;

        const response = await fetch('/api/notifications/count', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        if (data.success) {
            updateNotificationBadge(data.count);
        }
    } catch (error) {
        console.error('[Notifications] Error loading count:', error);
    }
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notification-badge');
    const headerCount = document.getElementById('notification-header-count');

    if (badge) {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline';

            // Animate if count increased
            if (count > lastNotificationCount) {
                badge.classList.add('notification-pulse');
                setTimeout(() => badge.classList.remove('notification-pulse'), 1000);
            }
        } else {
            badge.style.display = 'none';
        }
    }

    if (headerCount) {
        headerCount.textContent = count;
    }

    lastNotificationCount = count;
}

async function loadNotifications() {
    try {
        const token = await window.getIdToken();
        if (!token) return;

        const response = await fetch('/api/notifications/with-announcements?limit=10', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        if (data.success) {
            renderNotificationList(data.items || []);
            updateNotificationBadge(data.unread_count);
        }
    } catch (error) {
        console.error('[Notifications] Error loading notifications:', error);
        document.getElementById('notification-list').innerHTML = `
            <div class="dropdown-item text-center text-muted py-3">
                <i class="fas fa-exclamation-circle text-danger"></i> Gagal memuat notifikasi
            </div>
        `;
    }
}

function renderNotificationList(items) {
    const container = document.getElementById('notification-list');
    if (!container) return;

    if (items.length === 0) {
        container.innerHTML = `
            <div class="dropdown-item text-center text-muted py-3">
                <i class="far fa-bell-slash"></i> Tidak ada notifikasi
            </div>
        `;
        return;
    }

    container.innerHTML = items.map(item => {
        const isRead = item.is_read;
        const timeAgo = formatTimeAgo(item.created_at);
        const bgClass = isRead ? '' : 'bg-light';

        return `
            <a href="#" class="dropdown-item ${bgClass}" onclick="handleNotificationClick(${item.id}, '${item.source}', '${item.link || ''}'); return false;">
                <div class="d-flex align-items-start">
                    <div class="mr-2">
                        <i class="${item.icon || 'fas fa-bell'} ${item.icon_color || 'text-primary'}"></i>
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="text-dark" style="font-size: 13px;">${escapeHtml(item.title)}</strong>
                            ${!isRead ? '<span class="badge badge-primary badge-sm ml-1">Baru</span>' : ''}
                        </div>
                        <p class="text-muted text-sm mb-0" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${escapeHtml(item.message?.substring(0, 80) || '')}${item.message?.length > 80 ? '...' : ''}
                        </p>
                        <small class="text-muted">${timeAgo}</small>
                    </div>
                </div>
            </a>
        `;
    }).join('');
}

async function handleNotificationClick(id, source, link) {
    try {
        const token = await window.getIdToken();

        // Mark as read based on source type
        if (source === 'notification') {
            await fetch(`/api/notifications/${id}/read`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        } else if (source === 'announcement') {
            await fetch(`/api/staff-announcements/${id}/read`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        }

        // Update badge count
        loadNotificationCount();
    } catch (error) {
        console.error('[Notifications] Error marking as read:', error);
    }

    // Close dropdown first
    $('#notification-dropdown .dropdown-toggle').dropdown('hide');

    // Navigate to link if provided
    if (link) {
        if (link.startsWith('#') || link.startsWith('javascript:')) {
            // In-page navigation
            eval(link.replace('javascript:', ''));
        } else {
            window.location.href = link;
        }
    }
}

async function markAllNotificationsRead() {
    try {
        const token = await window.getIdToken();
        if (!token) return;

        const response = await fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            loadNotifications();
            updateNotificationBadge(0);
            if (typeof showToast === 'function') {
                showToast('Semua notifikasi ditandai sudah dibaca', 'success');
            }
        }
    } catch (error) {
        console.error('[Notifications] Error marking all as read:', error);
    }
}

function showAllNotifications() {
    // Close dropdown
    $('#notification-dropdown .dropdown-toggle').dropdown('hide');

    // Navigate to notifications page
    showNotificationsPage();
}

// ========== NOTIFICATIONS PAGE FUNCTIONS ==========
let notificationPageData = [];
let notificationPageFilter = 'all';
let notificationPagePage = 1;
const notificationPageLimit = 20;

function showNotificationsPage(highlightAnnouncementId = null) {
    // Hide all pages
    document.querySelectorAll('[id$="-page"]').forEach(page => {
        page.classList.add('d-none');
    });

    // Show notifications page
    const notifPage = document.getElementById('notifications-page');
    if (notifPage) {
        notifPage.classList.remove('d-none');
    }

    // Update page title
    const pageTitle = document.getElementById('page-title');
    if (pageTitle) {
        pageTitle.textContent = 'Notifikasi';
    }

    // Remove active from all nav items
    document.querySelectorAll('.nav-sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // Set active on notifications nav
    const navNotifications = document.querySelector('#nav-notifications .nav-link');
    if (navNotifications) {
        navNotifications.classList.add('active');
    }

    // Load notifications and staff announcements
    loadNotificationsPage();
    loadStaffAnnouncements().then(() => {
        // Scroll to and highlight specific announcement if provided
        if (highlightAnnouncementId) {
            setTimeout(() => {
                const announcementEl = document.querySelector(`[data-announcement-id="${highlightAnnouncementId}"]`);
                if (announcementEl) {
                    announcementEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    announcementEl.classList.add('highlight-flash');
                    setTimeout(() => announcementEl.classList.remove('highlight-flash'), 2000);
                }
            }, 300);
        }
    });
}

// Make showNotificationsPage globally available
window.showNotificationsPage = showNotificationsPage;

// ========== STAFF ANNOUNCEMENTS ==========
async function loadStaffAnnouncements() {
    const container = document.getElementById('staff-announcements-list');
    if (!container) return;

    try {
        const token = localStorage.getItem('vps_auth_token');
        if (!token) return;

        const response = await fetch('/api/staff-announcements', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        const announcements = data.data || [];

        if (announcements.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-info-circle mr-2"></i>Tidak ada pengumuman staff.</div>';
            return;
        }

        const isDokter = window.auth?.currentUser?.is_superadmin || window.auth?.currentUser?.role === 'dokter';

        container.innerHTML = announcements.map(a => {
            const priorityClass = a.priority === 'urgent' ? 'border-danger' : (a.priority === 'important' ? 'border-warning' : 'border-info');
            const priorityIcon = a.priority === 'urgent' ? 'fa-exclamation-triangle text-danger' : (a.priority === 'important' ? 'fa-exclamation-circle text-warning' : 'fa-bullhorn text-info');
            const priorityBadge = a.priority === 'urgent' ? '<span class="badge badge-danger ml-2">URGENT</span>' : (a.priority === 'important' ? '<span class="badge badge-warning ml-2">Penting</span>' : '');
            const timeAgo = formatTimeAgo(new Date(a.created_at));

            return `
                <div class="callout ${priorityClass} mb-2" data-announcement-id="${a.id}">
                    <div class="d-flex justify-content-between">
                        <h6 class="mb-1"><i class="fas ${priorityIcon} mr-2"></i>${escapeHtml(a.title)}${priorityBadge}</h6>
                        ${isDokter ? `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary btn-xs" onclick="editStaffAnnouncement(${a.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-xs" onclick="deleteStaffAnnouncement(${a.id})" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <p class="mb-1" style="white-space: pre-wrap;">${escapeHtml(a.message)}</p>
                    <small class="text-muted">${a.created_by_name || 'Admin'} - ${timeAgo}</small>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Failed to load staff announcements:', error);
        container.innerHTML = '<div class="text-danger text-center py-3"><i class="fas fa-exclamation-circle mr-2"></i>Gagal memuat pengumuman.</div>';
    }
}

function showCreateStaffAnnouncement() {
    document.getElementById('staff-announcement-id').value = '';
    document.getElementById('staff-announcement-title').value = '';
    document.getElementById('staff-announcement-message').value = '';
    document.getElementById('staff-announcement-priority').value = 'normal';
    document.getElementById('staff-announcement-status').value = 'active';
    document.getElementById('modal-staff-announcement-title').textContent = 'Buat Pengumuman Staff';
    $('#modal-staff-announcement').modal('show');
}

async function editStaffAnnouncement(id) {
    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch(`/api/staff-announcements/${id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.message);

        const a = data.data;
        document.getElementById('staff-announcement-id').value = a.id;
        document.getElementById('staff-announcement-title').value = a.title;
        document.getElementById('staff-announcement-message').value = a.message;
        document.getElementById('staff-announcement-priority').value = a.priority;
        document.getElementById('staff-announcement-status').value = a.status;
        document.getElementById('modal-staff-announcement-title').textContent = 'Edit Pengumuman Staff';
        $('#modal-staff-announcement').modal('show');
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

async function saveStaffAnnouncement() {
    const id = document.getElementById('staff-announcement-id').value;
    const title = document.getElementById('staff-announcement-title').value.trim();
    const message = document.getElementById('staff-announcement-message').value.trim();
    const priority = document.getElementById('staff-announcement-priority').value;
    const status = document.getElementById('staff-announcement-status').value;

    if (!title || !message) {
        Swal.fire('Error', 'Judul dan isi pengumuman harus diisi', 'error');
        return;
    }

    try {
        const token = localStorage.getItem('vps_auth_token');
        const url = id ? `/api/staff-announcements/${id}` : '/api/staff-announcements';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, message, priority, status })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.message);

        $('#modal-staff-announcement').modal('hide');
        Swal.fire('Sukses', id ? 'Pengumuman berhasil diperbarui' : 'Pengumuman berhasil dibuat', 'success');
        loadStaffAnnouncements();
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

async function deleteStaffAnnouncement(id) {
    const result = await Swal.fire({
        title: 'Hapus Pengumuman?',
        text: 'Pengumuman akan dihapus permanen.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
    });

    if (!result.isConfirmed) return;

    try {
        const token = localStorage.getItem('vps_auth_token');
        const response = await fetch(`/api/staff-announcements/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.message);

        Swal.fire('Sukses', 'Pengumuman berhasil dihapus', 'success');
        loadStaffAnnouncements();
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

// Helper: format time ago
function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Baru saja';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} menit lalu`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} jam lalu`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} hari lalu`;
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
}

// Helper: escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Export functions
window.loadStaffAnnouncements = loadStaffAnnouncements;
window.showCreateStaffAnnouncement = showCreateStaffAnnouncement;
window.editStaffAnnouncement = editStaffAnnouncement;
window.saveStaffAnnouncement = saveStaffAnnouncement;
window.deleteStaffAnnouncement = deleteStaffAnnouncement;

// ========== END STAFF ANNOUNCEMENTS ==========

async function loadNotificationsPage() {
    const container = document.getElementById('notifications-page-list');
    if (!container) return;

    // Show loading
    container.innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Memuat notifikasi...</p>
        </div>
    `;

    try {
        const token = await window.getIdToken();
        if (!token) {
            container.innerHTML = '<div class="alert alert-warning">Silakan login untuk melihat notifikasi.</div>';
            return;
        }

        // Fetch notifications
        const notifResponse = await fetch('/api/notifications?limit=50', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        // Fetch announcements
        const annResponse = await fetch('/api/announcements?status=active&limit=20', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        let notifications = [];
        let announcements = [];

        if (notifResponse.ok) {
            const notifData = await notifResponse.json();
            if (notifData.success) {
                notifications = notifData.notifications.map(n => ({ ...n, source: 'notification' }));
            }
        }

        if (annResponse.ok) {
            const annData = await annResponse.json();
            if (annData.success) {
                announcements = (annData.data || annData.announcements || []).map(a => ({
                    id: a.id,
                    type: 'announcement',
                    title: a.title,
                    message: a.message,
                    link: 'javascript:showKelolaPengumumanPage()',
                    icon: a.priority === 'urgent' ? 'fas fa-exclamation-triangle' : (a.priority === 'important' ? 'fas fa-exclamation-circle' : 'fas fa-bullhorn'),
                    icon_color: a.priority === 'urgent' ? 'text-danger' : (a.priority === 'important' ? 'text-warning' : 'text-info'),
                    created_at: a.created_at,
                    source: 'announcement',
                    is_read: 0
                }));
            }
        }

        // Combine and sort
        notificationPageData = [...notifications, ...announcements]
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Update stats
        updateNotificationPageStats();

        // Render with current filter
        renderNotificationsPageList();

    } catch (error) {
        console.error('[Notifications Page] Error:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Gagal memuat notifikasi. <a href="#" onclick="loadNotificationsPage(); return false;">Coba lagi</a>
            </div>
        `;
    }
}

function updateNotificationPageStats() {
    const notifications = notificationPageData.filter(n => n.source === 'notification');
    const announcements = notificationPageData.filter(n => n.source === 'announcement');
    const unread = notifications.filter(n => !n.is_read);
    const read = notifications.filter(n => n.is_read);

    document.getElementById('notif-stat-unread').textContent = unread.length;
    document.getElementById('notif-stat-read').textContent = read.length;
    document.getElementById('notif-stat-announcements').textContent = announcements.length;
    document.getElementById('notif-stat-total').textContent = notificationPageData.length;
}

function filterNotifications(filter) {
    notificationPageFilter = filter;
    notificationPagePage = 1;

    // Update tab active state
    document.querySelectorAll('#notification-tabs .nav-link').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
            tab.classList.add('active');
        }
    });

    renderNotificationsPageList();
}

// Render markdown for notification messages (safe subset)
function renderNotificationMarkdown(text) {
    if (!text) return '';
    try {
        // Use marked.js to parse markdown
        if (typeof marked !== 'undefined') {
            // Configure marked for safe output
            marked.setOptions({
                breaks: true,
                gfm: true
            });
            // Parse and return
            let html = marked.parse(text);
            // Remove wrapping <p> tags to keep it inline-ish
            html = html.replace(/^<p>/, '').replace(/<\/p>\n?$/, '');
            return html;
        }
    } catch (e) {
        console.error('[Notifications] Markdown parse error:', e);
    }
    // Fallback to escaped text
    return escapeHtml(text);
}

function renderNotificationsPageList() {
    const container = document.getElementById('notifications-page-list');
    if (!container) return;

    // Filter data
    let filtered = notificationPageData;
    if (notificationPageFilter === 'unread') {
        filtered = notificationPageData.filter(n => !n.is_read);
    } else if (notificationPageFilter === 'notification') {
        filtered = notificationPageData.filter(n => n.source === 'notification');
    } else if (notificationPageFilter === 'announcement') {
        filtered = notificationPageData.filter(n => n.source === 'announcement');
    }

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="far fa-bell-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">Tidak ada notifikasi${notificationPageFilter !== 'all' ? ' dalam kategori ini' : ''}.</p>
            </div>
        `;
        document.getElementById('notifications-pagination-container').style.display = 'none';
        return;
    }

    // Pagination
    const totalPages = Math.ceil(filtered.length / notificationPageLimit);
    const start = (notificationPagePage - 1) * notificationPageLimit;
    const end = Math.min(start + notificationPageLimit, filtered.length);
    const pageData = filtered.slice(start, end);

    // Render list
    container.innerHTML = pageData.map(item => {
        const isRead = item.is_read;
        const timeAgo = formatTimeAgo(item.created_at);
        const sourceLabel = item.source === 'announcement' ?
            '<span class="badge badge-info badge-sm ml-2">Pengumuman</span>' :
            '<span class="badge badge-secondary badge-sm ml-2">Notifikasi</span>';

        return `
            <div class="card mb-2 notification-card ${!isRead ? 'border-left-primary' : ''}" style="border-left-width: ${!isRead ? '4px' : '1px'}; cursor: ${item.link ? 'pointer' : 'default'};" onclick="${item.link ? `handleNotifPageClick('${item.link}')` : ''}">
                <div class="card-body py-3">
                    <div class="d-flex align-items-start">
                        <div class="mr-3">
                            <span class="btn btn-${!isRead ? 'primary' : 'secondary'} btn-sm rounded-circle" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="${item.icon || 'fas fa-bell'}"></i>
                            </span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 ${!isRead ? 'font-weight-bold' : ''}">
                                        ${escapeHtml(item.title)}
                                        ${!isRead ? '<span class="badge badge-primary ml-2">Baru</span>' : ''}
                                        ${sourceLabel}
                                    </h6>
                                    <div class="text-muted mb-2 notification-message">${renderNotificationMarkdown(item.message?.substring(0, 500) || '')}${item.message?.length > 500 ? '...' : ''}</div>
                                    <small class="text-muted">
                                        <i class="far fa-clock mr-1"></i>${timeAgo}
                                    </small>
                                </div>
                                <div class="ml-3">
                                    ${item.source === 'notification' && !isRead ? `
                                        <button class="btn btn-sm btn-outline-primary" onclick="markNotificationReadPage(${item.id})" title="Tandai dibaca">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    ${item.link ? `
                                        <a href="${item.link}" class="btn btn-sm btn-outline-secondary ml-1" title="Lihat detail">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Update pagination
    document.getElementById('notif-showing-start').textContent = start + 1;
    document.getElementById('notif-showing-end').textContent = end;
    document.getElementById('notif-showing-total').textContent = filtered.length;

    if (totalPages > 1) {
        document.getElementById('notifications-pagination-container').style.display = 'flex';
        renderNotificationsPagination(totalPages);
    } else {
        document.getElementById('notifications-pagination-container').style.display = 'none';
    }
}

function renderNotificationsPagination(totalPages) {
    const pagination = document.getElementById('notifications-pagination');
    if (!pagination) return;

    let html = '';

    // Previous
    html += `<li class="page-item ${notificationPagePage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToNotificationPage(${notificationPagePage - 1}); return false;">&laquo;</a>
    </li>`;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= notificationPagePage - 2 && i <= notificationPagePage + 2)) {
            html += `<li class="page-item ${i === notificationPagePage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goToNotificationPage(${i}); return false;">${i}</a>
            </li>`;
        } else if (i === notificationPagePage - 3 || i === notificationPagePage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next
    html += `<li class="page-item ${notificationPagePage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="goToNotificationPage(${notificationPagePage + 1}); return false;">&raquo;</a>
    </li>`;

    pagination.innerHTML = html;
}

function goToNotificationPage(page) {
    if (page < 1) return;
    notificationPagePage = page;
    renderNotificationsPageList();
    // Scroll to top
    document.getElementById('notifications-page').scrollIntoView({ behavior: 'smooth' });
}

async function markNotificationReadPage(id) {
    try {
        const token = await window.getIdToken();
        if (!token) return;

        const response = await fetch(`/api/notifications/${id}/read`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            // Update local data
            const item = notificationPageData.find(n => n.id === id && n.source === 'notification');
            if (item) {
                item.is_read = 1;
            }
            updateNotificationPageStats();
            renderNotificationsPageList();
            loadNotificationCount(); // Update badge
        }
    } catch (error) {
        console.error('[Notifications Page] Error marking as read:', error);
    }
}

async function markAllNotificationsReadPage() {
    try {
        const token = await window.getIdToken();
        if (!token) return;

        const response = await fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            // Update local data
            notificationPageData.forEach(n => {
                if (n.source === 'notification') {
                    n.is_read = 1;
                }
            });
            updateNotificationPageStats();
            renderNotificationsPageList();
            loadNotificationCount(); // Update badge
            if (typeof showToast === 'function') {
                showToast('Semua notifikasi ditandai sudah dibaca', 'success');
            }
        }
    } catch (error) {
        console.error('[Notifications Page] Error marking all as read:', error);
    }
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);

    if (diffSec < 60) return 'Baru saja';
    if (diffMin < 60) return `${diffMin} menit lalu`;
    if (diffHour < 24) return `${diffHour} jam lalu`;
    if (diffDay < 7) return `${diffDay} hari lalu`;

    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function handleNotifPageClick(link) {
    if (!link) return;
    if (link.startsWith('javascript:')) {
        eval(link.replace('javascript:', ''));
    } else {
        window.location.href = link;
    }
}
window.handleNotifPageClick = handleNotifPageClick;
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/staff/public/sw.js')
            .then((registration) => {
                console.log('[PWA] Service Worker registered:', registration.scope);

                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    console.log('[PWA] Service Worker update found');

                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New content available
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    title: 'Update Tersedia',
                                    text: 'Versi baru aplikasi tersedia. Refresh untuk update?',
                                    icon: 'info',
                                    showCancelButton: true,
                                    confirmButtonText: 'Update',
                                    cancelButtonText: 'Nanti'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                });
                            }
                        }
                    });
                });
            })
            .catch((error) => {
                console.log('[PWA] Service Worker registration failed:', error);
            });
    });

    // Handle controller change
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] Controller changed');
    });
}

// PWA Cache Control Functions - Use these for smooth real-time operation
window.PWACache = {
    // Clear all caches (use when having stale data issues)
    clearAll: async function() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            return new Promise((resolve) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    console.log('[PWA] Cache cleared:', event.data);
                    resolve(event.data);
                };
                navigator.serviceWorker.controller.postMessage(
                    { type: 'CLEAR_CACHE' },
                    [messageChannel.port2]
                );
            });
        }
        // Fallback: clear via Cache API directly
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            console.log('[PWA] Caches cleared directly');
            return { success: true };
        }
    },

    // Clear only API cache (keeps static assets cached)
    clearAPICache: async function() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            return new Promise((resolve) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    console.log('[PWA] API cache cleared:', event.data);
                    resolve(event.data);
                };
                navigator.serviceWorker.controller.postMessage(
                    { type: 'CLEAR_API_CACHE' },
                    [messageChannel.port2]
                );
            });
        }
    },

    // Force reload page with cache bypass
    forceReload: function() {
        window.location.reload(true);
    },

    // Get cache status
    getStatus: async function() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            return new Promise((resolve) => {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => resolve(event.data);
                navigator.serviceWorker.controller.postMessage(
                    { type: 'GET_CACHE_STATUS' },
                    [messageChannel.port2]
                );
            });
        }
        return { caches: [], version: 'unknown' };
    }
};

// Auto-clear API cache on page load during service hours (Sunday)
(function() {
    const now = new Date();
    const day = now.getDay(); // 0 = Sunday
    const hour = now.getHours();

    // If it's Sunday between 8 AM and 6 PM, clear API cache for fresh data
    if (day === 0 && hour >= 8 && hour <= 18) {
        console.log('[PWA] Service hours detected - ensuring fresh data');
        if (window.PWACache) {
            window.PWACache.clearAPICache();
        }
    }
})();

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] Install prompt available');
    e.preventDefault();
    deferredPrompt = e;

    // Show install button if not already installed
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
        installBtn.style.display = 'block';
    }
});

window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed');
    deferredPrompt = null;
    const installBtn = document.getElementById('pwa-install-btn');
    if (installBtn) {
        installBtn.style.display = 'none';
    }
});

// Install PWA function
function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
            console.log('[PWA] User choice:', choiceResult.outcome);
            deferredPrompt = null;
        });
    }
}
</script>

</body>
</html>

