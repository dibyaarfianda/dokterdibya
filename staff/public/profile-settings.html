<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Profil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .profile-avatar-container {
            position: relative;
            display: inline-block;
        }
        .profile-avatar-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Content Header -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-user-cog mr-2"></i>Pengaturan Profil</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/staff/public/index-adminlte.html">Home</a></li>
                            <li class="breadcrumb-item active">Pengaturan Profil</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <!-- Profile Picture & Display Name -->
                    <div class="col-md-4">
                        <div class="card card-primary card-outline">
                            <div class="card-body box-profile">
                                <div class="text-center">
                                    <div class="profile-avatar-container">
                                        <img id="profile-avatar-img" src="" alt="Profile Picture" class="profile-user-img img-fluid img-circle elevation-2" style="width: 120px; height: 120px; object-fit: cover; display: none;">
                                        <i id="profile-avatar-icon" class="fas fa-user-circle fa-6x text-primary"></i>
                                        <div class="profile-avatar-overlay">
                                            <label for="profile-picture-input" class="btn btn-primary btn-sm rounded-circle m-0" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-camera"></i>
                                            </label>
                                            <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                                        </div>
                                    </div>
                                </div>

                                <h3 class="profile-username text-center mt-3" id="profile-display-name">Loading...</h3>

                                <p class="text-muted text-center" id="profile-display-email">email@example.com</p>

                                <ul class="list-group list-group-unbordered mb-3">
                                    <li class="list-group-item">
                                        <b>Role</b> <a class="float-right" id="profile-display-role">-</a>
                                    </li>
                                    <li class="list-group-item">
                                        <b>User ID</b> <a class="float-right" id="profile-display-uid">-</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-user-edit mr-2"></i>Edit Profile</h3>
                            </div>
                            <form id="profile-form">
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="profile-displayname">Tampilan Nama <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="profile-displayname" placeholder="Nama yang ditampilkan" required>
                                        <small class="form-text text-muted">Nama ini akan muncul di header dan sistem</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="profile-email">Email</label>
                                        <input type="email" class="form-control" id="profile-email" readonly disabled>
                                        <small class="form-text text-muted">Email tidak dapat diubah</small>
                                    </div>

                                    <hr>
                                    <h5 class="mb-3"><i class="fas fa-key mr-2"></i>Ubah Password</h5>

                                    <div class="form-group">
                                        <label for="profile-current-password">Password Saat Ini</label>
                                        <input type="password" class="form-control" id="profile-current-password" name="current_password" autocomplete="current-password" placeholder="Masukkan password saat ini">
                                        <small class="form-text text-muted">Diperlukan untuk mengubah password</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="profile-new-password">Password Baru</label>
                                        <input type="password" class="form-control" id="profile-new-password" name="new_password" autocomplete="new-password" placeholder="Password baru (min. 6 karakter)">
                                    </div>

                                    <div class="form-group">
                                        <label for="profile-confirm-password">Konfirmasi Password Baru</label>
                                        <input type="password" class="form-control" id="profile-confirm-password" name="confirm_password" autocomplete="new-password" placeholder="Konfirmasi password baru">
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                                    </button>
                                    <button type="button" class="btn btn-secondary ml-2" onclick="window.location.href='/staff/public/index-adminlte.html'">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script type="module">
    import { auth, getIdToken } from './scripts/vps-auth-v2.js';

    let currentUser = null;
    let selectedProfilePicture = null;

    // Get token from localStorage
    function getToken() {
        return localStorage.getItem('vps_auth_token') || sessionStorage.getItem('vps_auth_token');
    }

    // Show toast message
    function showToast(message, type = 'success') {
        const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107';
        const textColor = type === 'warning' ? '#212529' : '#ffffff';
        const toast = $(`
            <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 250px;
                        background: ${bgColor}; color: ${textColor}; padding: 15px 20px;
                        border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                ${message}
            </div>
        `);
        $('body').append(toast);
        setTimeout(() => toast.fadeOut(500, function() { $(this).remove(); }), 3000);
    }

    // Load profile data
    async function loadProfileData() {
        try {
            const token = getToken();
            if (!token) {
                showToast('Session expired. Please login again.', 'error');
                window.location.href = 'login.html';
                return;
            }

            const response = await fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                currentUser = data.data.user;

                // Update display elements
                $('#profile-display-name').text(currentUser.name || 'User');
                $('#profile-display-email').text(currentUser.email || '-');
                $('#profile-display-role').text(currentUser.role_display_name || currentUser.role || '-');
                $('#profile-display-uid').text((currentUser.id || '').substring(0, 12) + '...');

                // Update form fields
                $('#profile-displayname').val(currentUser.name || '');
                $('#profile-email').val(currentUser.email || '');

                // Load profile picture
                displayProfilePicture(currentUser.photo_url);
            } else {
                showToast('Failed to load profile data', 'error');
            }
        } catch (error) {
            console.error('Error loading profile:', error);
            showToast('Error loading profile data', 'error');
        }
    }

    // Display profile picture
    function displayProfilePicture(photoURL) {
        const avatarImg = $('#profile-avatar-img');
        const avatarIcon = $('#profile-avatar-icon');

        if (photoURL) {
            avatarImg.attr('src', photoURL).show();
            avatarIcon.hide();
        } else {
            avatarImg.hide();
            avatarIcon.show();
        }
    }

    // Handle profile picture selection
    $('#profile-picture-input').on('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showToast('File harus berupa gambar (JPG, PNG, GIF)', 'error');
            return;
        }

        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('Ukuran file maksimal 2MB', 'error');
            return;
        }

        // Read file as base64
        const reader = new FileReader();
        reader.onload = (event) => {
            selectedProfilePicture = event.target.result;
            displayProfilePicture(selectedProfilePicture);
            showToast('Foto dipilih. Klik Simpan untuk menyimpan.', 'success');
        };
        reader.onerror = () => {
            showToast('Gagal membaca file', 'error');
        };
        reader.readAsDataURL(file);
    });

    // Handle form submission
    $('#profile-form').on('submit', async function(e) {
        e.preventDefault();

        if (!currentUser) {
            showToast('Session expired. Please login again.', 'error');
            return;
        }

        const newDisplayName = $('#profile-displayname').val().trim();
        const currentPassword = $('#profile-current-password').val();
        const newPassword = $('#profile-new-password').val();
        const confirmPassword = $('#profile-confirm-password').val();

        // Validate display name
        if (!newDisplayName) {
            showToast('Tampilan nama harus diisi', 'error');
            return;
        }

        // Validate password if changing
        if (newPassword || confirmPassword) {
            if (!currentPassword) {
                showToast('Password saat ini harus diisi untuk mengubah password', 'error');
                return;
            }
            if (newPassword.length < 6) {
                showToast('Password baru minimal 6 karakter', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast('Konfirmasi password tidak cocok', 'error');
                return;
            }
        }

        // Prepare update data for profile (name and photo only)
        const updateData = { name: newDisplayName };

        if (selectedProfilePicture !== null) {
            updateData.photo_url = selectedProfilePicture;
        }

        try {
            const token = getToken();

            // Update profile (name and photo)
            const response = await fetch('/api/auth/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.message || 'Gagal memperbarui profil', 'error');
                return;
            }

            // If password change requested, call separate endpoint
            if (newPassword) {
                const passwordResponse = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const passwordData = await passwordResponse.json();

                if (!passwordResponse.ok) {
                    showToast(passwordData.message || 'Gagal mengubah password', 'error');
                    return;
                }
            }

            showToast('Profil berhasil diperbarui!', 'success');
            selectedProfilePicture = null;

            // Clear password fields
            $('#profile-current-password').val('');
            $('#profile-new-password').val('');
            $('#profile-confirm-password').val('');

            // Reload profile data
            setTimeout(() => loadProfileData(), 1000);
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('Error updating profile', 'error');
        }
    });

    // Initialize on page load
    $(document).ready(function() {
        loadProfileData();
    });
</script>
    <!-- Global Chat Loader -->
    <script src="/staff/public/scripts/global-chat-loader.js"></script>
</body>
</html>
